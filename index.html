<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>I-STYLE æ–°åº—ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ - å®Œå…¨ç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #007AFF;
            --secondary: #5856D6;
            --success: #34C759;
            --warning: #FF9500;
            --danger: #FF3B30;
            --background: #F5F5F7;
            --surface: #FFFFFF;
            --text-primary: #1D1D1F;
            --text-secondary: #86868B;
            --border: #D2D2D7;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Helvetica Neue', Arial, sans-serif;
            background: var(--background);
            color: var(--text-primary);
            line-height: 1.6;
        }

        .app-container {
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ */
        .mobile-menu-btn {
            display: none;
            position: fixed;
            top: 16px;
            left: 16px;
            z-index: 1001;
            background: var(--primary);
            color: white;
            border: none;
            width: 48px;
            height: 48px;
            border-radius: 12px;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3);
        }

        .mobile-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }

        /* ã‚µã‚¤ãƒ‰ãƒãƒ¼ */
        .sidebar {
            width: 280px;
            background: var(--surface);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            z-index: 1000;
            position: relative;
        }

        .sidebar-header {
            padding: 24px;
            border-bottom: 1px solid var(--border);
        }

        .logo {
            font-size: 24px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
        }

        .store-selector {
            margin-top: 16px;
        }

        .store-select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-size: 15px;
            background: var(--background);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .store-select:focus {
            outline: none;
            border-color: var(--primary);
            background: var(--surface);
        }

        .nav-menu {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            margin-bottom: 4px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
            color: var(--text-primary);
        }

        .nav-item:hover {
            background: var(--background);
        }

        .nav-item.active {
            background: var(--primary);
            color: white;
        }

        .nav-item .icon {
            margin-right: 12px;
            font-size: 20px;
        }

        /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */
        .main-content {
            flex: 1;
            overflow-y: auto;
            background: var(--background);
        }

        .content-header {
            background: var(--surface);
            padding: 12px 24px;
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(20px);
            background: rgba(255, 255, 255, 0.9);
            overflow: hidden;
            transition: all 0.2s ease;
        }

        .content-header h1 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 2px;
        }

        .content-header p {
            color: var(--text-secondary);
            font-size: 13px;
        }

        .content-body {
            padding: 16px;
        }

        /* ãƒªã‚µã‚¤ã‚¶ãƒ¼ */
        .sidebar-resizer {
            position: absolute;
            right: 0;
            top: 0;
            width: 5px;
            height: 100%;
            cursor: ew-resize;
            background: transparent;
            z-index: 1001;
            transition: background 0.2s ease;
        }

        .sidebar-resizer:hover {
            background: var(--primary);
        }

        .header-resizer {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 5px;
            cursor: ns-resize;
            background: transparent;
            z-index: 101;
            transition: background 0.2s ease;
        }

        .header-resizer:hover {
            background: var(--primary);
        }

        /* ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */
        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ã‚«ãƒ¼ãƒ‰ */
        .card {
            background: var(--surface);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            flex-wrap: wrap;
            gap: 8px;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
        }

        /* ãƒœã‚¿ãƒ³ */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: #0051D5;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3);
        }

        .btn-secondary {
            background: var(--background);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: #E8E8ED;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-group {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        /* çµ±è¨ˆã‚«ãƒ¼ãƒ‰ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            padding: 24px;
            border-radius: 16px;
            color: white;
            text-align: center;
        }

        .stat-value {
            font-size: 36px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }

        /* éšå±¤ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆ */
        .hierarchical-task-list {
            margin-top: 20px;
        }

        .task-group {
            margin-bottom: 16px;
        }

        .parent-task {
            background: linear-gradient(135deg, rgba(0, 122, 255, 0.15), rgba(88, 86, 214, 0.15));
            border-left: 6px solid var(--primary);
            padding: 20px;
            margin-bottom: 8px;
            border-radius: 12px;
            font-weight: 700;
            font-size: 18px;
        }

        .child-tasks {
            margin-left: 30px;
        }

        .task-item {
            background: var(--background);
            border-left: 4px solid var(--primary);
            padding: 16px;
            margin-bottom: 8px;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .task-item:hover {
            background: #E8E8ED;
            transform: translateX(4px);
        }

        .task-item.level-1 {
            background: linear-gradient(135deg, rgba(0, 122, 255, 0.1), rgba(88, 86, 214, 0.1));
            border-left-width: 6px;
            font-weight: 700;
            font-size: 18px;
            padding: 20px;
        }

        .task-item.level-2 {
            margin-left: 30px;
            border-left-color: var(--secondary);
            font-weight: 600;
            font-size: 16px;
        }

        .task-item.level-3 {
            margin-left: 60px;
            border-left-color: var(--success);
        }

        .task-item.level-4 { margin-left: 90px; border-left-color: var(--warning); }
        .task-item.level-5 { margin-left: 120px; border-left-color: #FF2D55; }
        .task-item.level-6 { margin-left: 150px; border-left-color: #AF52DE; }
        .task-item.level-7 { margin-left: 180px; border-left-color: #FFD60A; }
        .task-item.level-8 { margin-left: 210px; border-left-color: #64D2FF; }
        .task-item.level-9 { margin-left: 240px; border-left-color: #30D158; }
        .task-item.level-10 { margin-left: 270px; border-left-color: #BF5AF2; }

        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
            gap: 12px;
        }

        .task-name {
            font-weight: 600;
            color: var(--text-primary);
            flex: 1;
        }

        .task-meta {
            display: flex;
            gap: 12px;
            font-size: 14px;
            color: var(--text-secondary);
            margin-top: 8px;
            flex-wrap: wrap;
        }

        .task-assignee {
            background: rgba(0, 122, 255, 0.1);
            color: var(--primary);
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 600;
        }

        .task-status {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 600;
        }

        .task-status.pending { background: #FEF5E7; color: #D68910; }
        .task-status.in-progress { background: #E3F2FD; color: #1976D2; }
        .task-status.completed { background: #E8F5E9; color: #388E3C; }

        .task-memo {
            color: var(--text-secondary);
            font-size: 14px;
            margin-top: 8px;
            font-style: italic;
        }

        .task-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .btn-edit, .btn-delete {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-edit {
            background: #E3F2FD;
            color: #1976D2;
        }

        .btn-delete {
            background: #FFEBEE;
            color: #C62828;
        }

        /* ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆ */
        .gantt-container {
            background: var(--surface);
            border-radius: 12px;
            padding: 12px;
            display: flex;
            flex-direction: column;
            max-height: calc(100vh - 120px);
            min-height: 400px;
        }

        /* 2. ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆâ†’ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒœã‚¿ãƒ³ã‚’å¸¸æ™‚è¡¨ç¤ºã•ã›ãŸã„ */
        .gantt-scroll-wrapper {
            overflow: scroll; /* auto ã‹ã‚‰ scroll ã«å¤‰æ›´ */
            overflow-x: scroll; /* æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’æ˜ç¤º */
            overflow-y: scroll; /* ç¸¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’æ˜ç¤º */
            flex: 1;
            position: relative;
        }

        /* 1. ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆâ†’å­ã€å­«ã‚¿ã‚¹ã‚¯ã®è¡¨ç¤º/éè¡¨ç¤º (æ–°è¦è¿½åŠ ) */
        /* é–‰ã˜ã¦ã„ã‚‹ã‚¿ã‚¹ã‚¯ã®è¡Œã¯éè¡¨ç¤º */
        .gantt-row.collapsed {
            display: none;
        }

        /* å±•é–‹/æŠ˜ã‚ŠãŸãŸã¿ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .gantt-toggle-btn {
            display: inline-block;
            margin-right: 6px;
            cursor: pointer;
            font-size: 10px;
            line-height: 1;
            transition: transform 0.2s ease;
            font-family: 'SF Pro Display', 'Helvetica Neue', Arial, sans-serif; /* è¨˜å·ãŒå´©ã‚Œãªã„ã‚ˆã†ã« */
            font-weight: 900;
        }

        /* å±•é–‹çŠ¶æ…‹ã®è¡Œï¼ˆè¦ªã‚¿ã‚¹ã‚¯ï¼‰ */
        .gantt-row.expanded > .gantt-task-info > div {
            /* flexã‚’ç¶­æŒã—ã¦ãƒœã‚¿ãƒ³ã¨ã‚¿ã‚¹ã‚¯åã‚’ä¸¦ã¹ã‚‹ */
            display: flex;
            align-items: center;
        }

        /* å±•é–‹çŠ¶æ…‹ã®æ™‚ã®ãƒœã‚¿ãƒ³ã®å‘ãï¼ˆâ–¶ï¸ã‹ã‚‰â–¼ã¸ï¼‰ */
        .gantt-row.expanded > .gantt-task-info .gantt-toggle-btn {
            transform: rotate(90deg);
        }

        /* éè¦ªã‚¿ã‚¹ã‚¯ã®æƒ…å ±éƒ¨åˆ†ã‚’èª¿æ•´ */
        .gantt-row:not(.expanded) > .gantt-task-info > div {
            display: block; /* ãƒœã‚¿ãƒ³ãŒãªã„å ´åˆã¯ç¸¦ã«ç©ã‚€ */
        }
        
        .gantt-header-fixed {
            position: sticky;
            top: 0;
            background: var(--surface);
            z-index: 15;
            padding-bottom: 16px;
            border-bottom: 2px solid var(--border);
            margin-bottom: 16px;
        }

        .gantt-timeline-wrapper {
            display: flex;
        }

        .gantt-task-names {
            width: 300px;
            flex-shrink: 0;
            position: sticky;
            left: 0;
            background: var(--surface);
            z-index: 40;
        }

        .gantt-timeline-container {
            flex: 1;
            min-width: 2000px;
        }

        .gantt-calendar-header {
            display: flex;
            border-bottom: 2px solid var(--border);
            margin-bottom: 12px;
        }

        .gantt-year-header {
            display: flex;
            margin-bottom: 8px;
        }

        .gantt-year-block {
            flex: 0 0 auto;
            text-align: center;
            padding: 10px 12px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            font-weight: 700;
            font-size: 15px;
            border-radius: 8px;
            margin: 0 1px;
        }

        .gantt-month-header {
            display: flex;
            margin-bottom: 4px;
        }

        .gantt-month-block {
            flex: 0 0 auto;
            text-align: center;
            padding: 8px 6px;
            background: var(--background);
            font-weight: 600;
            font-size: 13px;
            border-radius: 6px;
            margin: 0 1px;
        }

        .gantt-day-header {
            display: flex;
        }

        .gantt-day-cell {
            flex: 0 0 30px;
            width: 30px;
            text-align: center;
            padding: 6px 2px;
            font-size: 10px;
            border-right: 1px solid var(--border);
            color: var(--text-secondary);
            line-height: 1.2;
        }

        .gantt-day-cell.weekend {
            background: rgba(255, 149, 0, 0.05);
        }

        .gantt-day-cell.today {
            background: rgba(0, 122, 255, 0.15);
            color: var(--primary);
            font-weight: 700;
        }

        .gantt-row {
            display: flex;
            align-items: stretch;
            border-bottom: 1px solid var(--border);
            min-height: 30px;
        }

        .gantt-task-info {
            padding: 4px 8px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            background: #FFFFFF !important;
            position: sticky;
            left: 0;
            z-index: 150;
            border-right: 2px solid var(--border);
        }

        .gantt-row.level-1 .gantt-task-info {
            font-weight: 700;
            background: #e8f0ff !important;
        }

        .gantt-row.level-2 .gantt-task-info {
            padding-left: 32px;
            font-weight: 600;
        }

        .gantt-row.level-3 .gantt-task-info {
            padding-left: 52px;
        }

        .gantt-timeline-row {
            flex: 1;
            position: relative;
            display: flex;
            align-items: center;
        }

        .gantt-timeline-bg {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
        }

        .gantt-day-bg {
            border-right: 1px solid rgba(0, 0, 0, 0.05);
        }

        .gantt-day-bg.weekend {
            background: rgba(255, 149, 0, 0.02);
        }

        .gantt-bar {
            position: absolute;
            height: 32px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 8px;
            cursor: move;
            display: flex;
            align-items: center;
            padding: 0 12px;
            color: white;
            font-size: 12px;
            font-weight: 600;
            user-select: none;
            transition: box-shadow 0.2s ease;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            z-index: 5;
            opacity: 1;
        }

        .gantt-bar:hover {
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.5);
            z-index: 20;
        }

        .gantt-bar.dragging {
            opacity: 0.8;
            z-index: 100;
        }

        .gantt-bar-resize-left,
        .gantt-bar-resize-right {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 10px;
            cursor: ew-resize;
            background: rgba(255, 255, 255, 0.3);
        }

        .gantt-bar-resize-left {
            left: 0;
            border-radius: 8px 0 0 8px;
        }

        .gantt-bar-resize-right {
            right: 0;
            border-radius: 0 8px 8px 0;
        }

        .gantt-today-line {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 3px;
            background: var(--danger);
            z-index: 20;
            pointer-events: none;
            box-shadow: 0 0 8px rgba(255, 59, 48, 0.5);
        }

        /* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ */
        .calendar-container {
            background: var(--surface);
            border-radius: 16px;
            padding: 24px;
            /* 3. ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ç¸¦å¹…æ‹¡å¼µ: 220px -> 100px */
            height: calc(100vh - 100px); 
            display: flex;
            flex-direction: column;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            flex-shrink: 0;
        }

        .calendar-nav {
            display: flex;
            gap: 8px;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            grid-template-rows: repeat(6, 1fr);
            gap: 8px;
            flex: 1;
            min-height: 0;
        }

        .calendar-day {
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 8px;
            position: relative;
            overflow: auto;
        }

        .calendar-day.other-month {
            opacity: 0.3;
        }

        .calendar-day.today {
            background: rgba(0, 122, 255, 0.1);
            border-color: var(--primary);
            border-width: 2px;
        }

        .calendar-day-number {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .calendar-task {
            font-size: 11px;
            padding: 2px 6px;
            background: var(--primary);
            color: white;
            border-radius: 4px;
            margin-bottom: 2px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* ã‚¹ã‚¿ãƒƒãƒ•ã‚°ãƒªãƒƒãƒ‰ */
        .staff-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
        }

        .staff-card {
            background: var(--background);
            border-radius: 12px;
            padding: 20px;
            transition: all 0.2s ease;
        }

        .staff-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        .staff-name {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .staff-role {
            display: inline-block;
            padding: 4px 12px;
            background: rgba(0, 122, 255, 0.1);
            color: var(--primary);
            border-radius: 12px;
            font-size: 13px;
            margin-bottom: 12px;
        }

        .staff-info {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 32px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 2px solid var(--border);
        }

        .modal-title {
            font-size: 24px;
            font-weight: 700;
        }

        /* ãƒ•ã‚©ãƒ¼ãƒ  */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 15px;
            transition: all 0.2s ease;
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(0, 122, 255, 0.1);
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        /* CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ */
        .import-zone {
            border: 2px dashed var(--border);
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            background: var(--background);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .import-zone:hover {
            border-color: var(--primary);
            background: rgba(0, 122, 255, 0.05);
        }

        .import-zone.dragover {
            border-color: var(--primary);
            background: rgba(0, 122, 255, 0.1);
        }

        /* å°åˆ·ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        @media print {
            .sidebar,
            .content-header,
            .mobile-menu-btn,
            .btn,
            .task-actions,
            .calendar-nav {
                display: none !important;
            }

            body {
                background: white;
            }

            .main-content {
                width: 100%;
                padding: 0;
            }

            .content-body {
                padding: 0;
            }

            .gantt-container {
                box-shadow: none;
                border: 1px solid #000;
                page-break-inside: avoid;
            }

            .card-header {
                border-bottom: 2px solid #000;
                padding-bottom: 16px;
                margin-bottom: 16px;
            }

            .card-title {
                color: #000;
                font-size: 20px;
            }

            .gantt-bar {
                print-color-adjust: exact;
                -webkit-print-color-adjust: exact;
            }

            .gantt-year-block,
            .gantt-month-block {
                print-color-adjust: exact;
                -webkit-print-color-adjust: exact;
            }

            .gantt-scroll-wrapper {
                overflow: visible !important;
                max-height: none !important;
                transform: none !important;
            }

            .gantt-task-info {
                position: relative;
                left: auto;
            }
        }

        /* ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œ */
        /* 4. ã‚¹ãƒãƒ›ã§ã‚‚è¦‹ã‚„ã™ã„æ§˜ã« (æ—¢å­˜ã® @media ãƒ–ãƒ­ãƒƒã‚¯å†…ã«è¿½è¨˜/ä¿®æ­£) */
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: 0;
                top: 0;
                height: 100%;
                transform: translateX(-100%);
            }

            .sidebar.active {
                transform: translateX(0);
            }

            .mobile-menu-btn {
                display: block;
            }

            .mobile-overlay.active {
                display: block;
            }

            .content-header {
                padding: 20px 16px;
                padding-top: 80px;
            }

            .content-header h1 {
                font-size: 24px;
            }

            .content-body {
                padding: 16px;
            }

            .gantt-task-names,
            .gantt-task-info {
                width: 150px;
            }

            .task-item.level-2 { margin-left: 20px; }
            .task-item.level-3 { margin-left: 40px; }
            .task-item.level-4 { margin-left: 60px; }
            .task-item.level-5 { margin-left: 80px; }
            .task-item.level-6 { margin-left: 100px; }
            .task-item.level-7 { margin-left: 120px; }
            .task-item.level-8 { margin-left: 140px; }
            .task-item.level-9 { margin-left: 160px; }
            .task-item.level-10 { margin-left: 180px; }

            .staff-grid {
                grid-template-columns: 1fr;
            }

            .calendar-grid {
                gap: 4px;
            }

            .calendar-day {
                min-height: 60px;
                padding: 4px;
            }

            /* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®é«˜ã•ã‚’èª¿æ•´ */
            .calendar-container {
                height: auto; 
                min-height: calc(100vh - 150px); /* æœ€å°é«˜ã•ã‚’è¨­å®šã—ã¦è¦‹ã‚„ã™ãã™ã‚‹ */
            }
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-state-text {
            font-size: 18px;
        }
    </style>
</head>
<body>
    <div id="loginScreen" class="login-screen" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(135deg, #007AFF, #5856D6); z-index: 9999; display: flex; align-items: center; justify-content: center;">
        <div style="background: white; padding: 48px; border-radius: 24px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); width: 420px; max-width: 90%;">
            <h1 style="font-size: 32px; font-weight: 700; background: linear-gradient(135deg, #007AFF, #5856D6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-align: center; margin-bottom: 32px;">ğŸª I-STYLE</h1>
            <div id="loginError" style="display: none; padding: 12px; background: rgba(255, 59, 48, 0.1); color: #FF3B30; border-radius: 8px; margin-bottom: 16px; font-size: 14px;"></div>
            <form id="loginForm" onsubmit="handleLogin(event)">
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                    <input type="email" id="loginEmail" required style="width: 100%; padding: 12px; border: 2px solid #D2D2D7; border-radius: 10px; font-size: 16px;">
                </div>
                <div style="margin-bottom: 24px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                    <input type="password" id="loginPassword" required style="width: 100%; padding: 12px; border: 2px solid #D2D2D7; border-radius: 10px; font-size: 16px;">
                </div>
                <button type="submit" style="width: 100%; padding: 14px; background: #007AFF; color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer;">ãƒ­ã‚°ã‚¤ãƒ³</button>
            </form>
        </div>
    </div>

    <button class="mobile-menu-btn" onclick="toggleSidebar()">â˜°</button>
    <div class="mobile-overlay" onclick="toggleSidebar()"></div>

    <div class="app-container" id="appContainer" style="display: none;">
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="logo">ğŸª I-STYLE</div>
                <div class="store-selector">
                    <select class="store-select" id="storeSelect" onchange="switchStore()">
                        <option value="default">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆåº—èˆ—</option>
                    </select>
                </div>
                <div id="userInfo" style="margin-top: 16px; padding: 12px; background: #F5F5F7; border-radius: 10px;">
                    <div style="font-weight: 600; margin-bottom: 4px;" id="currentUserName"></div>
                    <div style="font-size: 12px; color: #86868B;" id="currentUserRole"></div>
                </div>
            </div>

            <nav class="nav-menu">
                <div class="nav-item active" onclick="showTab('dashboard')">
                    <span class="icon">ğŸ“Š</span>
                    ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
                </div>
                <div class="nav-item" onclick="showTab('gantt')">
                    <span class="icon">ğŸ“…</span>
                    ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆ
                </div>
                <div class="nav-item" onclick="showTab('calendar')">
                    <span class="icon">ğŸ—“ï¸</span>
                    ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼
                </div>
                <div class="nav-item" onclick="showTab('staff')">
                    <span class="icon">ğŸ‘¥</span>
                    ã‚¹ã‚¿ãƒƒãƒ•
                </div>
                <div class="nav-item" onclick="showTab('timeline')">
                    <span class="icon">â±ï¸</span>
                    ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³
                </div>
                <div class="nav-item" onclick="showTab('tasks')">
                    <span class="icon">ğŸ“‹</span>
                    ã‚¿ã‚¹ã‚¯ç®¡ç†
                </div>
                <div class="nav-item" onclick="showTab('settings')">
                    <span class="icon">âš™ï¸</span>
                    è¨­å®š
                </div>
            </nav>
            
            <div style="margin-top: auto; padding: 16px; border-top: 1px solid #D2D2D7;">
                <button onclick="logout()" style="width: 100%; padding: 12px; background: #FF3B30; color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer;">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
            </div>
            <div class="sidebar-resizer" id="sidebarResizer"></div>
        </aside>

        <main class="main-content">
            <div class="content-header">
                <h1 id="pageTitle">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
                <p id="pageDescription">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®é€²æ—ã‚’ä¸€ç›®ã§ç¢ºèª</p>
                <div class="header-resizer" id="headerResizer"></div>
            </div>

            <div class="content-body">
                <div id="dashboard" class="tab-content active">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="totalTasks">0</div>
                            <div class="stat-label">ç·ã‚¿ã‚¹ã‚¯æ•°</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="completedTasks">0</div>
                            <div class="stat-label">å®Œäº†</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="inProgressTasks">0</div>
                            <div class="stat-label">é€²è¡Œä¸­</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="progressPercent">0%</div>
                            <div class="stat-label">é€²æ—ç‡</div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦</h2>
                        </div>
                        <div id="dashboardStats"></div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">é‡è¦ãªãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³</h2>
                        </div>
                        <div id="milestones">
                            <div class="empty-state">
                                <div class="empty-state-icon">ğŸ‰</div>
                                <div class="empty-state-text">é‡è¦ãªã‚¿ã‚¹ã‚¯ã‚’ãƒãƒ¼ã‚¯ã—ã¾ã—ã‚‡ã†</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="gantt" class="tab-content">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ»ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆ</h2>
                        </div>
                        <div class="gantt-container" id="ganttChart">
                            <div class="empty-state">
                                <div class="empty-state-icon">ğŸ“…</div>
                                <div class="empty-state-text">ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="calendar" class="tab-content">
                    <div class="calendar-container">
                        <div class="calendar-header">
                            <h2 class="card-title" id="calendarTitle">2025å¹´ 10æœˆ</h2>
                            <div class="calendar-nav btn-group">
                                <button class="btn btn-secondary" onclick="todayMonth()">ä»Šæ—¥</button>
                                <button class="btn btn-secondary" onclick="previousMonth()">â—€</button>
                                <button class="btn btn-secondary" onclick="nextMonth()">â–¶</button>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(7, 1fr); margin-bottom: 8px; font-weight: 600; text-align: center; color: var(--text-secondary); flex-shrink: 0;">
                            <div>æ—¥</div>
                            <div>æœˆ</div>
                            <div>ç«</div>
                            <div>æ°´</div>
                            <div>æœ¨</div>
                            <div>é‡‘</div>
                            <div>åœŸ</div>
                        </div>
                        <div class="calendar-grid" id="calendarGrid">
                            </div>
                    </div>
                </div>

                <div id="staff" class="tab-content">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">ã‚¹ã‚¿ãƒƒãƒ•ä¸€è¦§</h2>
                            <button class="btn btn-primary" onclick="openStaffModal()">â• ã‚¹ã‚¿ãƒƒãƒ•è¿½åŠ </button>
                        </div>
                        <div class="staff-grid" id="staffList">
                            <div class="empty-state">
                                <div class="empty-state-icon">ğŸ‘¥</div>
                                <div class="empty-state-text">ã‚¹ã‚¿ãƒƒãƒ•ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="timeline" class="tab-content">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">ã‚¿ã‚¹ã‚¯ãƒ»ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ (é–‹å§‹æ—¥é †)</h2>
                        </div>
                        <div id="timelineView">
                            <div class="empty-state">
                                <div class="empty-state-icon">â±ï¸</div>
                                <div class="empty-state-text">ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="tasks" class="tab-content">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">ã‚¿ã‚¹ã‚¯è¿½åŠ /ç·¨é›†</h2>
                        </div>
                        <form onsubmit="addOrUpdateTask(event)" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                            <div class="form-group">
                                <label class="form-label">ãƒ¬ãƒ™ãƒ«</label>
                                <input type="number" id="taskLevel" class="form-input" min="1" max="10" value="1" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">è¦ªã‚¿ã‚¹ã‚¯å</label>
                                <input type="text" id="taskParent" class="form-input">
                            </div>
                            <div class="form-group">
                                <label class="form-label">ã‚¿ã‚¹ã‚¯å</label>
                                <input type="text" id="taskName" class="form-input" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">æ‹…å½“è€…</label>
                                <input type="text" id="taskAssignee" class="form-input">
                            </div>
                            <div class="form-group">
                                <label class="form-label">ãƒ¡ãƒ¢</label>
                                <input type="text" id="taskMemo" class="form-input">
                            </div>
                            <div class="form-group">
                                <label class="form-label">é–‹å§‹æ—¥</label>
                                <input type="date" id="taskStart" class="form-input" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">çµ‚äº†æ—¥</label>
                                <input type="date" id="taskEnd" class="form-input" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
                                <select id="taskStatus" class="form-select" required>
                                    <option value="æœªç€æ‰‹">æœªç€æ‰‹</option>
                                    <option value="é€²è¡Œä¸­">é€²è¡Œä¸­</option>
                                    <option value="å®Œäº†">å®Œäº†</option>
                                </select>
                            </div>
                            <div class="form-group" style="display: flex; align-items: flex-end; gap: 8px;">
                                <button type="submit" class="btn btn-primary" id="taskSubmitBtn">â• ã‚¿ã‚¹ã‚¯è¿½åŠ </button>
                                <button type="button" class="btn btn-secondary" id="cancelEditBtn" onclick="cancelEdit()" style="display: none;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                            </div>
                        </form>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">éšå±¤ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆ</h2>
                        </div>
                        <div class="hierarchical-task-list" id="taskList"></div>
                    </div>
                </div>

                <div id="settings" class="tab-content">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">åº—èˆ—ç®¡ç†</h2>
                        </div>
                        <div class="form-group">
                            <label class="form-label">æ–°è¦åº—èˆ—å</label>
                            <input type="text" id="newStoreName" class="form-input">
                            <button class="btn btn-secondary" onclick="addStore()" style="margin-top: 10px;">â• åº—èˆ—è¿½åŠ </button>
                        </div>
                        <div class="form-group">
                            <button class="btn btn-danger" onclick="deleteStore()">ğŸ—‘ï¸ ç¾åœ¨ã®åº—èˆ—ã‚’å‰Šé™¤</button>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">ãƒ‡ãƒ¼ã‚¿æ“ä½œ</h2>
                        </div>
                        <div class="form-group">
                            <button class="btn btn-secondary" onclick="exportData()">ğŸ’¾ å…¨ãƒ‡ãƒ¼ã‚¿ã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
                        </div>
                        <div class="form-group">
                            <label class="form-label">CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼ˆã‚¿ã‚¹ã‚¯ï¼‰</label>
                            <div class="import-zone" id="importZone" onclick="document.getElementById('csvFile').click()">
                                ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ— ã¾ãŸã¯ ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠ
                            </div>
                            <input type="file" id="csvFile" accept=".csv" style="display: none;">
                        </div>
                        <div class="form-group">
                            <button class="btn btn-danger" onclick="deleteAllData()">ğŸš¨ å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤</button>
                        </div>
                    </div>

                    <div class="card" id="userManagement" style="display: none;">
                        <div class="card-header">
                            <h2 class="card-title">ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†</h2>
                            <button class="btn btn-primary" onclick="openUserModal()">â• ãƒ¦ãƒ¼ã‚¶ãƒ¼è¿½åŠ </button>
                        </div>
                        <div id="userList">
                            </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="staffModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">ã‚¹ã‚¿ãƒƒãƒ•è¿½åŠ /ç·¨é›†</h2>
            </div>
            <form id="staffForm" onsubmit="addOrUpdateStaff(event)">
                <input type="hidden" id="staffId">
                <div class="form-group">
                    <label class="form-label">åå‰</label>
                    <input type="text" id="staffName" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">å½¹å‰²</label>
                    <select class="form-select" id="staffRole" required>
                        <option value="åº—é•·">åº—é•·</option>
                        <option value="ã‚¨ãƒªã‚¢ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼">ã‚¨ãƒªã‚¢ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼</option>
                        <option value="SV">SV</option>
                        <option value="ç¤¾å“¡">ç¤¾å“¡</option>
                        <option value="ã‚¢ãƒ«ãƒã‚¤ãƒˆ">ã‚¢ãƒ«ãƒã‚¤ãƒˆ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">é›»è©±ç•ªå·</label>
                    <input type="tel" id="staffPhone" class="form-input">
                </div>
                <div class="form-group">
                    <label class="form-label">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                    <input type="email" id="staffEmail" class="form-input">
                </div>
                <div class="form-group">
                    <label class="form-label">å…¥ç¤¾æ—¥</label>
                    <input type="date" id="staffJoinDate" class="form-input">
                </div>
                <div class="btn-group" style="margin-top: 16px;">
                    <button type="submit" class="btn btn-primary">è¿½åŠ </button>
                    <button type="button" class="btn btn-secondary" onclick="closeStaffModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                </div>
            </form>
        </div>
    </div>

    <div id="userModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">ãƒ¦ãƒ¼ã‚¶ãƒ¼è¿½åŠ </h2>
            </div>
            <form id="userForm" onsubmit="addUser(event)">
                <div class="form-group">
                    <label class="form-label">åå‰</label>
                    <input type="text" id="userName" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                    <input type="email" id="userEmail" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">åˆæœŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                    <input type="password" id="userPassword" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">æ¨©é™</label>
                    <select class="form-select" id="userRole">
                        <option value="admin">ç®¡ç†è€…ï¼ˆå…¨ç·¨é›†æ¨©é™ï¼‰</option>
                        <option value="editor">ç·¨é›†è€…ï¼ˆé€²æ—å¤‰æ›´ã®ã¿ï¼‰</option>
                    </select>
                </div>
                <div class="btn-group" style="margin-top: 16px;">
                    <button type="submit" class="btn btn-primary">è¿½åŠ </button>
                    <button type="button" class="btn btn-secondary" onclick="closeUserModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let stores = {};
        let currentStore = 'default';
        let editingTaskId = null;
        let currentMonth = new Date();
        let draggedTask = null;
        let resizingTask = null;
        let initialX = 0;
        let initialLeft = 0;
        let initialWidth = 0;
        let DAY_WIDTH = 30; 
        let TASK_COL_WIDTH = 240; // åˆæœŸå€¤
        const DELETE_PASSWORD = 'delete';
        const STORES_KEY = 'istyle_stores';
        const USERS_KEY = 'istyle_users';
        let users = [];
        let currentUser = null;
        
        // ====================================
        // 1. ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆâ†’å­ã€å­«ã‚¿ã‚¹ã‚¯ã®è¡¨ç¤º/éè¡¨ç¤º (å±•é–‹çŠ¶æ…‹ã®å¤‰æ•°)
        // ====================================
        let ganttExpandedState = JSON.parse(localStorage.getItem('ganttExpandedState')) || {}; // å±•é–‹çŠ¶æ…‹ã‚’ä¿å­˜ã™ã‚‹å¤‰æ•°

        // ãƒ‡ãƒ¼ã‚¿ã®åˆæœŸåŒ–ã¨ä¿å­˜
        function loadData() {
            const savedStores = localStorage.getItem(STORES_KEY);
            if (savedStores) {
                stores = JSON.parse(savedStores);
            } else {
                stores['default'] = {
                    name: 'ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆåº—èˆ—',
                    tasks: [
                        { id: 1, level: 1, parentName: null, name: "I-STYLE æ–°åº—ç«‹ã¡ä¸Šã’ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ", assignee: "ä½è—¤", memo: "å…¨ä½“çµ±æ‹¬", startDate: "2025-10-01", endDate: "2025-12-31", status: "é€²è¡Œä¸­" },
                        { id: 2, level: 2, parentName: "I-STYLE æ–°åº—ç«‹ã¡ä¸Šã’ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ", name: "ãƒ•ã‚§ãƒ¼ã‚º1: è¨ˆç”»ã¨ç‰©ä»¶", assignee: "ä½è—¤", memo: "åˆæœŸè¨ˆç”»ã®ç¢ºå®š", startDate: "2025-10-01", endDate: "2025-10-31", status: "å®Œäº†" },
                        { id: 3, level: 3, parentName: "ãƒ•ã‚§ãƒ¼ã‚º1: è¨ˆç”»ã¨ç‰©ä»¶", name: "å¸‚å ´èª¿æŸ»", assignee: "ç”°ä¸­", memo: "ç«¶åˆåº—ã®åˆ†æã‚’å«ã‚€", startDate: "2025-10-01", endDate: "2025-10-10", status: "å®Œäº†" },
                        { id: 4, level: 3, parentName: "ãƒ•ã‚§ãƒ¼ã‚º1: è¨ˆç”»ã¨ç‰©ä»¶", name: "ç‰©ä»¶å¥‘ç´„", assignee: "ä½è—¤", memo: "é‡è¦ã‚¿ã‚¹ã‚¯", startDate: "2025-10-11", endDate: "2025-10-31", status: "å®Œäº†" },
                        { id: 5, level: 2, parentName: "I-STYLE æ–°åº—ç«‹ã¡ä¸Šã’ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ", name: "ãƒ•ã‚§ãƒ¼ã‚º2: å†…è£…ã¨ã‚·ã‚¹ãƒ†ãƒ ", assignee: "é«˜æ©‹", memo: "å†…è£…æ¥­è€…ã¨ã‚·ã‚¹ãƒ†ãƒ ãƒ™ãƒ³ãƒ€ãƒ¼ã®é¸å®š", startDate: "2025-11-01", endDate: "2025-11-30", status: "é€²è¡Œä¸­" },
                        { id: 6, level: 3, parentName: "ãƒ•ã‚§ãƒ¼ã‚º2: å†…è£…ã¨ã‚·ã‚¹ãƒ†ãƒ ", name: "å†…è£…è¨­è¨ˆç¢ºå®š", assignee: "é«˜æ©‹", memo: "ãƒ‡ã‚¶ã‚¤ãƒ³æœ€çµ‚æ±ºå®š", startDate: "2025-11-01", endDate: "2025-11-15", status: "é€²è¡Œä¸­" },
                        { id: 7, level: 4, parentName: "å†…è£…è¨­è¨ˆç¢ºå®š", name: "å†…è£…å­ã‚¿ã‚¹ã‚¯ï¼‘", assignee: "é«˜æ©‹", memo: "å­ã‚¿ã‚¹ã‚¯ã®ãƒ†ã‚¹ãƒˆ", startDate: "2025-11-01", endDate: "2025-11-08", status: "é€²è¡Œä¸­" },
                        { id: 8, level: 4, parentName: "å†…è£…è¨­è¨ˆç¢ºå®š", name: "å†…è£…å­ã‚¿ã‚¹ã‚¯ï¼’", assignee: "é«˜æ©‹", memo: "å­ã‚¿ã‚¹ã‚¯ã®ãƒ†ã‚¹ãƒˆ", startDate: "2025-11-09", endDate: "2025-11-15", status: "æœªç€æ‰‹" },
                        { id: 9, level: 3, parentName: "ãƒ•ã‚§ãƒ¼ã‚º2: å†…è£…ã¨ã‚·ã‚¹ãƒ†ãƒ ", name: "POSã‚·ã‚¹ãƒ†ãƒ ç™ºæ³¨", assignee: "éˆ´æœ¨", memo: "åˆæœŸè¨­å®šä½œæ¥­ã‚‚å«ã‚€", startDate: "2025-11-16", endDate: "2025-11-30", status: "æœªç€æ‰‹" },
                        { id: 10, level: 2, parentName: "I-STYLE æ–°åº—ç«‹ã¡ä¸Šã’ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ", name: "ãƒ•ã‚§ãƒ¼ã‚º3: æ¡ç”¨ã¨ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°", assignee: "å±±æœ¬", memo: "ã‚ªãƒ¼ãƒ—ãƒ³ã«å‘ã‘ãŸäººå“¡ç¢ºä¿", startDate: "2025-12-01", endDate: "2025-12-31", status: "æœªç€æ‰‹" },
                        { id: 11, level: 3, parentName: "ãƒ•ã‚§ãƒ¼ã‚º3: æ¡ç”¨ã¨ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°", name: "æ±‚äººåºƒå‘Šé–‹å§‹", assignee: "å±±æœ¬", memo: "", startDate: "2025-12-01", endDate: "2025-12-15", status: "æœªç€æ‰‹" },
                    ],
                    staff: [
                        { id: 101, name: "ä½è—¤ å¤ªéƒ", role: "åº—é•·", phone: "090-1111-2222", email: "sato@istyle.com", joinDate: "2025-10-01" },
                        { id: 102, name: "ç”°ä¸­ æ¬¡éƒ", role: "ç¤¾å“¡", phone: "080-3333-4444", email: "tanaka@istyle.com", joinDate: "2025-10-15" },
                        { id: 103, name: "é«˜æ©‹ èŠ±å­", role: "SV", phone: "070-5555-6666", email: "takahashi@istyle.com", joinDate: "2025-09-01" },
                    ]
                };
            }

            const savedCurrentStore = localStorage.getItem('istyle_currentStore');
            if (savedCurrentStore && stores[savedCurrentStore]) {
                currentStore = savedCurrentStore;
            } else if (Object.keys(stores).length > 0) {
                currentStore = Object.keys(stores)[0];
            } else {
                currentStore = 'default';
            }
            
            const savedUsers = localStorage.getItem(USERS_KEY);
            if (savedUsers) {
                users = JSON.parse(savedUsers);
            } else {
                 users = [
                    { id: 1, name: 'ç®¡ç†è€…', email: 'admin@istyle.com', password: 'password', role: 'admin' },
                    { id: 2, name: 'ç·¨é›†è€…', email: 'editor@istyle.com', password: 'password', role: 'editor' },
                ];
            }
            
            const savedUser = localStorage.getItem('istyle_currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
            }
        }

        function saveData() {
            localStorage.setItem(STORES_KEY, JSON.stringify(stores));
            localStorage.setItem('istyle_currentStore', currentStore);
            localStorage.setItem(USERS_KEY, JSON.stringify(users));
        }

        function getCurrentStore() {
            return stores[currentStore];
        }

        // åº—èˆ—ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ã®åˆæœŸåŒ–
        function initializeStoreSelector() {
            const select = document.getElementById('storeSelect');
            select.innerHTML = ''; // ã‚¯ãƒªã‚¢
            Object.entries(stores).forEach(([id, store]) => {
                const option = document.createElement('option');
                option.value = id;
                option.textContent = store.name;
                select.appendChild(option);
            });
            select.value = currentStore;
        }

        // åº—èˆ—åˆ‡ã‚Šæ›¿ãˆ
        function switchStore() {
            const select = document.getElementById('storeSelect');
            currentStore = select.value;
            saveData();
            renderAll();
        }

        // åº—èˆ—è¿½åŠ 
        function addStore() {
            const nameInput = document.getElementById('newStoreName');
            const name = nameInput.value.trim();
            if (!name) {
                alert('åº—èˆ—åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            const storeId = 'store_' + Date.now();
            stores[storeId] = { name: name, tasks: [], staff: [] };
            currentStore = storeId;
            saveData();
            initializeStoreSelector();
            renderAll();
            nameInput.value = '';
            alert(`âœ… ${name}ã‚’è¿½åŠ ã—ã¾ã—ãŸï¼`);
        }

        // åº—èˆ—å‰Šé™¤ï¼ˆãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ä¿è­·ï¼‰
        function deleteStore() {
            if (!currentStore || currentStore === 'default') {
                alert('ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆåº—èˆ—ã¯å‰Šé™¤ã§ãã¾ã›ã‚“ã€‚');
                return;
            }
            const storeName = stores[currentStore].name;
            const password = prompt(`${storeName}ã‚’å‰Šé™¤ã—ã¾ã™ã€‚\nãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:`);
            if (password !== DELETE_PASSWORD) {
                if (password !== null) {
                    alert('âŒ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé–“é•ã£ã¦ã„ã¾ã™ã€‚');
                }
                return;
            }
            if (confirm(`æœ¬å½“ã«${storeName}ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚`)) {
                delete stores[currentStore];
                const remainingStores = Object.keys(stores);
                if (remainingStores.length === 0) {
                    stores['default'] = { name: 'ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆåº—èˆ—', tasks: [], staff: [] };
                    currentStore = 'default';
                } else {
                    currentStore = remainingStores[0];
                }
                saveData();
                initializeStoreSelector();
                renderAll();
                alert('âœ… åº—èˆ—ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚');
            }
        }

        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.nav-item').forEach(nav => {
                nav.classList.remove('active');
            });
            document.getElementById(tabName).classList.add('active');
            event.target.closest('.nav-item').classList.add('active');

            const titles = {
                dashboard: { title: 'ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰', desc: 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®é€²æ—ã‚’ä¸€ç›®ã§ç¢ºèª' },
                gantt: { title: 'ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆ', desc: 'ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’è¦–è¦šçš„ã«ç®¡ç†' },
                calendar: { title: 'ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼', desc: 'æœˆé–“ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã§ã‚¿ã‚¹ã‚¯ã‚’ç¢ºèª' },
                staff: { title: 'ã‚¹ã‚¿ãƒƒãƒ•', desc: 'ãƒãƒ¼ãƒ ãƒ¡ãƒ³ãƒãƒ¼ã‚’ç®¡ç†' },
                timeline: { title: 'ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³', desc: 'ã‚¿ã‚¹ã‚¯ã‚’æ™‚ç³»åˆ—ã§è¡¨ç¤º' },
                tasks: { title: 'ã‚¿ã‚¹ã‚¯ç®¡ç†', desc: 'éšå±¤æ§‹é€ ã§ã‚¿ã‚¹ã‚¯ã‚’ç®¡ç†' },
                settings: { title: 'è¨­å®š', desc: 'åº—èˆ—ã€ãƒ‡ãƒ¼ã‚¿ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç®¡ç†' }
            };

            const info = titles[tabName] || { title: '', desc: '' };
            document.getElementById('pageTitle').textContent = info.title;
            document.getElementById('pageDescription').textContent = info.desc;
            
            // ã‚¿ãƒ–ãŒåˆ‡ã‚Šæ›¿ã‚ã£ãŸã‚‰å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
            if (tabName === 'gantt') {
                renderGanttChart();
            } else if (tabName === 'calendar') {
                renderCalendar();
            } else if (tabName === 'timeline') {
                renderTimeline();
            }
        }

        // ã‚¿ã‚¹ã‚¯è¿½åŠ /æ›´æ–°
        function addOrUpdateTask(event) {
            event.preventDefault();
            
            if (currentUser.role !== 'admin' && currentUser.role !== 'editor') {
                alert('æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã‚¿ã‚¹ã‚¯ã®è¿½åŠ ãƒ»ç·¨é›†ã¯ç®¡ç†è€…/ç·¨é›†è€…ã®ã¿å¯èƒ½ã§ã™ã€‚');
                return;
            }

            const level = parseInt(document.getElementById('taskLevel').value);
            const parentName = document.getElementById('taskParent').value.trim() || null;
            const name = document.getElementById('taskName').value.trim();
            const assignee = document.getElementById('taskAssignee').value.trim();
            const memo = document.getElementById('taskMemo').value.trim();
            const startDate = document.getElementById('taskStart').value;
            const endDate = document.getElementById('taskEnd').value;
            const status = document.getElementById('taskStatus').value;

            if (new Date(startDate) > new Date(endDate)) {
                alert('âŒ çµ‚äº†æ—¥ã¯é–‹å§‹æ—¥ä»¥é™ã®æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            const store = getCurrentStore();
            const tasks = store.tasks;

            if (editingTaskId !== null) {
                // æ›´æ–°
                const task = tasks.find(t => t.id === editingTaskId);
                if (task) {
                    task.level = level;
                    task.parentName = parentName;
                    task.name = name;
                    task.assignee = assignee;
                    task.memo = memo;
                    task.startDate = startDate;
                    task.endDate = endDate;
                    task.status = status;
                    alert('âœ… ã‚¿ã‚¹ã‚¯ã‚’æ›´æ–°ã—ã¾ã—ãŸï¼');
                }
            } else {
                // æ–°è¦è¿½åŠ 
                const newId = tasks.length > 0 ? Math.max(...tasks.map(t => t.id)) + 1 : 1;
                const newTask = {
                    id: newId,
                    level,
                    parentName,
                    name,
                    assignee,
                    memo,
                    startDate,
                    endDate,
                    status
                };
                tasks.push(newTask);
                alert('âœ… ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ ã—ã¾ã—ãŸï¼');
            }

            saveData();
            document.querySelector('#tasks form').reset();
            cancelEdit(); // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
            renderAll();
        }

        // ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆæç”» (éšå±¤è¡¨ç¤º)
        function renderTaskList() {
            const container = document.getElementById('taskList');
            const store = getCurrentStore();
            
            if (store.tasks.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ“‹</div><div class="empty-state-text">ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“</div></div>';
                return;
            }

            // è¦ªã‚¿ã‚¹ã‚¯åã‹ã‚‰ã‚¿ã‚¹ã‚¯ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¸ã®ãƒãƒƒãƒ—ã‚’ä½œæˆ
            const taskMapByName = store.tasks.reduce((map, t) => {
                map[t.name] = t;
                return map;
            }, {});

            // ãƒ«ãƒ¼ãƒˆã‚¿ã‚¹ã‚¯ (parentNameãŒãªã„ã‚‚ã®) ã‚’æŠ½å‡º
            let rootTasks = store.tasks.filter(t => !t.parentName || !taskMapByName[t.parentName])
                .sort((a, b) => a.level - b.level); // ãƒ¬ãƒ™ãƒ«ã§ã‚½ãƒ¼ãƒˆ

            function getChildren(parentName) {
                return store.tasks.filter(t => t.parentName === parentName)
                    .sort((a, b) => a.level - b.level);
            }

            function getStatusClass(status) {
                if (status === 'å®Œäº†') return 'completed';
                if (status === 'é€²è¡Œä¸­') return 'in-progress';
                return 'pending';
            }

            function renderTask(task) {
                const children = getChildren(task.name);
                let html = `
                    <div class="task-item level-${task.level}">
                        <div class="task-header">
                            <div class="task-name">${task.name}</div>
                            <span class="task-status ${getStatusClass(task.status)}">${task.status}</span>
                        </div>
                        <div class="task-meta">
                            ${task.parentName ? `<span>ğŸ“‚ ${task.parentName}</span>` : ''}
                            ${task.assignee ? `<span class="task-assignee">${task.assignee}</span>` : ''}
                            <span>ğŸ“… ${task.startDate} ã€œ ${task.endDate}</span>
                        </div>
                        ${task.memo ? `<div class="task-memo">${task.memo}</div>` : ''}
                        <div class="task-actions">
                            <button class="btn-edit" onclick="editTask(${task.id})">âœï¸ ç·¨é›†</button>
                            <button class="btn-delete" onclick="deleteTask(${task.id})">ğŸ—‘ï¸ å‰Šé™¤</button>
                        </div>
                    </div>
                `;
                
                if (children.length > 0) {
                    html += '<div class="child-tasks">';
                    children.sort((a, b) => a.level - b.level).forEach(child => {
                        html += renderTask(child);
                    });
                    html += '</div>';
                }
                
                return html;
            }

            container.innerHTML = rootTasks.map(task => `
                <div class="task-group">
                    ${renderTask(task)}
                </div>
            `).join('');
        }

        // ã‚¿ã‚¹ã‚¯ç·¨é›†
        function editTask(id) {
            if (currentUser.role !== 'admin' && currentUser.role !== 'editor') {
                alert('æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã‚¿ã‚¹ã‚¯ã®ç·¨é›†ã¯ç®¡ç†è€…/ç·¨é›†è€…ã®ã¿å¯èƒ½ã§ã™ã€‚');
                return;
            }
            
            const store = getCurrentStore();
            const task = store.tasks.find(t => t.id === id);
            if (!task) return;

            editingTaskId = id;

            // ãƒ•ã‚©ãƒ¼ãƒ ã«å€¤ã‚’ã‚»ãƒƒãƒˆ
            document.getElementById('taskLevel').value = task.level;
            document.getElementById('taskParent').value = task.parentName;
            document.getElementById('taskName').value = task.name;
            document.getElementById('taskAssignee').value = task.assignee;
            document.getElementById('taskMemo').value = task.memo;
            document.getElementById('taskStart').value = task.startDate;
            document.getElementById('taskEnd').value = task.endDate;
            document.getElementById('taskStatus').value = task.status;

            // ã‚¿ã‚¹ã‚¯ã‚¿ãƒ–ã«åˆ‡ã‚Šæ›¿ãˆ
            const taskTab = document.querySelector('.nav-item[onclick*="tasks"]');
            if (taskTab) {
                taskTab.click();
            }

            // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
            const submitBtn = document.getElementById('taskSubmitBtn');
            const cancelBtn = document.getElementById('cancelEditBtn');
            submitBtn.textContent = 'âœï¸ ã‚¿ã‚¹ã‚¯ã‚’æ›´æ–°';
            submitBtn.className = 'btn btn-success';
            cancelBtn.style.display = 'block';

            // ãƒ•ã‚©ãƒ¼ãƒ ã¾ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
            setTimeout(() => {
                document.querySelector('form').scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 100);

            alert('ğŸ“ ã‚¿ã‚¹ã‚¯ã‚’ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã§èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚');
        }

        // ç·¨é›†ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        function cancelEdit() {
            editingTaskId = null;
            const submitBtn = document.getElementById('taskSubmitBtn');
            const cancelBtn = document.getElementById('cancelEditBtn');
            submitBtn.textContent = 'â• ã‚¿ã‚¹ã‚¯è¿½åŠ ';
            submitBtn.className = 'btn btn-primary';
            cancelBtn.style.display = 'none';
            document.querySelector('#tasks form').reset();
        }

        // ã‚¿ã‚¹ã‚¯å‰Šé™¤ï¼ˆãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ä¿è­·ï¼‰
        function deleteTask(id) {
            if (currentUser.role !== 'admin') {
                alert('æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã‚¿ã‚¹ã‚¯ã®å‰Šé™¤ã¯ç®¡ç†è€…ã®ã¿å¯èƒ½ã§ã™ã€‚');
                return;
            }
            
            const password = prompt('ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤ã—ã¾ã™ã€‚\nãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');
            if (password !== DELETE_PASSWORD) {
                if (password !== null) {
                    alert('âŒ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé–“é•ã£ã¦ã„ã¾ã™ã€‚');
                }
                return;
            }
            if (confirm('ã“ã®ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                const store = getCurrentStore();
                store.tasks = store.tasks.filter(t => t.id !== id);
                saveData();
                renderAll();
                alert('âœ… ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚');
            }
        }

        // ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆæç”»ï¼ˆ2025å¹´10æœˆã€œ2030å¹´12æœˆã€æ—¥åˆ¥ï¼‰
        function renderGanttChart() {
            const container = document.getElementById('ganttChart');
            const store = getCurrentStore();
            if (store.tasks.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ“…</div><div class="empty-state-text">ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“</div></div>';
                return;
            }

            // ã‚¿ã‚¹ã‚¯ã‚’éšå±¤æ§‹é€ ã«å¤‰æ›ã—ã€ãƒ•ãƒ©ãƒƒãƒˆãªãƒªã‚¹ãƒˆã¨ã—ã¦æç”»é †åºã‚’æ±ºå®šã™ã‚‹
            const taskMap = store.tasks.reduce((map, t) => { map[t.id] = {...t}; return map; }, {});
            // è¦ªã‚¿ã‚¹ã‚¯åã‹ã‚‰ã‚¿ã‚¹ã‚¯ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å¼•ã‘ã‚‹ãƒãƒƒãƒ— (éšå±¤æ§‹ç¯‰ç”¨)
            const taskMapByName = store.tasks.reduce((map, t) => { map[t.name] = t; return map; }, {});
            
            // ãƒ«ãƒ¼ãƒˆã‚¿ã‚¹ã‚¯ã‚’æŠ½å‡ºï¼ˆè¦ªã‚¿ã‚¹ã‚¯åãŒãªã„ã€ã¾ãŸã¯è¦ªã‚¿ã‚¹ã‚¯åã‚’æŒã¤ã‚¿ã‚¹ã‚¯ãŒå­˜åœ¨ã—ãªã„ã‚‚ã®ï¼‰
            const rootTasks = store.tasks.filter(t => !t.parentName || !taskMapByName[t.parentName]).sort((a, b) => a.level - b.level);

            function buildHierarchy(task) {
                if (!task.id) return null; // IDãŒãªã„ã‚¿ã‚¹ã‚¯ã¯é™¤å¤–
                const children = store.tasks.filter(t => t.parentName === task.name).sort((a, b) => a.level - b.level);
                task.children = children.map(child => buildHierarchy(child)).filter(c => c !== null);
                return task;
            }
            
            const hierarchicalTasks = rootTasks.map(task => buildHierarchy(task)).filter(t => t !== null);
            
            let flatTaskList = [];
            function flattenTasks(task) {
                flatTaskList.push(task);
                if (task.children) {
                    task.children.forEach(flattenTasks);
                }
            }
            hierarchicalTasks.forEach(flattenTasks);

            // å›ºå®šæœŸé–“: 2025å¹´10æœˆ1æ—¥ ã€œ 2030å¹´12æœˆ31æ—¥
            const minDate = new Date(2025, 9, 1); // 10æœˆã¯9ï¼ˆ0å§‹ã¾ã‚Šï¼‰
            const maxDate = new Date(2030, 11, 31); // 12æœˆã¯11
            
            // å…¨æ—¥ä»˜ã‚’ç”Ÿæˆ
            const allDays = [];
            let currentDate = new Date(minDate);
            while (currentDate <= maxDate) {
                allDays.push(new Date(currentDate));
                currentDate.setDate(currentDate.getDate() + 1);
            }
            const totalDays = allDays.length;
            const today = new Date();
            const todayIndex = allDays.findIndex(d => d.toDateString() === today.toDateString());

            // å¹´ãƒ˜ãƒƒãƒ€ãƒ¼ç”Ÿæˆ
            const years = {};
            allDays.forEach(day => {
                const year = day.getFullYear();
                if (!years[year]) years[year] = 0;
                years[year]++;
            });

            // æœˆãƒ˜ãƒƒãƒ€ãƒ¼ç”Ÿæˆ
            const months = {};
            allDays.forEach(day => {
                const monthYear = `${day.getFullYear()}-${day.getMonth()}`;
                if (!months[monthYear]) months[monthYear] = 0;
                months[monthYear]++;
            });

            const yearHeaderHtml = Object.keys(years).map(year => 
                `<div class="gantt-year-block" style="width: ${years[year] * DAY_WIDTH}px;">${year}å¹´</div>`
            ).join('');

            const monthHeaderHtml = Object.keys(months).map(monthYear => {
                const monthName = new Date(monthYear.split('-')[0], monthYear.split('-')[1]).toLocaleDateString('ja-JP', { month: 'short' });
                return `<div class="gantt-month-block" style="width: ${months[monthYear] * DAY_WIDTH}px;">${monthName}</div>`;
            }).join('');

            const dayHeaderHtml = allDays.map(day => {
                const isWeekend = day.getDay() === 0 || day.getDay() === 6;
                const isToday = day.toDateString() === today.toDateString();
                return `<div class="gantt-day-cell ${isWeekend ? 'weekend' : ''} ${isToday ? 'today' : ''}" style="width: ${DAY_WIDTH}px;">${day.getDate()}</div>`;
            }).join('');

            // ã‚¿ã‚¹ã‚¯è¡Œã®æç”»
            const taskRowsHtml = flatTaskList.map(task => {
                const start = new Date(task.startDate);
                const end = new Date(task.endDate);
                const startIndex = allDays.findIndex(d => d.toDateString() === start.toDateString());
                let endIndex = allDays.findIndex(d => d.toDateString() === end.toDateString());
                
                let actualStartIndex = startIndex === -1 ? 0 : startIndex;
                let actualEndIndex = endIndex === -1 ? allDays.length - 1 : endIndex;
                
                if (startIndex === -1 && endIndex === -1) {
                    actualStartIndex = 0;
                    actualEndIndex = -1; // è¡¨ç¤ºã—ãªã„
                } else if (startIndex === -1 && endIndex !== -1) {
                    actualStartIndex = 0;
                } else if (startIndex !== -1 && endIndex === -1) {
                    actualEndIndex = allDays.length - 1;
                }

                const leftPos = actualStartIndex * DAY_WIDTH;
                const width = (actualEndIndex - actualStartIndex + 1) * DAY_WIDTH;
                const duration = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
                
                // éšå±¤ã‚¿ã‚¹ã‚¯ã®ãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³ã‚’æº–å‚™
                const hasChildren = task.children && task.children.length > 0;
                const isExpanded = ganttExpandedState[task.id] === undefined ? true : ganttExpandedState[task.id]; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯å±•é–‹
                
                // è¦ªã‚¿ã‚¹ã‚¯ãŒé–‰ã˜ã¦ã„ã‚‹å ´åˆã¯ã€è¡Œã‚’éè¡¨ç¤ºã«ã™ã‚‹ãŸã‚ã« 'collapsed' ã‚¯ãƒ©ã‚¹ã‚’é©ç”¨ã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯
                let rowClass = `level-${task.level}`;
                if (hasChildren && isExpanded) {
                    rowClass += ' expanded';
                }

                let isChildCollapsed = false;
                if (task.parentName) {
                    let currentParentName = task.parentName;
                    while (currentParentName) {
                        const parentTask = flatTaskList.find(t => t.name === currentParentName);
                        if (parentTask) {
                            // è¦ªã®å±•é–‹çŠ¶æ…‹ã‚’ç¢ºèª (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯å±•é–‹ true)
                            const parentExpanded = ganttExpandedState[parentTask.id] === undefined ? true : ganttExpandedState[parentTask.id];
                            if (!parentExpanded) {
                                isChildCollapsed = true;
                                break;
                            }
                            currentParentName = parentTask.parentName; // ã•ã‚‰ã«ç¥–å…ˆã¸
                        } else {
                            break;
                        }
                    }
                }
                
                if (isChildCollapsed) {
                    rowClass += ' collapsed'; // ç¥–å…ˆãŒé–‰ã˜ã¦ã„ã‚‹ã‚¿ã‚¹ã‚¯ã‚’éè¡¨ç¤º
                }

                const toggleButton = hasChildren 
                    ? `<span class="gantt-toggle-btn" onclick="toggleGanttTask(${task.id})">${isExpanded ? 'â–¼' : 'â–¶ï¸'}</span>`
                    : '';

                if (width < 0) width = 0; // çµ‚äº†æ—¥ãŒé–‹å§‹æ—¥ã‚ˆã‚Šå‰ã®å ´åˆã¯éè¡¨ç¤º
                
                return `
                    <div class="gantt-row ${rowClass}" id="gantt-row-${task.id}">
                        <div class="gantt-task-info" style="width: ${TASK_COL_WIDTH}px;">
                            <div style="width: 100%; overflow: hidden; padding: 4px; display: flex; align-items: center;">
                                ${toggleButton}
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; margin-bottom: 2px; font-size: ${Math.max(11, Math.min(14, TASK_COL_WIDTH / 15))}px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; line-height: 1.2;">${task.name}</div>
                                    <div style="font-size: ${Math.max(9, Math.min(11, TASK_COL_WIDTH / 20))}px; color: var(--text-secondary); line-height: 1.2;">
                                        ${task.assignee ? `ğŸ‘¤ ${task.assignee} | ` : ''}${duration}æ—¥é–“ 
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="gantt-timeline-row">
                            <div class="gantt-timeline-bg" style="width: ${totalDays * DAY_WIDTH}px;">
                                ${allDays.map((d, i) => {
                                    const isWeekend = d.getDay() === 0 || d.getDay() === 6;
                                    return `<div class="gantt-day-bg ${isWeekend ? 'weekend' : ''}" style="width: ${DAY_WIDTH}px;"></div>`;
                                }).join('')}
                            </div>
                            ${actualEndIndex >= actualStartIndex && width > 0 ? `
                                <div class="gantt-bar" 
                                    data-task-id="${task.id}"
                                    style="left: ${leftPos}px; width: ${width}px; top: 0; height: 100%; background: ${task.status === 'å®Œäº†' ? 'var(--success)' : task.status === 'é€²è¡Œä¸­' ? 'var(--warning)' : 'var(--primary)'};"
                                    onmousedown="startGanttDrag(event, ${task.id})">
                                    <div class="gantt-bar-resize-left" onmousedown="startGanttResize(event, ${task.id}, 'left')"></div>
                                    ${task.name}
                                    <div class="gantt-bar-resize-right" onmousedown="startGanttResize(event, ${task.id}, 'right')"></div>
                                </div>
                            ` : ''}
                            
                            ${todayIndex >= 0 ? `
                                <div class="gantt-today-line" style="left: ${todayIndex * DAY_WIDTH + (DAY_WIDTH / 2)}px;"></div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');

            // æœ€çµ‚çš„ãªHTMLæ§‹é€ ã®æ§‹ç¯‰
            container.innerHTML = `
                <div class="gantt-scroll-wrapper" id="ganttScrollWrapper">
                    <div class="gantt-header-fixed" style="width: ${TASK_COL_WIDTH + totalDays * DAY_WIDTH}px;">
                        <div class="gantt-timeline-wrapper">
                            <div class="gantt-task-names" style="width: ${TASK_COL_WIDTH}px;">
                                <div style="padding: 10px; font-weight: 700; font-size: 16px; text-align: center;">ã‚¿ã‚¹ã‚¯å</div>
                            </div>
                            <div class="gantt-timeline-container">
                                <div class="gantt-year-header">${yearHeaderHtml}</div>
                                <div class="gantt-month-header">${monthHeaderHtml}</div>
                                <div class="gantt-day-header">${dayHeaderHtml}</div>
                            </div>
                        </div>
                    </div>
                    <div class="gantt-body" style="width: ${TASK_COL_WIDTH + totalDays * DAY_WIDTH}px;">
                        ${taskRowsHtml}
                    </div>
                </div>
                <div class="card-header" style="margin-top: 16px;">
                    <div class="btn-group">
                        <button class="btn btn-secondary" onclick="zoomOut()">ã‚ºãƒ¼ãƒ ã‚¢ã‚¦ãƒˆ (-)</button>
                        <input type="text" id="zoomInput" style="width: 60px; text-align: center; border: 1px solid var(--border); border-radius: 8px; padding: 4px;" onchange="setZoomByInput(this.value)">
                        <button class="btn btn-secondary" onclick="zoomIn()">ã‚ºãƒ¼ãƒ ã‚¤ãƒ³ (+)</button>
                        <button class="btn btn-secondary" onclick="resetZoom()">ãƒªã‚»ãƒƒãƒˆ</button>
                    </div>
                    <button class="btn btn-secondary" onclick="printGantt()">ğŸ–¨ï¸ å°åˆ·</button>
                </div>
            `;

            updateZoomDisplay();

            // Today Lineã‚’ä¸­å¤®ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
            if (todayIndex >= 0) {
                document.getElementById('ganttScrollWrapper').scrollLeft = todayIndex * DAY_WIDTH - (container.clientWidth / 2) + (TASK_COL_WIDTH / 2);
            }
        }
        
        // ====================================
        // 1. ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆâ†’å­ã€å­«ã‚¿ã‚¹ã‚¯ã®è¡¨ç¤º/éè¡¨ç¤º (ãƒˆã‚°ãƒ«æ©Ÿèƒ½)
        // ====================================
        function toggleGanttTask(taskId) {
            const row = document.getElementById(`gantt-row-${taskId}`);
            if (!row) return;

            // çŠ¶æ…‹ã‚’ãƒˆã‚°ãƒ«
            const isExpanded = row.classList.contains('expanded');
            
            // ãƒˆã‚°ãƒ«å¾Œã®æ–°ã—ã„çŠ¶æ…‹
            if (isExpanded) {
                row.classList.remove('expanded');
                ganttExpandedState[taskId] = false;
            } else {
                row.classList.add('expanded');
                ganttExpandedState[taskId] = true;
            }
            
            // å­å­«ã‚¿ã‚¹ã‚¯ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹
            const store = getCurrentStore();
            const taskMap = store.tasks.reduce((map, t) => { map[t.id] = t; return map; }, {});

            function getDescendantIds(parentId) {
                let descendants = [];
                // taskMapã‹ã‚‰è¦ªIDã®ã‚¿ã‚¹ã‚¯åã‚’å–å¾—
                const parentTaskName = taskMap[parentId] ? taskMap[parentId].name : null;
                if (!parentTaskName) return descendants;
                
                // å­ã‚¿ã‚¹ã‚¯ã‚’æ¤œç´¢
                const children = store.tasks.filter(t => t.parentName === parentTaskName);

                for (const child of children) {
                    descendants.push(child.id);
                    descendants = descendants.concat(getDescendantIds(child.id));
                }
                return descendants;
            }
            
            const descendants = getDescendantIds(taskId);

            descendants.forEach(descendantId => {
                const descRow = document.getElementById(`gantt-row-${descendantId}`);
                if (descRow) {
                    if (isExpanded) {
                        // è¦ªãŒé–‰ã˜ãŸã‚‰ã€å­å­«ã¯ã™ã¹ã¦éè¡¨ç¤º
                        descRow.classList.add('collapsed');
                    } else {
                        // è¦ªãŒé–‹ã„ãŸã‚‰ã€ç¥–å…ˆã‚’é¡ã‚Šã€ä¸€ã¤ã§ã‚‚é–‰ã˜ã¦ã„ãªã‘ã‚Œã°è¡¨ç¤º
                        const descendantTask = taskMap[descendantId];
                        let shouldBeVisible = true;
                        
                        let currentParentName = descendantTask.parentName;
                        while (currentParentName) {
                            const parentTask = store.tasks.find(t => t.name === currentParentName);
                            if (parentTask) {
                                // è¦ªã®å±•é–‹çŠ¶æ…‹ã‚’ç¢ºèª (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯å±•é–‹ true)
                                const parentExpanded = ganttExpandedState[parentTask.id] === undefined ? true : ganttExpandedState[parentTask.id];
                                if (!parentExpanded) {
                                    shouldBeVisible = false;
                                    break;
                                }
                                currentParentName = parentTask.parentName; // ã•ã‚‰ã«ç¥–å…ˆã¸
                            } else {
                                break;
                            }
                        }
                        
                        if (shouldBeVisible) {
                            descRow.classList.remove('collapsed');
                        }
                    }
                }
            });

            // å±•é–‹çŠ¶æ…‹ã‚’ä¿å­˜
            localStorage.setItem('ganttExpandedState', JSON.stringify(ganttExpandedState));
        }

        // ã‚¬ãƒ³ãƒˆãƒãƒ¼ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹
        function startGanttDrag(e, id) {
            if (currentUser.role !== 'admin' && currentUser.role !== 'editor') {
                alert('æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã‚¬ãƒ³ãƒˆãƒãƒ¼ã®æ“ä½œã¯ç®¡ç†è€…/ç·¨é›†è€…ã®ã¿å¯èƒ½ã§ã™ã€‚');
                return;
            }
            
            e.preventDefault();
            draggedTask = { id: id, startX: e.clientX };
            const bar = document.querySelector(`[data-task-id="${id}"]`);
            bar.classList.add('dragging');
            document.addEventListener('mousemove', handleGanttDrag);
            document.addEventListener('mouseup', endGanttDrag);
        }

        // ã‚¬ãƒ³ãƒˆãƒãƒ¼ãƒ‰ãƒ©ãƒƒã‚°ä¸­
        function handleGanttDrag(e) {
            if (!draggedTask) return;
            const bar = document.querySelector(`[data-task-id="${draggedTask.id}"]`);
            if (!bar) return;

            const deltaX = e.clientX - draggedTask.startX;
            const daysDelta = Math.round(deltaX / DAY_WIDTH);
            if (daysDelta === 0) return;

            const currentLeft = parseInt(bar.style.left) || 0;
            const newLeft = currentLeft + (daysDelta * DAY_WIDTH);

            if (newLeft >= 0) {
                bar.style.left = newLeft + 'px';
                draggedTask.startX = e.clientX; 
            }
        }

        // ã‚¬ãƒ³ãƒˆãƒãƒ¼ãƒ‰ãƒ©ãƒƒã‚°çµ‚äº†
        function endGanttDrag(e) {
            if (!draggedTask) return;
            const bar = document.querySelector(`[data-task-id="${draggedTask.id}"]`);
            if (bar) {
                bar.classList.remove('dragging');
                const leftPos = parseInt(bar.style.left) || 0;
                const dayOffset = Math.round(leftPos / DAY_WIDTH);
                
                const minDate = new Date(2025, 9, 1);
                const newStartDate = new Date(minDate);
                newStartDate.setDate(newStartDate.getDate() + dayOffset);

                const store = getCurrentStore();
                const task = store.tasks.find(t => t.id === draggedTask.id);
                
                if (task) {
                    const duration = Math.ceil((new Date(task.endDate) - new Date(task.startDate)) / (1000 * 60 * 60 * 24));
                    
                    const newEndDate = new Date(newStartDate);
                    newEndDate.setDate(newEndDate.getDate() + duration);

                    task.startDate = newStartDate.toISOString().split('T')[0];
                    task.endDate = newEndDate.toISOString().split('T')[0];
                    saveData();

                    // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã¨é€£å‹•ã—ã¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
                    const scrollWrapper = document.getElementById('ganttScrollWrapper');
                    if(scrollWrapper) {
                        scrollWrapper.scrollLeft = leftPos - 300;
                    }

                    confetti({
                        particleCount: 50,
                        spread: 50,
                        origin: { x: e.clientX / window.innerWidth, y: e.clientY / window.innerHeight }
                    });
                    
                    renderAll(); // å…¨ä½“ã‚’å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã—ã¦åæ˜ 
                }
            }
            draggedTask = null;
            document.removeEventListener('mousemove', handleGanttDrag);
            document.removeEventListener('mouseup', endGanttDrag);
        }

        // ã‚¬ãƒ³ãƒˆãƒãƒ¼ãƒªã‚µã‚¤ã‚ºé–‹å§‹
        function startGanttResize(e, id, side) {
            if (currentUser.role !== 'admin' && currentUser.role !== 'editor') {
                alert('æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã‚¬ãƒ³ãƒˆãƒãƒ¼ã®æ“ä½œã¯ç®¡ç†è€…/ç·¨é›†è€…ã®ã¿å¯èƒ½ã§ã™ã€‚');
                return;
            }
            
            e.preventDefault();
            e.stopPropagation(); // ãƒ‰ãƒ©ãƒƒã‚°ã¨ç«¶åˆã—ãªã„ã‚ˆã†ã«

            const bar = document.querySelector(`[data-task-id="${id}"]`);
            if (!bar) return;

            resizingTask = {
                id: id,
                side: side,
                startX: e.clientX,
                initialLeft: parseInt(bar.style.left) || 0,
                initialWidth: parseInt(bar.style.width) || 0,
                initialTask: getCurrentStore().tasks.find(t => t.id === id) 
            };
            
            bar.classList.add('dragging');
            document.addEventListener('mousemove', handleGanttResize);
            document.addEventListener('mouseup', endGanttResize);
        }

        // ã‚¬ãƒ³ãƒˆãƒãƒ¼ãƒªã‚µã‚¤ã‚ºä¸­
        function handleGanttResize(e) {
            if (!resizingTask) return;
            const bar = document.querySelector(`[data-task-id="${resizingTask.id}"]`);
            if (!bar) return;

            const deltaX = e.clientX - resizingTask.startX;

            if (resizingTask.side === 'left') {
                const newLeft = resizingTask.initialLeft + deltaX;
                const newWidth = resizingTask.initialWidth - deltaX;
                if (newWidth >= DAY_WIDTH) {
                    bar.style.left = newLeft + 'px';
                    bar.style.width = newWidth + 'px';
                }
            } else if (resizingTask.side === 'right') {
                const newWidth = resizingTask.initialWidth + deltaX;
                if (newWidth >= DAY_WIDTH) {
                    bar.style.width = newWidth + 'px';
                }
            }
        }

        // ã‚¬ãƒ³ãƒˆãƒãƒ¼ãƒªã‚µã‚¤ã‚ºçµ‚äº†
        function endGanttResize(e) {
            if (!resizingTask) return;
            const bar = document.querySelector(`[data-task-id="${resizingTask.id}"]`);
            if (bar) {
                bar.classList.remove('dragging');
                
                const minDate = new Date(2025, 9, 1);
                const currentLeft = parseInt(bar.style.left) || 0;
                const currentWidth = parseInt(bar.style.width) || 0;

                const startDayOffset = Math.round(currentLeft / DAY_WIDTH);
                const duration = Math.max(1, Math.round(currentWidth / DAY_WIDTH)); 

                const newStartDate = new Date(minDate);
                newStartDate.setDate(newStartDate.getDate() + startDayOffset);
                
                const newEndDate = new Date(newStartDate);
                newEndDate.setDate(newEndDate.getDate() + duration - 1);

                const store = getCurrentStore();
                const task = store.tasks.find(t => t.id === resizingTask.id);
                
                if (task) {
                    task.startDate = newStartDate.toISOString().split('T')[0];
                    task.endDate = newEndDate.toISOString().split('T')[0];
                    saveData();
                    renderAll(); // å…¨ä½“ã‚’å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã—ã¦åæ˜ 
                }
            }

            resizingTask = null;
            document.removeEventListener('mousemove', handleGanttResize);
            document.removeEventListener('mouseup', endGanttResize);
        }

        // ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆå°åˆ·
        function printGantt() {
            // å°åˆ·å‰ã«ã‚ºãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
            const originalDayWidth = DAY_WIDTH;
            const originalTaskColWidth = TASK_COL_WIDTH;
            resetZoom(); 
            
            // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’ä¸€æ™‚çš„ã«åœæ­¢
            const scrollWrapper = document.getElementById('ganttScrollWrapper');
            const originalOverflow = scrollWrapper.style.overflow;
            scrollWrapper.style.overflow = 'visible';

            window.print();
            
            // å…ƒã®çŠ¶æ…‹ã«æˆ»ã™
            DAY_WIDTH = originalDayWidth;
            TASK_COL_WIDTH = originalTaskColWidth;
            renderGanttChart(); // å†æç”»ã—ã¦ã‚ºãƒ¼ãƒ ãƒ¬ãƒ™ãƒ«ã‚’æˆ»ã™
            scrollWrapper.style.overflow = originalOverflow;
        }

        // ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆ ã‚ºãƒ¼ãƒ æ©Ÿèƒ½
        function zoomIn() {
            if (DAY_WIDTH < 60) {
                DAY_WIDTH += 3;
                TASK_COL_WIDTH = Math.max(120, Math.round(DAY_WIDTH * 8)); // æœ€å°120pxç¢ºä¿
                renderGanttChart();
                updateZoomDisplay();
            }
        }

        function zoomOut() {
            if (DAY_WIDTH > 2) {
                DAY_WIDTH -= 3;
                TASK_COL_WIDTH = Math.max(120, Math.round(DAY_WIDTH * 8)); // æœ€å°120pxç¢ºä¿
                renderGanttChart();
                updateZoomDisplay();
            }
        }

        function resetZoom() {
            DAY_WIDTH = 30;
            TASK_COL_WIDTH = 240;
            renderGanttChart();
            updateZoomDisplay();
        }

        function updateZoomDisplay() {
            const percentage = Math.round((DAY_WIDTH / 30) * 100);
            const input = document.getElementById('zoomInput');
            if (input) {
                input.value = percentage;
            }
        }

        function setZoomByInput(value) {
            let percentage = parseInt(value) || 100;
            percentage = Math.max(7, Math.min(200, percentage));
            DAY_WIDTH = Math.round((percentage / 100) * 30);
            DAY_WIDTH = Math.max(2, Math.min(60, DAY_WIDTH));
            TASK_COL_WIDTH = Math.max(120, Math.round(DAY_WIDTH * 8));
            renderGanttChart();
            updateZoomDisplay();
        }

        // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æç”»
        function renderCalendar() {
            const container = document.getElementById('calendarGrid');
            const title = document.getElementById('calendarTitle');
            const store = getCurrentStore();
            const today = new Date();

            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth(); // 0-11
            const date = currentMonth.getDate();

            title.textContent = `${year}å¹´ ${month + 1}æœˆ`;

            // ãã®æœˆã®æœ€åˆã®æ—¥ã®æ›œæ—¥ (0=æ—¥, 6=åœŸ)
            const firstDayOfMonth = new Date(year, month, 1);
            const startDay = firstDayOfMonth.getDay(); 
            
            // ãã®æœˆã®æ—¥æ•°
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            let html = '';

            // å‰æœˆã®æ—¥ä»˜ (éš™é–“åŸ‹ã‚)
            const daysInPreviousMonth = new Date(year, month, 0).getDate();
            for (let i = startDay; i > 0; i--) {
                const day = daysInPreviousMonth - i + 1;
                html += `<div class="calendar-day other-month"><div class="calendar-day-number">${day}</div></div>`;
            }

            // ä»Šæœˆã®æ—¥ä»˜
            for (let day = 1; day <= daysInMonth; day++) {
                const currentDate = new Date(year, month, day);
                const isToday = currentDate.toDateString() === today.toDateString();
                
                const dayTasks = store.tasks.filter(task => {
                    const start = new Date(task.startDate);
                    const end = new Date(task.endDate);
                    // æ™‚åˆ»æƒ…å ±ã‚’ã‚¯ãƒªã‚¢ã—ã¦æ¯”è¼ƒ
                    const date = new Date(currentDate.getFullYear(), currentDate.getMonth(), currentDate.getDate());
                    const taskStart = new Date(start.getFullYear(), start.getMonth(), start.getDate());
                    const taskEnd = new Date(end.getFullYear(), end.getMonth(), end.getDate());

                    return date >= taskStart && date <= taskEnd;
                }).sort((a, b) => new Date(a.startDate) - new Date(b.startDate));
                
                html += `
                    <div class="calendar-day ${isToday ? 'today' : ''}">
                        <div class="calendar-day-number">${day}</div>
                        ${dayTasks.slice(0, 3).map(task => `<div class="calendar-task">${task.name}</div>`
                        ).join('')}
                        ${dayTasks.length > 3 ? `<div style="font-size: 11px; color: var(--text-secondary); padding: 2px;">+${dayTasks.length - 3}ä»¶</div>` : ''}
                    </div>
                `;
            }

            // æ¬¡æœˆã®æ—¥ä»˜ (éš™é–“åŸ‹ã‚)
            const totalCells = startDay + daysInMonth;
            const remainingDays = 42 - totalCells; // 6é€±é–“è¡¨ç¤ºã§42ãƒã‚¹

            for (let day = 1; day <= remainingDays; day++) {
                html += `<div class="calendar-day other-month"><div class="calendar-day-number">${day}</div></div>`;
            }

            container.innerHTML = html;
        }

        function previousMonth() {
            currentMonth.setMonth(currentMonth.getMonth() - 1);
            renderCalendar();
        }

        function nextMonth() {
            currentMonth.setMonth(currentMonth.getMonth() + 1);
            renderCalendar();
        }

        function todayMonth() {
            currentMonth = new Date();
            renderCalendar();
        }

        // ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³æç”»
        function renderTimeline() {
            const container = document.getElementById('timelineView');
            const store = getCurrentStore();
            if (store.tasks.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">â±ï¸</div><div class="empty-state-text">ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“</div></div>';
                return;
            }

            const sortedTasks = [...store.tasks].sort((a, b) => new Date(a.startDate) - new Date(b.startDate));

            const getStatusClass = (status) => {
                if (status === 'å®Œäº†') return 'completed';
                if (status === 'é€²è¡Œä¸­') return 'in-progress';
                return 'pending';
            };

            container.innerHTML = sortedTasks.map(task => {
                return `
                    <div class="task-item level-${task.level}">
                        <div class="task-header">
                            <div class="task-name">${task.name}</div>
                            <span class="task-status ${getStatusClass(task.status)}">${task.status}</span>
                        </div>
                        <div class="task-meta">
                            ${task.parentName ? `<span>ğŸ“‚ ${task.parentName}</span>` : ''}
                            ${task.assignee ? `<span class="task-assignee">${task.assignee}</span>` : ''}
                            <span>ğŸ“… ${task.startDate} ã€œ ${task.endDate}</span>
                        </div>
                        ${task.memo ? `<div class="task-memo">${task.memo}</div>` : ''}
                        <div class="task-actions">
                            <button class="btn-edit" onclick="editTask(${task.id})">âœï¸ ç·¨é›†</button>
                            <button class="btn-delete" onclick="deleteTask(${task.id})">ğŸ—‘ï¸ å‰Šé™¤</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ã‚¹ã‚¿ãƒƒãƒ•ãƒªã‚¹ãƒˆæç”»
        function renderStaffList() {
            const container = document.getElementById('staffList');
            const store = getCurrentStore();
            if (store.staff.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ‘¥</div><div class="empty-state-text">ã‚¹ã‚¿ãƒƒãƒ•ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</div></div>';
                return;
            }

            container.innerHTML = store.staff.map(staff => `
                <div class="staff-card">
                    <div class="staff-name">${staff.name}</div>
                    <div class="staff-role">${staff.role}</div>
                    <div class="staff-info">â˜ï¸ ${staff.phone || 'æœªç™»éŒ²'}</div>
                    <div class="staff-info">ğŸ“§ ${staff.email || 'æœªç™»éŒ²'}</div>
                    <div class="staff-info">ğŸ—“ï¸ å…¥ç¤¾: ${staff.joinDate || 'æœªç™»éŒ²'}</div>
                    <div class="task-actions" style="margin-top: 16px;">
                        <button class="btn-edit" onclick="editStaff(${staff.id})">âœï¸ ç·¨é›†</button>
                        <button class="btn-delete" onclick="deleteStaff(${staff.id})">ğŸ—‘ï¸ å‰Šé™¤</button>
                    </div>
                </div>
            `).join('');
        }

        // ã‚¹ã‚¿ãƒƒãƒ•è¿½åŠ /æ›´æ–°ãƒ¢ãƒ¼ãƒ€ãƒ«
        function openStaffModal() {
            if (currentUser.role !== 'admin') {
                alert('æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã‚¹ã‚¿ãƒƒãƒ•ã®è¿½åŠ ãƒ»ç·¨é›†ã¯ç®¡ç†è€…ã®ã¿å¯èƒ½ã§ã™ã€‚');
                return;
            }
            document.getElementById('staffId').value = '';
            document.getElementById('staffForm').reset();
            document.getElementById('staffModal').classList.add('active');
        }

        function closeStaffModal() {
            document.getElementById('staffModal').classList.remove('active');
        }

        function addOrUpdateStaff(event) {
            event.preventDefault();

            const id = document.getElementById('staffId').value;
            const name = document.getElementById('staffName').value.trim();
            const role = document.getElementById('staffRole').value;
            const phone = document.getElementById('staffPhone').value.trim();
            const email = document.getElementById('staffEmail').value.trim();
            const joinDate = document.getElementById('staffJoinDate').value;
            
            const store = getCurrentStore();

            if (id) {
                // æ›´æ–°
                const staff = store.staff.find(s => s.id == id);
                if (staff) {
                    staff.name = name;
                    staff.role = role;
                    staff.phone = phone;
                    staff.email = email;
                    staff.joinDate = joinDate;
                    alert('âœ… ã‚¹ã‚¿ãƒƒãƒ•æƒ…å ±ã‚’æ›´æ–°ã—ã¾ã—ãŸï¼');
                }
            } else {
                // æ–°è¦è¿½åŠ 
                const newId = store.staff.length > 0 ? Math.max(...store.staff.map(s => s.id)) + 1 : 101;
                store.staff.push({ id: newId, name, role, phone, email, joinDate });
                alert('âœ… ã‚¹ã‚¿ãƒƒãƒ•ã‚’è¿½åŠ ã—ã¾ã—ãŸï¼');
            }

            saveData();
            closeStaffModal();
            renderStaffList();
        }

        function editStaff(id) {
            if (currentUser.role !== 'admin') {
                alert('æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã‚¹ã‚¿ãƒƒãƒ•ã®è¿½åŠ ãƒ»ç·¨é›†ã¯ç®¡ç†è€…ã®ã¿å¯èƒ½ã§ã™ã€‚');
                return;
            }
            
            const store = getCurrentStore();
            const staff = store.staff.find(s => s.id === id);
            if (!staff) return;

            document.getElementById('staffId').value = staff.id;
            document.getElementById('staffName').value = staff.name;
            document.getElementById('staffRole').value = staff.role;
            document.getElementById('staffPhone').value = staff.phone;
            document.getElementById('staffEmail').value = staff.email;
            document.getElementById('staffJoinDate').value = staff.joinDate;

            openStaffModal();
        }

        function deleteStaff(id) {
            if (currentUser.role !== 'admin') {
                alert('æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã‚¹ã‚¿ãƒƒãƒ•ã®å‰Šé™¤ã¯ç®¡ç†è€…ã®ã¿å¯èƒ½ã§ã™ã€‚');
                return;
            }
            
            if (confirm('ã“ã®ã‚¹ã‚¿ãƒƒãƒ•ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                const store = getCurrentStore();
                store.staff = store.staff.filter(s => s.id !== id);
                saveData();
                renderStaffList();
                alert('âœ… ã‚¹ã‚¿ãƒƒãƒ•ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚');
            }
        }
        
        // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰çµ±è¨ˆ
        function renderDashboard() {
            const store = getCurrentStore();
            const tasks = store.tasks;
            if (tasks.length === 0) {
                document.getElementById('totalTasks').textContent = '0';
                document.getElementById('completedTasks').textContent = '0';
                document.getElementById('inProgressTasks').textContent = '0';
                document.getElementById('progressPercent').textContent = '0%';
                document.getElementById('dashboardStats').innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ“Š</div><div class="empty-state-text">ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“</div></div>';
                return;
            }

            const total = tasks.length;
            const completed = tasks.filter(t => t.status === 'å®Œäº†').length;
            const inProgress = tasks.filter(t => t.status === 'é€²è¡Œä¸­').length;
            const notStarted = tasks.filter(t => t.status === 'æœªç€æ‰‹').length;
            const progress = Math.round((completed / total) * 100);

            document.getElementById('totalTasks').textContent = total;
            document.getElementById('completedTasks').textContent = completed;
            document.getElementById('inProgressTasks').textContent = inProgress;
            document.getElementById('progressPercent').textContent = progress + '%';

            // ãƒ¬ãƒ™ãƒ«åˆ¥é›†è¨ˆ
            const byLevel = {};
            tasks.forEach(task => {
                byLevel[task.level] = (byLevel[task.level] || 0) + 1;
            });

            document.getElementById('dashboardStats').innerHTML = `
                <div style="background: var(--background); padding: 20px; border-radius: 12px; margin-bottom: 24px;">
                    <div style="font-weight: 600; margin-bottom: 12px;">å…¨ä½“é€²æ—ç‡</div>
                    <div style="background: white; height: 40px; border-radius: 20px; overflow: hidden;">
                        <div style="height: 100%; background: linear-gradient(135deg, #007AFF, #5856D6); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; transition: width 0.5s ease; width: ${progress}%;">
                            ${progress}%
                        </div>
                    </div>
                </div>
                <div>
                    <div style="font-weight: 600; margin-bottom: 16px;">éšå±¤åˆ¥ã‚¿ã‚¹ã‚¯æ•°</div>
                    ${Object.entries(byLevel).sort((a, b) => parseInt(a[0]) - parseInt(b[0])).map(([level, count]) => `
                        <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px dashed var(--border);">
                            <span>ãƒ¬ãƒ™ãƒ« ${level}</span>
                            <span style="font-weight: 700;">${count} ä»¶</span>
                        </div>
                    `).join('')}
                </div>
            `;
            
            // ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³
            const milestones = tasks.filter(t => t.memo && t.memo.includes('é‡è¦ã‚¿ã‚¹ã‚¯')).sort((a, b) => new Date(a.endDate) - new Date(b.endDate));
            const milestonesContainer = document.getElementById('milestones');

            if (milestones.length > 0) {
                 milestonesContainer.innerHTML = milestones.map(task => `
                    <div style="background: #FFF3E0; border-left: 6px solid var(--warning); padding: 16px; border-radius: 10px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; gap: 16px;">
                        <div>
                            <div style="font-weight: 700; font-size: 16px; color: var(--text-primary);">${task.name}</div>
                            <div style="font-size: 13px; color: var(--text-secondary); margin-top: 4px;">ğŸ“‚ ${task.parentName || 'ãªã—'} | ğŸ‘¤ ${task.assignee}</div>
                        </div>
                        <div style="flex-shrink: 0; text-align: right;">
                            <div style="font-weight: 700; color: var(--danger);">${task.endDate} æœŸé™</div>
                            <span class="task-status ${getStatusClass(task.status)}" style="margin-top: 4px; display: inline-block;">${task.status}</span>
                        </div>
                    </div>
                 `).join('');
            } else {
                 milestonesContainer.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ‰</div>
                        <div class="empty-state-text">é‡è¦ãªã‚¿ã‚¹ã‚¯ã‚’ãƒãƒ¼ã‚¯ã—ã¾ã—ã‚‡ã†</div>
                    </div>
                 `;
            }
        }

        // CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        function parseCSV(csv) {
            const lines = csv.trim().split('\n');
            if (lines.length <= 1) {
                alert('CSVãƒ•ã‚¡ã‚¤ãƒ«ã«ã‚¿ã‚¹ã‚¯ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚');
                return;
            }

            const headers = lines[0].split(',').map(h => h.trim());
            const requiredHeaders = ['level', 'parentName', 'name', 'assignee', 'memo', 'startDate', 'endDate', 'status'];
            
            const missingHeaders = requiredHeaders.filter(h => !headers.includes(h));
            if (missingHeaders.length > 0) {
                alert(`CSVãƒ˜ãƒƒãƒ€ãƒ¼ãŒä¸è¶³ã—ã¦ã„ã¾ã™: ${missingHeaders.join(', ')}`);
                return;
            }

            const store = getCurrentStore();
            let newId = store.tasks.length > 0 ? Math.max(...store.tasks.map(t => t.id)) + 1 : 1;
            let importCount = 0;

            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',').map(v => v.trim());
                if (values.length !== headers.length) continue;

                const taskData = {};
                headers.forEach((header, index) => {
                    taskData[header] = values[index];
                });

                if (taskData.name && taskData.startDate && taskData.endDate) {
                    const newTask = {
                        id: newId++,
                        level: parseInt(taskData.level) || 1,
                        parentName: taskData.parentName || null,
                        name: taskData.name,
                        assignee: taskData.assignee || '',
                        memo: taskData.memo || '',
                        startDate: taskData.startDate,
                        endDate: taskData.endDate,
                        status: ['æœªç€æ‰‹', 'é€²è¡Œä¸­', 'å®Œäº†'].includes(taskData.status) ? taskData.status : 'æœªç€æ‰‹'
                    };
                    store.tasks.push(newTask);
                    importCount++;
                }
            }

            saveData();
            renderAll();
            alert(`âœ… ${importCount}ä»¶ã®ã‚¿ã‚¹ã‚¯ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸï¼`);
        }

        function setupFileImport() {
            const fileInput = document.getElementById('csvFile');
            const importZone = document.getElementById('importZone');

            // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ
            fileInput.addEventListener('change', function(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const content = e.target.result;
                        parseCSV(content);
                    } catch (error) {
                        alert('CSVã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                    }
                };
                reader.readAsText(file, 'UTF-8');
            });
            
            // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                importZone.addEventListener(eventName, (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                }, false);
            });
            
            ['dragenter', 'dragover'].forEach(eventName => {
                importZone.addEventListener(eventName, () => importZone.classList.add('dragover'), false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                importZone.addEventListener(eventName, () => importZone.classList.remove('dragover'), false);
            });

            importZone.addEventListener('drop', function(e) {
                const file = e.dataTransfer.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            parseCSV(e.target.result);
                        } catch (error) {
                            alert('CSVã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                        }
                    };
                    reader.readAsText(file, 'UTF-8');
                }
            }, false);
        }
        
        // å…¨ãƒ‡ãƒ¼ã‚¿ã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        function exportData() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(stores));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "istyle_dashboard_data.json");
            document.body.appendChild(downloadAnchorNode); 
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        // å…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ï¼ˆãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ä¿è­·ï¼‰
        function deleteAllData() {
            if (currentUser.role !== 'admin') {
                alert('æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ãƒ‡ãƒ¼ã‚¿ã®å‰Šé™¤ã¯ç®¡ç†è€…ã®ã¿å¯èƒ½ã§ã™ã€‚');
                return;
            }
            
            const password = prompt('æœ¬å½“ã«å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');
            if (password !== DELETE_PASSWORD) {
                if (password !== null) {
                    alert('âŒ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé–“é•ã£ã¦ã„ã¾ã™ã€‚');
                }
                return;
            }
            if (confirm('æœ¬å½“ã«å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
                stores = {
                    default: { name: 'ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆåº—èˆ—', tasks: [], staff: [] }
                };
                currentStore = 'default';
                saveData();
                initializeStoreSelector();
                renderAll();
                alert('âœ… å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚');
            }
        }

        // ã™ã¹ã¦ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
        function renderAll() {
            renderDashboard();
            renderTaskList();
            renderGanttChart();
            renderStaffList();
            renderCalendar();
            renderTimeline();
        }
        
        // ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†
        function handleLogin(event) {
            event.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            const user = users.find(u => u.email === email && u.password === password);
            
            if (user) {
                currentUser = user;
                localStorage.setItem('istyle_currentUser', JSON.stringify(user));
                showApp();
            } else {
                const errorDiv = document.getElementById('loginError');
                errorDiv.textContent = 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“';
                errorDiv.style.display = 'block';
            }
        }

        // ã‚¢ãƒ—ãƒªè¡¨ç¤º
        function showApp() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('appContainer').style.display = 'flex';
            
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’è¡¨ç¤º
            document.getElementById('currentUserName').textContent = currentUser.name;
            document.getElementById('currentUserRole').textContent = currentUser.role === 'admin' ? 'ç®¡ç†è€…' : 'ç·¨é›†è€…';

            // ç®¡ç†è€…ã®ã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ã‚’è¡¨ç¤º
            if (currentUser.role === 'admin') {
                document.getElementById('userManagement').style.display = 'block';
                renderUserList();
            } else {
                 document.getElementById('userManagement').style.display = 'none';
            }
            
            renderAll();
        }

        // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
        function logout() {
            if (confirm('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
                localStorage.removeItem('istyle_currentUser');
                currentUser = null;
                document.getElementById('loginScreen').style.display = 'flex';
                document.getElementById('appContainer').style.display = 'none';
            }
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆæç”»
        function renderUserList() {
            if (currentUser.role !== 'admin') return;
            const container = document.getElementById('userList');
            let html = '';

            users.forEach(user => {
                if (user.id === currentUser.id) return;

                html += `
                    <div style="padding: 16px; background: #F5F5F7; border-radius: 10px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-weight: 600; margin-bottom: 4px;">${user.name}</div>
                            <div style="font-size: 14px; color: #86868B;">${user.email}</div>
                            <span style="display: inline-block; padding: 4px 12px; border-radius: 8px; font-size: 12px; font-weight: 600; margin-top: 8px; ${user.role === 'admin' ? 'background: rgba(0, 122, 255, 0.1); color: #007AFF;' : 'background: rgba(88, 86, 214, 0.1); color: #5856D6;'}"">${user.role === 'admin' ? 'ç®¡ç†è€…' : 'ç·¨é›†è€…'}</span>
                        </div>
                        <button class="btn btn-danger" onclick="deleteUser(${user.id})">å‰Šé™¤</button>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ«
        function openUserModal() {
            if (currentUser.role !== 'admin') return;
            document.getElementById('userForm').reset();
            document.getElementById('userModal').classList.add('active');
        }

        function closeUserModal() {
            document.getElementById('userModal').classList.remove('active');
        }

        function addUser(event) {
            event.preventDefault();
            if (currentUser.role !== 'admin') return;
            
            const name = document.getElementById('userName').value.trim();
            const email = document.getElementById('userEmail').value.trim();
            const password = document.getElementById('userPassword').value;
            const role = document.getElementById('userRole').value;

            if (users.some(u => u.email === email)) {
                alert('ã“ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯æ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™ã€‚');
                return;
            }

            const newId = users.length > 0 ? Math.max(...users.map(u => u.id)) + 1 : 1;
            users.push({ id: newId, name, email, password, role });
            saveData();
            renderUserList();
            closeUserModal();
            alert('âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è¿½åŠ ã—ã¾ã—ãŸï¼');
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤
        function deleteUser(userId) {
            if (currentUser.role !== 'admin') return;
            
            if (!confirm('ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
            
            users = users.filter(u => u.id !== userId);
            saveData();
            renderUserList();
        }

        // ãƒ­ã‚°ã‚¤ãƒ³ãƒã‚§ãƒƒã‚¯
        function checkLogin() {
            const savedUser = localStorage.getItem('istyle_currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                showApp();
            } else {
                document.getElementById('loginScreen').style.display = 'flex';
            }
        }

        // ã‚µã‚¤ãƒ‰ãƒãƒ¼é–‹é–‰ (ãƒ¢ãƒã‚¤ãƒ«)
        function toggleSidebar() {
            const sidebar = document.querySelector('.sidebar');
            const overlay = document.querySelector('.mobile-overlay');
            sidebar.classList.toggle('active');
            overlay.classList.toggle('active');
        }

        // ãƒªã‚µã‚¤ã‚¶ãƒ¼æ©Ÿèƒ½
        function setupResizers() {
            const sidebar = document.querySelector('.sidebar');
            const sidebarResizer = document.getElementById('sidebarResizer');
            const contentHeader = document.querySelector('.content-header');
            const headerResizer = document.getElementById('headerResizer');
            let isResizingSidebar = false;
            let isResizingHeader = false;
            let startX = 0;
            let startY = 0;
            let startWidth = 0;
            let startHeight = 0;

            // ã‚µã‚¤ãƒ‰ãƒãƒ¼ãƒªã‚µã‚¤ã‚¶ãƒ¼
            if (sidebarResizer) {
                sidebarResizer.addEventListener('mousedown', (e) => {
                    isResizingSidebar = true;
                    startX = e.clientX;
                    startWidth = parseInt(getComputedStyle(sidebar).width, 10);
                    document.body.style.cursor = 'ew-resize';
                    document.body.style.userSelect = 'none';
                    e.preventDefault();
                });
            }

            // ãƒ˜ãƒƒãƒ€ãƒ¼ãƒªã‚µã‚¤ã‚¶ãƒ¼
            if (headerResizer) {
                headerResizer.addEventListener('mousedown', (e) => {
                    isResizingHeader = true;
                    startY = e.clientY;
                    startHeight = parseInt(getComputedStyle(contentHeader).height, 10);
                    document.body.style.cursor = 'ns-resize';
                    document.body.style.userSelect = 'none';
                    e.preventDefault();
                });
            }

            // ãƒã‚¦ã‚¹ç§»å‹•
            document.addEventListener('mousemove', (e) => {
                if (isResizingSidebar) {
                    const width = startWidth + (e.clientX - startX);
                    if (width >= 200 && width <= 500) {
                        sidebar.style.width = width + 'px';
                        TASK_COL_WIDTH = width; // ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆã®ã‚¿ã‚¹ã‚¯ååˆ—å¹…ã¨é€£å‹•
                        renderGanttChart();
                    }
                } else if (isResizingHeader) {
                    const height = startHeight + (e.clientY - startY);
                    if (height >= 0 && height <= 150) {
                        // ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’èª¿æ•´ã—ã¦é«˜ã•ã‚’å¤‰ãˆã‚‹
                        contentHeader.style.padding = Math.max(0, height / 5) + 'px 24px ' + Math.max(0, height / 5) + 'px 24px';
                    }
                }
            });

            // ãƒã‚¦ã‚¹ã‚¢ãƒƒãƒ—
            document.addEventListener('mouseup', () => {
                isResizingSidebar = false;
                isResizingHeader = false;
                document.body.style.cursor = 'default';
                document.body.style.userSelect = 'auto';
            });
        }


        // åˆæœŸå‡¦ç†
        window.onload = function() {
            loadData();
            initializeStoreSelector();
            setupFileImport();
            setupResizers();
            checkLogin();
        };

    </script>
</body>
</html>