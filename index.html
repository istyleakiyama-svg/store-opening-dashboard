<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>I-STYLE åº—èˆ—ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ v8.0ï¼ˆæ—¥åˆ¥ã‚¬ãƒ³ãƒˆãƒ»2030å¹´å¯¾å¿œï¼‰</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        :root{
            --accent:#007aff;
            --accent-dark:#0051c3;
            --accent-soft:#e5f0ff;
            --bg:#f2f2f7;
            --card-bg:#ffffff;
            --border:#d1d1d6;
            --text-main:#1c1c1e;
            --text-sub:#8e8e93;
        }
        *{margin:0;padding:0;box-sizing:border-box;}
        body{
            font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text","Segoe UI",sans-serif;
            background:var(--bg);
            padding:16px;
            color:var(--text-main);
        }
        .container{
            max-width:1600px;
            margin:0 auto;
            background:var(--card-bg);
            border-radius:24px;
            border:1px solid rgba(0,0,0,0.04);
            box-shadow:0 18px 40px rgba(0,0,0,0.12);
            overflow:hidden;
        }
        .header{
            padding:16px 20px;
            border-bottom:1px solid var(--border);
            display:flex;
            align-items:center;
            justify-content:space-between;
            gap:12px;
            background:#f9f9fb;
        }
        .header-left h1{
            font-size:20px;
            font-weight:600;
            letter-spacing:0.03em;
        }
        .header-right{
            display:flex;
            align-items:center;
            gap:8px;
        }
        .project-select{
            padding:7px 11px;
            border-radius:999px;
            border:1px solid var(--border);
            font-size:13px;
            background:#fff;
            color:var(--text-main);
        }
        .mode-indicator{
            font-size:11px;
            color:var(--accent-dark);
            padding:4px 10px;
            border-radius:999px;
            border:1px solid var(--accent-soft);
            background:#f5f8ff;
            cursor:pointer;
        }
        .mode-indicator:hover{
            background:#e3edff;
        }
        .btn{
            padding:7px 14px;
            border-radius:999px;
            border:none;
            font-size:12px;
            font-weight:500;
            cursor:pointer;
            display:inline-flex;
            align-items:center;
            gap:6px;
            transition:all .15s;
            white-space:nowrap;
        }
        .btn-primary{
            background:var(--accent);
            color:#fff;
        }
        .btn-primary:hover{background:var(--accent-dark);}
        .btn-secondary{
            background:#e5e5ea;
            color:var(--text-main);
        }
        .btn-secondary:hover{background:#d1d1d6;}
        .btn-ghost{
            background:transparent;
            color:var(--text-sub);
        }
        .btn-ghost:hover{background:rgba(0,0,0,0.05);}
        .btn-danger{
            background:#ff3b30;
            color:#fff;
        }
        .btn-danger:hover{background:#d70015;}

        .project-menu-wrapper{position:relative;}
        .dropdown-menu{
            position:absolute;
            right:0;
            top:110%;
            min-width:160px;
            background:#fff;
            border-radius:12px;
            border:1px solid var(--border);
            box-shadow:0 14px 30px rgba(0,0,0,0.18);
            padding:6px;
            display:none;
            z-index:40;
        }
        .dropdown-menu.open{display:block;}
        .dropdown-item{
            width:100%;
            text-align:left;
            border:none;
            background:transparent;
            padding:7px 10px;
            border-radius:8px;
            font-size:12px;
            cursor:pointer;
            color:var(--text-main);
        }
        .dropdown-item:hover{
            background:#f2f2f7;
        }

        .tabs{
            display:flex;
            border-bottom:1px solid var(--border);
            background:#f9f9fb;
        }
        .tab{
            padding:10px 16px;
            border:none;
            background:transparent;
            cursor:pointer;
            font-size:13px;
            color:var(--text-sub);
            display:flex;
            align-items:center;
            gap:6px;
            border-bottom:2px solid transparent;
        }
        .tab.active{
            color:var(--accent-dark);
            border-bottom-color:var(--accent);
            background:#fff;
        }
        .tab-content{
            display:none;
            padding:16px 20px 20px;
        }
        .tab-content.active{display:block;}

        .two-column{
            display:grid;
            grid-template-columns:2fr 1.1fr;
            gap:14px;
        }
        .card{
            background:var(--card-bg);
            border-radius:18px;
            border:1px solid var(--border);
            padding:14px 16px 16px;
        }
        .card-header{
            display:flex;
            justify-content:space-between;
            align-items:center;
            margin-bottom:8px;
        }
        .card-title{
            font-size:14px;
            font-weight:600;
        }
        .card-sub{
            font-size:11px;
            color:var(--text-sub);
        }

        .form-row{
            display:grid;
            grid-template-columns:repeat(auto-fit,minmax(160px,1fr));
            gap:8px;
            margin-bottom:8px;
        }
        .form-group{
            display:flex;
            flex-direction:column;
            gap:4px;
        }
        .form-group label{
            font-size:11px;
            color:var(--text-sub);
        }
        .form-group input,
        .form-group select,
        .form-group textarea{
            padding:7px 9px;
            border-radius:10px;
            border:1px solid var(--border);
            font-size:12px;
            background:#fafafa;
        }
        .form-group textarea{resize:vertical;min-height:48px;}

        .filters{
            display:flex;
            gap:6px;
            flex-wrap:wrap;
        }
        .filter-pill{
            padding:4px 10px;
            border-radius:999px;
            border:1px solid var(--border);
            font-size:11px;
            cursor:pointer;
            color:var(--text-sub);
            background:#fff;
        }
        .filter-pill.active{
            background:var(--accent);
            color:#fff;
            border-color:var(--accent);
        }

        .task-list{
            display:flex;
            flex-direction:column;
            gap:6px;
            margin-top:6px;
        }
        .task-item{
            background:#fff;
            border-radius:12px;
            border:1px solid var(--border);
            padding:8px 10px;
            transition:all .12s;
        }
        .task-item:hover{
            box-shadow:0 3px 10px rgba(0,0,0,0.09);
            transform:translateY(-1px);
        }
        .task-item.drag-over{
            border-style:dashed;
            border-color:var(--accent);
            background:var(--accent-soft);
        }
        .task-main{
            display:flex;
            justify-content:space-between;
            align-items:center;
            gap:8px;
        }
        .task-left{
            display:flex;
            align-items:center;
            gap:6px;
            flex:1;
        }
        .task-level-dot{
            width:8px;height:8px;border-radius:999px;background:var(--accent);flex-shrink:0;
        }
        .task-title{
            font-size:13px;
            font-weight:500;
        }
        .task-meta{
            display:flex;
            gap:6px;
            font-size:11px;
            color:var(--text-sub);
            margin-top:3px;
            flex-wrap:wrap;
        }
        .status-pill{
            padding:3px 8px;
            border-radius:999px;
            font-size:10px;
            font-weight:500;
        }
        .status-not-started{background:#f2f2f7;color:#6e6e73;}
        .status-in-progress{background:#fff4d0;color:#8e5b00;}
        .status-completed{background:#d1f7d6;color:#1d7a32;}
        .task-body{
            margin-top:6px;
            padding-top:6px;
            border-top:1px dashed var(--border);
            display:none;
            font-size:11px;
        }
        .task-body.open{display:block;}
        .toggle-icon{font-size:11px;color:var(--text-sub);}

        .today-panel-list{
            display:flex;
            flex-direction:column;
            gap:6px;
            margin-top:4px;
        }
        .today-empty{
            font-size:12px;
            color:var(--text-sub);
            margin-top:8px;
        }

        .tree-row{
            display:grid;
            grid-template-columns:260px 1fr;
            border-bottom:1px solid var(--border);
            padding:6px 0;
            background:#fff;
        }
        .tree-cell{
            padding-right:10px;
            display:flex;
            align-items:center;
            gap:6px;
            font-size:12px;
        }
        .gantt-cell{position:relative;height:26px;}
        .gantt-track{
            position:absolute;
            inset:6px 0;
            background:#f2f2f7;
            border-radius:999px;
            overflow:hidden;
        }
        .gantt-bar{
            position:absolute;
            top:0;bottom:0;
            border-radius:999px;
            font-size:10px;
            padding:0 6px;
            display:flex;
            align-items:center;
            color:#fff;
            white-space:nowrap;
            cursor:grab;
        }
        .gantt-bar:active{cursor:grabbing;}
        .gantt-row-highlight{
            outline:2px solid var(--accent);
            outline-offset:-2px;
            background:var(--accent-soft);
        }

        .metrics{
            display:grid;
            grid-template-columns:repeat(auto-fit,minmax(190px,1fr));
            gap:12px;
            margin-bottom:14px;
        }
        .metric-card{
            padding:10px 12px;
            border-radius:14px;
            border:1px solid var(--border);
            background:#fff;
        }
        .metric-label{
            font-size:11px;
            color:var(--text-sub);
        }
        .metric-value{
            font-size:20px;
            font-weight:600;
            color:var(--accent-dark);
        }
        .metric-sub{
            font-size:11px;
            color:var(--text-sub);
        }

        .calendar-header{
            display:flex;
            justify-content:space-between;
            align-items:center;
            margin-bottom:8px;
        }
        .calendar-grid{
            display:grid;
            grid-template-columns:repeat(7,1fr);
            gap:1px;
            background:var(--border);
            border-radius:14px;
            overflow:hidden;
            font-size:11px;
        }
        .calendar-cell{
            background:#fff;
            min-height:78px;
            padding:4px;
            position:relative;
            cursor:pointer;
        }
        .calendar-cell.weekend{background:#faf5f5;}
        .calendar-cell.today{outline:2px solid var(--accent);outline-offset:-2px;}
        .calendar-date{
            font-size:11px;
            color:#4b4b4b;
            margin-bottom:2px;
        }
        .calendar-task-dot{
            width:6px;height:6px;border-radius:999px;margin-right:4px;
            background:var(--accent);display:inline-block;
        }
        .calendar-task-item{
            font-size:10px;
            color:#333;
            white-space:nowrap;
            overflow:hidden;
            text-overflow:ellipsis;
        }
        .day-task-list{
            margin-top:10px;
            font-size:12px;
        }

        .modal{
            position:fixed;
            inset:0;
            background:rgba(0,0,0,0.45);
            display:none;
            align-items:center;
            justify-content:center;
            z-index:100;
        }
        .modal.show{display:flex;}
        .modal-content{
            background:var(--card-bg);
            border-radius:16px;
            padding:16px 18px 14px;
            width:96%;
            max-width:520px;
            max-height:90vh;
            overflow-y:auto;
            box-shadow:0 20px 45px rgba(0,0,0,0.5);
        }
        .modal-header{
            display:flex;
            justify-content:space-between;
            align-items:center;
            margin-bottom:10px;
        }
        .modal-header h2{
            font-size:15px;
        }
        .modal-close{
            border:none;
            background:transparent;
            font-size:22px;
            cursor:pointer;
            color:var(--text-sub);
        }
        .modal-footer{
            display:flex;
            justify-content:flex-end;
            gap:8px;
            margin-top:10px;
        }

        .csv-input{font-size:11px;}

        table.staff-table{
            width:100%;
            border-collapse:collapse;
            margin-top:6px;
            font-size:12px;
        }
        .staff-table th,
        .staff-table td{
            border-bottom:1px solid var(--border);
            padding:6px 4px;
            text-align:left;
        }
        .staff-table th{
            font-size:11px;
            color:var(--text-sub);
        }

        .fab{
            position:fixed;
            right:28px;
            bottom:28px;
            background:var(--accent);
            color:#fff;
            width:52px;
            height:52px;
            border-radius:999px;
            display:flex;
            align-items:center;
            justify-content:center;
            font-size:26px;
            cursor:pointer;
            box-shadow:0 10px 25px rgba(0,0,0,0.35);
            border:none;
            z-index:50;
        }
        .fab:hover{background:var(--accent-dark);}

        @media (max-width:900px){
            .two-column{grid-template-columns:1fr;}
            .tree-row{grid-template-columns:1fr;}
            .header{flex-direction:column;align-items:flex-start;}
        }

        @media print{
            body{background:#fff;padding:0;}
            .tabs,.fab,.modal,.header-right .project-menu-wrapper,
            #tasks,#dashboard,#calendar,#staff{display:none!important;}
            .tab-content{display:none!important;}
            #integrated{display:block!important;}
            .container{box-shadow:none;border-radius:0;border:none;}
            .header{box-shadow:none;border-bottom:1px solid #ccc;}
        }
    </style>
</head>
<body>
<div class="container">
    <header class="header">
        <div class="header-left">
            <h1>I-STYLE åº—èˆ—ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ v8.0</h1>
        </div>
        <div class="header-right">
            <select id="project-select" class="project-select" onchange="changeProject(this.value)"></select>
            <div id="mode-indicator" class="mode-indicator" onclick="togglePermissionMode()">
                ãƒ¢ãƒ¼ãƒ‰ï¼šãƒ•ãƒ«ç·¨é›†
            </div>
            <div class="project-menu-wrapper">
                <button class="btn btn-secondary" onclick="toggleProjectMenu()">ç·¨é›† â–¾</button>
                <div id="project-menu" class="dropdown-menu">
                    <button class="dropdown-item" onclick="menuAddProject()">ï¼‹ åº—èˆ—è¿½åŠ </button>
                    <button class="dropdown-item" onclick="menuDeleteProject()">âˆ’ åº—èˆ—å‰Šé™¤</button>
                    <button class="dropdown-item" onclick="changeProjectColor()">ã‚«ãƒ©ãƒ¼å¤‰æ›´</button>
                    <button class="dropdown-item" onclick="copyTasksBetweenProjects()">ä»–åº—èˆ—ã‹ã‚‰ã‚¿ã‚¹ã‚¯å¼•ãç¶™ã</button>
                </div>
            </div>
        </div>
    </header>

    <div class="tabs">
        <button class="tab active" onclick="switchTab(event,'integrated')">ğŸ§© éšå±¤ï¼‹ã‚¬ãƒ³ãƒˆ</button>
        <button class="tab" onclick="switchTab(event,'tasks')">ğŸ“‹ ã‚¿ã‚¹ã‚¯</button>
        <button class="tab" onclick="switchTab(event,'dashboard')">ğŸ“ˆ ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</button>
        <button class="tab" onclick="switchTab(event,'calendar')">ğŸ“… ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</button>
        <button class="tab" onclick="switchTab(event,'staff')">ğŸ‘¥ ã‚¹ã‚¿ãƒƒãƒ•</button>
    </div>

    <!-- ã‚¬ãƒ³ãƒˆå°‚ç”¨ãƒ“ãƒ¥ãƒ¼ -->
    <section id="integrated" class="tab-content active">
        <div class="card">
            <div class="card-header">
                <div>
                    <div class="card-title">ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆï¼ˆè¦ªå­æ§‹é€ ï¼‹æœŸé–“ï¼‹æ‹…å½“ï¼‰</div>
                    <div class="card-sub">ã‚¬ãƒ³ãƒˆæœŸé–“ã‚’æ—¥åˆ¥ãƒãƒ¼ã§è¡¨ç¤ºã—ã€ã‚¿ã‚¹ã‚¯ãƒ»æœŸé–“ãƒ»æ‹…å½“ã‚’ä¸€ç”»é¢ã§ä¿¯ç°</div>
                </div>
                <div style="display:flex;gap:6px;align-items:center;">
                    <select id="gantt-year-select" onchange="changeGanttYear(this.value)"
                            style="padding:4px 8px;border-radius:999px;border:1px solid var(--border);font-size:11px;background:#fff;">
                        <option value="2025">2025å¹´</option>
                        <option value="2026">2026å¹´</option>
                        <option value="2027">2027å¹´</option>
                        <option value="2028">2028å¹´</option>
                        <option value="2029">2029å¹´</option>
                        <option value="2030">2030å¹´</option>
                    </select>
                    <button class="btn btn-ghost" onclick="expandAll()">ã™ã¹ã¦å±•é–‹</button>
                    <button class="btn btn-ghost" onclick="collapseAll()">ã™ã¹ã¦é–‰ã˜ã‚‹</button>
                    <button class="btn btn-secondary" onclick="printGantt()">å°åˆ·</button>
                </div>
            </div>
            <div id="integrated-gantt"></div>
        </div>
    </section>

    <!-- ã‚¿ã‚¹ã‚¯ -->
    <section id="tasks" class="tab-content">
        <div class="two-column">
            <div class="card">
                <div class="card-header">
                    <div>
                        <div class="card-title">ã‚¿ã‚¹ã‚¯ä¸€è¦§ï¼ˆç¾åœ¨ã®åº—èˆ—ï¼‰</div>
                        <div class="card-sub" id="current-project-label"></div>
                    </div>
                    <div class="filters">
                        <button class="filter-pill active" data-filter="all" onclick="setStatusFilter(event,'all')">ã™ã¹ã¦</button>
                        <button class="filter-pill" data-filter="æœªç€æ‰‹" onclick="setStatusFilter(event,'æœªç€æ‰‹')">æœªç€æ‰‹</button>
                        <button class="filter-pill" data-filter="é€²è¡Œä¸­" onclick="setStatusFilter(event,'é€²è¡Œä¸­')">é€²è¡Œä¸­</button>
                        <button class="filter-pill" data-filter="å®Œäº†" onclick="setStatusFilter(event,'å®Œäº†')">å®Œäº†</button>
                    </div>
                </div>
                <div class="task-list" id="task-list"></div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div>
                        <div class="card-title">ä»Šæ—¥ã‚„ã‚‹ã“ã¨</div>
                        <div class="card-sub">ä»Šæ—¥ã®ç¯„å›²ã«å…¥ã£ã¦ã„ã‚‹ã‚¿ã‚¹ã‚¯ã‚’è‡ªå‹•æŠ½å‡º</div>
                    </div>
                    <button class="btn btn-ghost" onclick="extractTodayTasks()">æ›´æ–°</button>
                </div>
                <div id="today-tasks-panel">
                    <p class="today-empty">å³ä¸Šã®ï¼»æ›´æ–°ï¼½ã‚’æŠ¼ã™ã¨ã€ä»Šæ—¥ã®ã‚¿ã‚¹ã‚¯ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
                </div>
                <hr style="margin:12px 0;border:none;border-top:1px solid var(--border);">
                <div>
                    <div class="card-title" style="font-size:13px;margin-bottom:4px;">CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ / ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</div>
                    <div style="display:flex;flex-wrap:wrap;gap:6px;align-items:center;margin-bottom:6px;">
                        <button class="btn btn-secondary" onclick="exportToCSV()">ğŸ“¥ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
                        <button class="btn btn-secondary" onclick="document.getElementById('csv-input').click()">ğŸ“¤ ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
                        <input id="csv-input" class="csv-input" type="file" accept=".csv" style="display:none" onchange="importFromCSV(event)">
                    </div>
                    <p style="font-size:10px;color:var(--text-sub);">
                        â€» CSVå½¢å¼ï¼šãƒ¬ãƒ™ãƒ«,è¦ªã‚¿ã‚¹ã‚¯å,ã‚¿ã‚¹ã‚¯å,æ‹…å½“è€…,é–‹å§‹æ—¥,çµ‚äº†æ—¥,ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹,å„ªå…ˆåº¦,ãƒ¡ãƒ¢
                    </p>
                </div>
            </div>
        </div>
    </section>

    <!-- ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ -->
    <section id="dashboard" class="tab-content">
        <div class="metrics" id="metrics"></div>

        <div class="card" style="margin-bottom:14px;">
            <div class="card-header">
                <div>
                    <div class="card-title">éšå±¤åˆ¥é€²æ—</div>
                    <div class="card-sub">ãƒ¬ãƒ™ãƒ«ã”ã¨ã®å®Œäº†ç‡</div>
                </div>
            </div>
            <div id="level-progress"></div>
        </div>

        <div class="card">
            <div class="card-header">
                <div>
                    <div class="card-title">KPIï¼ˆFLãƒ»åŸä¾¡ç‡ãƒ»äººä»¶è²»ï¼‰</div>
                    <div class="card-sub">åº—èˆ—ã”ã¨ã®KPIãƒ¡ãƒ¢ã¨ã—ã¦åˆ©ç”¨ã§ãã¾ã™</div>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>FLï¼ˆï¼…ï¼‰</label>
                    <input id="kpi-fl" type="number" min="0" max="100" step="0.1" placeholder="ä¾‹ï¼š50">
                </div>
                <div class="form-group">
                    <label>åŸä¾¡ç‡ï¼ˆï¼…ï¼‰</label>
                    <input id="kpi-cost" type="number" min="0" max="100" step="0.1" placeholder="ä¾‹ï¼š25">
                </div>
                <div class="form-group">
                    <label>äººä»¶è²»ç‡ï¼ˆï¼…ï¼‰</label>
                    <input id="kpi-labor" type="number" min="0" max="100" step="0.1" placeholder="ä¾‹ï¼š25">
                </div>
            </div>
            <div class="modal-footer" style="justify-content:flex-start;margin-top:4px;">
                <button class="btn btn-primary" type="button" onclick="saveKPI()">KPIã‚’ä¿å­˜</button>
                <span id="kpi-message" style="font-size:11px;color:var(--text-sub);"></span>
            </div>
            <div id="kpi-summary" style="font-size:12px;color:var(--text-main);margin-top:8px;"></div>
        </div>
    </section>

    <!-- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ -->
    <section id="calendar" class="tab-content">
        <div class="card">
            <div class="calendar-header">
                <div>
                    <div class="card-title">ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ï¼ˆæœˆè¡¨ç¤ºï¼‰</div>
                    <div class="card-sub">æ—¥ä»˜ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€ãã®æ—¥ã®ã‚¿ã‚¹ã‚¯ã¨ãƒ¡ãƒ¢æ¬„ã‚’è¡¨ç¤º</div>
                </div>
                <div style="display:flex;gap:6px;align-items:center;">
                    <button class="btn btn-ghost" onclick="changeMonth(-1)">â—€</button>
                    <span id="calendar-month-label" style="font-size:13px;"></span>
                    <button class="btn btn-ghost" onclick="changeMonth(1)">â–¶</button>
                    <button class="btn btn-secondary" onclick="goToToday()">ä»Šæ—¥</button>
                </div>
            </div>
            <div class="calendar-grid" id="calendar-grid"></div>
            <div class="day-task-list" id="day-task-list"></div>
        </div>
    </section>

    <!-- ã‚¹ã‚¿ãƒƒãƒ• -->
    <section id="staff" class="tab-content">
        <div class="card">
            <div class="card-header">
                <div>
                    <div class="card-title">ã‚¹ã‚¿ãƒƒãƒ•åç°¿ï¼ˆåº—èˆ—ã”ã¨ï¼‰</div>
                    <div class="card-sub">ç¾åœ¨é¸æŠä¸­ã®åº—èˆ—ã«ç´ã¥ãã‚¹ã‚¿ãƒƒãƒ•ä¸€è¦§</div>
                </div>
            </div>
            <form onsubmit="addStaff(event)">
                <div class="form-row">
                    <div class="form-group">
                        <label>ã‚¹ã‚¿ãƒƒãƒ•å *</label>
                        <input id="staff-name" type="text" required>
                    </div>
                    <div class="form-group">
                        <label>å½¹å‰² / ãƒã‚¸ã‚·ãƒ§ãƒ³</label>
                        <input id="staff-role" type="text" placeholder="ä¾‹ï¼šåº—é•·ãƒ»ã‚·ãƒ•ãƒˆãƒªãƒ¼ãƒ€ãƒ¼">
                    </div>
                    <div class="form-group">
                        <label>é€£çµ¡å…ˆï¼ˆä»»æ„ï¼‰</label>
                        <input id="staff-contact" type="text" placeholder="ãƒ¡ãƒ¼ãƒ« / é›»è©±ãªã©">
                    </div>
                </div>
                <div class="modal-footer" style="justify-content:flex-start;margin-top:0;">
                    <button type="submit" class="btn btn-primary">ã‚¹ã‚¿ãƒƒãƒ•è¿½åŠ </button>
                    <span style="font-size:11px;color:var(--text-sub);">â€»ã€Œé€²è¡ŒçŠ¶æ³ã®ã¿ã€ãƒ¢ãƒ¼ãƒ‰ã§ã¯è¿½åŠ ã§ãã¾ã›ã‚“ã€‚</span>
                </div>
            </form>
            <table class="staff-table">
                <thead>
                <tr>
                    <th>åå‰</th>
                    <th>å½¹å‰²</th>
                    <th>é€£çµ¡å…ˆ</th>
                    <th style="width:60px;">æ“ä½œ</th>
                </tr>
                </thead>
                <tbody id="staff-list"></tbody>
            </table>
        </div>
    </section>
</div>

<!-- ã‚¿ã‚¹ã‚¯è¿½åŠ /ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="task-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="task-modal-title">ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ </h2>
            <button class="modal-close" onclick="closeTaskModal()">Ã—</button>
        </div>
        <form id="task-form">
            <div class="form-row">
                <div class="form-group">
                    <label>ã‚¿ã‚¹ã‚¯å *</label>
                    <input type="text" id="task-name" required>
                </div>
                <div class="form-group">
                    <label>æ‹…å½“è€… *</label>
                    <input type="text" id="task-person" required>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>é–‹å§‹æ—¥ *</label>
                    <input type="date" id="task-start" required>
                </div>
                <div class="form-group">
                    <label>çµ‚äº†æ—¥ *</label>
                    <input type="date" id="task-end" required>
                </div>
                <div class="form-group">
                    <label>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ *</label>
                    <select id="task-status" required>
                        <option value="æœªç€æ‰‹">æœªç€æ‰‹</option>
                        <option value="é€²è¡Œä¸­">é€²è¡Œä¸­</option>
                        <option value="å®Œäº†">å®Œäº†</option>
                    </select>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>å„ªå…ˆåº¦</label>
                    <select id="task-priority">
                        <option value="é«˜">é«˜</option>
                        <option value="ä¸­" selected>ä¸­</option>
                        <option value="ä½">ä½</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ãƒ¬ãƒ™ãƒ«ï¼ˆ1ã€œ10ï¼‰</label>
                    <select id="task-level" onchange="updateParentOptions()">
                        <option value="1">1ï¼ˆæœ€ä¸Šä½ï¼‰</option>
                        <option value="2">2</option>
                        <option value="3" selected>3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                        <option value="6">6</option>
                        <option value="7">7</option>
                        <option value="8">8</option>
                        <option value="9">9</option>
                        <option value="10">10ï¼ˆæœ€ä¸‹ä½ï¼‰</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>è¦ªã‚¿ã‚¹ã‚¯ï¼ˆä»»æ„ï¼‰</label>
                    <select id="task-parent">
                        <option value="">ãªã—</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label>ãƒ¡ãƒ¢</label>
                <textarea id="task-memo" rows="3"></textarea>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-ghost" onclick="closeTaskModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button type="submit" class="btn btn-primary">ä¿å­˜</button>
            </div>
        </form>
    </div>
</div>

<button id="fab" class="fab" onclick="openTaskModal()">ï¼‹</button>

<script>
    // ===== ã‚¬ãƒ³ãƒˆæœŸé–“ï¼ˆå¹´åˆ‡ã‚Šæ›¿ãˆå¯¾å¿œï¼‰ =====
    let GANTT_START;
    let GANTT_END;
    const MS_DAY = 1000*60*60*24;
    let GANTT_TOTAL_DAYS;
    const WEEKDAYS = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'];

    function setGanttYear(year){
        GANTT_START = new Date(year+'-01-01');
        GANTT_END   = new Date(year+'-12-31');
        GANTT_TOTAL_DAYS = Math.round((GANTT_END - GANTT_START)/MS_DAY) + 1;
    }
    function changeGanttYear(year){
        const y = parseInt(year,10);
        if(isNaN(y)) return;
        setGanttYear(y);
        renderIntegrated();
    }

    // ===== ã‚°ãƒ­ãƒ¼ãƒãƒ«çŠ¶æ…‹ =====
    let projects = ['ãƒ©ã‚¾ãƒ¼ãƒŠå·å´åº—'];
    let currentProject = 'ãƒ©ã‚¾ãƒ¼ãƒŠå·å´åº—';
    let projectColors = new Map();
    projectColors.set('ãƒ©ã‚¾ãƒ¼ãƒŠå·å´åº—','#007aff');

    let tasks = [];
    let taskMap = new Map();
    let historyMap = new Map();
    let commentsMap = new Map();
    let expandedSet = new Set();
    let draggedTaskId = null;
    let statusFilter = 'all';
    let currentMonth = new Date();
    let editingTaskId = null;
    let kpiMap = new Map();
    let taskOrderCounter = 0;

    let ganttDrag = null; // {id,task,barEl,trackRect,type,originalStart,originalEnd,previewStart,previewEnd,startX,pxPerDay}
    let permissionMode = 'full';
    let permissionPassword = null;
    let staffList = [];

    // ===== æ±ç”¨ãƒ˜ãƒ«ãƒ‘ãƒ¼ =====
    function toISODate(date){
        const d = new Date(date);
        return d.toISOString().split('T')[0];
    }
    function shortDateLabel(date){
        const d = new Date(date);
        if(isNaN(d)) return '';
        return `${d.getMonth()+1}/${d.getDate()}(${WEEKDAYS[d.getDay()]})`;
    }
    function shortDateLabelRange(start,end){
        if(!start || !end) return '';
        return `${shortDateLabel(start)}ã€œ${shortDateLabel(end)}`;
    }
    function getKPI(project=currentProject){
        if(!kpiMap.has(project)){
            kpiMap.set(project,{fl:'',costRate:'',laborRate:''});
        }
        return kpiMap.get(project);
    }
    function rebuildMaps(){
        taskMap.clear();
        tasks.forEach(t=>taskMap.set(t.id,t));
    }
    function getProjectTasks(project=currentProject){
        return tasks
            .filter(t=>t.project===project)
            .sort((a,b)=>(a.order ?? 0)-(b.order ?? 0));
    }
    function getTaskById(id){return taskMap.get(id) || null;}
    function getChildren(id){
        return getProjectTasks().filter(t=>t.parentId===id);
    }
    function addHistory(id,action,detail){
        if(!historyMap.has(id)) historyMap.set(id,[]);
        historyMap.get(id).unshift({
            action,
            detail,
            time:new Date().toLocaleString('ja-JP')
        });
    }
    function formatStatusClass(status){
        if(status==='å®Œäº†') return 'status-completed';
        if(status==='é€²è¡Œä¸­') return 'status-in-progress';
        return 'status-not-started';
    }
    function projectLabel(){
        const el = document.getElementById('current-project-label');
        if(!el) return;
        el.textContent =
            `å¯¾è±¡åº—èˆ—ï¼š${currentProject}ï¼ˆã‚¿ã‚¹ã‚¯æ•°ï¼š${getProjectTasks().length}ä»¶ï¼‰`;
    }
    function getNextOrderForProject(project){
        const proj = tasks.filter(t=>t.project===project);
        if(!proj.length) return 0;
        const maxOrder = Math.max(...proj.map(t=>t.order ?? 0));
        return maxOrder+1;
    }

    // è¦ªå­æ§‹é€ ã§ä¸¦ã¹æ›¿ãˆï¼ˆãƒ—ãƒ¬ã‚ªãƒ¼ãƒ€ãƒ¼ï¼‰
    function buildHierarchicalOrder(project){
        const projectTasks = tasks.filter(t=>t.project===project);
        const byParent = new Map();
        projectTasks.forEach(t=>{
            const key = (t.parentId == null) ? 'root' : t.parentId;
            if(!byParent.has(key)) byParent.set(key,[]);
            byParent.get(key).push(t);
        });
        const result = [];
        function walk(parentKey){
            const arr = byParent.get(parentKey) || [];
            arr.sort((a,b)=>{
                if(a.level !== b.level) return a.level - b.level;
                const ao = a.order ?? 0;
                const bo = b.order ?? 0;
                return ao - bo;
            });
            arr.forEach(t=>{
                result.push(t);
                walk(t.id);
            });
        }
        walk('root');
        return result;
    }

    // ===== æ¨©é™ãƒ¢ãƒ¼ãƒ‰é–¢é€£ =====
    function isFullEdit(){
        return permissionMode === 'full';
    }
    function updatePermissionUI(){
        const el = document.getElementById('mode-indicator');
        const fab = document.getElementById('fab');
        if(el){
            el.textContent = permissionMode==='full'
                ? 'ãƒ¢ãƒ¼ãƒ‰ï¼šãƒ•ãƒ«ç·¨é›†'
                : 'ãƒ¢ãƒ¼ãƒ‰ï¼šé€²è¡ŒçŠ¶æ³ã®ã¿';
        }
        if(fab){
            fab.style.display = permissionMode==='full' ? 'flex' : 'none';
        }
    }
    function togglePermissionMode(){
        if(permissionMode==='full'){
            permissionMode = 'statusOnly';
            alert('ã€Œé€²è¡ŒçŠ¶æ³ç·¨é›†ã®ã¿ã€ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆã¾ã—ãŸã€‚\nã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ä»¥å¤–ã®ç·¨é›†ã¯ã§ãã¾ã›ã‚“ã€‚');
            updatePermissionUI();
            renderTasks();
            renderStaff();
        }else{
            if(permissionPassword){
                const input = prompt('ãƒ•ãƒ«ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                if(input!==permissionPassword){
                    alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™ã€‚');
                    return;
                }
            }else{
                const pw = prompt('ãƒ•ãƒ«ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¨­å®šã—ã¦ãã ã•ã„ï¼ˆç©ºæ¬„ãªã‚‰ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç„¡ã—ï¼‰');
                if(pw) permissionPassword = pw;
            }
            permissionMode = 'full';
            alert('ãƒ•ãƒ«ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆã¾ã—ãŸã€‚');
            updatePermissionUI();
            renderTasks();
            renderStaff();
        }
    }

    // ===== ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé–¢é€£ =====
    function renderProjectSelect(){
        const sel = document.getElementById('project-select');
        sel.innerHTML = '';
        projects.forEach(p=>{
            const opt = document.createElement('option');
            opt.value = p;
            opt.textContent = p;
            sel.appendChild(opt);
        });
        sel.value = currentProject;
    }
    function applyProjectColor(){
        const color = projectColors.get(currentProject) || '#007aff';
        document.documentElement.style.setProperty('--accent',color);
        document.documentElement.style.setProperty('--accent-dark',color);
    }
    function changeProject(project){
        currentProject = project;
        applyProjectColor();
        projectLabel();
        updateParentOptions();
        renderAllViews();
        renderStaff();
    }
    function addProject(){
        if(!isFullEdit()){
            alert('ã“ã®ãƒ¢ãƒ¼ãƒ‰ã§ã¯åº—èˆ—ã®è¿½åŠ ã¯ã§ãã¾ã›ã‚“ã€‚');
            return;
        }
        const name = prompt('è¿½åŠ ã™ã‚‹åº—èˆ—åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        if(!name) return;
        if(projects.includes(name)){
            alert('åŒã˜åå‰ã®åº—èˆ—ãŒæ—¢ã«å­˜åœ¨ã—ã¾ã™ã€‚');
            return;
        }
        projects.push(name);
        projectColors.set(name, projectColors.get(currentProject) || '#007aff');
        currentProject = name;
        renderProjectSelect();
        applyProjectColor();
        if(projects.length>1){
            const source = prompt(`ã‚¿ã‚¹ã‚¯ã‚’å¼•ãç¶™ãå…ƒã®åº—èˆ—åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹ï¼š${projects.join(' / ')}ï¼‰ã€‚\nâ€»ç©ºæ¬„ãªã‚‰å¼•ãç¶™ããªã—ã€‚`);
            if(source && projects.includes(source)){
                const copied = tasks.filter(t=>t.project===source);
                copied.forEach((t,i)=>{
                    const id = Date.now()+i;
                    const newTask = {
                        ...t,
                        id,
                        project:name,
                        order:getNextOrderForProject(name)
                    };
                    tasks.push(newTask);
                    addHistory(id,'ã‚³ãƒ”ãƒ¼',`åº—èˆ—ã€Œ${source}ã€ã‹ã‚‰å¼•ãç¶™ã`);
                });
                rebuildMaps();
            }
        }
        renderAllViews();
        renderStaff();
    }
    function deleteProject(){
        if(!isFullEdit()){
            alert('ã“ã®ãƒ¢ãƒ¼ãƒ‰ã§ã¯åº—èˆ—ã®å‰Šé™¤ã¯ã§ãã¾ã›ã‚“ã€‚');
            return;
        }
        if(projects.length<=1){
            alert('ã“ã‚Œä»¥ä¸Šåº—èˆ—ã‚’å‰Šé™¤ã§ãã¾ã›ã‚“ã€‚');
            return;
        }
        if(!confirm(`${currentProject} ã‚’å‰Šé™¤ã—ã¾ã™ã€‚é–¢é€£ã™ã‚‹ã‚¿ã‚¹ã‚¯ã‚‚ã™ã¹ã¦å‰Šé™¤ã•ã‚Œã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`)) return;
        tasks = tasks.filter(t=>t.project!==currentProject);
        rebuildMaps();
        projects = projects.filter(p=>p!==currentProject);
        if(kpiMap.has(currentProject)) kpiMap.delete(currentProject);
        projectColors.delete(currentProject);
        staffList = staffList.filter(s=>s.project!==currentProject);
        currentProject = projects[0];
        renderProjectSelect();
        applyProjectColor();
        renderAllViews();
        renderStaff();
    }

    function toggleProjectMenu(){
        const menu = document.getElementById('project-menu');
        menu.classList.toggle('open');
    }
    function menuAddProject(){
        toggleProjectMenu();
        addProject();
    }
    function menuDeleteProject(){
        toggleProjectMenu();
        deleteProject();
    }
    function changeProjectColor(){
        if(!isFullEdit()){
            alert('ã“ã®ãƒ¢ãƒ¼ãƒ‰ã§ã¯ã‚«ãƒ©ãƒ¼å¤‰æ›´ã¯ã§ãã¾ã›ã‚“ã€‚');
            return;
        }
        toggleProjectMenu();
        const current = projectColors.get(currentProject)||'#007aff';
        const c = prompt(`åº—èˆ—ã€Œ${currentProject}ã€ã®ã‚«ãƒ©ãƒ¼ï¼ˆ16é€²ã‚«ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ãªã©ï¼‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚\nä¾‹ï¼š#007aff\nç¾åœ¨ï¼š${current}`);
        if(!c) return;
        projectColors.set(currentProject,c);
        applyProjectColor();
    }
    function copyTasksBetweenProjects(){
        if(!isFullEdit()){
            alert('ã“ã®ãƒ¢ãƒ¼ãƒ‰ã§ã¯ã‚¿ã‚¹ã‚¯å¼•ãç¶™ãã¯ã§ãã¾ã›ã‚“ã€‚');
            return;
        }
        toggleProjectMenu();
        if(projects.length<2){
            alert('ä»–åº—èˆ—ãŒå­˜åœ¨ã—ã¾ã›ã‚“ã€‚');
            return;
        }
        const source = prompt(`ã‚¿ã‚¹ã‚¯ã‚’ã‚³ãƒ”ãƒ¼ã™ã‚‹å…ƒã®åº—èˆ—åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹ï¼š${projects.join(' / ')}ï¼‰ã€‚`);
        if(!source || !projects.includes(source)){
            alert('åº—èˆ—åãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚');
            return;
        }
        if(source===currentProject){
            alert('åŒã˜åº—èˆ—ã‹ã‚‰ã¯ã‚³ãƒ”ãƒ¼ã§ãã¾ã›ã‚“ã€‚');
            return;
        }
        const copied = tasks.filter(t=>t.project===source);
        if(!copied.length){
            alert('ã‚³ãƒ”ãƒ¼å…ƒã®åº—èˆ—ã«ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
            return;
        }
        copied.forEach((t,i)=>{
            const id = Date.now()+i;
            const newTask = {
                ...t,
                id,
                project:currentProject,
                order:getNextOrderForProject(currentProject)
            };
            tasks.push(newTask);
            addHistory(id,'ã‚³ãƒ”ãƒ¼',`åº—èˆ—ã€Œ${source}ã€ã‹ã‚‰å¼•ãç¶™ã`);
        });
        rebuildMaps();
        renderAllViews();
    }

    // ===== ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ =====
    function switchTab(e,id){
        document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
        e.target.classList.add('active');
        document.getElementById(id).classList.add('active');
        if(id==='integrated') renderIntegrated();
        if(id==='dashboard') renderDashboard();
        if(id==='calendar'){renderCalendar();renderDayTasks(null);}
        if(id==='tasks') renderTasks();
        if(id==='staff') renderStaff();
    }

    // ===== ã‚¿ã‚¹ã‚¯ãƒ¢ãƒ¼ãƒ€ãƒ« =====
    function openTaskModal(id=null){
        if(!isFullEdit()){
            alert('ã“ã®ãƒ¢ãƒ¼ãƒ‰ã§ã¯ã‚¿ã‚¹ã‚¯ã®è¿½åŠ ãƒ»ç·¨é›†ã¯ã§ãã¾ã›ã‚“ã€‚');
            return;
        }
        editingTaskId = id;
        const modal = document.getElementById('task-modal');
        const form = document.getElementById('task-form');
        form.reset();
        if(id){
            const t = getTaskById(id);
            if(!t) return;
            document.getElementById('task-modal-title').textContent = 'ã‚¿ã‚¹ã‚¯ã‚’ç·¨é›†';
            document.getElementById('task-name').value = t.name;
            document.getElementById('task-person').value = t.person;
            document.getElementById('task-start').value = t.start;
            document.getElementById('task-end').value = t.end;
            document.getElementById('task-status').value = t.status;
            document.getElementById('task-priority').value = t.priority;
            document.getElementById('task-level').value = String(t.level);
            updateParentOptions();
            document.getElementById('task-parent').value = t.parentId || '';
            document.getElementById('task-memo').value = t.memo || '';
        }else{
            document.getElementById('task-modal-title').textContent = 'ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ ';
            document.getElementById('task-level').value = '3';
            updateParentOptions();
        }
        modal.classList.add('show');
    }
    function closeTaskModal(){
        document.getElementById('task-modal').classList.remove('show');
        document.getElementById('task-form').reset();
        editingTaskId = null;
    }

    document.getElementById('task-form').addEventListener('submit', function(e){
        e.preventDefault();
        if(!isFullEdit()){
            alert('ã“ã®ãƒ¢ãƒ¼ãƒ‰ã§ã¯ã‚¿ã‚¹ã‚¯ã®ä¿å­˜ã¯ã§ãã¾ã›ã‚“ã€‚');
            return;
        }
        const level = parseInt(document.getElementById('task-level').value,10);
        const parentVal = document.getElementById('task-parent').value;
        const parentId = parentVal? Number(parentVal) : null;
        const data = {
            name: document.getElementById('task-name').value.trim(),
            person: document.getElementById('task-person').value.trim(),
            start: document.getElementById('task-start').value,
            end: document.getElementById('task-end').value,
            status: document.getElementById('task-status').value,
            priority: document.getElementById('task-priority').value,
            level,
            parentId,
            memo: document.getElementById('task-memo').value.trim()
        };

        if(editingTaskId){
            const t = getTaskById(editingTaskId);
            if(t){
                Object.assign(t, data);
                addHistory(editingTaskId,'ç·¨é›†','ã‚¿ã‚¹ã‚¯å†…å®¹ã‚’æ›´æ–°');
            }
        }else{
            const id = Date.now();
            const order = getNextOrderForProject(currentProject);
            const t = {
                id,
                project: currentProject,
                order,
                ...data
            };
            tasks.push(t);
            addHistory(id,'ä½œæˆ','æ–°è¦ã‚¿ã‚¹ã‚¯ä½œæˆ');
        }
        rebuildMaps();
        closeTaskModal();
        renderAllViews();
    });

    function updateParentOptions(){
        const level = parseInt(document.getElementById('task-level').value,10);
        const select = document.getElementById('task-parent');
        select.innerHTML = '<option value="">ãªã—</option>';
        getProjectTasks().forEach(t=>{
            if(t.level < level && t.id !== editingTaskId){
                const opt = document.createElement('option');
                opt.value = t.id;
                opt.textContent = `[Lv${t.level}] ${t.name}`;
                select.appendChild(opt);
            }
        });
    }

    // ===== ã‚¿ã‚¹ã‚¯ä¸€è¦§æç”» + ãƒ•ã‚£ãƒ«ã‚¿ + ä¸¦ã³æ›¿ãˆ =====
    function setStatusFilter(e,filter){
        statusFilter = filter;
        document.querySelectorAll('.filter-pill').forEach(btn=>btn.classList.remove('active'));
        e.target.classList.add('active');
        renderTasks();
    }

    function renderTasks(){
        const list = document.getElementById('task-list');
        let items;
        if(statusFilter==='all'){
            items = buildHierarchicalOrder(currentProject);
        }else{
            items = getProjectTasks().filter(t=>t.status===statusFilter);
        }
        if(!items.length){
            list.innerHTML = '<p style="font-size:12px;color:var(--text-sub);">ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“ã€‚å³ä¸‹ã®ï¼»ï¼‹ï¼½ã‹ã‚‰è¿½åŠ ã—ã¦ãã ã•ã„ã€‚</p>';
            return;
        }
        list.innerHTML = items.map(t=>{
            const indent = (t.level-1)*12;
            const childrenCount = getChildren(t.id).length;
            const history = historyMap.get(t.id) || [];
            const latestComment = (commentsMap.get(t.id)||[])[0];
            const canEdit = isFullEdit();
            return `
            <div class="task-item"
                 draggable="true"
                 ondragstart="handleDragStartList(event,${t.id})"
                 ondragover="handleDragOver(event)"
                 ondrop="handleDropList(event,${t.id})">
                <div class="task-main" onclick="toggleTaskBody(${t.id})">
                    <div class="task-left">
                        <div style="width:${indent}px;"></div>
                        <div class="task-level-dot"></div>
                        <div>
                            <div class="task-title">${t.name}</div>
                            <div class="task-meta">
                                <span>ğŸ‘¤ ${t.person}</span>
                                <span>ğŸ“… ${t.start}ã€œ${t.end}</span>
                                ${t.parentId? `<span>ğŸ“‚ è¦ª: ${getTaskById(t.parentId)?.name||'ä¸æ˜'}</span>`:''}
                            </div>
                        </div>
                    </div>
                    <div style="display:flex;flex-direction:column;align-items:flex-end;gap:2px;">
                        <span class="status-pill ${formatStatusClass(t.status)}">${t.status}</span>
                        <span class="toggle-icon">è©³ç´° â–¼</span>
                    </div>
                </div>
                <div class="task-body" id="task-body-${t.id}">
                    <div class="task-meta" style="margin-bottom:4px;">
                        <span>å„ªå…ˆåº¦ï¼š${t.priority}</span>
                        <span>ãƒ¬ãƒ™ãƒ«ï¼š${t.level}</span>
                        <span>å­ã‚¿ã‚¹ã‚¯ï¼š${childrenCount}ä»¶</span>
                        <span>å±¥æ­´ï¼š${history.length}ä»¶</span>
                    </div>
                    ${t.memo? `<p style="margin-top:4px;">${t.memo}</p>`:''}
                    ${latestComment? `<div style="margin-top:4px;font-size:11px;color:var(--text-sub);">ğŸ’¬ æœ€æ–°ã‚³ãƒ¡ãƒ³ãƒˆï¼š${latestComment.text}</div>`:''}
                    <div style="margin-top:6px;display:flex;gap:6px;flex-wrap:wrap;">
                        <button class="btn btn-secondary" onclick="event.stopPropagation();${canEdit?`openTaskModal(${t.id})`:`alert('ã“ã®ãƒ¢ãƒ¼ãƒ‰ã§ã¯ç·¨é›†ã§ãã¾ã›ã‚“ã€‚')`}">ç·¨é›†</button>
                        <button class="btn btn-secondary" onclick="event.stopPropagation();changeStatus(${t.id},'é€²è¡Œä¸­')">é€²è¡Œä¸­</button>
                        <button class="btn btn-secondary" onclick="event.stopPropagation();changeStatus(${t.id},'å®Œäº†')">å®Œäº†</button>
                        <button class="btn btn-danger" onclick="event.stopPropagation();${canEdit?`deleteTask(${t.id})`:`alert('ã“ã®ãƒ¢ãƒ¼ãƒ‰ã§ã¯å‰Šé™¤ã§ãã¾ã›ã‚“ã€‚')`}">å‰Šé™¤</button>
                    </div>
                </div>
            </div>`;
        }).join('');
    }

    function toggleTaskBody(id){
        const body = document.getElementById('task-body-'+id);
        if(!body) return;
        body.classList.toggle('open');
    }

    function changeStatus(id,newStatus){
        const t = getTaskById(id);
        if(!t) return;
        const old = t.status;
        t.status = newStatus;
        addHistory(id,'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´',`${old} â†’ ${newStatus}`);
        renderAllViews();
    }

    function deleteTask(id){
        if(!isFullEdit()){
            alert('ã“ã®ãƒ¢ãƒ¼ãƒ‰ã§ã¯å‰Šé™¤ã§ãã¾ã›ã‚“ã€‚');
            return;
        }
        if(!confirm('ã“ã®ã‚¿ã‚¹ã‚¯ã¨å­ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
        const projectTasks = getProjectTasks();
        const toDelete = new Set([id]);
        let changed = true;
        while(changed){
            changed = false;
            projectTasks.forEach(t=>{
                if(t.parentId && toDelete.has(t.parentId) && !toDelete.has(t.id)){
                    toDelete.add(t.id);
                    changed = true;
                }
            });
        }
        tasks = tasks.filter(t=>!toDelete.has(t.id));
        rebuildMaps();
        renderAllViews();
    }

    // ä¸¦ã³æ›¿ãˆç”¨ãƒ‰ãƒ©ãƒƒã‚°ï¼ˆã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆï¼‰
    function handleDragStartList(e,id){
        if(!isFullEdit()) return;
        draggedTaskId = id;
        e.dataTransfer.effectAllowed = 'move';
    }
    function handleDragOver(e){
        e.preventDefault();
        e.currentTarget.classList.add('drag-over');
    }
    function handleDropList(e,targetId){
        e.preventDefault();
        e.currentTarget.classList.remove('drag-over');
        if(!isFullEdit()) return;
        if(!draggedTaskId || draggedTaskId===targetId) return;
        const projTasks = getProjectTasks();
        const fromIndex = projTasks.findIndex(t=>t.id===draggedTaskId);
        const toIndex   = projTasks.findIndex(t=>t.id===targetId);
        if(fromIndex<0 || toIndex<0) return;
        const ordered = projTasks.slice();
        const [moved] = ordered.splice(fromIndex,1);
        ordered.splice(toIndex,0,moved);
        ordered.forEach((t,idx)=>{t.order = idx;});
        draggedTaskId = null;
        renderAllViews();
    }

    // ===== ä»Šæ—¥ã®ã‚¿ã‚¹ã‚¯ =====
    function extractTodayTasks(){
        const panel = document.getElementById('today-tasks-panel');
        const today = new Date();
        today.setHours(0,0,0,0);
        const data = getProjectTasks().filter(t=>{
            if(!t.start || !t.end) return false;
            const s = new Date(t.start);
            const e = new Date(t.end);
            s.setHours(0,0,0,0);
            e.setHours(0,0,0,0);
            return (today>=s && today<=e) || e.getTime()===today.getTime();
        }).sort((a,b)=>a.end.localeCompare(b.end));
        if(!data.length){
            panel.innerHTML = '<p class="today-empty">ä»Šæ—¥ã®ã‚¿ã‚¹ã‚¯ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
            return;
        }
        panel.innerHTML = `<div class="today-panel-list">
            ${data.map(t=>`
            <div style="padding:6px 8px;border-radius:10px;border:1px solid var(--border);background:#f9f9fb;">
                <div style="font-size:12px;font-weight:500;">${t.name}</div>
                <div style="font-size:11px;color:var(--text-sub);">ğŸ‘¤ ${t.person}ï½œ${shortDateLabelRange(t.start,t.end)}ï½œ${t.status}</div>
            </div>`).join('')}
        </div>`;
    }

    // ===== ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆï¼ˆæ—¥åˆ¥ãƒ˜ãƒƒãƒ€ãƒ¼ï¼‹ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒªã‚µã‚¤ã‚ºï¼‰ =====
    function printGantt(){
        window.print();
    }

    function renderIntegrated(){
        const projectTasks = getProjectTasks();
        const ganttEl = document.getElementById('integrated-gantt');
        if(!projectTasks.length){
            ganttEl.innerHTML = '<p style="font-size:12px;color:var(--text-sub);">ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
            return;
        }

        const roots = projectTasks
            .filter(t=>!t.parentId)
            .sort((a,b)=>(a.order ?? 0)-(b.order ?? 0));

        let html = `
        <div style="border:1px solid var(--border);border-radius:12px;overflow:auto;background:#fff;">
          <div style="min-width:900px;">
            <!-- ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œï¼šå·¦ã«ã€Œã‚¿ã‚¹ã‚¯/æ‹…å½“ã€ã€å³ã«æ—¥åˆ¥ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ -->
            <div style="display:grid;grid-template-columns:260px 1fr;border-bottom:1px solid var(--border);background:#f9f9fb;">
              <div style="padding:4px 4px 4px 8px;font-size:11px;color:var(--text-sub);">
                ã‚¿ã‚¹ã‚¯ / æ‹…å½“
              </div>
              <div style="display:flex;width:100%;font-size:9px;color:var(--text-sub);border-left:1px solid var(--border);">
    `;

        const dayWidth = 100 / GANTT_TOTAL_DAYS;
        for(let i=0; i<GANTT_TOTAL_DAYS; i++){
            const d = new Date(GANTT_START);
            d.setDate(d.getDate()+i);
            const label = `${d.getMonth()+1}/${d.getDate()}`;
            const wd = WEEKDAYS[d.getDay()];
            html += `
          <div style="flex:0 0 ${dayWidth}%;padding:2px 0;border-right:1px solid #e5e5ea;text-align:center;box-sizing:border-box;">
            ${label}<br><span style="font-size:8px;">${wd}</span>
          </div>`;
        }

        html += `
              </div>
            </div>
    `;

        function barPos(t){
            const s0 = t.start ? new Date(t.start) : GANTT_START;
            const e0 = t.end   ? new Date(t.end)   : s0;

            let s = new Date(Math.max(GANTT_START, s0));
            let e = new Date(Math.min(GANTT_END,   e0));
            if(e < s) e = new Date(s);

            const startOffset = Math.round((s - GANTT_START)/MS_DAY);
            const duration    = Math.max(1, Math.round((e - s)/MS_DAY)+1);

            const left  = Math.min(100, (startOffset / GANTT_TOTAL_DAYS) * 100);
            const width = Math.min(100, (duration    / GANTT_TOTAL_DAYS) * 100);

            return {left, width};
        }

        function renderNode(task, depth){
            const children = getChildren(task.id);
            const expanded = expandedSet.has(task.id);
            const pos = barPos(task);
            const dateLabel = (task.start && task.end) ? shortDateLabelRange(task.start,task.end) : '';
            const barLabel = `${dateLabel}${(dateLabel && task.person)?'ï½œ':''}${task.person || ''}`;

            html += `
            <div class="tree-row" id="gantt-row-${task.id}">
              <div class="tree-cell">
                <div style="width:${depth*14}px;"></div>
                ${children.length
                    ? `<button class="btn btn-ghost" style="padding:2px 6px;font-size:10px;" onclick="toggleExpand(${task.id})">${expanded?'âˆ’':'ï¼‹'}</button>`
                    : `<div style="width:24px;"></div>`
                }
                <div style="display:flex;flex-direction:column;">
                    <div style="font-weight:500;font-size:12px;">${task.name}</div>
                    <div style="font-size:10px;color:var(--text-sub);">ğŸ‘¤ ${task.person || 'æœªè¨­å®š'}</div>
                </div>
              </div>
              <div class="gantt-cell">
                <div class="gantt-track"></div>
                <div class="gantt-bar ${formatStatusClass(task.status)}"
                     style="left:${pos.left}%;width:${pos.width}%;background:var(--accent);"
                     onmousedown="startBarDrag(event,${task.id})">
                    ${barLabel}
                </div>
              </div>
            </div>`;

            if(expanded && children.length){
                children
                    .sort((a,b)=>(a.order ?? 0)-(b.order ?? 0))
                    .forEach(c=>renderNode(c, depth+1));
            }
        }

        roots.forEach(r=>{
            if(!expandedSet.has(r.id)) expandedSet.add(r.id);
            renderNode(r,0);
        });

        html += `
          </div>
        </div>
    `;

        ganttEl.innerHTML = html;
    }

    function toggleExpand(id){
        if(expandedSet.has(id)) expandedSet.delete(id); else expandedSet.add(id);
        renderIntegrated();
    }
    function expandAll(){
        getProjectTasks().forEach(t=>expandedSet.add(t.id));
        renderIntegrated();
    }
    function collapseAll(){
        expandedSet.clear();
        renderIntegrated();
    }

    // â˜…â˜…â˜… ä¿®æ­£ç‰ˆï¼šã‚¬ãƒ³ãƒˆãƒãƒ¼ã®ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒªã‚µã‚¤ã‚ºï¼ˆå¹´ã‚’ã¾ãŸãæœŸé–“ã‚’æ½°ã•ãªã„ï¼‰â˜…â˜…â˜…
    function startBarDrag(event,id){
        if(!isFullEdit()) return;
        event.preventDefault();
        const t = getTaskById(id);
        if(!t) return;
        const barEl = event.currentTarget;
        const track = barEl.parentElement.querySelector('.gantt-track');
        if(!track) return;

        const trackRect = track.getBoundingClientRect();
        const barRect = barEl.getBoundingClientRect();

        const rel = (event.clientX - barRect.left)/barRect.width;
        let mode = 'move';
        if(rel > 0.7) mode = 'resizeEnd';
        else if(rel < 0.3) mode = 'resizeStart';

        const pxPerDay = trackRect.width / GANTT_TOTAL_DAYS;

        ganttDrag = {
            id,
            task: t,
            barEl,
            trackRect,
            type: mode,
            originalStart: t.start ? new Date(t.start) : new Date(GANTT_START),
            originalEnd:   t.end   ? new Date(t.end)   : (t.start ? new Date(t.start) : new Date(GANTT_START)),
            previewStart: null,
            previewEnd: null,
            startX: event.clientX,
            pxPerDay
        };

        document.addEventListener('mousemove',onGanttDrag);
        document.addEventListener('mouseup',endGanttDrag);
    }

    function onGanttDrag(e){
        if(!ganttDrag) return;
        const {barEl,trackRect,type,originalStart,originalEnd,task,startX,pxPerDay} = ganttDrag;

        const deltaX = e.clientX - startX;
        const deltaDays = Math.round(deltaX / pxPerDay);

        let newStart = new Date(originalStart);
        let newEnd   = new Date(originalEnd);

        if(type === 'move'){
            newStart.setDate(newStart.getDate() + deltaDays);
            newEnd.setDate(newEnd.getDate() + deltaDays);
        }else if(type === 'resizeStart'){
            newStart.setDate(newStart.getDate() + deltaDays);
            if(newStart > newEnd) newStart = new Date(newEnd);
        }else{
            newEnd.setDate(newEnd.getDate() + deltaDays);
            if(newEnd < newStart) newEnd = new Date(newStart);
        }

        ganttDrag.previewStart = newStart;
        ganttDrag.previewEnd   = newEnd;

        let dispStart = new Date(Math.max(GANTT_START, newStart));
        let dispEnd   = new Date(Math.min(GANTT_END,   newEnd));
        if(dispEnd < dispStart) dispEnd = new Date(dispStart);

        const startOffset = Math.round((dispStart - GANTT_START)/MS_DAY);
        const durationDays = Math.max(1, Math.round((dispEnd - dispStart)/MS_DAY)+1);
        const left = Math.min(100,(startOffset/GANTT_TOTAL_DAYS)*100);
        const width = Math.min(100,(durationDays/GANTT_TOTAL_DAYS)*100);

        barEl.style.left = left+'%';
        barEl.style.width = width+'%';

        const label = shortDateLabelRange(newStart,newEnd) + (task && task.person ? `ï½œ${task.person}` : '');
        barEl.textContent = label;
    }

    function endGanttDrag(){
        if(!ganttDrag){
            document.removeEventListener('mousemove',onGanttDrag);
            document.removeEventListener('mouseup',endGanttDrag);
            return;
        }
        const {id,previewStart,previewEnd} = ganttDrag;
        if(previewStart && previewEnd){
            const t = getTaskById(id);
            if(t){
                t.start = toISODate(previewStart);
                t.end   = toISODate(previewEnd);
                addHistory(id,'æœŸé–“å¤‰æ›´','ã‚¬ãƒ³ãƒˆä¸Šã§ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦æœŸé–“ã‚’å¤‰æ›´');
            }
        }
        ganttDrag = null;
        document.removeEventListener('mousemove',onGanttDrag);
        document.removeEventListener('mouseup',endGanttDrag);
        renderAllViews();
    }

    // ===== ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ & KPI =====
    function renderDashboard(){
        const metrics = document.getElementById('metrics');
        const projectTasks = getProjectTasks();
        const total = projectTasks.length;
        const completed = projectTasks.filter(t=>t.status==='å®Œäº†').length;
        const inProgress = projectTasks.filter(t=>t.status==='é€²è¡Œä¸­').length;
        const notStarted = total - completed - inProgress;
        const rate = total? Math.round(completed/total*100):0;

        metrics.innerHTML = `
        <div class="metric-card">
            <div class="metric-label">ç·ã‚¿ã‚¹ã‚¯æ•°</div>
            <div class="metric-value">${total}</div>
            <div class="metric-sub">å®Œäº† ${completed} / é€²è¡Œä¸­ ${inProgress}</div>
        </div>
        <div class="metric-card">
            <div class="metric-label">å®Œäº†ç‡</div>
            <div class="metric-value">${rate}%</div>
            <div class="metric-sub">æœªç€æ‰‹ ${notStarted}ä»¶</div>
        </div>
        <div class="metric-card">
            <div class="metric-label">ä»Šæ—¥ã®ã‚¿ã‚¹ã‚¯</div>
            <div class="metric-value">${countTodayTasks()}</div>
            <div class="metric-sub">ä»Šæ—¥ã®é–‹å§‹ã€œçµ‚äº†ã«å«ã¾ã‚Œã‚‹ã‚¿ã‚¹ã‚¯æ•°</div>
        </div>`;

        const levelDiv = document.getElementById('level-progress');
        let html = '';
        for(let lv=1; lv<=10; lv++){
            const lvTasks = projectTasks.filter(t=>t.level===lv);
            if(!lvTasks.length) continue;
            const c = lvTasks.filter(t=>t.status==='å®Œäº†').length;
            const r = Math.round(c/lvTasks.length*100);
            html += `
            <div style="margin-bottom:8px;">
                <div style="display:flex;justify-content:space-between;font-size:11px;">
                    <span>Lv${lv}</span><span>${c}/${lvTasks.length}ï¼ˆ${r}%ï¼‰</span>
                </div>
                <div style="height:8px;background:#f2f2f7;border-radius:999px;overflow:hidden;">
                    <div style="height:100%;width:${r}%;background:var(--accent);"></div>
                </div>
            </div>`;
        }
        levelDiv.innerHTML = html || '<p style="font-size:12px;color:var(--text-sub);">ãƒ¬ãƒ™ãƒ«åˆ¥ã®ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>';

        const kpi = getKPI();
        const flInput = document.getElementById('kpi-fl');
        if(flInput){
            flInput.value = kpi.fl || '';
            document.getElementById('kpi-cost').value = kpi.costRate || '';
            document.getElementById('kpi-labor').value = kpi.laborRate || '';
            document.getElementById('kpi-message').textContent = '';
            updateKPISummary();
        }
    }

    function countTodayTasks(){
        const today = new Date();
        today.setHours(0,0,0,0);
        return getProjectTasks().filter(t=>{
            if(!t.start || !t.end) return false;
            const s = new Date(t.start);
            const e = new Date(t.end);
            s.setHours(0,0,0,0);
            e.setHours(0,0,0,0);
            return (today>=s && today<=e) || e.getTime()===today.getTime();
        }).length;
    }

    function saveKPI(){
        const fl = document.getElementById('kpi-fl').value;
        const cost = document.getElementById('kpi-cost').value;
        const labor = document.getElementById('kpi-labor').value;
        const kpi = getKPI();
        kpi.fl = fl;
        kpi.costRate = cost;
        kpi.laborRate = labor;
        document.getElementById('kpi-message').textContent = 'ä¿å­˜ã—ã¾ã—ãŸ';
        updateKPISummary();
    }

    function updateKPISummary(){
        const kpi = getKPI();
        const el = document.getElementById('kpi-summary');
        if(!el) return;
        if(!kpi.fl && !kpi.costRate && !kpi.laborRate){
            el.textContent = 'ã¾ã KPIãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚';
        }else{
            el.textContent = `FLï¼š${kpi.fl||'-'}ï¼… ï¼ åŸä¾¡ç‡ï¼š${kpi.costRate||'-'}ï¼… ï¼ äººä»¶è²»ç‡ï¼š${kpi.laborRate||'-'}ï¼…`;
        }
    }

    // ===== ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ =====
    function renderCalendar(){
        const grid = document.getElementById('calendar-grid');
        const year = currentMonth.getFullYear();
        const month = currentMonth.getMonth();
        const first = new Date(year,month,1);
        const last = new Date(year,month+1,0);
        const startDay = first.getDay();
        const today = new Date();
        const projectTasks = getProjectTasks();

        document.getElementById('calendar-month-label').textContent =
            `${year}å¹´ ${month+1}æœˆ`;

        let cells = '';
        const weekdays = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'];
        weekdays.forEach(d=>{
            cells += `<div class="calendar-cell" style="background:#f9f9fb;font-weight:600;">${d}</div>`;
        });
        for(let i=0;i<startDay;i++){
            cells += `<div class="calendar-cell" style="background:#f9f9fb;"></div>`;
        }
        for(let d=1; d<=last.getDate(); d++){
            const dateObj = new Date(year,month,d);
            const isWeekend = dateObj.getDay()===0 || dateObj.getDay()===6;
            const isToday = dateObj.toDateString()===today.toDateString();
            const dateStr = dateObj.toISOString().split('T')[0];
            const dayTasks = projectTasks.filter(t=>{
                if(!t.start || !t.end) return false;
                const s = new Date(t.start);
                const e = new Date(t.end);
                s.setHours(0,0,0,0);
                e.setHours(0,0,0,0);
                return dateObj>=s && dateObj<=e;
            });

            cells += `
            <div class="calendar-cell ${isWeekend?'weekend':''} ${isToday?'today':''}"
                 onclick="renderDayTasks('${dateStr}')">
                <div class="calendar-date">${d}</div>
                ${dayTasks.slice(0,3).map(t=>`
                <div class="calendar-task-item">
                    <span class="calendar-task-dot"></span>${t.name}
                </div>`).join('')}
                ${dayTasks.length>3? `<div style="font-size:10px;color:var(--text-sub);">ä»–${dayTasks.length-3}ä»¶</div>`:''}
            </div>`;
        }
        grid.innerHTML = cells;
    }

    function changeMonth(diff){
        currentMonth.setMonth(currentMonth.getMonth()+diff);
        renderCalendar();
        renderDayTasks(null);
    }
    function goToToday(){
        currentMonth = new Date();
        renderCalendar();
        const todayStr = new Date().toISOString().split('T')[0];
        renderDayTasks(todayStr);
    }
    function renderDayTasks(dateStr){
        const box = document.getElementById('day-task-list');
        if(!dateStr){
            box.innerHTML = '<p style="font-size:12px;color:var(--text-sub);">æ—¥ä»˜ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€ãã®æ—¥ã®ã‚¿ã‚¹ã‚¯ã¨ãƒ¡ãƒ¢æ¬„ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>';
            return;
        }
        const dateObj = new Date(dateStr);
        const projectTasks = getProjectTasks();
        const list = projectTasks.filter(t=>{
            if(!t.start || !t.end) return false;
            const s = new Date(t.start);
            const e = new Date(t.end);
            s.setHours(0,0,0,0);
            e.setHours(0,0,0,0);
            return dateObj>=s && dateObj<=e;
        }).sort((a,b)=>a.start.localeCompare(b.start));
        if(!list.length){
            box.innerHTML = `<p style="font-size:12px;color:var(--text-sub);">${dateStr} ã®ã‚¿ã‚¹ã‚¯ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
            <div class="form-group" style="margin-top:8px;">
                <label>å…­æ›œãƒ»é–‹é‹æ—¥ãƒ»å‰æ—¥ãƒ»ä¸æˆå°±æ—¥ãƒ¡ãƒ¢ï¼ˆæ‰‹å…¥åŠ›ï¼‰</label>
                <textarea rows="2" placeholder="ä¾‹ï¼šå¤§å®‰ï¼å¤©èµ¦æ—¥ï¼ä¸€ç²’ä¸‡å€æ—¥ ãªã©è‡ªç”±ã«ãƒ¡ãƒ¢"></textarea>
            </div>`;
            return;
        }
        box.innerHTML = `
        <div style="margin-top:6px;">
            <div style="font-size:12px;font-weight:600;margin-bottom:4px;">${dateStr} ã®ã‚¿ã‚¹ã‚¯</div>
            ${list.map(t=>`
            <div style="padding:4px 6px;border-radius:10px;border:1px solid var(--border);margin-bottom:4px;font-size:11px;background:#fff;">
                <div style="font-weight:500;">${t.name}</div>
                <div style="color:var(--text-sub);">ğŸ‘¤ ${t.person}ï½œ${shortDateLabelRange(t.start,t.end)}ï½œ${t.status}</div>
            </div>`).join('')}
            <div class="form-group" style="margin-top:8px;">
                <label>å…­æ›œãƒ»é–‹é‹æ—¥ãƒ»å‰æ—¥ãƒ»ä¸æˆå°±æ—¥ãƒ¡ãƒ¢ï¼ˆæ‰‹å…¥åŠ›ï¼‰</label>
                <textarea rows="2" placeholder="ä¾‹ï¼šå¤§å®‰ï¼å¤©èµ¦æ—¥ï¼ä¸€ç²’ä¸‡å€æ—¥ ãªã©è‡ªç”±ã«ãƒ¡ãƒ¢"></textarea>
            </div>
        </div>`;
    }

    // ===== CSV å…¥å‡ºåŠ› =====
    function exportToCSV(){
        const projectTasks = getProjectTasks();
        if(!projectTasks.length){
            alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
            return;
        }
        let csv = 'ãƒ¬ãƒ™ãƒ«,è¦ªã‚¿ã‚¹ã‚¯å,ã‚¿ã‚¹ã‚¯å,æ‹…å½“è€…,é–‹å§‹æ—¥,çµ‚äº†æ—¥,ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹,å„ªå…ˆåº¦,ãƒ¡ãƒ¢\n';
        projectTasks.forEach(t=>{
            const parentName = t.parentId? (getTaskById(t.parentId)?.name||'') : '';
            const row = [
                t.level,
                parentName,
                t.name,
                t.person,
                t.start,
                t.end,
                t.status,
                t.priority,
                t.memo||''
            ].map(v=>`"${(v||'').replace(/"/g,'""')}"`).join(',');
            csv += row + '\n';
        });
        const blob = new Blob(['\uFEFF'+csv], {type:'text/csv;charset=utf-8;'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `${currentProject}_ã‚¿ã‚¹ã‚¯ä¸€è¦§_${new Date().toISOString().split('T')[0]}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(a.href);
    }

    function importFromCSV(e){
        if(!isFullEdit()){
            alert('ã“ã®ãƒ¢ãƒ¼ãƒ‰ã§ã¯ã‚¤ãƒ³ãƒãƒ¼ãƒˆã§ãã¾ã›ã‚“ã€‚');
            e.target.value = '';
            return;
        }
        const file = e.target.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = function(evt){
            const text = evt.target.result;
            const lines = text.split(/\r?\n/).filter(l=>l.trim());
            if(lines.length<=1){
                alert('æœ‰åŠ¹ãªCSVã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚');
                return;
            }
            const header = lines[0].split(',');
            if(header.length<3){
                alert('ãƒ˜ãƒƒãƒ€ãƒ¼è¡ŒãŒä¸æ­£ã§ã™ã€‚');
                return;
            }
            const newTasks = [];
            const nameToIdMap = new Map();
            for(let i=1;i<lines.length;i++){
                const cols = parseCSVLine(lines[i]);
                if(!cols.length) continue;
                const level = parseInt(cols[0]||'3',10);
                const parentName = cols[1]||'';
                const name = cols[2]||'';
                if(!name) continue;
                const t = {
                    id: Date.now()+i,
                    project: currentProject,
                    order: getNextOrderForProject(currentProject),
                    level: isNaN(level)?3:Math.min(Math.max(level,1),10),
                    parentId: null,
                    name,
                    person: cols[3]||'',
                    start: cols[4]||'',
                    end: cols[5]||'',
                    status: cols[6]||'æœªç€æ‰‹',
                    priority: cols[7]||'ä¸­',
                    memo: cols[8]||''
                };
                newTasks.push({t,parentName});
                nameToIdMap.set(name,t.id);
            }
            newTasks.forEach(nt=>{
                if(nt.parentName && nameToIdMap.has(nt.parentName)){
                    nt.t.parentId = nameToIdMap.get(nt.parentName);
                }
                tasks.push(nt.t);
                addHistory(nt.t.id,'CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ','CSVã‹ã‚‰è¿½åŠ ');
            });
            rebuildMaps();
            renderAllViews();
            alert(`CSVã‹ã‚‰${newTasks.length}ä»¶ã®ã‚¿ã‚¹ã‚¯ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚`);
        };
        reader.readAsText(file,'utf-8');
        e.target.value = '';
    }

    function parseCSVLine(line){
        const result = [];
        let current = '';
        let inQuotes = false;
        for(let i=0;i<line.length;i++){
            const c = line[i];
            if(c==='"'){
                if(inQuotes && line[i+1]==='"'){
                    current+='"';i++;
                }else{
                    inQuotes = !inQuotes;
                }
            }else if(c===',' && !inQuotes){
                result.push(current);
                current = '';
            }else{
                current+=c;
            }
        }
        result.push(current);
        return result;
    }

    // ===== ã‚¹ã‚¿ãƒƒãƒ•åç°¿ =====
    function getProjectStaff(){
        return staffList.filter(s=>s.project===currentProject);
    }
    function renderStaff(){
        const tbody = document.getElementById('staff-list');
        if(!tbody) return;
        const list = getProjectStaff();
        if(!list.length){
            tbody.innerHTML = `<tr><td colspan="4" style="font-size:12px;color:var(--text-sub);padding:8px 4px;">ã‚¹ã‚¿ãƒƒãƒ•ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</td></tr>`;
            return;
        }
        tbody.innerHTML = list.map(s=>`
            <tr>
                <td>${s.name}</td>
                <td>${s.role||''}</td>
                <td>${s.contact||''}</td>
                <td>
                    <button class="btn btn-ghost" style="font-size:11px;padding:4px 8px;"
                        onclick="${isFullEdit()?`deleteStaff(${s.id})`:`alert('ã“ã®ãƒ¢ãƒ¼ãƒ‰ã§ã¯å‰Šé™¤ã§ãã¾ã›ã‚“ã€‚')`}">å‰Šé™¤</button>
                </td>
            </tr>
        `).join('');
    }
    function addStaff(e){
        e.preventDefault();
        if(!isFullEdit()){
            alert('ã“ã®ãƒ¢ãƒ¼ãƒ‰ã§ã¯ã‚¹ã‚¿ãƒƒãƒ•ã®è¿½åŠ ã¯ã§ãã¾ã›ã‚“ã€‚');
            return;
        }
        const nameEl = document.getElementById('staff-name');
        const roleEl = document.getElementById('staff-role');
        const contactEl = document.getElementById('staff-contact');
        const name = nameEl.value.trim();
        if(!name){
            alert('ã‚¹ã‚¿ãƒƒãƒ•åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
            return;
        }
        staffList.push({
            id: Date.now(),
            project: currentProject,
            name,
            role: roleEl.value.trim(),
            contact: contactEl.value.trim()
        });
        nameEl.value = '';
        roleEl.value = '';
        contactEl.value = '';
        renderStaff();
    }
    function deleteStaff(id){
        if(!isFullEdit()){
            alert('ã“ã®ãƒ¢ãƒ¼ãƒ‰ã§ã¯å‰Šé™¤ã§ãã¾ã›ã‚“ã€‚');
            return;
        }
        if(!confirm('ã“ã®ã‚¹ã‚¿ãƒƒãƒ•ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
        staffList = staffList.filter(s=>s.id!==id);
        renderStaff();
    }

    // ===== å…¨ãƒ“ãƒ¥ãƒ¼å†æç”» =====
    function renderAllViews(){
        projectLabel();
        renderTasks();
        renderIntegrated();
        renderDashboard();
        renderCalendar();
        extractTodayTasks();
    }

    // ===== ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ï¼ˆãƒ©ã‚¾ãƒ¼ãƒŠå·å´ï¼š2025/10/20ã€œ2026/3/31ï¼‰ =====
    function loadSample(){
        if(tasks.length) return;
        const base = [
            {level:1,parent:null,name:'ãƒ©ã‚¾ãƒ¼ãƒŠå·å´åº—ã‚ªãƒ¼ãƒ—ãƒ³ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ',person:'ç§‹å±±',start:'2025-10-20',end:'2026-03-31',status:'é€²è¡Œä¸­',priority:'é«˜'},
            {level:2,parent:'ãƒ©ã‚¾ãƒ¼ãƒŠå·å´åº—ã‚ªãƒ¼ãƒ—ãƒ³ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ',name:'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨­è¨ˆãƒ»å…¨ä½“è¨ˆç”»',person:'ç§‹å±±',start:'2025-10-20',end:'2025-11-15',status:'é€²è¡Œä¸­',priority:'é«˜'},
            {level:2,parent:'ãƒ©ã‚¾ãƒ¼ãƒŠå·å´åº—ã‚ªãƒ¼ãƒ—ãƒ³ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ',name:'ãƒ‡ãƒ™ãƒ­ãƒƒãƒ‘ãƒ¼ãƒ»å¥‘ç´„é–¢é€£',person:'ç«¹ä¹‹å†…',start:'2025-10-20',end:'2025-12-15',status:'é€²è¡Œä¸­',priority:'é«˜'},
            {level:2,parent:'ãƒ©ã‚¾ãƒ¼ãƒŠå·å´åº—ã‚ªãƒ¼ãƒ—ãƒ³ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ',name:'æ¡ç”¨ãƒ»äººå“¡ãƒ»æ•™è‚²',person:'ç§‹å±±/å¶Œç”°',start:'2025-11-01',end:'2026-01-31',status:'æœªç€æ‰‹',priority:'é«˜'},
            {level:2,parent:'ãƒ©ã‚¾ãƒ¼ãƒŠå·å´åº—ã‚ªãƒ¼ãƒ—ãƒ³ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ',name:'ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ»ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ãƒ»ä»•çµ„ã¿',person:'å¶Œç”°ãƒ»å¤ç›®',start:'2025-12-01',end:'2026-02-29',status:'æœªç€æ‰‹',priority:'ä¸­'},
            {level:2,parent:'ãƒ©ã‚¾ãƒ¼ãƒŠå·å´åº—ã‚ªãƒ¼ãƒ—ãƒ³ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ',name:'ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°ãƒ»è²©ä¿ƒãƒ»ãƒ–ãƒ©ãƒ³ãƒ‡ã‚£ãƒ³ã‚°',person:'è‰æŸ³',start:'2025-12-15',end:'2026-03-15',status:'æœªç€æ‰‹',priority:'ä¸­'}
        ];
        const nameId = new Map();
        base.forEach((b,i)=>{
            const id = Date.now()+i;
            const t = {
                id,
                project:'ãƒ©ã‚¾ãƒ¼ãƒŠå·å´åº—',
                order: taskOrderCounter++,
                level:b.level,
                parentId:null,
                name:b.name,
                person:b.person,
                start:b.start,
                end:b.end,
                status:b.status,
                priority:b.priority,
                memo:b.memo || ''
            };
            tasks.push(t);
            nameId.set(b.name,id);
        });
        tasks.forEach(t=>{
            const baseItem = base.find(b=>b.name===t.name);
            if(baseItem && baseItem.parent && nameId.has(baseItem.parent)){
                t.parentId = nameId.get(baseItem.parent);
            }
        });
        rebuildMaps();
    }

    // ===== åˆæœŸåŒ– =====
    renderProjectSelect();
    applyProjectColor();
    loadSample();
    setGanttYear(2025);
    const ys = document.getElementById('gantt-year-select');
    if(ys) ys.value = '2025';
    updatePermissionUI();
    renderAllViews();
    renderStaff();
</script>
</body>
</html>
