<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>I-STYLE åº—èˆ—ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ v9.1ï¼ˆã‚¬ãƒ³ãƒˆæ”¹å–„ç‰ˆï¼‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f5f5f7;
      padding: 16px;
      color: #222;
    }

    .app-shell {
      max-width: 1400px;
      margin: 0 auto;
      background: #ffffff;
      border-radius: 24px;
      box-shadow: 0 24px 60px rgba(0, 0, 0, 0.12);
      padding: 20px 20px 28px;
    }

    .app-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
      gap: 12px;
    }

    .title-block h1 {
      font-size: 20px;
      font-weight: 700;
      letter-spacing: 0.05em;
    }

    .title-block span {
      display: inline-block;
      margin-top: 4px;
      font-size: 11px;
      color: #999;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      background: #f2f2f7;
      font-size: 11px;
      color: #666;
      white-space: nowrap;
    }

    .chip-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #34c759;
      box-shadow: 0 0 0 4px rgba(52, 199, 89, 0.2);
    }

    .tabs {
      display: flex;
      gap: 8px;
      margin-top: 16px;
      border-bottom: 1px solid #ececec;
      padding-bottom: 4px;
      overflow-x: auto;
    }

    .tab {
      padding: 6px 14px 10px;
      border-radius: 999px 999px 0 0;
      font-size: 13px;
      cursor: pointer;
      color: #555;
      background: transparent;
      border: none;
      outline: none;
      transition: all 0.2s ease;
      white-space: nowrap;
    }

    .tab.active {
      background: #f5f5f7;
      color: #007aff;
      font-weight: 600;
      box-shadow: 0 0 0 1px rgba(0, 0, 0, 0.04);
    }

    .tab-content {
      margin-top: 18px;
    }

    /* ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒãƒ¼ */
    .control-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }

    .control-left,
    .control-right {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .select,
    .btn {
      appearance: none;
      border-radius: 999px;
      border: 1px solid #d2d2d7;
      font-size: 12px;
      padding: 6px 10px;
      background: #f9f9fb;
      color: #333;
      cursor: pointer;
      outline: none;
      transition: all 0.15s ease;
      white-space: nowrap;
    }

    .select:focus,
    .btn:focus {
      box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.15);
      border-color: #007aff;
    }

    .btn-primary {
      background: #007aff;
      color: #fff;
      border-color: #007aff;
    }

    .btn-primary:hover {
      background: #005ecb;
      border-color: #005ecb;
    }

    .btn-ghost {
      background: transparent;
      border: none;
      color: #666;
      padding-inline: 6px;
    }

    .btn-ghost:hover {
      background: rgba(0, 0, 0, 0.04);
    }

    /* éšå±¤ï¼‹ã‚¬ãƒ³ãƒˆãƒ“ãƒ¥ãƒ¼æ  */
    .tree-gantt-shell {
      margin-top: 4px;
      border-radius: 18px;
      border: 1px solid #e4e4e7;
      background: #fbfbfd;
      overflow: hidden;
    }

    .tree-gantt-toolbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 12px;
      border-bottom: 1px solid #e5e5ea;
      font-size: 11px;
      background: linear-gradient(90deg, #f9fafb, #f3f4f6);
      gap: 8px;
      flex-wrap: wrap;
    }

    .tree-gantt-toolbar-left {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .badge {
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      background: #e5f2ff;
      color: #007aff;
      font-weight: 600;
      white-space: nowrap;
    }

    .tree-gantt-toolbar-right {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    /* ãƒ¡ã‚¤ãƒ³ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼ˆå·¦ï¼šãƒ„ãƒªãƒ¼ã€å³ï¼šã‚¬ãƒ³ãƒˆï¼‰ */
    .gantt-grid {
      display: grid;
      grid-template-columns: 280px minmax(520px, 1fr);
      border-top: 1px solid #ececec;
      font-size: 12px;
    }

    .tree-column {
      border-right: 1px solid #ececec;
      background: #ffffff;
    }

    .gantt-column {
      background: #ffffff;
    }

    .tree-header {
      padding: 6px 10px;
      font-weight: 600;
      color: #555;
      background: #f9fafb;
      border-bottom: 1px solid #ececec;
      font-size: 11px;
    }

    .tree-rows {
      max-height: 460px;
      overflow-y: auto;
    }

    .tree-row {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-bottom: 1px solid #f0f0f0;
      background: #fff;
    }

    .tree-row:hover {
      background: #f5f9ff;
    }

    .tree-toggle {
      width: 16px;
      height: 16px;
      border-radius: 4px;
      border: 1px solid #d0d0d7;
      font-size: 10px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      background: #fff;
      color: #555;
      flex-shrink: 0;
    }

    .tree-toggle.empty {
      border: none;
      background: transparent;
      cursor: default;
    }

    .level-badge {
      padding: 1px 6px;
      font-size: 10px;
      border-radius: 999px;
      background: #eef2ff;
      color: #4f46e5;
      flex-shrink: 0;
    }

    .task-title {
      font-weight: 500;
      font-size: 12px;
    }

    .task-person {
      font-size: 11px;
      color: #666;
      margin-left: 6px;
    }

    .task-status {
      margin-left: auto;
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      background: #f2f2f7;
      color: #555;
      white-space: nowrap;
    }

    /* ã‚¬ãƒ³ãƒˆå´ */
    .gantt-wrapper {
      max-height: 460px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .gantt-scroll {
      overflow-x: auto;
      overflow-y: auto;
      position: relative;
    }

    .gantt-inner {
      min-width: 720px;
    }

    .gantt-header-days {
      position: sticky;
      top: 0;
      display: flex;
      align-items: stretch;
      height: 38px;
      font-size: 9px;
      color: #555;
      background: #fdfdfd;
      border-bottom: 1px solid #ececec;
      z-index: 2;
    }

    .gantt-day {
      min-width: 32px;
      max-width: 32px;
      border-left: 1px solid #f0f0f0;
      padding-top: 2px;
      text-align: center;
      flex-shrink: 0;
    }

    .gantt-day:first-child {
      border-left: none;
    }

    .gantt-day span {
      display: block;
      line-height: 1.2;
    }

    .gantt-day .dow {
      font-size: 8px;
      color: #999;
    }

    .gantt-day.weekend {
      background: #faf5ff;
    }

    .gantt-day.today {
      background: #fff4d0;
      box-shadow: inset 0 0 0 1px #ff9f0a;
      font-weight: 600;
    }

    .gantt-rows {
      position: relative;
    }

    .gantt-row {
      height: 36px;
      border-bottom: 1px solid #f0f0f0;
      position: relative;
    }

    .gantt-row-track {
      position: absolute;
      inset: 8px 0;
      background: #f2f2f7;
      border-radius: 999px;
      overflow: hidden;
    }

    .gantt-bar {
      position: absolute;
      top: 0;
      bottom: 0;
      border-radius: 999px;
      background: linear-gradient(135deg, #007aff, #5856d6);
      color: #ffffff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      padding: 0 8px;
      box-shadow: 0 6px 14px rgba(0, 0, 0, 0.18);
      cursor: grab;
      user-select: none;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .gantt-bar.dragging {
      opacity: 0.9;
      cursor: grabbing;
      box-shadow: 0 10px 24px rgba(0, 0, 0, 0.25);
    }

    .empty-hint {
      padding: 32px;
      text-align: center;
      color: #888;
      font-size: 12px;
    }

    /* ä»–ã‚¿ãƒ–ï¼ˆãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ï¼‰ */
    .placeholder {
      padding: 40px 16px;
      text-align: center;
      font-size: 13px;
      color: #777;
      background: #fafafa;
      border-radius: 18px;
      border: 1px dashed #e0e0e0;
    }

    /* ã‚¹ãƒãƒ›å¯¾å¿œ */
    @media (max-width: 768px) {
      body {
        padding: 8px;
      }

      .app-shell {
        padding: 14px 12px 18px;
        border-radius: 18px;
      }

      .app-header {
        flex-direction: column;
        align-items: flex-start;
      }

      .title-block h1 {
        font-size: 17px;
      }

      .gantt-grid {
        grid-template-columns: 220px minmax(360px, 1fr);
      }

      .tree-rows,
      .gantt-wrapper {
        max-height: 360px;
      }

      .gantt-day {
        min-width: 28px;
        max-width: 28px;
      }

      .tree-row {
        padding-inline: 6px;
      }

      .task-title {
        font-size: 11px;
      }

      .task-person {
        display: none;
      }

      .task-status {
        font-size: 9px;
      }

      .control-bar {
        flex-direction: column;
        align-items: flex-start;
      }

      .control-right {
        width: 100%;
        justify-content: flex-start;
      }
    }
  </style>
</head>

<body>
  <div class="app-shell">
    <header class="app-header">
      <div class="title-block">
        <h1>I-STYLE åº—èˆ—ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ v9.1</h1>
        <span>æ–°åº—ã‚ªãƒ¼ãƒ—ãƒ³ã®éšå±¤ã‚¿ã‚¹ã‚¯ã‚’æ—¥åˆ¥ã‚¬ãƒ³ãƒˆã§ä¸€æ‹¬ç®¡ç†</span>
      </div>
      <div class="chip">
        <span class="chip-dot"></span>
        <span>ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ç·¨é›†ä¸­</span>
      </div>
    </header>

    <nav class="tabs">
      <button class="tab active" data-tab="gantt-tab">éšå±¤ï¼‹ã‚¬ãƒ³ãƒˆ</button>
      <button class="tab" data-tab="tasks-tab">ã‚¿ã‚¹ã‚¯ä¸€è¦§ï¼ˆæº–å‚™ä¸­ï¼‰</button>
      <button class="tab" data-tab="calendar-tab">ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ï¼ˆæº–å‚™ä¸­ï¼‰</button>
      <button class="tab" data-tab="staff-tab">ã‚¹ã‚¿ãƒƒãƒ•ï¼ˆæº–å‚™ä¸­ï¼‰</button>
    </nav>

    <!-- éšå±¤ï¼‹ã‚¬ãƒ³ãƒˆ -->
    <section id="gantt-tab" class="tab-content">
      <div class="control-bar">
        <div class="control-left">
          <select id="store-select" class="select">
            <option value="kawasaki">ãƒ©ã‚¾ãƒ¼ãƒŠå·å´åº—</option>
            <option value="aoyama">é’å±±åº—ï¼ˆã‚µãƒ³ãƒ—ãƒ«ï¼‰</option>
            <option value="shinjuku">æ–°å®¿åº—ï¼ˆã‚µãƒ³ãƒ—ãƒ«ï¼‰</option>
          </select>

          <select id="year-select" class="select">
            <option value="all">å¹´ï¼šã™ã¹ã¦</option>
            <option value="2025">2025å¹´</option>
            <option value="2026">2026å¹´</option>
            <option value="2027">2027å¹´</option>
            <option value="2028">2028å¹´</option>
            <option value="2029">2029å¹´</option>
            <option value="2030">2030å¹´</option>
          </select>

          <select id="month-select" class="select">
            <option value="all">æœˆï¼šã™ã¹ã¦</option>
            <option value="1">1æœˆ</option>
            <option value="2">2æœˆ</option>
            <option value="3">3æœˆ</option>
            <option value="4">4æœˆ</option>
            <option value="5">5æœˆ</option>
            <option value="6">6æœˆ</option>
            <option value="7">7æœˆ</option>
            <option value="8">8æœˆ</option>
            <option value="9">9æœˆ</option>
            <option value="10">10æœˆ</option>
            <option value="11">11æœˆ</option>
            <option value="12">12æœˆ</option>
          </select>

          <button class="btn btn-ghost" id="today-button">ä»Šæ—¥ã¸</button>
        </div>
        <div class="control-right">
          <button class="btn btn-primary" id="expand-all">ã™ã¹ã¦å±•é–‹</button>
          <button class="btn" id="collapse-all">ã™ã¹ã¦æŠ˜ã‚ŠãŸãŸã¿</button>
        </div>
      </div>

      <div class="tree-gantt-shell">
        <div class="tree-gantt-toolbar">
          <div class="tree-gantt-toolbar-left">
            <span class="badge">ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆ</span>
            <span>è¦ªå­æ§‹é€ ã®ã‚¿ã‚¹ã‚¯ã¨æ—¥ä»˜ã‚’ã€Œæ—¥åˆ¥ãƒãƒ¼ã€ã§ç¢ºèª</span>
          </div>
          <div class="tree-gantt-toolbar-right">
            <span style="font-size:11px;color:#777;">ãƒãƒ¼ã¯ãƒ‰ãƒ©ãƒƒã‚°ã§ç§»å‹•ï¼ç«¯ã‚’ã¤ã‹ã‚“ã§æœŸé–“å¤‰æ›´</span>
          </div>
        </div>

        <div id="gantt-view"></div>
      </div>
    </section>

    <!-- ä»¥ä¸‹ã¯ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ -->
    <section id="tasks-tab" class="tab-content" style="display:none;">
      <div class="placeholder">
        ã‚¿ã‚¹ã‚¯ä¸€è¦§ãƒ“ãƒ¥ãƒ¼ã¯åˆ¥ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆv8.0ãªã©ï¼‰ã§é‹ç”¨ã—ã€<br>
        ã“ã®ç”»é¢ã¯ã€Œéšå±¤ï¼‹ã‚¬ãƒ³ãƒˆã€ã«ç‰¹åŒ–ã•ã›ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚
      </div>
    </section>

    <section id="calendar-tab" class="tab-content" style="display:none;">
      <div class="placeholder">
        ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼é€£æºã¯æ¬¡ã‚¹ãƒ†ãƒƒãƒ—ã§æ‹¡å¼µå¯èƒ½ã§ã™ã€‚
      </div>
    </section>

    <section id="staff-tab" class="tab-content" style="display:none;">
      <div class="placeholder">
        æ–°åº—ã‚¹ã‚¿ãƒƒãƒ•åç°¿ãªã©ã‚’ã“ã“ã«è¿½åŠ ã§ãã¾ã™ã€‚
      </div>
    </section>
  </div>

  <script>
    /* ==== å®šæ•°ãƒ»çŠ¶æ…‹ ================================================ */
    const MS_PER_DAY = 1000 * 60 * 60 * 24;

    const tasks = [
      {
        id: 1,
        level: 1,
        parentId: null,
        name: "ãƒ©ã‚¾ãƒ¼ãƒŠå·å´åº—ã‚ªãƒ¼ãƒ—ãƒ³ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ",
        person: "ç§‹å±±",
        start: "2025-10-20",
        end: "2026-03-31",
        status: "é€²è¡Œä¸­",
      },
      {
        id: 2,
        level: 2,
        parentId: 1,
        name: "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨­è¨ˆãƒ»å…¨ä½“è¨ˆç”»",
        person: "ç§‹å±±",
        start: "2025-10-20",
        end: "2025-11-15",
        status: "é€²è¡Œä¸­",
      },
      {
        id: 3,
        level: 2,
        parentId: 1,
        name: "ãƒ‡ãƒ™ãƒ­ãƒƒãƒ‘ãƒ¼ãƒ»å¥‘ç´„é–¢é€£",
        person: "ç«¹ä¹‹å†…",
        start: "2025-10-20",
        end: "2025-12-15",
        status: "é€²è¡Œä¸­",
      },
      {
        id: 4,
        level: 2,
        parentId: 1,
        name: "æ¡ç”¨ãƒ»äººå“¡ãƒ»æ•™è‚²",
        person: "ç§‹å±± / å¶Œç”°",
        start: "2025-11-01",
        end: "2026-02-15",
        status: "æœªç€æ‰‹",
      },
      {
        id: 5,
        level: 2,
        parentId: 1,
        name: "ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ»ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ãƒ»ä»•çµ„ã¿",
        person: "å¶Œç”° / å¤ç›®",
        start: "2025-11-10",
        end: "2026-01-31",
        status: "æœªç€æ‰‹",
      },
      {
        id: 6,
        level: 2,
        parentId: 1,
        name: "ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°ãƒ»è²©ä¿ƒãƒ»ãƒ–ãƒ©ãƒ³ãƒ‡ã‚£ãƒ³ã‚°",
        person: "è‰æŸ³",
        start: "2025-12-01",
        end: "2026-02-28",
        status: "æœªç€æ‰‹",
      },
      {
        id: 7,
        level: 3,
        parentId: 2,
        name: "ã‚ªãƒ¼ãƒ—ãƒ³ç›®æ¨™æ—¥ã¨ã‚½ãƒ•ãƒˆã‚ªãƒ¼ãƒ—ãƒ³æ—¥ã‚’æ±ºå®šã™ã‚‹",
        person: "ç§‹å±±",
        start: "2025-10-20",
        end: "2025-10-31",
        status: "é€²è¡Œä¸­",
      },
      {
        id: 8,
        level: 3,
        parentId: 2,
        name: "KGI/KPIãƒ»å£²ä¸Šã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½œæˆ",
        person: "ç§‹å±±",
        start: "2025-10-25",
        end: "2025-11-10",
        status: "æœªç€æ‰‹",
      },
      {
        id: 9,
        level: 3,
        parentId: 4,
        name: "æ±‚äººæ¡ä»¶ãƒ»äººæ•°è¨ˆç”»ã®ç¢ºå®š",
        person: "ç§‹å±± / å¶Œç”°",
        start: "2025-11-05",
        end: "2025-11-20",
        status: "æœªç€æ‰‹",
      },
      {
        id: 10,
        level: 3,
        parentId: 4,
        name: "ã‚¢ãƒ«ãƒã‚¤ãƒˆãƒ»ç¤¾å“¡ã®æ¡ç”¨é¢æ¥",
        person: "å¶Œç”°",
        start: "2025-11-20",
        end: "2026-01-10",
        status: "æœªç€æ‰‹",
      },
      {
        id: 11,
        level: 3,
        parentId: 6,
        name: "SNSãƒ»é¤¨å†…å‘ŠçŸ¥ã®ä¼ç”»ã¨ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ä½œæˆ",
        person: "è‰æŸ³",
        start: "2025-12-10",
        end: "2026-01-15",
        status: "æœªç€æ‰‹",
      },
      {
        id: 12,
        level: 3,
        parentId: 6,
        name: "ã‚ªãƒ¼ãƒ—ãƒ³è¨˜å¿µãƒãƒ™ãƒ«ãƒ†ã‚£ä¼ç”»ãƒ»ç™ºæ³¨",
        person: "è‰æŸ³ / å²¡æœ¬",
        start: "2025-12-20",
        end: "2026-02-10",
        status: "æœªç€æ‰‹",
      },
    ];

    const expanded = new Set();
    let ganttStart = null;
    let ganttEnd = null;
    let GANTT_TOTAL_DAYS = 1;

    let currentYearFilter = "all";
    let currentMonthFilter = "all";

    // ãƒ‰ãƒ©ãƒƒã‚°ç”¨
    let ganttDrag = null;

    /* ==== æ—¥ä»˜ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ===================================== */

    function parseDate(str) {
      const [y, m, d] = str.split("-").map((v) => parseInt(v, 10));
      return new Date(y, m - 1, d);
    }

    function formatDateForLabel(date) {
      const m = date.getMonth() + 1;
      const d = date.getDate();
      return `${m}/${d}`;
    }

    function formatISO(date) {
      const y = date.getFullYear();
      const m = String(date.getMonth() + 1).padStart(2, "0");
      const d = String(date.getDate()).padStart(2, "0");
      return `${y}-${m}-${d}`;
    }

    function computeGanttRange(yearFilter, monthFilter) {
      const dates = [];
      for (const t of tasks) {
        if (!t.start || !t.end) continue;
        let s = parseDate(t.start);
        let e = parseDate(t.end);

        // å¹´ãƒ•ã‚£ãƒ«ã‚¿
        if (yearFilter && yearFilter !== "all") {
          const yf = parseInt(yearFilter, 10);
          const yearStart = new Date(yf, 0, 1);
          const yearEnd = new Date(yf, 11, 31);
          if (e < yearStart || s > yearEnd) continue;
          if (s < yearStart) s = yearStart;
          if (e > yearEnd) e = yearEnd;
        }

        // æœˆãƒ•ã‚£ãƒ«ã‚¿ï¼ˆå¹´æŒ‡å®šãŒã‚ã‚‹å ´åˆã®ã¿ï¼‰
        if (
          monthFilter &&
          monthFilter !== "all" &&
          yearFilter &&
          yearFilter !== "all"
        ) {
          const yf = parseInt(yearFilter, 10);
          const mf = parseInt(monthFilter, 10) - 1;
          const monthStart = new Date(yf, mf, 1);
          const monthEnd = new Date(yf, mf + 1, 0);
          if (e < monthStart || s > monthEnd) continue;
          if (s < monthStart) s = monthStart;
          if (e > monthEnd) e = monthEnd;
        }

        dates.push(s, e);
      }

      if (!dates.length) {
        ganttStart = null;
        ganttEnd = null;
        GANTT_TOTAL_DAYS = 1;
        return;
      }

      const min = new Date(Math.min(...dates.map((d) => d.getTime())));
      const max = new Date(Math.max(...dates.map((d) => d.getTime())));

      ganttStart = new Date(min.getFullYear(), min.getMonth(), min.getDate());
      ganttEnd = new Date(max.getFullYear(), max.getMonth(), max.getDate());

      GANTT_TOTAL_DAYS =
        Math.round((ganttEnd - ganttStart) / MS_PER_DAY) + 1 || 1;
    }

    function getTotalDays() {
      return GANTT_TOTAL_DAYS || 1;
    }

    function buildHeaderDaysHtml() {
      if (!ganttStart || !ganttEnd) return "";

      const dayNames = "æ—¥æœˆç«æ°´æœ¨é‡‘åœŸ";
      const days = [];
      const tmp = new Date(ganttStart.getTime());
      const today = new Date();
      today.setHours(0, 0, 0, 0);

      while (tmp <= ganttEnd) {
        const label = formatDateForLabel(tmp);
        const dow = dayNames[tmp.getDay()];
        const weekend = tmp.getDay() === 0 || tmp.getDay() === 6;

        const cellDate = new Date(tmp.getTime());
        cellDate.setHours(0, 0, 0, 0);
        const isToday = cellDate.getTime() === today.getTime();

        days.push(
          `<div class="gantt-day ${weekend ? "weekend" : ""} ${
            isToday ? "today" : ""
          }">
              <span>${label}</span>
              <span class="dow">${dow}</span>
           </div>`
        );
        tmp.setDate(tmp.getDate() + 1);
      }
      return days.join("");
    }

    function calculateBarPercentPosition(startStr, endStr) {
      if (!ganttStart || !ganttEnd) {
        return { left: 0, width: 0 };
      }
      let s = parseDate(startStr);
      let e = parseDate(endStr);

      if (e < s) e = new Date(s);

      // ãƒ˜ãƒƒãƒ€ãƒ¼ç¯„å›²ã«ã‚¯ãƒªãƒƒãƒ—
      if (s < ganttStart) s = new Date(ganttStart);
      if (e > ganttEnd) e = new Date(ganttEnd);

      let startOffset = Math.round((s - ganttStart) / MS_PER_DAY);
      let endOffset = Math.round((e - ganttStart) / MS_PER_DAY);

      const totalDays = getTotalDays();
      startOffset = Math.max(0, Math.min(totalDays - 1, startOffset));
      endOffset = Math.max(0, Math.min(totalDays - 1, endOffset));
      let duration = endOffset - startOffset + 1;
      if (duration <= 0) duration = 1;

      const left = (startOffset / totalDays) * 100;
      const width = (duration / totalDays) * 100;

      return { left, width };
    }

    /* ==== ãƒ„ãƒªãƒ¼ï¼‹ã‚¬ãƒ³ãƒˆæç”» ======================================= */

    function renderGanttView() {
      const container = document.getElementById("gantt-view");
      const yearFilter = currentYearFilter;
      const monthFilter = currentMonthFilter;

      computeGanttRange(yearFilter, monthFilter);

      if (!ganttStart || !ganttEnd) {
        container.innerHTML =
          '<div class="empty-hint">ã“ã®æ¡ä»¶ã«è©²å½“ã™ã‚‹ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>';
        return;
      }

      const headerDaysHtml = buildHeaderDaysHtml();

      const rows = [];
      const topLevel = tasks.filter((t) => t.parentId === null);

      function hasChildren(taskId) {
        return tasks.some((t) => t.parentId === taskId);
      }

      function walk(task, depth) {
        rows.push({ task, depth });
        if (expanded.has(task.id)) {
          tasks
            .filter((t) => t.parentId === task.id)
            .forEach((child) => walk(child, depth + 1));
        }
      }

      topLevel.forEach((t) => {
        if (!expanded.has(t.id)) expanded.add(t.id);
        walk(t, 0);
      });

      if (!rows.length) {
        container.innerHTML =
          '<div class="empty-hint">ã‚¿ã‚¹ã‚¯ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</div>';
        return;
      }

      const treeRowsHtml = rows
        .map(({ task, depth }) => {
          const indentPx = depth * 14;
          const children = hasChildren(task.id);
          const isExpanded = expanded.has(task.id);
          return `
            <div class="tree-row">
              <span class="tree-toggle ${
                children ? "" : "empty"
              }" onclick="${children ? `toggleExpand(${task.id})` : ""}">
                ${children ? (isExpanded ? "âˆ’" : "+") : ""}
              </span>
              <span style="width:${indentPx}px;"></span>
              <span class="level-badge">Lv${task.level}</span>
              <span class="task-title">${task.name}</span>
              <span class="task-person">ğŸ‘¤ ${task.person}</span>
              <span class="task-status">${task.status}</span>
            </div>
          `;
        })
        .join("");

      const ganttRowsHtml = rows
        .map(({ task }) => {
          const pos = calculateBarPercentPosition(task.start, task.end);
          const label = `${formatDateForLabel(
            parseDate(task.start)
          )}ã€œ${formatDateForLabel(parseDate(task.end))}${
            task.person ? "ï½œ" + task.person : ""
          }`;
          return `
            <div class="gantt-row">
              <div class="gantt-row-track"></div>
              <div class="gantt-bar"
                   data-task-id="${task.id}"
                   style="left:${pos.left}%;width:${pos.width}%;"
                   onmousedown="startBarDrag(event, ${task.id})">
                   ${label}
              </div>
            </div>
          `;
        })
        .join("");

      container.innerHTML = `
        <div class="gantt-grid">
          <div class="tree-column">
            <div class="tree-header">ã‚¿ã‚¹ã‚¯ / æ‹…å½“</div>
            <div class="tree-rows">
              ${treeRowsHtml}
            </div>
          </div>
          <div class="gantt-column">
            <div class="gantt-wrapper">
              <div class="gantt-scroll" id="gantt-scroll">
                <div class="gantt-inner">
                  <div class="gantt-header-days">
                    ${headerDaysHtml}
                  </div>
                  <div class="gantt-rows">
                    ${ganttRowsHtml}
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    /* ==== å±•é–‹ãƒ»æŠ˜ã‚ŠãŸãŸã¿ ======================================== */

    function toggleExpand(id) {
      if (expanded.has(id)) {
        expanded.delete(id);
      } else {
        expanded.add(id);
      }
      renderGanttView();
    }

    function expandAll() {
      tasks.forEach((t) => expanded.add(t.id));
      renderGanttView();
    }

    function collapseAll() {
      expanded.clear();
      renderGanttView();
    }

    /* ==== ã‚¬ãƒ³ãƒˆãƒãƒ¼ã®ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒªã‚µã‚¤ã‚º ========================== */

    function startBarDrag(event, id) {
      event.preventDefault();
      const task = tasks.find((t) => t.id === id);
      if (!task || !ganttStart || !ganttEnd) return;

      const barEl = event.currentTarget;
      const trackEl = barEl.parentElement.querySelector(".gantt-row-track");
      if (!trackEl) return;

      const trackRect = trackEl.getBoundingClientRect();
      const barRect = barEl.getBoundingClientRect();
      const rel = (event.clientX - barRect.left) / barRect.width;
      let mode = "move";
      if (rel < 0.3) mode = "resizeStart";
      else if (rel > 0.7) mode = "resizeEnd";

      const originalStart = parseDate(task.start);
      const originalEnd = parseDate(task.end);

      ganttDrag = {
        id,
        task,
        barEl,
        trackRect,
        type: mode,
        originalStart,
        originalEnd,
        previewStart: null,
        previewEnd: null,
      };

      barEl.classList.add("dragging");

      document.addEventListener("mousemove", onGanttDrag);
      document.addEventListener("mouseup", endGanttDrag);
    }

    function onGanttDrag(e) {
      if (!ganttDrag || !ganttStart || !ganttEnd) return;

      const { barEl, trackRect, type, originalStart, originalEnd, task } =
        ganttDrag;

      const x = Math.max(trackRect.left, Math.min(e.clientX, trackRect.right));
      const ratio = (x - trackRect.left) / trackRect.width;
      let offsetDays = Math.round(ratio * (GANTT_TOTAL_DAYS - 1));

      let newStart, newEnd;

      if (type === "move") {
        const duration = Math.max(
          1,
          Math.round((originalEnd - originalStart) / MS_PER_DAY)
        );
        newStart = new Date(ganttStart);
        newStart.setDate(ganttStart.getDate() + offsetDays);
        newEnd = new Date(newStart);
        newEnd.setDate(newEnd.getDate() + duration);
      } else if (type === "resizeStart") {
        newStart = new Date(ganttStart);
        newStart.setDate(ganttStart.getDate() + offsetDays);
        newEnd = new Date(originalEnd);
        if (newStart > newEnd) newStart = new Date(newEnd);
      } else {
        // resizeEnd
        newStart = new Date(originalStart);
        newEnd = new Date(ganttStart);
        newEnd.setDate(ganttStart.getDate() + offsetDays);
        if (newEnd < newStart) newEnd = new Date(newStart);
      }

      // ç¯„å›²å†…ã«ã‚¯ãƒªãƒƒãƒ—
      if (newStart < ganttStart) newStart = new Date(ganttStart);
      if (newEnd > ganttEnd) newEnd = new Date(ganttEnd);

      ganttDrag.previewStart = newStart;
      ganttDrag.previewEnd = newEnd;

      const startOffset = Math.round((newStart - ganttStart) / MS_PER_DAY);
      const durationDays =
        Math.max(1, Math.round((newEnd - newStart) / MS_PER_DAY) + 1) || 1;
      const left = (startOffset / GANTT_TOTAL_DAYS) * 100;
      const width = (durationDays / GANTT_TOTAL_DAYS) * 100;

      barEl.style.left = left + "%";
      barEl.style.width = width + "%";
      const label =
        formatDateForLabel(newStart) +
        "ã€œ" +
        formatDateForLabel(newEnd) +
        (task.person ? "ï½œ" + task.person : "");
      barEl.textContent = label;
    }

    function endGanttDrag() {
      if (ganttDrag) {
        const { task, previewStart, previewEnd, barEl } = ganttDrag;
        if (previewStart && previewEnd) {
          task.start = formatISO(previewStart);
          task.end = formatISO(previewEnd);
        }
        if (barEl) {
          barEl.classList.remove("dragging");
        }
      }
      ganttDrag = null;
      document.removeEventListener("mousemove", onGanttDrag);
      document.removeEventListener("mouseup", endGanttDrag);
      renderGanttView();
    }

    /* ==== ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ ============================================= */

    document.querySelectorAll(".tab").forEach((tab) => {
      tab.addEventListener("click", () => {
        const target = tab.getAttribute("data-tab");
        document
          .querySelectorAll(".tab")
          .forEach((t) => t.classList.remove("active"));
        document
          .querySelectorAll(".tab-content")
          .forEach((c) => (c.style.display = "none"));

        tab.classList.add("active");
        document.getElementById(target).style.display = "block";

        if (target === "gantt-tab") {
          renderGanttView();
        }
      });
    });

    /* ==== å„ç¨®ã‚¤ãƒ™ãƒ³ãƒˆ ============================================= */

    document
      .getElementById("expand-all")
      .addEventListener("click", expandAll);
    document
      .getElementById("collapse-all")
      .addEventListener("click", collapseAll);

    document.getElementById("year-select").addEventListener("change", (e) => {
      currentYearFilter = e.target.value;
      renderGanttView();
    });

    document.getElementById("month-select").addEventListener("change", (e) => {
      currentMonthFilter = e.target.value;
      renderGanttView();
    });

    document.getElementById("today-button").addEventListener("click", () => {
      if (!ganttStart || !ganttEnd) return;
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      if (today < ganttStart || today > ganttEnd) return;

      const daysFromStart = Math.round((today - ganttStart) / MS_PER_DAY);
      const scrollX = daysFromStart * 32 - 160;

      const scrollEl = document.getElementById("gantt-scroll");
      if (scrollEl) {
        scrollEl.scrollLeft = Math.max(scrollX, 0);
      }
    });

    /* ==== åˆæœŸåŒ– =================================================== */

    // æœ€åˆã¯ 2025 å¹´ã§è¡¨ç¤º
    currentYearFilter = "2025";
    document.getElementById("year-select").value = "2025";
    currentMonthFilter = "all";
    document.getElementById("month-select").value = "all";

    // å…¨ã‚¿ã‚¹ã‚¯å±•é–‹
    tasks.forEach((t) => expanded.add(t.id));

    renderGanttView();
  </script>
</body>
</html>
