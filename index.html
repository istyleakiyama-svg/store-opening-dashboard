<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>I-STYLE æ–°åº—ã‚ªãƒ¼ãƒ—ãƒ³çµ±åˆç®¡ç†ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        :root {
            --primary: #667eea;
            --primary-soft: rgba(102, 126, 234, 0.12);
            --accent: #764ba2;
            --bg: #f3f4f8;
            --card-bg: #ffffff;
            --border-soft: #e5e7eb;
            --text-main: #111827;
            --text-muted: #6b7280;
            --radius-lg: 18px;
            --radius-xl: 22px;
            --shadow-soft: 0 18px 45px rgba(15, 23, 42, 0.18);
            --transition-fast: 0.18s ease-out;
        }

        * {
            box-sizing: border-box;
        }

        html, body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", system-ui, -sans-serif;
            background: radial-gradient(circle at top left, #eef2ff 0, #f9fafb 40%, #f3f4f8 100%);
            color: var(--text-main);
            -webkit-font-smoothing: antialiased;
        }

        body {
            padding: 24px;
        }

        .app-shell {
            max-width: 1400px;
            margin: 0 auto;
            background: linear-gradient(135deg, rgba(255,255,255,0.96), rgba(250,250,255,0.98));
            border-radius: 26px;
            box-shadow: var(--shadow-soft);
            padding: 22px 26px 26px;
            border: 1px solid rgba(255,255,255,0.8);
            backdrop-filter: blur(18px);
        }

        .app-header {
            display: flex;
            justify-content: space-between;
            gap: 18px;
            align-items: center;
            margin-bottom: 18px;
        }

        .title-block {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .title-main {
            display: flex;
            align-items: baseline;
            gap: 10px;
        }

        .title-main h1 {
            font-size: 22px;
            letter-spacing: 0.12em;
            text-transform: uppercase;
            margin: 0;
        }

        .title-main span {
            font-size: 11px;
            padding: 3px 8px;
            border-radius: 999px;
            background: #eef2ff;
            color: #4f46e5;
            font-weight: 600;
        }

        .title-sub {
            font-size: 12px;
            color: var(--text-muted);
        }

        .status-block {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 8px;
        }

        .status-chip {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            border-radius: 999px;
            padding: 4px 12px;
            background: rgba(15,23,42,0.03);
            border: 1px solid rgba(148,163,184,0.4);
            font-size: 11px;
            color: var(--text-muted);
        }

        .status-dot {
            width: 9px;
            height: 9px;
            border-radius: 50%;
            background: #22c55e;
            box-shadow: 0 0 0 4px rgba(34,197,94,0.22);
        }

        .status-label {
            font-weight: 500;
        }

        .status-time {
            font-size: 10px;
            color: #9ca3af;
        }

        .view-switch {
            display: inline-flex;
            border-radius: 999px;
            padding: 3px;
            background: rgba(15,23,42,0.04);
            border: 1px solid rgba(148,163,184,0.45);
        }

        .view-btn {
            border: none;
            background: transparent;
            padding: 4px 12px;
            border-radius: 999px;
            font-size: 11px;
            cursor: pointer;
            color: #6b7280;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            transition: all var(--transition-fast);
        }

        .view-btn.active {
            background: #ffffff;
            color: #111827;
            box-shadow: 0 6px 14px rgba(15,23,42,0.16);
        }

        .view-btn span.icon {
            font-size: 13px;
        }

        .top-controls {
            display: flex;
            justify-content: space-between;
            gap: 16px;
            align-items: center;
            margin-bottom: 16px;
        }

        .top-controls-left,
        .top-controls-right {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        .select,
        .btn {
            border-radius: 999px;
            border: 1px solid #d1d5db;
            font-size: 12px;
            padding: 6px 12px;
            background: #f9fafb;
            color: #111827;
            outline: none;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .select:focus,
        .btn:focus {
            box-shadow: 0 0 0 3px rgba(99,102,241,0.25);
            border-color: #6366f1;
        }

        .btn-primary {
            background: linear-gradient(135deg, #6366f1, #4f46e5);
            border-color: transparent;
            color: #ffffff;
            box-shadow: 0 10px 25px rgba(79,70,229,0.35);
        }

        .btn-primary:hover {
            filter: brightness(1.04);
            transform: translateY(-0.5px);
        }

        .btn-ghost {
            background: transparent;
            border: none;
            color: #6b7280;
            padding-inline: 4px;
        }

        .btn-ghost:hover {
            color: #111827;
        }

        .kpi-badges {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .kpi-badge {
            border-radius: 999px;
            background: rgba(15,23,42,0.02);
            border: 1px solid rgba(148,163,184,0.55);
            padding: 4px 10px;
            font-size: 11px;
            color: #4b5563;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .kpi-badge strong {
            font-size: 11px;
            color: #111827;
        }

        .tab-bar {
            display: flex;
            gap: 8px;
            padding: 4px;
            background: rgba(148,163,184,0.08);
            border-radius: 999px;
            border: 1px solid rgba(148,163,184,0.35);
            margin-bottom: 16px;
        }

        .tab {
            border-radius: 999px;
            padding: 6px 14px;
            border: none;
            background: transparent;
            font-size: 12px;
            cursor: pointer;
            color: #6b7280;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: all var(--transition-fast);
        }

        .tab-icon {
            font-size: 14px;
        }

        .tab.active {
            background: #ffffff;
            color: #111827;
            box-shadow: 0 7px 20px rgba(15,23,42,0.18);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .tab-panel {
            border-radius: var(--radius-xl);
            background: rgba(255,255,255,0.9);
            border: 1px solid rgba(226,232,240,0.9);
            box-shadow: 0 14px 30px rgba(15,23,42,0.12);
            padding: 16px 18px 18px;
        }

        .tab-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            gap: 16px;
        }

        .tab-panel-header-left {
            display: flex;
            align-items: baseline;
            gap: 8px;
        }

        .tab-panel-title {
            font-size: 14px;
            font-weight: 600;
        }

        .tab-panel-subtitle {
            font-size: 11px;
            color: #6b7280;
        }

        .pill {
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 999px;
            background: #eef2ff;
            color: #4f46e5;
            font-weight: 600;
        }

        .panel-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .panel-actions .btn {
            font-size: 11px;
            padding: 4px 10px;
        }

        .content-grid {
            display: grid;
            grid-template-columns: minmax(0, 1.2fr) minmax(0, 1fr);
            gap: 16px;
        }

        .card {
            border-radius: 18px;
            background: radial-gradient(circle at top left, rgba(248,250,252,0.95), rgba(255,255,255,0.98));
            border: 1px solid rgba(226,232,240,0.9);
            box-shadow: 0 10px 25px rgba(15,23,42,0.06);
            padding: 12px 14px 14px;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .card-title {
            font-size: 13px;
            font-weight: 600;
        }

        .card-subtitle {
            font-size: 11px;
            color: #6b7280;
        }

        .card-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .card-body {
            max-height: 420px;
            overflow: auto;
        }

        .card-body::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        .card-body::-webkit-scrollbar-thumb {
            background: rgba(148,163,184,0.6);
            border-radius: 999px;
        }

        .card-body::-webkit-scrollbar-track {
            background: transparent;
        }

        .task-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        .task-table th,
        .task-table td {
            padding: 6px 6px;
            border-bottom: 1px solid #e5e7eb;
        }

        .task-table th {
            position: sticky;
            top: 0;
            z-index: 1;
            background: #f9fafb;
            font-weight: 600;
            color: #4b5563;
        }

        .task-table tr:hover td {
            background: rgba(239,246,255,0.7);
        }

        .task-table tr.selected td {
            background: rgba(219,234,254,0.95);
        }

        .level-tag {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 999px;
            font-weight: 500;
        }

        .level-1 { background: #eef2ff; color: #4f46e5; }
        .level-2 { background: #dcfce7; color: #16a34a; }
        .level-3 { background: #fee2e2; color: #b91c1c; }
        .level-4 { background: #fef3c7; color: #d97706; }
        .level-5 { background: #e0f2fe; color: #0369a1; }
        .level-6 { background: #f5f3ff; color: #6d28d9; }

        .status-badge {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 999px;
            font-weight: 500;
        }

        .status-not-started {
            background: #f3f4f6;
            color: #4b5563;
        }

        .status-in-progress {
            background: #dbeafe;
            color: #1d4ed8;
        }

        .status-done {
            background: #dcfce7;
            color: #15803d;
        }

        .status-risk {
            background: #fee2e2;
            color: #b91c1c;
        }

        .assignee {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 11px;
            color: #374151;
        }

        .assignee-avatar {
            width: 18px;
            height: 18px;
            border-radius: 999px;
            background: linear-gradient(135deg, #6366f1, #ec4899);
            color: #ffffff;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: 600;
        }

        .priority-tag {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 999px;
            font-weight: 500;
        }

        .priority-high {
            background: #fee2e2;
            color: #b91c1c;
        }

        .priority-medium {
            background: #fef3c7;
            color: #b45309;
        }

        .priority-low {
            background: #ecfdf5;
            color: #047857;
        }

        .tree-gantt-container {
            display: flex;
            flex-direction: column;
            border-radius: 18px;
            border: 1px solid rgba(226,232,240,0.9);
            background: radial-gradient(circle at top left, rgba(248,250,252,0.98), rgba(255,255,255,0.98));
            box-shadow: 0 10px 25px rgba(148,163,184,0.18);
            overflow: hidden;
        }

        .tree-gantt-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: linear-gradient(90deg, rgba(239,246,255,0.95), rgba(249,250,251,0.96));
            border-bottom: 1px solid rgba(226,232,240,0.9);
        }

        .tree-gantt-header-left {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tree-gantt-header-title {
            font-size: 13px;
            font-weight: 600;
        }

        .tree-gantt-header-sub {
            font-size: 11px;
            color: #6b7280;
        }

        .tree-gantt-header-right {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .tree-gantt-header-legend {
            display: inline-flex;
            gap: 10px;
            font-size: 11px;
            color: #6b7280;
        }

        .tree-gantt-header-legend span {
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .legend-color {
            width: 10px;
            height: 4px;
            border-radius: 999px;
            background: #6366f1;
        }

        .tree-gantt-grid {
            display: grid;
            grid-template-columns: minmax(280px, 0.8fr) minmax(480px, 1.2fr);
            border-top: 1px solid rgba(226,232,240,0.9);
            max-height: 460px;
        }

        .tree-column {
            border-right: 1px solid rgba(226,232,240,0.9);
            overflow: auto;
        }

        .gantt-column {
            overflow: auto;
            position: relative;
        }

        .tree-header-row {
            display: grid;
            grid-template-columns: 1fr 80px 60px;
            font-size: 11px;
            font-weight: 600;
            color: #4b5563;
            padding: 6px 10px;
            background: #f9fafb;
            border-bottom: 1px solid #e5e7eb;
            position: sticky;
            top: 0;
            z-index: 1;
        }

        .tree-rows {
            font-size: 12px;
        }

        .tree-row {
            display: grid;
            grid-template-columns: 1fr 80px 60px;
            align-items: center;
            padding: 5px 10px;
            border-bottom: 1px solid rgba(243,244,246,0.95);
            transition: background var(--transition-fast);
        }

        .tree-row:hover {
            background: rgba(239,246,255,0.9);
        }

        .tree-cell-main {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .tree-toggle {
            width: 16px;
            height: 16px;
            border-radius: 6px;
            border: 1px solid #d1d5db;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: #4b5563;
            background: #ffffff;
            cursor: pointer;
        }

        .tree-toggle.empty {
            border-color: transparent;
            background: transparent;
            cursor: default;
        }

        .tree-level-indicator {
            width: 2px;
            height: 18px;
            border-radius: 999px;
            background: linear-gradient(180deg, #6366f1, #a855f7);
        }

        .tree-task-title {
            font-weight: 500;
        }

        .tree-assignee {
            font-size: 11px;
            color: #6b7280;
        }

        .tree-date {
            font-size: 11px;
            color: #6b7280;
            text-align: center;
        }

        .tree-status {
            text-align: center;
        }

        .gantt-header {
            position: sticky;
            top: 0;
            z-index: 2;
            background: #f9fafb;
            border-bottom: 1px solid #e5e7eb;
        }

        .gantt-header-inner {
            display: flex;
            align-items: stretch;
            position: relative;
            border-bottom: 1px solid #e5e7eb;
        }

        .gantt-header-label {
            font-size: 11px;
            color: #6b7280;
            padding: 5px 10px;
            white-space: nowrap;
        }

        .gantt-header-days {
            display: flex;
            align-items: stretch;
            white-space: nowrap;
            overflow: hidden;
        }

        .gantt-day {
            min-width: 32px;
            max-width: 32px;
            border-left: 1px solid #e5e7eb;
            font-size: 10px;
            text-align: center;
            padding-top: 3px;
            color: #4b5563;
            background: #f9fafb;
        }

        .gantt-day:first-child {
            border-left: none;
        }

        .gantt-day span {
            display: block;
            line-height: 1.1;
        }

        .gantt-day .dow {
            font-size: 9px;
            color: #9ca3af;
        }

        .gantt-day.weekend {
            background: #fef3c7;
        }

        .gantt-body {
            position: relative;
        }

        .gantt-row {
            position: relative;
            height: 34px;
            border-bottom: 1px solid rgba(243,244,246,0.95);
        }

        .gantt-row::before {
            content: "";
            position: absolute;
            inset: 0;
            background-image: linear-gradient(to right, rgba(229,231,235,0.8) 1px, transparent 1px);
            background-size: 32px 100%;
        }

        .gantt-track {
            position: relative;
            height: 100%;
        }

        .gantt-bar-mini {
            position: absolute;
            top: 5px;
            height: 24px;
            border-radius: 999px;
            background: linear-gradient(135deg, #6366f1, #4f46e5);
            color: #ffffff;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 8px;
            box-shadow: 0 6px 14px rgba(129,140,248,0.5);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            cursor: grab;
            user-select: none;
            transition: box-shadow 0.12s ease-out, transform 0.12s ease-out, opacity 0.12s ease-out;
        }

        .gantt-bar-mini.dragging {
            cursor: grabbing;
            opacity: 0.9;
            box-shadow: 0 10px 26px rgba(79,70,229,0.65);
            transform: translateY(-1px);
        }

        .gantt-status-not-started {
            background: linear-gradient(135deg, #9ca3af, #6b7280);
        }

        .gantt-status-done {
            background: linear-gradient(135deg, #22c55e, #16a34a);
        }

        .gantt-status-risk {
            background: linear-gradient(135deg, #ef4444, #b91c1c);
        }

        .empty-state {
            padding: 40px;
            text-align: center;
            color: #9ca3af;
            font-size: 13px;
        }

        .empty-state strong {
            color: #4b5563;
        }

        .pill-soft {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            border-radius: 999px;
            background: rgba(15,23,42,0.03);
            border: 1px dashed rgba(148,163,184,0.6);
            padding: 4px 10px;
            font-size: 11px;
            color: #6b7280;
        }

        .highlight {
            color: #4f46e5;
            font-weight: 600;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 6px;
            font-size: 11px;
        }

        .calendar-day-header {
            text-align: center;
            font-weight: 600;
            color: #6b7280;
            padding-bottom: 4px;
        }

        .calendar-day {
            min-height: 64px;
            border-radius: 12px;
            border: 1px solid rgba(226,232,240,0.9);
            background: #ffffff;
            padding: 4px 6px;
            position: relative;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .calendar-day.today {
            border-color: #6366f1;
            box-shadow: 0 0 0 1px rgba(99,102,241,0.35);
        }

        .calendar-date-label {
            font-size: 10px;
            color: #4b5563;
            font-weight: 500;
        }

        .calendar-lucky {
            font-size: 9px;
            color: #10b981;
        }

        .calendar-unlucky {
            font-size: 9px;
            color: #ef4444;
        }

        .calendar-task-chip {
            margin-top: 2px;
            border-radius: 999px;
            padding: 1px 4px;
            font-size: 9px;
            background: rgba(96,165,250,0.14);
            color: #1d4ed8;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .calendar-task-chip.important {
            background: rgba(249,115,22,0.12);
            color: #c2410c;
        }

        .calendar-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .calendar-toolbar-left {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .calendar-toolbar-right {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .staff-grid {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 12px;
            font-size: 12px;
        }

        .staff-card {
            border-radius: 16px;
            padding: 8px 10px;
            background: rgba(249,250,251,0.98);
            border: 1px solid rgba(226,232,240,0.9);
            display: flex;
            gap: 8px;
        }

        .staff-avatar {
            width: 36px;
            height: 36px;
            border-radius: 999px;
            background: radial-gradient(circle at 30% 20%, #f97316, #7c2d12);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #ffffff;
            font-weight: 700;
        }

        .staff-info {
            flex: 1;
        }

        .staff-name {
            font-weight: 600;
            margin-bottom: 2px;
        }

        .staff-role {
            font-size: 11px;
            color: #6b7280;
            margin-bottom: 2px;
        }

        .staff-skills {
            font-size: 10px;
            color: #4b5563;
        }

        .staff-tag-row {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
            margin-top: 4px;
        }

        .staff-tag {
            font-size: 9px;
            padding: 1px 6px;
            border-radius: 999px;
            background: rgba(15,23,42,0.03);
            color: #4b5563;
        }

        .store-select {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            border-radius: 999px;
            padding: 4px 10px;
            background: rgba(15,23,42,0.02);
            border: 1px solid rgba(209,213,219,0.9);
            font-size: 11px;
            color: #374151;
        }

        .store-select select {
            border: none;
            background: transparent;
            outline: none;
            font-size: 11px;
            color: #111827;
            padding-right: 12px;
        }

        .store-select select option {
            font-size: 11px;
        }

        .quick-today {
            font-size: 11px;
            color: #6b7280;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 3px;
        }

        .quick-today:hover {
            color: #111827;
        }

        .section-label {
            font-size: 11px;
            color: #6b7280;
        }

        .tag-soft-green {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 999px;
            background: rgba(16,185,129,0.09);
            color: #047857;
        }

        .tag-soft-blue {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 999px;
            background: rgba(59,130,246,0.09);
            color: #1d4ed8;
        }

        .tag-soft-orange {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 999px;
            background: rgba(249,115,22,0.11);
            color: #c2410c;
        }

        .summary-row {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 6px;
        }

        .summary-pill {
            font-size: 10px;
            padding: 2px 8px;
            border-radius: 999px;
            background: rgba(15,23,42,0.02);
            border: 1px solid rgba(209,213,219,0.9);
            color: #4b5563;
        }

        .today-marker {
            font-size: 10px;
            color: #ef4444;
            font-weight: 600;
        }

        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(15,23,42,0.4);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 999;
        }

        .modal {
            width: 560px;
            max-width: 95vw;
            max-height: 85vh;
            overflow: auto;
            border-radius: 20px;
            background: #ffffff;
            box-shadow: 0 30px 70px rgba(15,23,42,0.45);
            padding: 18px 20px 20px;
            border: 1px solid rgba(226,232,240,0.9);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .modal-title {
            font-size: 14px;
            font-weight: 600;
        }

        .modal-close-btn {
            border: none;
            background: transparent;
            font-size: 18px;
            cursor: pointer;
            color: #6b7280;
        }

        .modal-content {
            font-size: 12px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 10px 12px;
            margin-bottom: 10px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }

        .form-group.full {
            grid-column: 1 / -1;
        }

        .form-label {
            font-size: 11px;
            color: #4b5563;
        }

        .form-input,
        .form-select,
        .form-textarea {
            border-radius: 9px;
            border: 1px solid #d1d5db;
            padding: 6px 7px;
            font-size: 12px;
            outline: none;
            background: #f9fafb;
            transition: all var(--transition-fast);
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            border-color: #6366f1;
            box-shadow: 0 0 0 2px rgba(129,140,248,0.35);
            background: #ffffff;
        }

        .form-textarea {
            min-height: 54px;
            resize: vertical;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 2px;
        }

        .badge-soft {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 999px;
            background: rgba(15,23,42,0.03);
            color: #4b5563;
        }

        @media (max-width: 1024px) {
            body {
                padding: 12px;
            }
            .app-shell {
                padding: 18px;
            }
            .content-grid {
                grid-template-columns: minmax(0, 1fr);
            }
            .staff-grid {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }
        }

        @media (max-width: 768px) {
            .app-header {
                flex-direction: column;
                align-items: flex-start;
            }
            .status-block {
                align-items: flex-start;
            }
            .top-controls {
                flex-direction: column;
                align-items: flex-start;
            }
            .tab-bar {
                overflow-x: auto;
                white-space: nowrap;
            }
            .tree-gantt-grid {
                grid-template-columns: minmax(220px, 0.9fr) minmax(400px, 1.1fr);
            }
            .staff-grid {
                grid-template-columns: minmax(0, 1fr);
            }
        }
    </style>
</head>
<body>
<div class="app-shell">
    <header class="app-header">
        <div class="title-block">
            <div class="title-main">
                <h1>I-STYLE PROJECT DASHBOARD</h1>
                <span>STORE OPENING STANDARD</span>
            </div>
            <div class="title-sub">
                ãƒ©ã‚¾ãƒ¼ãƒŠå·å´åº—ã‚’ã¯ã˜ã‚ã€è¤‡æ•°åº—èˆ—ã®ã€Œæ–°åº—ã‚ªãƒ¼ãƒ—ãƒ³ã€œç«‹ã¡ä¸ŠãŒã‚Šã€ã‚’ä¸€å…ƒç®¡ç†ã™ã‚‹ãŸã‚ã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
            </div>
        </div>
        <div class="status-block">
            <div class="status-chip" id="sync-status-chip">
                <span class="status-dot" id="sync-status-dot"></span>
                <span class="status-label" id="sync-status-label">Online / è‡ªå‹•ä¿å­˜ä¸­</span>
            </div>
            <div class="status-time" id="sync-status-time">æœ€çµ‚æ›´æ–°: -</div>
            <div class="view-switch">
                <button class="view-btn active" data-view="both" onclick="setView('both')">
                    <span class="icon">ğŸ§©</span><span>çµ±åˆãƒ“ãƒ¥ãƒ¼</span>
                </button>
                <button class="view-btn" data-view="tasks" onclick="setView('tasks')">
                    <span class="icon">ğŸ“‹</span><span>ã‚¿ã‚¹ã‚¯ä¸­å¿ƒ</span>
                </button>
                <button class="view-btn" data-view="gantt" onclick="setView('gantt')">
                    <span class="icon">ğŸ“Š</span><span>ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆ</span>
                </button>
            </div>
        </div>
    </header>

    <div class="top-controls">
        <div class="top-controls-left">
            <div class="store-select">
                <span>åº—èˆ—</span>
                <select id="store-filter" onchange="onStoreChange()">
                    <option value="all">å…¨åº—èˆ—</option>
                    <option value="kawasaki">ãƒ©ã‚¾ãƒ¼ãƒŠå·å´åº—</option>
                    <option value="sample-aoyama">é’å±±åº—ï¼ˆã‚µãƒ³ãƒ—ãƒ«ï¼‰</option>
                    <option value="sample-yokohama">æ¨ªæµœåº—ï¼ˆã‚µãƒ³ãƒ—ãƒ«ï¼‰</option>
                    <option value="sample-shinjuku">æ–°å®¿åº—ï¼ˆã‚µãƒ³ãƒ—ãƒ«ï¼‰</option>
                </select>
            </div>
            <select id="level-filter" class="select" onchange="onLevelFilterChange()">
                <option value="all">ãƒ¬ãƒ™ãƒ«ï¼šã™ã¹ã¦</option>
                <option value="1">ãƒ¬ãƒ™ãƒ«1</option>
                <option value="2">ãƒ¬ãƒ™ãƒ«2</option>
                <option value="3">ãƒ¬ãƒ™ãƒ«3</option>
                <option value="4">ãƒ¬ãƒ™ãƒ«4</option>
                <option value="5">ãƒ¬ãƒ™ãƒ«5</option>
                <option value="6">ãƒ¬ãƒ™ãƒ«6</option>
                <option value="7">ãƒ¬ãƒ™ãƒ«7</option>
                <option value="8">ãƒ¬ãƒ™ãƒ«8</option>
            </select>
            <button class="btn btn-ghost" onclick="scrollToToday()">
                ä»Šæ—¥ä»˜è¿‘ã¸
            </button>
        </div>
        <div class="top-controls-right">
            <div class="kpi-badges">
                <div class="kpi-badge">
                    <span>ğŸ§¾ ã‚¿ã‚¹ã‚¯æ•°</span>
                    <strong id="kpi-total-tasks">0</strong>
                </div>
                <div class="kpi-badge">
                    <span>âœ… å®Œäº†</span>
                    <strong id="kpi-done-tasks">0</strong>
                </div>
                <div class="kpi-badge">
                    <span>âš  ãƒªã‚¹ã‚¯</span>
                    <strong id="kpi-risk-tasks">0</strong>
                </div>
                <div class="kpi-badge">
                    <span>ğŸ“ˆ FLç›®æ¨™</span>
                    <strong>55% ãƒ™ãƒ¼ã‚¹</strong>
                </div>
            </div>
        </div>
    </div>

    <nav class="tab-bar">
        <button class="tab active" data-tab="tasks-tab" onclick="switchTab('tasks-tab')">
            <span class="tab-icon">ğŸ§©</span>
            <span>ã‚¿ã‚¹ã‚¯ï¼†éšå±¤ãƒ“ãƒ¥ãƒ¼</span>
        </button>
        <button class="tab" data-tab="calendar-tab" onclick="switchTab('calendar-tab')">
            <span class="tab-icon">ğŸ“…</span>
            <span>ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ï¼†å‰æ—¥</span>
        </button>
        <button class="tab" data-tab="staff-tab" onclick="switchTab('staff-tab')">
            <span class="tab-icon">ğŸ‘¥</span>
            <span>ã‚¹ã‚¿ãƒƒãƒ•ï¼†å½¹å‰²</span>
        </button>
        <button class="tab" data-tab="report-tab" onclick="switchTab('report-tab')">
            <span class="tab-icon">ğŸ“Š</span>
            <span>KPIï¼†ãƒ¬ãƒãƒ¼ãƒˆ</span>
        </button>
    </nav>

    <section id="tasks-tab" class="tab-content active">
        <div class="tab-panel">
            <div class="tab-panel-header">
                <div class="tab-panel-header-left">
                    <div>
                        <div class="tab-panel-title">
                            ã‚¿ã‚¹ã‚¯ä¸€è¦§ ï¼‹ éšå±¤ã‚¬ãƒ³ãƒˆãƒ“ãƒ¥ãƒ¼
                        </div>
                        <div class="tab-panel-subtitle">
                            ãƒ¬ãƒ™ãƒ«1ã€œ3ã§ã€Œéª¨æ ¼ã€ã€ãƒ¬ãƒ™ãƒ«4ä»¥é™ã§ã€Œç¾å ´ã®å…·ä½“ç­–ã€ã‚’æ•´ç†
                        </div>
                    </div>
                    <span class="pill">L1ã€œL8 å…¨ä½“è¨­è¨ˆ</span>
                </div>
                <div class="panel-actions">
                    <button class="btn" onclick="openTaskModal()">ï¼‹ ã‚¿ã‚¹ã‚¯è¿½åŠ </button>
                    <button class="btn" onclick="exportTasks()">CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
                    <span class="section-label">â€» Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆé€£æºç”¨</span>
                </div>
            </div>

            <div class="content-grid">
                <div class="card">
                    <div class="card-header">
                        <div>
                            <div class="card-title">ã‚¿ã‚¹ã‚¯ä¸€è¦§ï¼ˆè¡¨å½¢å¼ï¼‰</div>
                            <div class="card-subtitle">
                                ãƒ¬ãƒ™ãƒ«ã€åº—èˆ—ã€æ‹…å½“ã€æœŸé–“ã€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ä¸€è¦§ã§ç¢ºèª
                            </div>
                        </div>
                        <div class="card-actions">
                            <span class="badge-soft">ã‚¯ãƒªãƒƒã‚¯ã§é¸æŠï¼ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã§ç·¨é›†</span>
                        </div>
                    </div>
                    <div class="card-body">
                        <table class="task-table" id="task-table">
                            <thead>
                            <tr>
                                <th style="width: 24px;"></th>
                                <th style="width: 60px;">ãƒ¬ãƒ™ãƒ«</th>
                                <th>ã‚¿ã‚¹ã‚¯å</th>
                                <th style="width: 120px;">è¦ªã‚¿ã‚¹ã‚¯</th>
                                <th style="width: 120px;">åº—èˆ—</th>
                                <th style="width: 110px;">æ‹…å½“</th>
                                <th style="width: 80px;">å„ªå…ˆåº¦</th>
                                <th style="width: 110px;">é–‹å§‹æ—¥</th>
                                <th style="width: 110px;">çµ‚äº†æ—¥</th>
                                <th style="width: 90px;">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                            </tr>
                            </thead>
                            <tbody id="task-table-body">
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div>
                            <div class="card-title">éšå±¤ï¼‹ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆ</div>
                            <div class="card-subtitle">
                                è¦ªå­æ§‹é€ ãƒ»æ‹…å½“ãƒ»æœŸé–“ã‚’1ã¤ã®ç”»é¢ã§ä¿¯ç°ï¼ˆãƒãƒ¼ã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã§ç§»å‹•ï¼‰
                            </div>
                        </div>
                        <div class="card-actions">
                            <button class="btn" onclick="expandAll()">ã™ã¹ã¦å±•é–‹</button>
                            <button class="btn" onclick="collapseAll()">ã™ã¹ã¦æŠ˜ã‚ŠãŸãŸã¿</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="tree-gantt-container">
                            <div class="tree-gantt-header">
                                <div class="tree-gantt-header-left">
                                    <span class="tree-gantt-header-title">ãƒ©ã‚¾ãƒ¼ãƒŠå·å´åº— ã‚ªãƒ¼ãƒ—ãƒ³ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ</span>
                                    <span class="tree-gantt-header-sub">
                                        2025å¹´ã€œ2030å¹´ã¾ã§å¯¾å¿œ / ã‚¬ãƒ³ãƒˆãƒãƒ¼ã¯ãƒ‰ãƒ©ãƒƒã‚°ã§ç§»å‹•ï¼ãƒã‚¦ã‚¹ã‚’é›¢ã™ã¨ãƒ‰ãƒ­ãƒƒãƒ—
                                    </span>
                                </div>
                                <div class="tree-gantt-header-right">
                                    <div class="tree-gantt-header-legend">
                                        <span><span class="legend-color" style="background:#6366f1;"></span>é€²è¡Œä¸­</span>
                                        <span><span class="legend-color" style="background:#22c55e;"></span>å®Œäº†</span>
                                        <span><span class="legend-color" style="background:#ef4444;"></span>è¦æ³¨æ„</span>
                                    </div>
                                </div>
                            </div>
                            <div class="tree-gantt-grid">
                                <div class="tree-column">
                                    <div class="tree-header-row">
                                        <div>ã‚¿ã‚¹ã‚¯ / éšå±¤</div>
                                        <div style="text-align:center;">æœŸé–“</div>
                                        <div style="text-align:center;">æ‹…å½“</div>
                                    </div>
                                    <div class="tree-rows" id="tree-rows"></div>
                                </div>
                                <div class="gantt-column">
                                    <div class="gantt-header">
                                        <div class="gantt-header-inner">
                                            <div class="gantt-header-label">
                                                æœŸé–“ï¼ˆæ—¥å˜ä½ï¼‰
                                            </div>
                                            <div class="gantt-header-days" id="gantt-header-days"></div>
                                        </div>
                                    </div>
                                    <div class="gantt-body" id="gantt-body"></div>
                                </div>
                            </div>
                        </div>
                        <div id="integrated-view-footer" style="padding-top:6px;font-size:11px;color:#6b7280;">
                            ãƒãƒ¼ã¯æ¨ªæ–¹å‘ã¸ãƒ‰ãƒ©ãƒƒã‚°ã§æ—¥ä»˜ç§»å‹•ã§ãã¾ã™ï¼ˆãƒã‚¦ã‚¹ã‚’é›¢ã—ãŸä½ç½®ã§ç¢ºå®šï¼‰
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section id="calendar-tab" class="tab-content">
        <div class="tab-panel">
            <div class="tab-panel-header">
                <div class="tab-panel-header-left">
                    <div>
                        <div class="tab-panel-title">ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ ï¼‹ å…­æ›œãƒ»å‰æ—¥</div>
                        <div class="tab-panel-subtitle">
                            ã‚¿ã‚¹ã‚¯ã®ç· åˆ‡ãƒ»ã‚¤ãƒ™ãƒ³ãƒˆã‚’ã€å…­æ›œã‚„ä¸€ç²’ä¸‡å€æ—¥ãªã©ã¨é‡ã­ã¦ç¢ºèª
                        </div>
                    </div>
                    <span class="pill">æ¯æœˆã®é‹ç”¨ä¼šè­°ç”¨</span>
                </div>
                <div class="panel-actions">
                    <div class="calendar-toolbar">
                        <div class="calendar-toolbar-left">
                            <button class="btn" onclick="changeMonth(-1)">â—€ å‰æœˆ</button>
                            <button class="btn" onclick="goToThisMonth()">ä»Šæœˆ</button>
                            <button class="btn" onclick="changeMonth(1)">æ¬¡æœˆ â–¶</button>
                        </div>
                        <div class="calendar-toolbar-right">
                            <span id="calendar-month-label" class="section-label"></span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card">
                <div class="card-body">
                    <div class="calendar-grid" id="calendar-grid"></div>
                </div>
            </div>
        </div>
    </section>

    <section id="staff-tab" class="tab-content">
        <div class="tab-panel">
            <div class="tab-panel-header">
                <div class="tab-panel-header-left">
                    <div>
                        <div class="tab-panel-title">ã‚¹ã‚¿ãƒƒãƒ•ãƒ»å½¹å‰²åˆ†æ‹…</div>
                        <div class="tab-panel-subtitle">
                            èª°ãŒä½•ã‚’æ‹…å½“ã—ã¦ã„ã‚‹ã‹ã‚’å¯è¦–åŒ–ã—ã€ä¾é ¼ãƒ»ç›¸è«‡ã®çª“å£ã‚’æ˜ç¢ºã«ã™ã‚‹
                        </div>
                    </div>
                    <span class="pill">æœ¬éƒ¨ Ã— åº—èˆ—ã®é€£æº</span>
                </div>
                <div class="panel-actions">
                    <span class="section-label">â€» å°†æ¥çš„ã«ã€Œæ¨©é™ç®¡ç†ã€ã€Œã‚¢ãƒ©ãƒ¼ãƒ é€ä¿¡å…ˆã€ã®ç´ä»˜ã‘ã‚‚å¯èƒ½</span>
                </div>
            </div>
            <div class="card">
                <div class="card-body">
                    <div class="staff-grid" id="staff-grid">
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section id="report-tab" class="tab-content">
        <div class="tab-panel">
            <div class="tab-panel-header">
                <div class="tab-panel-header-left">
                    <div>
                        <div class="tab-panel-title">KPI / FL / é€²æ—ãƒ¬ãƒãƒ¼ãƒˆ</div>
                        <div class="tab-panel-subtitle">
                            å£²ä¸Šãƒ»FLãƒ»ã‚¿ã‚¹ã‚¯é€²è¡Œç‡ãªã©ã‚’ã€åº—é•·ä¼šè­°ã‚„æœ¬éƒ¨ä¼šè­°ã§å…±æœ‰ã™ã‚‹ãŸã‚ã®å©ãå°
                        </div>
                    </div>
                    <span class="pill">PLãƒ»FLé€£æºå‰æã®æ çµ„ã¿</span>
                </div>
                <div class="panel-actions">
                    <button class="btn" onclick="generateSimpleReport()">æœ¬æ—¥ã®ã‚µãƒãƒªãƒ¼ç”Ÿæˆ</button>
                </div>
            </div>
            <div class="card">
                <div class="card-header">
                    <div>
                        <div class="card-title">ãƒ†ã‚­ã‚¹ãƒˆãƒ¬ãƒãƒ¼ãƒˆï¼ˆãƒ¡ãƒ¢ç”¨ï¼‰</div>
                        <div class="card-subtitle">ã‚³ãƒ”ãƒ¼ã—ã¦è­°äº‹éŒ²ã‚„Chatworkã«è²¼ã‚Šä»˜ã‘å¯èƒ½</div>
                    </div>
                    <div class="card-actions">
                        <button class="btn" onclick="copyReport()">ã‚³ãƒ”ãƒ¼</button>
                    </div>
                </div>
                <div class="card-body">
                    <textarea id="report-text" class="form-textarea" style="width:100%; min-height:220px;"></textarea>
                </div>
            </div>
        </div>
    </section>
</div>

<div class="modal-backdrop" id="task-modal-backdrop">
    <div class="modal">
        <div class="modal-header">
            <div class="modal-title" id="task-modal-title">ã‚¿ã‚¹ã‚¯è¿½åŠ </div>
            <button class="modal-close-btn" onclick="closeTaskModal()">Ã—</button>
        </div>
        <div class="modal-content">
            <form id="task-form" onsubmit="saveTaskFromModal(event)">
                <input type="hidden" id="task-id">
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">ãƒ¬ãƒ™ãƒ«</label>
                        <select id="task-level" class="form-select">
                            <option value="1">ãƒ¬ãƒ™ãƒ«1ï¼ˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå…¨ä½“ï¼‰</option>
                            <option value="2">ãƒ¬ãƒ™ãƒ«2ï¼ˆå¤§åˆ†é¡ï¼‰</option>
                            <option value="3">ãƒ¬ãƒ™ãƒ«3ï¼ˆä¸­åˆ†é¡ï¼‰</option>
                            <option value="4">ãƒ¬ãƒ™ãƒ«4ï¼ˆå…·ä½“ã‚¿ã‚¹ã‚¯ï¼‰</option>
                            <option value="5">ãƒ¬ãƒ™ãƒ«5</option>
                            <option value="6">ãƒ¬ãƒ™ãƒ«6</option>
                            <option value="7">ãƒ¬ãƒ™ãƒ«7</option>
                            <option value="8">ãƒ¬ãƒ™ãƒ«8</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">åº—èˆ—</label>
                        <select id="task-store" class="form-select">
                            <option value="kawasaki">ãƒ©ã‚¾ãƒ¼ãƒŠå·å´åº—</option>
                            <option value="sample-aoyama">é’å±±åº—ï¼ˆã‚µãƒ³ãƒ—ãƒ«ï¼‰</option>
                            <option value="sample-yokohama">æ¨ªæµœåº—ï¼ˆã‚µãƒ³ãƒ—ãƒ«ï¼‰</option>
                            <option value="sample-shinjuku">æ–°å®¿åº—ï¼ˆã‚µãƒ³ãƒ—ãƒ«ï¼‰</option>
                        </select>
                    </div>
                    <div class="form-group full">
                        <label class="form-label">ã‚¿ã‚¹ã‚¯å</label>
                        <input type="text" id="task-name" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">è¦ªã‚¿ã‚¹ã‚¯</label>
                        <select id="task-parent" class="form-select">
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">æ‹…å½“è€…</label>
                        <input type="text" id="task-person" class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label">å„ªå…ˆåº¦</label>
                        <select id="task-priority" class="form-select">
                            <option value="medium">ä¸­</option>
                            <option value="high">é«˜</option>
                            <option value="low">ä½</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">é–‹å§‹æ—¥</label>
                        <input type="date" id="task-start" class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label">çµ‚äº†æ—¥</label>
                        <input type="date" id="task-end" class="form-input">
                    </div>
                    <div class="form-group full">
                        <label class="form-label">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
                        <select id="task-status" class="form-select">
                            <option value="not-started">æœªç€æ‰‹</option>
                            <option value="in-progress">é€²è¡Œä¸­</option>
                            <option value="done">å®Œäº†</option>
                            <option value="risk">è¦æ³¨æ„</option>
                        </select>
                    </div>
                    <div class="form-group full">
                        <label class="form-label">ãƒ¡ãƒ¢</label>
                        <textarea id="task-memo" class="form-textarea"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn" onclick="deleteTaskFromModal()">å‰Šé™¤</button>
                    <button type="button" class="btn" onclick="closeTaskModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button type="submit" class="btn btn-primary">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    let tasks = [];
    let currentFilter = 'all';
    let selectedTasks = new Set();
    let currentView = 'both';
    let expandedTasks = new Set();
    let taskHistory = {};
    let taskComments = {};
    let taskAttachments = {};
    let currentCalendarMonth = new Date();
    let notifications = [];
    let reportHistory = [];
    let syncStatus = 'online';

    const MS_PER_DAY = 1000 * 60 * 60 * 24;
    let ganttProjectStart = null;
    let ganttProjectEnd = null;

    setInterval(() => {
        simulateSync();
    }, 5000);

    function simulateSync() {
        const statusDot = document.getElementById('sync-status-dot');
        const statusLabel = document.getElementById('sync-status-label');
        const statusTime = document.getElementById('sync-status-time');

        if (syncStatus === 'online') {
            statusDot.style.background = '#22c55e';
            statusDot.style.boxShadow = '0 0 0 4px rgba(34,197,94,0.22)';
            statusLabel.textContent = 'Online / è‡ªå‹•ä¿å­˜ä¸­';
            const now = new Date();
            statusTime.textContent = 'æœ€çµ‚æ›´æ–°: ' + now.toLocaleString('ja-JP', { hour12:false });
        } else {
            statusDot.style.background = '#f97316';
            statusDot.style.boxShadow = '0 0 0 4px rgba(249,115,22,0.25)';
            statusLabel.textContent = 'Offline / ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ä¸­';
        }
    }

    function initializeStaff() {
        const staff = [
            {
                name: 'ç§‹å±±',
                initials: 'A',
                role: 'å…¨ä½“è¨ˆç”»ãƒ»æ•™è‚²',
                skills: ['PM', 'æ•™è‚²è¨­è¨ˆ', 'åº—èˆ—é‹å–¶'],
                tags: ['æœ¬éƒ¨', 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒªãƒ¼ãƒ€ãƒ¼', 'æ¡ç”¨ãƒ»æ•™è‚²']
            },
            {
                name: 'ç«¹ä¹‹å†…',
                initials: 'T',
                role: 'å¥‘ç´„ãƒ»ãƒ‡ãƒ™ãƒ­ãƒƒãƒ‘ãƒ¼çª“å£',
                skills: ['å¥‘ç´„äº¤æ¸‰', 'ãƒ‡ãƒ™ãƒ­ãƒƒãƒ‘ãƒ¼å¯¾å¿œ'],
                tags: ['æœ¬éƒ¨', 'å¥‘ç´„', 'ãƒªãƒ¼ã‚·ãƒ³ã‚°']
            },
            {
                name: 'å¶Œç”°',
                initials: 'S',
                role: 'æ¡ç”¨ãƒ»ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³',
                skills: ['æ¡ç”¨é¢æ¥', 'åº—èˆ—ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³'],
                tags: ['ç¾å ´è²¬ä»»è€…', 'æ¡ç”¨', 'OJT']
            },
            {
                name: 'å¤ç›®',
                initials: 'N',
                role: 'ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ”¹å–„',
                skills: ['æ¥å®¢', 'ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³è¨­è¨ˆ'],
                tags: ['ç¾å ´', 'OJT', 'å“è³ª']
            },
            {
                name: 'è‰æŸ³',
                initials: 'K',
                role: 'SNSãƒ»ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°',
                skills: ['SNSé‹ç”¨', 'è²©ä¿ƒä¼ç”»'],
                tags: ['ãƒãƒ¼ã‚±', 'å‘ŠçŸ¥', 'ãƒ–ãƒ©ãƒ³ãƒ‰']
            },
            {
                name: 'å²¡æœ¬',
                initials: 'O',
                role: 'POPãƒ»ãƒ‡ã‚¶ã‚¤ãƒ³',
                skills: ['ãƒ‡ã‚¶ã‚¤ãƒ³', 'POPåˆ¶ä½œ'],
                tags: ['ãƒ‡ã‚¶ã‚¤ãƒ³', 'è²©ä¿ƒãƒ„ãƒ¼ãƒ«']
            }
        ];

        const container = document.getElementById('staff-grid');
        if (!container) return;
        container.innerHTML = staff.map(member => `
            <div class="staff-card">
                <div class="staff-avatar">${member.initials}</div>
                <div class="staff-info">
                    <div class="staff-name">${member.name}</div>
                    <div class="staff-role">${member.role}</div>
                    <div class="staff-skills">${member.skills.join(' / ')}</div>
                    <div class="staff-tag-row">
                        ${member.tags.map(t => `<span class="staff-tag">${t}</span>`).join('')}
                    </div>
                </div>
            </div>
        `).join('');
    }

    function setView(view) {
        currentView = view;
        const buttons = document.querySelectorAll('.view-btn');
        buttons.forEach(btn => {
            const v = btn.getAttribute('data-view');
            btn.classList.toggle('active', v === view);
        });

        const tasksCard = document.querySelector('#task-table')?.closest('.card');
        const ganttCard = document.querySelector('.tree-gantt-container')?.closest('.card');

        if (!tasksCard || !ganttCard) return;

        if (view === 'both') {
            tasksCard.style.display = '';
            ganttCard.style.display = '';
        } else if (view === 'tasks') {
            tasksCard.style.display = '';
            ganttCard.style.display = 'none';
        } else if (view === 'gantt') {
            tasksCard.style.display = 'none';
            ganttCard.style.display = '';
        }
    }

    function switchTab(tabId) {
        document.querySelectorAll('.tab').forEach(tab => {
            tab.classList.toggle('active', tab.getAttribute('data-tab') === tabId);
        });

        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.toggle('active', content.id === tabId);
        });
    }

    function onStoreChange() {
        const select = document.getElementById('store-filter');
        currentFilter = select.value;
        renderTasks();
        renderIntegratedView();
        renderCalendar();
    }

    function onLevelFilterChange() {
        renderTasks();
        renderIntegratedView();
    }

    function openTaskModal(taskId = null) {
        const backdrop = document.getElementById('task-modal-backdrop');
        const title = document.getElementById('task-modal-title');
        const form = document.getElementById('task-form');
        form.reset();

        document.getElementById('task-id').value = taskId || '';
        updateParentOptions(taskId);

        if (taskId) {
            title.textContent = 'ã‚¿ã‚¹ã‚¯ç·¨é›†';
            const task = tasks.find(t => t.id === taskId);
            if (task) {
                document.getElementById('task-level').value = task.level || 1;
                document.getElementById('task-store').value = task.store || 'kawasaki';
                document.getElementById('task-name').value = task.name || '';
                document.getElementById('task-parent').value = task.parent || '';
                document.getElementById('task-person').value = task.person || '';
                document.getElementById('task-priority').value = task.priority || 'medium';
                document.getElementById('task-start').value = task.start || '';
                document.getElementById('task-end').value = task.end || '';
                document.getElementById('task-status').value = task.status || 'not-started';
                document.getElementById('task-memo').value = task.memo || '';
            }
        } else {
            title.textContent = 'ã‚¿ã‚¹ã‚¯è¿½åŠ ';
            document.getElementById('task-store').value = document.getElementById('store-filter').value === 'all'
                ? 'kawasaki'
                : document.getElementById('store-filter').value;
        }

        backdrop.style.display = 'flex';
    }

    function closeTaskModal() {
        const backdrop = document.getElementById('task-modal-backdrop');
        backdrop.style.display = 'none';
    }

    function updateParentOptions(excludeTaskId = null) {
        const parentSelect = document.getElementById('task-parent');
        if (!parentSelect) return;

        const options = ['<option value="">ï¼ˆè¦ªãªã—ï¼‰</option>'];
        tasks.forEach(t => {
            if (excludeTaskId && t.id === excludeTaskId) return;
            options.push(`<option value="${t.id}">[L${t.level}] ${t.name}</option>`);
        });
        parentSelect.innerHTML = options.join('');
    }

    function saveTaskFromModal(event) {
        event.preventDefault();

        const id = document.getElementById('task-id').value;
        const level = parseInt(document.getElementById('task-level').value, 10);
        const store = document.getElementById('task-store').value;
        const name = document.getElementById('task-name').value.trim();
        const parent = document.getElementById('task-parent').value || null;
        const person = document.getElementById('task-person').value.trim();
        const priority = document.getElementById('task-priority').value;
        const start = document.getElementById('task-start').value;
        const end = document.getElementById('task-end').value;
        const status = document.getElementById('task-status').value;
        const memo = document.getElementById('task-memo').value;

        if (!name) {
            alert('ã‚¿ã‚¹ã‚¯åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
            return;
        }

        if (id) {
            const task = tasks.find(t => t.id === parseInt(id, 10));
            if (task) {
                task.level = level;
                task.store = store;
                task.name = name;
                task.parent = parent;
                task.person = person;
                task.priority = priority;
                task.start = start;
                task.end = end;
                task.status = status;
                task.memo = memo;
            }
        } else {
            const newId = tasks.length ? Math.max(...tasks.map(t => t.id)) + 1 : 1;
            tasks.push({
                id: newId,
                level,
                store,
                name,
                parent,
                person,
                priority,
                start,
                end,
                status,
                memo
            });
        }

        closeTaskModal();
        renderTasks();
        renderIntegratedView();
        renderCalendar();
        saveToLocalStorage();
    }

    function deleteTaskFromModal() {
        const id = document.getElementById('task-id').value;
        if (!id) {
            closeTaskModal();
            return;
        }

        if (!confirm('ã“ã®ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿï¼ˆå­ã‚¿ã‚¹ã‚¯ãŒã‚ã‚‹å ´åˆã‚‚å‰Šé™¤ã•ã‚Œã¾ã™ï¼‰')) return;

        const deleteIds = new Set([parseInt(id, 10)]);

        let changed = true;
        while (changed) {
            changed = false;
            tasks.forEach(t => {
                if (t.parent && deleteIds.has(t.parent)) {
                    if (!deleteIds.has(t.id)) {
                        deleteIds.add(t.id);
                        changed = true;
                    }
                }
            });
        }

        tasks = tasks.filter(t => !deleteIds.has(t.id));
        closeTaskModal();
        renderTasks();
        renderIntegratedView();
        renderCalendar();
        saveToLocalStorage();
    }

    function renderTasks() {
        const tbody = document.getElementById('task-table-body');
        if (!tbody) return;

        const store = document.getElementById('store-filter').value;
        const levelFilter = document.getElementById('level-filter').value;

        const filtered = tasks.filter(t => {
            if (store !== 'all' && t.store !== store) return false;
            if (levelFilter !== 'all' && String(t.level) !== levelFilter) return false;
            return true;
        });

        filtered.sort((a, b) => {
            if (a.level !== b.level) return a.level - b.level;
            const pa = a.parent ? a.parent : 0;
            const pb = b.parent ? b.parent : 0;
            if (pa !== pb) return pa - pb;
            if (a.start && b.start) {
                return new Date(a.start) - new Date(b.start);
            }
            return a.id - b.id;
        });

        const parentMap = {};
        tasks.forEach(t => parentMap[t.id] = t.name);

        const statusClassMap = {
            'not-started': 'status-not-started',
            'in-progress': 'status-in-progress',
            'done': 'status-done',
            'risk': 'status-risk'
        };

        tbody.innerHTML = filtered.map(task => {
            const isSelected = selectedTasks.has(task.id);
            const levelClass = `level-${task.level}`;
            const parentName = task.parent ? parentMap[task.parent] || '' : '';
            const startLabel = task.start || '';
            const endLabel = task.end || '';
            const statusClass = statusClassMap[task.status] || 'status-not-started';

            const priorityText = task.priority === 'high' ? 'é«˜' : (task.priority === 'low' ? 'ä½' : 'ä¸­');
            const priorityClass = task.priority === 'high'
                ? 'priority-high'
                : task.priority === 'low'
                    ? 'priority-low'
                    : 'priority-medium';

            const initials = task.person ? task.person.charAt(0) : '?';

            return `
                <tr class="${isSelected ? 'selected' : ''}" data-task-id="${task.id}" ondblclick="openTaskModal(${task.id})" onclick="toggleTaskSelection(${task.id})">
                    <td style="text-align:center;">${isSelected ? 'âœ“' : ''}</td>
                    <td><span class="level-tag ${levelClass}">L${task.level}</span></td>
                    <td>${task.name}</td>
                    <td>${parentName}</td>
                    <td>${formatStoreName(task.store)}</td>
                    <td>
                        <div class="assignee">
                            ${task.person ? `<span class="assignee-avatar">${initials}</span><span>${task.person}</span>` : '-'}
                        </div>
                    </td>
                    <td><span class="priority-tag ${priorityClass}">${priorityText}</span></td>
                    <td>${startLabel}</td>
                    <td>${endLabel}</td>
                    <td><span class="status-badge ${statusClass}">${formatStatus(task.status)}</span></td>
                </tr>
            `;
        }).join('');

        updateKPIs();
    }

    function toggleTaskSelection(taskId) {
        if (selectedTasks.has(taskId)) {
            selectedTasks.delete(taskId);
        } else {
            selectedTasks.add(taskId);
        }
        renderTasks();
    }

    function formatStoreName(store) {
        switch (store) {
            case 'kawasaki': return 'ãƒ©ã‚¾ãƒ¼ãƒŠå·å´åº—';
            case 'sample-aoyama': return 'é’å±±åº—ï¼ˆã‚µãƒ³ãƒ—ãƒ«ï¼‰';
            case 'sample-yokohama': return 'æ¨ªæµœåº—ï¼ˆã‚µãƒ³ãƒ—ãƒ«ï¼‰';
            case 'sample-shinjuku': return 'æ–°å®¿åº—ï¼ˆã‚µãƒ³ãƒ—ãƒ«ï¼‰';
            default: return store || '';
        }
    }

    function formatStatus(status) {
        switch (status) {
            case 'not-started': return 'æœªç€æ‰‹';
            case 'in-progress': return 'é€²è¡Œä¸­';
            case 'done': return 'å®Œäº†';
            case 'risk': return 'è¦æ³¨æ„';
            default: return status || '';
        }
    }

    function updateKPIs() {
        const total = tasks.length;
        const done = tasks.filter(t => t.status === 'done').length;
        const risk = tasks.filter(t => t.status === 'risk').length;

        const totalEl = document.getElementById('kpi-total-tasks');
        const doneEl = document.getElementById('kpi-done-tasks');
        const riskEl = document.getElementById('kpi-risk-tasks');

        if (totalEl) totalEl.textContent = total;
        if (doneEl) doneEl.textContent = done;
        if (riskEl) riskEl.textContent = risk;
    }

    function computeGanttRangeFromTasks() {
        if (!tasks || tasks.length === 0) {
            ganttProjectStart = null;
            ganttProjectEnd = null;
            return;
        }

        const dates = [];
        tasks.forEach(t => {
            if (t.start) dates.push(new Date(t.start));
            if (t.end) dates.push(new Date(t.end));
        });

        if (dates.length === 0) {
            ganttProjectStart = null;
            ganttProjectEnd = null;
            return;
        }

        const minTime = Math.min(...dates.map(d => d.getTime()));
        const maxTime = Math.max(...dates.map(d => d.getTime()));

        ganttProjectStart = new Date(minTime);
        ganttProjectEnd = new Date(maxTime);

        ganttProjectStart.setDate(ganttProjectStart.getDate() - 3);
        ganttProjectEnd.setDate(ganttProjectEnd.getDate() + 3);
    }

    function calculateBarPosition(start, end) {
        if (!ganttProjectStart || !ganttProjectEnd) {
            computeGanttRangeFromTasks();
        }
        if (!ganttProjectStart || !ganttProjectEnd) {
            return { left: 0, width: 0 };
        }

        const startDate = new Date(start);
        const endDate = new Date(end);

        const totalDaysRaw = (ganttProjectEnd - ganttProjectStart) / MS_PER_DAY;
        const totalDays = totalDaysRaw > 0 ? totalDaysRaw : 1;

        let startOffset = (startDate - ganttProjectStart) / MS_PER_DAY;
        let endOffset = (endDate - ganttProjectStart) / MS_PER_DAY;

        startOffset = Math.max(0, Math.min(totalDays, startOffset));
        endOffset = Math.max(0, Math.min(totalDays, endOffset));

        let duration = endOffset - startOffset;
        if (duration <= 0) duration = 1;

        return {
            left: Math.max(0, Math.min(100, (startOffset / totalDays) * 100)),
            width: Math.max(1, Math.min(100, (duration / totalDays) * 100))
        };
    }

    let ganttDraggingTaskId = null;
    let ganttDragStartX = 0;
    let ganttDragStartStartDate = null;
    let ganttDragStartEndDate = null;

    function attachGanttDragHandlers() {
        const bars = document.querySelectorAll('.gantt-bar-mini');
        bars.forEach(bar => {
            bar.addEventListener('mousedown', onGanttBarMouseDown);
        });
    }

    function onGanttBarMouseDown(e) {
        const bar = e.currentTarget;
        const id = bar.getAttribute('data-task-id');
        const task = tasks.find(t => String(t.id) === String(id));
        if (!task) return;

        ganttDraggingTaskId = id;
        ganttDragStartX = e.clientX;
        ganttDragStartStartDate = new Date(task.start);
        ganttDragStartEndDate = new Date(task.end);

        bar.classList.add('dragging');

        window.addEventListener('mousemove', onGanttBarMouseMove);
        window.addEventListener('mouseup', onGanttBarMouseUp);
    }

    function onGanttBarMouseMove(e) {
        if (!ganttDraggingTaskId || !ganttProjectStart || !ganttProjectEnd) return;

        const task = tasks.find(t => String(t.id) === String(ganttDraggingTaskId));
        if (!task) return;

        const timeline = document.querySelector('.gantt-timeline');
        if (!timeline) return;

        const totalDaysRaw = (ganttProjectEnd - ganttProjectStart) / MS_PER_DAY;
        const totalDays = totalDaysRaw > 0 ? totalDaysRaw : 1;
        const pxPerDay = timeline.clientWidth / totalDays;

        const deltaX = e.clientX - ganttDragStartX;
        const deltaDays = Math.round(deltaX / pxPerDay);

        const newStart = new Date(ganttDragStartStartDate.getTime());
        const newEnd = new Date(ganttDragStartEndDate.getTime());
        newStart.setDate(newStart.getDate() + deltaDays);
        newEnd.setDate(newEnd.getDate() + deltaDays);

        task.start = newStart.toISOString().slice(0, 10);
        task.end = newEnd.toISOString().slice(0, 10);

        renderIntegratedView();
        renderTasks();
        renderCalendar();
        saveToLocalStorage();
    }

    function onGanttBarMouseUp() {
        const bars = document.querySelectorAll('.gantt-bar-mini.dragging');
        bars.forEach(b => b.classList.remove('dragging'));

        ganttDraggingTaskId = null;
        ganttDragStartX = 0;
        ganttDragStartStartDate = null;
        ganttDragStartEndDate = null;

        window.removeEventListener('mousemove', onGanttBarMouseMove);
        window.removeEventListener('mouseup', onGanttBarMouseUp);
    }

    function renderIntegratedView() {
        const treeContainer = document.getElementById('tree-rows');
        const ganttHeaderDays = document.getElementById('gantt-header-days');
        const ganttBody = document.getElementById('gantt-body');

        if (!treeContainer || !ganttHeaderDays || !ganttBody) return;

        if (tasks.length === 0) {
            treeContainer.innerHTML = '<div class="empty-state"><strong>ã‚¿ã‚¹ã‚¯ãŒã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚</strong><br>ã€Œã‚¿ã‚¹ã‚¯è¿½åŠ ã€ã‹ã‚‰ã€ãƒ©ã‚¾ãƒ¼ãƒŠå·å´åº—ã®ã‚ªãƒ¼ãƒ—ãƒ³ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®éª¨æ ¼ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚</div>';
            ganttHeaderDays.innerHTML = '';
            ganttBody.innerHTML = '';
            return;
        }

        computeGanttRangeFromTasks();

        if (!ganttProjectStart || !ganttProjectEnd) {
            treeContainer.innerHTML = '<div class="empty-state">æ—¥ä»˜ãŒè¨­å®šã•ã‚ŒãŸã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>';
            ganttHeaderDays.innerHTML = '';
            ganttBody.innerHTML = '';
            return;
        }

        let minDate = new Date(ganttProjectStart.getTime());
        let maxDate = new Date(ganttProjectEnd.getTime());

        const store = document.getElementById('store-filter').value;
        const levelFilter = document.getElementById('level-filter').value;

        const visibleTasks = tasks.filter(t => {
            if (store !== 'all' && t.store !== store) return false;
            if (levelFilter !== 'all' && String(t.level) !== levelFilter) return false;
            return true;
        });

        if (visibleTasks.length === 0) {
            treeContainer.innerHTML = '<div class="empty-state">ã“ã®æ¡ä»¶ã«è©²å½“ã™ã‚‹ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>';
            ganttHeaderDays.innerHTML = '';
            ganttBody.innerHTML = '';
            return;
        }

        const topLevel = visibleTasks.filter(t => !t.parent);

        topLevel.forEach(t => {
            if (!expandedTasks.has(t.id)) {
                expandedTasks.add(t.id);
            }
        });

        let workMin = null;
        let workMax = null;

        visibleTasks.forEach(t => {
            if (t.start) {
                const d = new Date(t.start);
                if (!workMin || d < workMin) workMin = d;
            }
            if (t.end) {
                const d = new Date(t.end);
                if (!workMax || d > workMax) workMax = d;
            }
        });

        if (workMin && workMax) {
            minDate = new Date(workMin.getTime());
            maxDate = new Date(workMax.getTime());
            minDate.setDate(minDate.getDate() - 2);
            maxDate.setDate(maxDate.getDate() + 2);
        }

        ganttProjectStart = minDate;
        ganttProjectEnd = maxDate;

        const dayNames = 'æ—¥æœˆç«æ°´æœ¨é‡‘åœŸ';
        const daysHtml = [];
        const days = [];
        const cursor = new Date(minDate.getFullYear(), minDate.getMonth(), minDate.getDate());

        while (cursor <= maxDate) {
            const label = `${cursor.getMonth() + 1}/${cursor.getDate()}`;
            const dow = dayNames[cursor.getDay()];
            const weekend = cursor.getDay() === 0 || cursor.getDay() === 6;
            daysHtml.push(`
                <div class="gantt-day ${weekend ? 'weekend' : ''}">
                    <span>${label}</span>
                    <span class="dow">${dow}</span>
                </div>
            `);
            days.push(new Date(cursor.getTime()));
            cursor.setDate(cursor.getDate() + 1);
        }

        ganttHeaderDays.innerHTML = daysHtml.join('');

        let treeHtml = '';
        let ganttRowsHtml = '';

        const levelColors = ['#6366f1', '#22c55e', '#f97316', '#0ea5e9', '#e11d48', '#6d28d9', '#16a34a', '#7c2d12'];
        const statusClassMap = {
            'not-started': 'gantt-status-not-started',
            'in-progress': '',
            'done': 'gantt-status-done',
            'risk': 'gantt-status-risk'
        };

        const renderTaskTree = (task, depth = 0) => {
            if (!visibleTasks.includes(task)) return;
            const hasChildren = visibleTasks.some(t => t.parent == task.id);
            const isExpanded = expandedTasks.has(task.id);
            const barPosition = calculateBarPosition(task.start, task.end);

            const levelClass = `level-${task.level}`;
            const statusClass = statusClassMap[task.status] || '';
            const color = levelColors[task.level - 1] || '#6b7280';

            const indentPadding = depth * 10;
            const dateLabel = task.start && task.end
                ? `${task.start}ã€œ${task.end}`
                : (task.start || task.end || '-');

            const initials = task.person ? task.person.charAt(0) : '?';

            treeHtml += `
                <div class="tree-row" data-task-id="${task.id}">
                    <div class="tree-cell-main" style="padding-left:${8 + indentPadding}px;">
                        <div class="tree-toggle ${hasChildren ? '' : 'empty'}" ${hasChildren ? `onclick="toggleExpand(${task.id})"` : ''}>
                            ${hasChildren ? (isExpanded ? 'âˆ’' : '+') : ''}
                        </div>
                        <div class="tree-level-indicator" style="background:${color};"></div>
                        <div>
                            <div class="tree-task-title">${task.name}</div>
                            <div class="tree-assignee">
                                ${task.person ? `<span class="assignee-avatar" style="width:16px;height:16px;font-size:9px;background:${color};">${initials}</span> ${task.person}` : ''}
                                <span style="margin-left:4px;font-size:10px;color:#9ca3af;">L${task.level}</span>
                            </div>
                        </div>
                    </div>
                    <div class="tree-date">${dateLabel}</div>
                    <div class="tree-status">
                        <span class="status-badge ${statusClass}">${formatStatus(task.status)}</span>
                    </div>
                </div>
            `;

            const barLeftPercent = barPosition.left;
            const barWidthPercent = barPosition.width;

            ganttRowsHtml += `
                <div class="gantt-row" data-task-id="${task.id}">
                    <div class="gantt-track">
                        <div class="gantt-bar-mini ${statusClass}"
                             data-task-id="${task.id}"
                             title="${task.name}ï½œ${task.person || ''}ï½œ${task.start || ''}ã€œ${task.end || ''}"
                             style="left:${barLeftPercent}%; width:${barWidthPercent}%;">
                            ${task.person ? task.person : ''} ${task.start || ''}ã€œ${task.end || ''}
                        </div>
                    </div>
                </div>
            `;

            if (isExpanded && hasChildren) {
                visibleTasks
                    .filter(t => t.parent == task.id)
                    .forEach(child => renderTaskTree(child, depth + 1));
            }
        };

        topLevel.forEach(task => renderTaskTree(task, 0));

        treeContainer.innerHTML = treeHtml;
        ganttBody.innerHTML = ganttRowsHtml;

        attachGanttDragHandlers();
    }

    function toggleExpand(taskId) {
        if (expandedTasks.has(taskId)) {
            expandedTasks.delete(taskId);
        } else {
            expandedTasks.add(taskId);
        }
        renderIntegratedView();
    }

    function expandAll() {
        tasks.forEach(t => expandedTasks.add(t.id));
        renderIntegratedView();
    }

    function collapseAll() {
        expandedTasks.clear();
        renderIntegratedView();
    }

    function buildKawasakiTasks() {
        tasks = [
            {
                id: 1,
                level: 1,
                store: 'kawasaki',
                name: 'ãƒ©ã‚¾ãƒ¼ãƒŠå·å´åº—ã‚ªãƒ¼ãƒ—ãƒ³ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ',
                parent: null,
                person: 'ç§‹å±±',
                priority: 'high',
                start: '2025-10-20',
                end: '2026-03-31',
                status: 'in-progress',
                memo: 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå…¨ä½“ã®è¦ªã‚¿ã‚¹ã‚¯'
            }
        ];
    }

    function renderCalendar() {
        const grid = document.getElementById('calendar-grid');
        if (!grid) return;

        const date = currentCalendarMonth;
        const y = date.getFullYear();
        const m = date.getMonth();

        document.getElementById('calendar-month-label').textContent = `${y}å¹´${m + 1}æœˆ`;

        const firstDay = new Date(y, m, 1);
        const lastDay = new Date(y, m + 1, 0);

        const startOffset = firstDay.getDay();
        const totalDays = lastDay.getDate();

        grid.innerHTML = '';

        const dayNames = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
        dayNames.forEach(d => {
            const header = document.createElement('div');
            header.className = 'calendar-day-header';
            header.textContent = d;
            grid.appendChild(header);
        });

        for (let i = 0; i < startOffset; i++) {
            const empty = document.createElement('div');
            grid.appendChild(empty);
        }

        const today = new Date();
        today.setHours(0,0,0,0);

        for (let d = 1; d <= totalDays; d++) {
            const dayDate = new Date(y, m, d);
            const dayCell = document.createElement('div');
            dayCell.className = 'calendar-day';

            if (dayDate.getTime() === today.getTime()) {
                dayCell.classList.add('today');
            }

            const dateLabel = document.createElement('div');
            dateLabel.className = 'calendar-date-label';
            dateLabel.textContent = d;

            const luckyLabel = document.createElement('div');
            if (dayDate.getDay() === 0) {
                luckyLabel.className = 'calendar-unlucky';
                luckyLabel.textContent = 'ä¸æˆå°±æ—¥';
            } else if (dayDate.getDay() === 6) {
                luckyLabel.className = 'calendar-lucky';
                luckyLabel.textContent = 'å¤§å®‰';
            }

            dayCell.appendChild(dateLabel);
            dayCell.appendChild(luckyLabel);

            const dayTasks = tasks.filter(t => t.start === formatISO(dayDate));
            dayTasks.forEach(t => {
                const chip = document.createElement('div');
                chip.className = 'calendar-task-chip';
                if (t.priority === 'high') chip.classList.add('important');
                chip.textContent = t.name;
                dayCell.appendChild(chip);
            });

            grid.appendChild(dayCell);
        }
    }

    function formatISO(date) {
        const y = date.getFullYear();
        const m = String(date.getMonth() + 1).padStart(2, '0');
        const d = String(date.getDate()).padStart(2, '0');
        return `${y}-${m}-${d}`;
    }

    function changeMonth(delta) {
        currentCalendarMonth = new Date(currentCalendarMonth.getFullYear(), currentCalendarMonth.getMonth() + delta, 1);
        renderCalendar();
    }

    function goToThisMonth() {
        currentCalendarMonth = new Date();
        renderCalendar();
    }

    function scrollToToday() {
        if (!ganttProjectStart || !ganttProjectEnd) return;

        const today = new Date();
        const todayISO = formatISO(today);
        const hasTodayTask = tasks.some(t => t.start === todayISO || t.end === todayISO);
        if (!hasTodayTask) return;

        const totalDays = (ganttProjectEnd - ganttProjectStart) / MS_PER_DAY;
        if (totalDays <= 0) return;

        const offsetDays = (today - ganttProjectStart) / MS_PER_DAY;
        const scrollFraction = offsetDays / totalDays;

        const ganttColumn = document.querySelector('.gantt-column');
        if (!ganttColumn) return;

        const maxScroll = ganttColumn.scrollWidth - ganttColumn.clientWidth;
        const targetScrollLeft = Math.max(0, Math.min(maxScroll, maxScroll * scrollFraction - ganttColumn.clientWidth / 2));

        ganttColumn.scrollLeft = targetScrollLeft;
    }

    function generateSimpleReport() {
        const now = new Date();
        const dateStr = now.toLocaleDateString('ja-JP', { year: 'numeric', month: 'short', day: 'numeric' });
        const done = tasks.filter(t => t.status === 'done');
        const inProgress = tasks.filter(t => t.status === 'in-progress');
        const risk = tasks.filter(t => t.status === 'risk');

        const reportLines = [];
        reportLines.push(`ã€${dateStr} æ–°åº—ã‚ªãƒ¼ãƒ—ãƒ³çŠ¶æ³ã€‘`);
        reportLines.push('');
        reportLines.push(`â–  é€²è¡Œä¸­ã‚¿ã‚¹ã‚¯æ•°ï¼š${inProgress.length}`);
        reportLines.push(`â–  å®Œäº†ã‚¿ã‚¹ã‚¯æ•°ã€€ï¼š${done.length}`);
        reportLines.push(`â–  è¦æ³¨æ„ã‚¿ã‚¹ã‚¯æ•°ï¼š${risk.length}`);
        reportLines.push('');

        if (inProgress.length) {
            reportLines.push('ï¼œé€²è¡Œä¸­ï¼ˆä¸»ãªã‚‚ã®ï¼‰ï¼');
            inProgress.slice(0, 5).forEach(t => {
                reportLines.push(`ãƒ»${t.name}ï¼ˆæ‹…å½“ï¼š${t.person || '-'} / ã€œ${t.end || '-'}ï¼‰`);
            });
            reportLines.push('');
        }

        if (risk.length) {
            reportLines.push('ï¼œè¦æ³¨æ„ã‚¿ã‚¹ã‚¯ï¼');
            risk.slice(0, 5).forEach(t => {
                reportLines.push(`ãƒ»${t.name}ï¼ˆæ‹…å½“ï¼š${t.person || '-'} / ã€œ${t.end || '-'}ï¼‰`);
            });
            reportLines.push('');
        }

        const reportArea = document.getElementById('report-text');
        if (reportArea) {
            reportArea.value = reportLines.join('\n');
        }
    }

    function copyReport() {
        const reportArea = document.getElementById('report-text');
        if (!reportArea || !reportArea.value) {
            alert('ã‚³ãƒ”ãƒ¼ã™ã‚‹ãƒ¬ãƒãƒ¼ãƒˆãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
            return;
        }
        reportArea.select();
        document.execCommand('copy');
        alert('ãƒ¬ãƒãƒ¼ãƒˆã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚');
    }

    function saveToLocalStorage() {
        try {
            const data = {
                tasks,
                expandedTasks: Array.from(expandedTasks),
                selectedTasks: Array.from(selectedTasks)
            };
            localStorage.setItem('istyle_store_dashboard', JSON.stringify(data));
        } catch (e) {}
    }

    function loadFromLocalStorage() {
        try {
            const raw = localStorage.getItem('istyle_store_dashboard');
            if (!raw) return;
            const data = JSON.parse(raw);
            if (data.tasks) tasks = data.tasks;
            if (data.expandedTasks) expandedTasks = new Set(data.expandedTasks);
            if (data.selectedTasks) selectedTasks = new Set(data.selectedTasks);
        } catch (e) {}
    }

    function exportTasks() {
        if (!tasks.length) {
            alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
            return;
        }

        const header = [
            'ID',
            'ãƒ¬ãƒ™ãƒ«',
            'åº—èˆ—',
            'ã‚¿ã‚¹ã‚¯å',
            'è¦ªã‚¿ã‚¹ã‚¯ID',
            'æ‹…å½“',
            'å„ªå…ˆåº¦',
            'é–‹å§‹æ—¥',
            'çµ‚äº†æ—¥',
            'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹',
            'ãƒ¡ãƒ¢'
        ];

        const rows = tasks.map(t => [
            t.id,
            t.level,
            formatStoreName(t.store),
            t.name,
            t.parent || '',
            t.person || '',
            t.priority || '',
            t.start || '',
            t.end || '',
            formatStatus(t.status),
            (t.memo || '').replace(/\r?\n/g, ' ')
        ]);

        const csvContent = [header, ...rows].map(r => r.map(field => {
            const f = String(field).replace(/"/g, '""');
            if (f.search(/("|,|\n)/g) >= 0) {
                return `"${f}"`;
            }
            return f;
        }).join(',')).join('\n');

        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'tasks_export.csv';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    function initializeSampleTasks() {
        buildKawasakiTasks();

        tasks.push(
            {
                id: 2,
                level: 2,
                store: 'kawasaki',
                name: 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨­è¨ˆãƒ»å…¨ä½“è¨ˆç”»',
                parent: 1,
                person: 'ç§‹å±±',
                priority: 'high',
                start: '2025-10-20',
                end: '2025-11-15',
                status: 'in-progress',
                memo: 'å…¨ä½“åƒã‚’å›ºã‚ã‚‹ãƒ•ã‚§ãƒ¼ã‚º'
            },
            {
                id: 3,
                level: 2,
                store: 'kawasaki',
                name: 'ãƒ‡ãƒ™ãƒ­ãƒƒãƒ‘ãƒ¼ãƒ»å¥‘ç´„é–¢é€£',
                parent: 1,
                person: 'ç«¹ä¹‹å†…',
                priority: 'high',
                start: '2025-10-20',
                end: '2025-12-15',
                status: 'in-progress',
                memo: 'ãƒ‡ãƒ™ãƒ­ãƒƒãƒ‘ãƒ¼ã¨ã®çª“å£'
            },
            {
                id: 4,
                level: 2,
                store: 'kawasaki',
                name: 'æ¡ç”¨ãƒ»äººå“¡ãƒ»æ•™è‚²',
                parent: 1,
                person: 'ç§‹å±± / å¶Œç”°',
                priority: 'high',
                start: '2025-11-01',
                end: '2026-02-15',
                status: 'not-started',
                memo: 'äººã®ç¢ºä¿ã¨è‚²æˆ'
            },
            {
                id: 5,
                level: 2,
                store: 'kawasaki',
                name: 'ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ»ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ãƒ»ä»•çµ„ã¿',
                parent: 1,
                person: 'å¶Œç”° / å¤ç›®',
                priority: 'medium',
                start: '2025-11-10',
                end: '2026-01-31',
                status: 'not-started',
                memo: 'ç¾å ´ã®å›ã—æ–¹'
            },
            {
                id: 6,
                level: 2,
                store: 'kawasaki',
                name: 'ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°ãƒ»è²©ä¿ƒãƒ»ãƒ–ãƒ©ãƒ³ãƒ‡ã‚£ãƒ³ã‚°',
                parent: 1,
                person: 'è‰æŸ³',
                priority: 'medium',
                start: '2025-12-01',
                end: '2026-02-28',
                status: 'not-started',
                memo: 'SNSã€œé¤¨å†…è²©ä¿ƒ'
            },
            {
                id: 7,
                level: 3,
                store: 'kawasaki',
                name: 'ã‚ªãƒ¼ãƒ—ãƒ³ç›®æ¨™æ—¥ã¨ã‚½ãƒ•ãƒˆã‚ªãƒ¼ãƒ—ãƒ³æ—¥ã‚’æ±ºå®šã™ã‚‹',
                parent: 2,
                person: 'ç§‹å±±',
                priority: 'high',
                start: '2025-10-20',
                end: '2025-10-31',
                status: 'in-progress',
                memo: 'å¼•ãæ¸¡ã—æ—¥ã‹ã‚‰é€†ç®—'
            },
            {
                id: 8,
                level: 3,
                store: 'kawasaki',
                name: 'KGI/KPIãƒ»å£²ä¸Šã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½œæˆ',
                parent: 2,
                person: 'ç§‹å±±',
                priority: 'high',
                start: '2025-10-25',
                end: '2025-11-10',
                status: 'not-started',
                memo: '1ãƒ¶æœˆ/3ãƒ¶æœˆ/1å¹´ã®ç›®æ¨™'
            },
            {
                id: 9,
                level: 3,
                store: 'kawasaki',
                name: 'æ±‚äººæ¡ä»¶ãƒ»äººæ•°è¨ˆç”»ã®ç¢ºå®š',
                parent: 4,
                person: 'ç§‹å±± / å¶Œç”°',
                priority: 'high',
                start: '2025-11-05',
                end: '2025-11-20',
                status: 'not-started',
                memo: 'å¿…è¦äººå“¡æ•°ãƒ»ãƒã‚¸ã‚·ãƒ§ãƒ³æ§‹æˆ'
            },
            {
                id: 10,
                level: 3,
                store: 'kawasaki',
                name: 'ã‚¢ãƒ«ãƒã‚¤ãƒˆãƒ»ç¤¾å“¡ã®æ¡ç”¨é¢æ¥',
                parent: 4,
                person: 'å¶Œç”°',
                priority: 'high',
                start: '2025-11-20',
                end: '2026-01-10',
                status: 'not-started',
                memo: 'é¢æ¥å®Ÿæ–½ãƒ»è©•ä¾¡ã‚·ãƒ¼ãƒˆ'
            },
            {
                id: 11,
                level: 3,
                store: 'kawasaki',
                name: 'SNSãƒ»é¤¨å†…å‘ŠçŸ¥ã®ä¼ç”»ã¨ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ä½œæˆ',
                parent: 6,
                person: 'è‰æŸ³',
                priority: 'medium',
                start: '2025-12-10',
                end: '2026-01-15',
                status: 'not-started',
                memo: 'ã‚ªãƒ¼ãƒ—ãƒ³å‘ŠçŸ¥è¨ˆç”»'
            },
            {
                id: 12,
                level: 3,
                store: 'kawasaki',
                name: 'ã‚ªãƒ¼ãƒ—ãƒ³è¨˜å¿µãƒãƒ™ãƒ«ãƒ†ã‚£ä¼ç”»ãƒ»ç™ºæ³¨',
                parent: 6,
                person: 'è‰æŸ³ / å²¡æœ¬',
                priority: 'medium',
                start: '2025-12-20',
                end: '2026-02-10',
                status: 'not-started',
                memo: 'ãƒãƒ™ãƒ«ãƒ†ã‚£å†…å®¹ãƒ»ã‚³ã‚¹ãƒˆ'
            }
        );
    }

    function init() {
        loadFromLocalStorage();
        if (!tasks.length) {
            initializeSampleTasks();
        }

        initializeStaff();
        renderTasks();
        renderIntegratedView();
        currentCalendarMonth = new Date(2025, 9, 1);
        renderCalendar();
        simulateSync();
    }

    document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
