<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>I-STYLE æ–°åº—ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ - æœ€çµ‚ä¿®æ­£ç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <style>
        /* CSSãƒªã‚»ãƒƒãƒˆã¨å¤‰æ•°å®šç¾© */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #007AFF;
            --secondary: #5856D6;
            --success: #34C759;
            --warning: #FF9500;
            --danger: #FF3B30;
            --background: #F5F5F7;
            --surface: #FFFFFF;
            --text-primary: #1D1D1F;
            --text-secondary: #86868B;
            --border: #D2D2D7;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Helvetica Neue', Arial, sans-serif;
            background: var(--background);
            color: var(--text-primary);
            line-height: 1.6;
            /* ãƒšãƒ¼ã‚¸å…¨ä½“ã®æœ€å°é«˜ã•ã‚’è¨­å®š */
            min-height: 100vh;
        }

        .app-container {
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ */
        .mobile-menu-btn {
            display: none;
            position: fixed;
            top: 16px;
            left: 16px;
            z-index: 1001;
            background: var(--primary);
            color: white;
            border: none;
            width: 48px;
            height: 48px;
            border-radius: 12px;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3);
        }

        .mobile-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }

        /* ã‚µã‚¤ãƒ‰ãƒãƒ¼ */
        .sidebar {
            width: 280px;
            background: var(--surface);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            z-index: 1000;
            position: relative;
        }

        .sidebar-header {
            padding: 24px;
            border-bottom: 1px solid var(--border);
        }

        .logo {
            font-size: 24px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
        }

        .store-selector {
            margin-top: 16px;
        }

        .store-select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-size: 15px;
            background: var(--background);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .store-select:focus {
            outline: none;
            border-color: var(--primary);
            background: var(--surface);
        }

        .nav-menu {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            margin-bottom: 4px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
            color: var(--text-primary);
        }

        .nav-item:hover {
            background: var(--background);
        }

        .nav-item.active {
            background: var(--primary);
            color: white;
        }

        .nav-item .icon {
            margin-right: 12px;
            font-size: 20px;
        }

        /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */
        .main-content {
            flex: 1;
            overflow-y: auto;
            background: var(--background);
        }

        .content-header {
            background: var(--surface);
            padding: 12px 24px;
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(20px);
            background: rgba(255, 255, 255, 0.9);
            overflow: hidden;
            transition: all 0.2s ease;
        }

        .content-header h1 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 2px;
        }

        .content-header p {
            color: var(--text-secondary);
            font-size: 13px;
        }

        .content-body {
            padding: 16px;
        }

        /* ãƒªã‚µã‚¤ã‚¶ãƒ¼ */
        .sidebar-resizer {
            position: absolute;
            right: 0;
            top: 0;
            width: 5px;
            height: 100%;
            cursor: ew-resize;
            background: transparent;
            z-index: 1001;
            transition: background 0.2s ease;
        }

        .sidebar-resizer:hover {
            background: var(--primary);
        }

        .header-resizer {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 5px;
            cursor: ns-resize;
            background: transparent;
            z-index: 101;
            transition: background 0.2s ease;
        }

        .header-resizer:hover {
            background: var(--primary);
        }

        /* ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */
        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ã‚«ãƒ¼ãƒ‰ */
        .card {
            background: var(--surface);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            flex-wrap: wrap;
            gap: 8px;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
        }

        /* ãƒœã‚¿ãƒ³ */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: #0051D5;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3);
        }

        .btn-secondary {
            background: var(--background);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: #E8E8ED;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-group {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        /* çµ±è¨ˆã‚«ãƒ¼ãƒ‰ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            padding: 24px;
            border-radius: 16px;
            color: white;
            text-align: center;
        }

        .stat-value {
            font-size: 36px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }

        /* éšå±¤ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆ */
        .hierarchical-task-list {
            margin-top: 20px;
        }

        .task-group {
            margin-bottom: 16px;
        }

        .parent-task {
            background: linear-gradient(135deg, rgba(0, 122, 255, 0.15), rgba(88, 86, 214, 0.15));
            border-left: 6px solid var(--primary);
            padding: 20px;
            margin-bottom: 8px;
            border-radius: 12px;
            font-weight: 700;
            font-size: 18px;
        }

        .child-tasks {
            margin-left: 30px;
        }

        .task-item {
            background: var(--background);
            border-left: 4px solid var(--primary);
            padding: 16px;
            margin-bottom: 8px;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .task-item:hover {
            background: #E8E8ED;
            transform: translateX(4px);
        }

        .task-item.level-1 {
            background: linear-gradient(135deg, rgba(0, 122, 255, 0.1), rgba(88, 86, 214, 0.1));
            border-left-width: 6px;
            font-weight: 700;
            font-size: 18px;
            padding: 20px;
        }

        .task-item.level-2 {
            margin-left: 30px;
            border-left-color: var(--secondary);
            font-weight: 600;
            font-size: 16px;
        }

        .task-item.level-3 {
            margin-left: 60px;
            border-left-color: var(--success);
        }

        .task-item.level-4 { margin-left: 90px; border-left-color: var(--warning); }
        .task-item.level-5 { margin-left: 120px; border-left-color: #FF2D55; }
        .task-item.level-6 { margin-left: 150px; border-left-color: #AF52DE; }
        .task-item.level-7 { margin-left: 180px; border-left-color: #FFD60A; }
        .task-item.level-8 { margin-left: 210px; border-left-color: #64D2FF; }
        .task-item.level-9 { margin-left: 240px; border-left-color: #30D158; }
        .task-item.level-10 { margin-left: 270px; border-left-color: #BF5AF2; }

        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
            gap: 12px;
        }

        .task-name {
            font-weight: 600;
            color: var(--text-primary);
            flex: 1;
        }

        .task-meta {
            display: flex;
            gap: 12px;
            font-size: 14px;
            color: var(--text-secondary);
            margin-top: 8px;
            flex-wrap: wrap;
        }

        .task-assignee {
            background: rgba(0, 122, 255, 0.1);
            color: var(--primary);
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 600;
        }

        .task-status {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 600;
        }

        .task-status.pending { background: #FEF5E7; color: #D68910; }
        .task-status.in-progress { background: #E3F2FD; color: #1976D2; }
        .task-status.completed { background: #E8F5E9; color: #388E3C; }

        .task-memo {
            color: var(--text-secondary);
            font-size: 14px;
            margin-top: 8px;
            font-style: italic;
        }

        .task-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .btn-edit, .btn-delete {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-edit {
            background: #E3F2FD;
            color: #1976D2;
        }

        .btn-delete {
            background: #FFEBEE;
            color: #C62828;
        }

        /* ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆ */
        .gantt-container {
            background: var(--surface);
            border-radius: 12px;
            padding: 12px;
            /* ç”»é¢ã®é«˜ã•ã„ã£ã±ã„ã«åºƒãŒã‚‹ã‚ˆã†ã«èª¿æ•´ */
            max-height: calc(100vh - 120px); 
            min-height: 400px;
            display: flex;
            flex-direction: column;
        }

        /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã‚’å¸¸æ™‚è¡¨ç¤º */
        .gantt-scroll-wrapper {
            overflow: scroll; 
            overflow-x: scroll; 
            overflow-y: scroll; 
            flex: 1;
            position: relative;
        }

        /* å­ã€å­«ã‚¿ã‚¹ã‚¯ã®è¡¨ç¤º/éè¡¨ç¤º */
        .gantt-row.collapsed {
            display: none;
        }

        /* å±•é–‹/æŠ˜ã‚ŠãŸãŸã¿ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .gantt-toggle-btn {
            display: inline-block;
            margin-right: 6px;
            cursor: pointer;
            font-size: 10px;
            line-height: 1;
            transition: transform 0.2s ease;
            font-family: 'SF Pro Display', 'Helvetica Neue', Arial, sans-serif;
            font-weight: 900;
        }

        /* å±•é–‹çŠ¶æ…‹ã®æ™‚ã®ãƒœã‚¿ãƒ³ã®å‘ãï¼ˆâ–¶ï¸ã‹ã‚‰â–¼ã¸ï¼‰ */
        .gantt-row.expanded > .gantt-task-info .gantt-toggle-btn {
            transform: rotate(90deg);
        }
        
        /* ã‚¿ã‚¹ã‚¯åè¡¨ç¤ºéƒ¨åˆ†ã®èª¿æ•´ */
        .gantt-row.expanded > .gantt-task-info > div {
            display: flex;
            align-items: center;
        }

        .gantt-header-fixed {
            position: sticky;
            top: 0;
            background: var(--surface);
            z-index: 15;
            padding-bottom: 16px;
            border-bottom: 2px solid var(--border);
            margin-bottom: 16px;
        }

        .gantt-timeline-wrapper {
            display: flex;
        }

        .gantt-task-names {
            width: 300px;
            flex-shrink: 0;
            position: sticky;
            left: 0;
            background: var(--surface);
            z-index: 40;
        }

        .gantt-timeline-container {
            flex: 1;
            min-width: 2000px;
        }

        .gantt-calendar-header {
            display: flex;
            border-bottom: 2px solid var(--border);
            margin-bottom: 12px;
        }

        .gantt-year-header {
            display: flex;
            margin-bottom: 8px;
        }

        .gantt-year-block {
            flex: 0 0 auto;
            text-align: center;
            padding: 10px 12px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            font-weight: 700;
            font-size: 15px;
            border-radius: 8px;
            margin: 0 1px;
        }

        .gantt-month-header {
            display: flex;
            margin-bottom: 4px;
        }

        .gantt-month-block {
            flex: 0 0 auto;
            text-align: center;
            padding: 8px 6px;
            background: var(--background);
            font-weight: 600;
            font-size: 13px;
            border-radius: 6px;
            margin: 0 1px;
        }

        .gantt-day-header {
            display: flex;
        }

        .gantt-day-cell {
            flex: 0 0 30px;
            width: 30px;
            text-align: center;
            padding: 6px 2px;
            font-size: 10px;
            border-right: 1px solid var(--border);
            color: var(--text-secondary);
            line-height: 1.2;
        }

        .gantt-day-cell.weekend {
            background: rgba(255, 149, 0, 0.05);
        }

        .gantt-day-cell.today {
            background: rgba(0, 122, 255, 0.15);
            color: var(--primary);
            font-weight: 700;
        }

        .gantt-row {
            display: flex;
            align-items: stretch;
            border-bottom: 1px solid var(--border);
            min-height: 40px; /* é«˜ã•ã‚’æƒãˆã‚‹ */
        }
        
        /* ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³å´ã®è¡Œã®é«˜ã•ã‚’ã‚¿ã‚¹ã‚¯æƒ…å ±å´ã¨åŒæœŸã•ã›ã‚‹ãŸã‚ã®èª¿æ•´ */
        .gantt-timeline-row {
            min-height: 40px; 
            height: 100%;
        }


        .gantt-task-info {
            padding: 4px 8px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            background: #FFFFFF !important;
            position: sticky;
            left: 0;
            z-index: 150;
            border-right: 2px solid var(--border);
        }

        .gantt-row.level-1 .gantt-task-info {
            font-weight: 700;
            background: #e8f0ff !important;
        }

        .gantt-row.level-2 .gantt-task-info {
            padding-left: 32px;
            font-weight: 600;
        }

        .gantt-row.level-3 .gantt-task-info {
            padding-left: 52px;
        }

        .gantt-timeline-row {
            flex: 1;
            position: relative;
            display: flex;
            align-items: center;
        }

        .gantt-timeline-bg {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
        }

        .gantt-day-bg {
            border-right: 1px solid rgba(0, 0, 0, 0.05);
        }

        .gantt-day-bg.weekend {
            background: rgba(255, 149, 0, 0.02);
        }

        .gantt-bar {
            position: absolute;
            height: 32px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 8px;
            cursor: move;
            display: flex;
            align-items: center;
            padding: 0 12px;
            color: white;
            font-size: 12px;
            font-weight: 600;
            user-select: none;
            transition: box-shadow 0.2s ease;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            z-index: 5;
            opacity: 1;
        }

        .gantt-bar:hover {
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.5);
            z-index: 20;
        }

        .gantt-bar.dragging {
            opacity: 0.8;
            z-index: 100;
        }

        .gantt-bar-resize-left,
        .gantt-bar-resize-right {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 10px;
            cursor: ew-resize;
            background: rgba(255, 255, 255, 0.3);
        }

        .gantt-bar-resize-left {
            left: 0;
            border-radius: 8px 0 0 8px;
        }

        .gantt-bar-resize-right {
            right: 0;
            border-radius: 0 8px 8px 0;
        }

        .gantt-today-line {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 3px;
            background: var(--danger);
            z-index: 20;
            pointer-events: none;
            box-shadow: 0 0 8px rgba(255, 59, 48, 0.5);
        }

        /* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ */
        .calendar-container {
            background: var(--surface);
            border-radius: 16px;
            padding: 24px;
            /* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ç¸¦å¹…èª¿æ•´ */
            height: calc(100vh - 100px); 
            display: flex;
            flex-direction: column;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            flex-shrink: 0;
        }

        .calendar-nav {
            display: flex;
            gap: 8px;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            grid-template-rows: repeat(6, 1fr);
            gap: 8px;
            flex: 1;
            min-height: 0;
        }

        .calendar-day {
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 8px;
            position: relative;
            overflow: auto;
        }

        .calendar-day.other-month {
            opacity: 0.3;
        }

        .calendar-day.today {
            background: rgba(0, 122, 255, 0.1);
            border-color: var(--primary);
            border-width: 2px;
        }

        .calendar-day-number {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .calendar-task {
            font-size: 11px;
            padding: 2px 6px;
            background: var(--primary);
            color: white;
            border-radius: 4px;
            margin-bottom: 2px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* ã‚¹ã‚¿ãƒƒãƒ•ã‚°ãƒªãƒƒãƒ‰ */
        .staff-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
        }

        .staff-card {
            background: var(--background);
            border-radius: 12px;
            padding: 20px;
            transition: all 0.2s ease;
        }

        .staff-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        .staff-name {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .staff-role {
            display: inline-block;
            padding: 4px 12px;
            background: rgba(0, 122, 255, 0.1);
            color: var(--primary);
            border-radius: 12px;
            font-size: 13px;
            margin-bottom: 12px;
        }

        .staff-info {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 32px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 2px solid var(--border);
        }

        .modal-title {
            font-size: 24px;
            font-weight: 700;
        }

        /* ãƒ•ã‚©ãƒ¼ãƒ  */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 15px;
            transition: all 0.2s ease;
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(0, 122, 255, 0.1);
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        /* CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ */
        .import-zone {
            border: 2px dashed var(--border);
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            background: var(--background);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .import-zone:hover {
            border-color: var(--primary);
            background: rgba(0, 122, 255, 0.05);
        }

        .import-zone.dragover {
            border-color: var(--primary);
            background: rgba(0, 122, 255, 0.1);
        }

        /* ç©ºã®ã‚¹ãƒ†ãƒ¼ãƒˆè¡¨ç¤º */
        .empty-state { 
            text-align: center; 
            padding: 60px 20px; 
            color: var(--text-secondary); 
        } 
        .empty-state-icon { 
            font-size: 64px; 
            margin-bottom: 16px; 
            opacity: 0.5; 
        } 
        .empty-state-text { 
            font-size: 18px; 
        }

        /* å°åˆ·ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        @media print {
            .sidebar,
            .content-header,
            .mobile-menu-btn,
            .btn,
            .task-actions,
            .calendar-nav,
            /* ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã¯å°åˆ·ã—ãªã„ */
            .login-screen {
                display: none !important;
            }

            body {
                background: white;
            }

            .main-content {
                width: 100%;
                padding: 0;
            }

            .content-body {
                padding: 0;
            }

            .gantt-container {
                box-shadow: none;
                border: 1px solid #000;
                page-break-inside: avoid;
            }

            .card-header {
                border-bottom: 2px solid #000;
                padding-bottom: 16px;
                margin-bottom: 16px;
            }

            .card-title {
                color: #000;
                font-size: 20px;
            }

            .gantt-bar {
                /* èƒŒæ™¯è‰²ã‚’å°åˆ·ã«åæ˜  */
                print-color-adjust: exact;
                -webkit-print-color-adjust: exact;
            }

            .gantt-year-block,
            .gantt-month-block {
                print-color-adjust: exact;
                -webkit-print-color-adjust: exact;
            }

            .gantt-scroll-wrapper {
                overflow: visible !important;
                max-height: none !important;
                transform: none !important;
            }

            .gantt-task-info {
                position: relative;
                left: auto;
            }
        }

        /* ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œ */
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: 0;
                top: 0;
                height: 100%;
                transform: translateX(-100%);
            }

            .sidebar.active {
                transform: translateX(0);
            }

            .mobile-menu-btn {
                display: block;
            }

            .mobile-overlay.active {
                display: block;
            }

            .content-header {
                padding: 20px 16px;
                padding-top: 80px;
            }

            .content-header h1 {
                font-size: 24px;
            }

            .content-body {
                padding: 16px;
            }

            .gantt-task-names,
            .gantt-task-info {
                width: 150px;
            }

            .task-item.level-2 { margin-left: 20px; }
            .task-item.level-3 { margin-left: 40px; }
            .task-item.level-4 { margin-left: 60px; }
            .task-item.level-5 { margin-left: 80px; }
            .task-item.level-6 { margin-left: 100px; }
            .task-item.level-7 { margin-left: 120px; }
            .task-item.level-8 { margin-left: 140px; }
            .task-item.level-9 { margin-left: 160px; }
            .task-item.level-10 { margin-left: 180px; }

            .staff-grid { grid-template-columns: 1fr; }
            .calendar-grid { gap: 4px; }
            .calendar-day { min-height: 60px; padding: 4px; } 

            /* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®é«˜ã•ã‚’èª¿æ•´ */
            .calendar-container { 
                height: auto; 
                min-height: calc(100vh - 150px);
            }
        }
    </style>
</head>
<body>

    <div id="loginScreen" class="login-screen" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(135deg, #007AFF, #5856D6); z-index: 9999; display: flex; align-items: center; justify-content: center;">
        <div style="background: white; padding: 48px; border-radius: 24px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); width: 420px; max-width: 90%;">
            <h1 style="font-size: 32px; font-weight: 700; background: linear-gradient(135deg, #007AFF, #5856D6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-align: center; margin-bottom: 32px;">ğŸª I-STYLE</h1>
            <div id="loginError" style="display: none; padding: 12px; background: rgba(255, 59, 48, 0.1); color: #FF3B30; border-radius: 8px; margin-bottom: 16px; font-size: 14px;"></div>
            <form id="loginForm" onsubmit="handleLogin(event)">
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                    <input type="email" id="loginEmail" required style="width: 100%; padding: 12px; border: 2px solid #D2D2D7; border-radius: 10px; font-size: 16px;">
                </div>
                <div style="margin-bottom: 24px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                    <input type="password" id="loginPassword" required style="width: 100%; padding: 12px; border: 2px solid #D2D2D7; border-radius: 10px; font-size: 16px;">
                </div>
                <button type="submit" style="width: 100%; padding: 14px; background: #007AFF; color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer;">ãƒ­ã‚°ã‚¤ãƒ³</button>
            </form>
            <div style="text-align: center; margin-top: 16px; font-size: 12px; color: #86868B;">
                ãƒ†ã‚¹ãƒˆã‚¢ã‚«ã‚¦ãƒ³ãƒˆ: test@istyle.com / password
            </div>
        </div>
    </div>


    <button class="mobile-menu-btn" onclick="toggleSidebar()">â˜°</button>
    <div class="mobile-overlay" onclick="toggleSidebar()"></div>
    <div class="app-container" id="appContainer" style="display: none;">

        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo">ğŸª I-STYLE</div>
                <div class="store-selector">
                    <select class="store-select" id="storeSelect" onchange="switchStore()">
                        <option value="default">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆåº—èˆ—</option>
                    </select>
                </div>
                <div id="userInfo" style="margin-top: 16px; padding: 12px; background: #F5F5F7; border-radius: 10px;">
                    <div style="font-weight: 600; margin-bottom: 4px;" id="currentUserName"></div>
                    <div style="font-size: 12px; color: #86868B;" id="currentUserRole"></div>
                </div>
            </div>
            <nav class="nav-menu">
                <div class="nav-item active" onclick="showTab('dashboard', this)">
                    <span class="icon">ğŸ“Š</span> ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
                </div>
                <div class="nav-item" onclick="showTab('gantt', this)">
                    <span class="icon">ğŸ“…</span> ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆ
                </div>
                <div class="nav-item" onclick="showTab('calendar', this)">
                    <span class="icon">ğŸ—“ï¸</span> ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼
                </div>
                <div class="nav-item" onclick="showTab('staff', this)">
                    <span class="icon">ğŸ‘¥</span> ã‚¹ã‚¿ãƒƒãƒ•
                </div>
                <div class="nav-item" onclick="showTab('timeline', this)">
                    <span class="icon">â±ï¸</span> ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³
                </div>
                <div class="nav-item" onclick="showTab('tasks', this)">
                    <span class="icon">ğŸ“‹</span> ã‚¿ã‚¹ã‚¯ç®¡ç†
                </div>
                <div class="nav-item" onclick="showTab('settings', this)">
                    <span class="icon">âš™ï¸</span> è¨­å®š
                </div>
            </nav>
            <div style="margin-top: auto; padding: 16px; border-top: 1px solid #D2D2D7;">
                <button onclick="logout()" style="width: 100%; padding: 12px; background: #FF3B30; color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer;">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
            </div>
            <div class="sidebar-resizer" id="sidebarResizer"></div>
        </aside>

        <main class="main-content">
            <div class="content-header" id="contentHeader">
                <h1 id="pageTitle">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
                <p id="pageDescription">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®é€²æ—ã‚’ä¸€ç›®ã§ç¢ºèª</p>
                <div class="header-resizer" id="headerResizer"></div>
            </div>
            <div class="content-body">

                <div id="dashboard" class="tab-content active">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="totalTasks">0</div>
                            <div class="stat-label">ç·ã‚¿ã‚¹ã‚¯æ•°</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="completedTasks">0</div>
                            <div class="stat-label">å®Œäº†</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="inProgressTasks">0</div>
                            <div class="stat-label">é€²è¡Œä¸­</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="progressPercent">0%</div>
                            <div class="stat-label">é€²æ—ç‡</div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦</h2>
                        </div>
                        <div id="dashboardStats">
                            <div class="empty-state">
                                <div class="empty-state-icon">ğŸ“‹</div>
                                <div class="empty-state-text">ã‚¿ã‚¹ã‚¯ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„</div>
                                <p>è¨­å®šã‚¿ãƒ–ã‹ã‚‰CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã§ãã¾ã™ã€‚</p>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">é‡è¦ãªãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³</h2>
                        </div>
                        <div id="milestones">
                            <div class="empty-state">
                                <div class="empty-state-icon">ğŸ‰</div>
                                <div class="empty-state-text">é‡è¦ãªã‚¿ã‚¹ã‚¯ã‚’ãƒãƒ¼ã‚¯ã—ã¾ã—ã‚‡ã†</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="gantt" class="tab-content">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">ãƒã‚¹ã‚¿ãƒ¼ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ« (ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆ)</h2>
                            <div class="btn-group">
                                <button class="btn btn-secondary" onclick="zoomGantt(0.9)">ğŸ” ç¸®å°</button>
                                <button class="btn btn-secondary" onclick="zoomGantt(1.1)">ğŸ” æ‹¡å¤§</button>
                                <button class="btn btn-primary" onclick="scrollToToday()">ğŸ¯ ä»Šæ—¥ã¸</button>
                            </div>
                        </div>
                        <div id="ganttContainer" class="gantt-container">
                            <div class="empty-state">
                                <div class="empty-state-icon">ğŸ“…</div>
                                <div class="empty-state-text">ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’å¾…æ©Ÿä¸­</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="calendar" class="tab-content">
                    <div class="card calendar-container">
                        <div class="calendar-header">
                            <h2 class="calendar-title" id="calendarTitle"></h2>
                            <div class="calendar-nav">
                                <button class="btn btn-secondary" onclick="changeMonth(-1)">â—€ï¸ å‰æœˆ</button>
                                <button class="btn btn-secondary" onclick="changeMonth(0)">ä»Šæ—¥</button>
                                <button class="btn btn-secondary" onclick="changeMonth(1)">ç¿Œæœˆ â–¶ï¸</button>
                            </div>
                        </div>
                        <div id="calendarGrid" class="calendar-grid">
                            <div class="calendar-day-number" style="text-align: center; color: var(--danger);">æ—¥</div>
                            <div class="calendar-day-number" style="text-align: center;">æœˆ</div>
                            <div class="calendar-day-number" style="text-align: center;">ç«</div>
                            <div class="calendar-day-number" style="text-align: center;">æ°´</div>
                            <div class="calendar-day-number" style="text-align: center;">æœ¨</div>
                            <div class="calendar-day-number" style="text-align: center;">é‡‘</div>
                            <div class="calendar-day-number" style="text-align: center; color: var(--primary);">åœŸ</div>
                            </div>
                    </div>
                </div>

                <div id="staff" class="tab-content">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">ãƒãƒ¼ãƒ ãƒ¡ãƒ³ãƒãƒ¼</h2>
                        </div>
                        <div id="staffGrid" class="staff-grid">
                            <div class="empty-state">
                                <div class="empty-state-icon">ğŸ‘¥</div>
                                <div class="empty-state-text">æ‹…å½“è€…ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>
                                <p>ã‚¿ã‚¹ã‚¯ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€ã¨è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="timeline" class="tab-content">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">æœ€è¿‘ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£</h2>
                        </div>
                        <div id="timelineContent">
                            <div class="empty-state">
                                <div class="empty-state-icon">â±ï¸</div>
                                <div class="empty-state-text">ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="tasks" class="tab-content">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">ã‚¿ã‚¹ã‚¯ä¸€è¦§</h2>
                            <div class="btn-group">
                                <button class="btn btn-primary" onclick="openTaskModal()">â• æ–°è¦ã‚¿ã‚¹ã‚¯</button>
                            </div>
                        </div>
                        <div id="hierarchicalTaskList" class="hierarchical-task-list">
                            <div class="empty-state">
                                <div class="empty-state-icon">ğŸ“‹</div>
                                <div class="empty-state-text">è¡¨ç¤ºã§ãã‚‹ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="settings" class="tab-content">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">ãƒ‡ãƒ¼ã‚¿ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</h2>
                            <button class="btn btn-danger" onclick="clearData()">å…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤</button>
                        </div>
                        <p style="margin-bottom: 12px; color: var(--text-secondary);">CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã™ã‚‹ã‹ã€ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚ãƒ‡ãƒ¼ã‚¿ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚</p>
                        <input type="file" id="csvFile" accept=".csv" style="display: none;" onchange="handleFileSelect(event)">
                        <div class="import-zone" id="importZone">
                            ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ— ã¾ãŸã¯ ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">å°åˆ·ã¨ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</h2>
                            <button class="btn btn-secondary" onclick="window.print()">ğŸ–¨ï¸ å°åˆ·</button>
                        </div>
                        <p style="color: var(--text-secondary);">ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆã‚„ã‚¿ã‚¹ã‚¯ä¸€è¦§ã‚’å°åˆ·ã«é©ã—ãŸå½¢å¼ã§è¡¨ç¤ºã—ã¾ã™ã€‚</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="taskModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">æ–°è¦ã‚¿ã‚¹ã‚¯è¿½åŠ </h3>
            </div>
            <form id="taskForm" onsubmit="saveTask(event)">
                <input type="hidden" id="taskId">
                <div class="form-group">
                    <label for="taskName" class="form-label">ã‚¿ã‚¹ã‚¯å</label>
                    <input type="text" id="taskName" class="form-input" required>
                </div>
                <div class="form-group">
                    <label for="taskAssignee" class="form-label">æ‹…å½“è€…</label>
                    <input type="text" id="taskAssignee" class="form-input">
                </div>
                <div class="form-group">
                    <label for="taskLevel" class="form-label">ãƒ¬ãƒ™ãƒ« (éšå±¤)</label>
                    <select id="taskLevel" class="form-select">
                        <option value="1">1 (ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ)</option>
                        <option value="2">2 (ãƒ•ã‚§ãƒ¼ã‚º)</option>
                        <option value="3">3 (å¤§ã‚¿ã‚¹ã‚¯)</option>
                        <option value="4">4 (ä¸­ã‚¿ã‚¹ã‚¯)</option>
                        <option value="5">5 (å°ã‚¿ã‚¹ã‚¯)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="taskParentName" class="form-label">è¦ªã‚¿ã‚¹ã‚¯å (ãƒ¬ãƒ™ãƒ«1ã¯ç©ºæ¬„)</label>
                    <input type="text" id="taskParentName" class="form-input">
                </div>
                <div class="form-group">
                    <label for="taskStart" class="form-label">é–‹å§‹æ—¥</label>
                    <input type="date" id="taskStart" class="form-input">
                </div>
                <div class="form-group">
                    <label for="taskEnd" class="form-label">çµ‚äº†æ—¥</label>
                    <input type="date" id="taskEnd" class="form-input">
                </div>
                <div class="form-group">
                    <label for="taskMemo" class="form-label">ãƒ¡ãƒ¢</label>
                    <textarea id="taskMemo" class="form-textarea"></textarea>
                </div>
                <div style="display: flex; justify-content: flex-end; gap: 12px; margin-top: 24px;">
                    <button type="button" class="btn btn-secondary" onclick="closeTaskModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button type="submit" class="btn btn-primary">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>


    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let tasks = [];
        let stores = ['ãƒ©ã‚¾ãƒ¼ãƒŠå·å´åº—', 'ãƒ«ãƒŸãƒæ± è¢‹åº—', 'æ¸‹è°·ã‚¹ã‚¯ãƒ©ãƒ³ãƒ–ãƒ«åº—'];
        let currentUser = null;
        let currentStoreId = null;

        // ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆé–¢é€£ã®å¤‰æ•°
        let TASK_COL_WIDTH = 300;
        let HEADER_HEIGHT = 120;
        let DAY_WIDTH = 30;
        let ganttZoomLevel = 1.0; 
        
        // ãƒªã‚µã‚¤ã‚¶ãƒ¼é–¢é€£ã®å¤‰æ•°
        let isResizingSidebar = false;
        let isResizingHeader = false;
        
        // ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆ ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒªã‚µã‚¤ã‚ºé–¢é€£ã®å¤‰æ•°
        let draggingBar = null;
        let resizingBar = null;
        let dragOffset = 0;
        // â­ ã‚¨ãƒ©ãƒ¼ä¿®æ­£ç®‡æ‰€: å¤‰æ•°ã®é‡è¤‡å®£è¨€ã‚’é¿ã‘ã‚‹ãŸã‚ã€ã“ã“ã§ä¸€åº¦ã ã‘å®šç¾©ã—ã¾ã™ã€‚
        let resizingTask = null; 
        let isResizing = false;
        let isDragging = false;


        // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
        function parseDate(dateStr) {
            if (!dateStr) return null;
            // YYYY-MM-DDå½¢å¼ã‚’æœŸå¾…
            const parts = dateStr.split('-');
            if (parts.length === 3) {
                // æœˆã¯0ã‹ã‚‰å§‹ã¾ã‚‹ãŸã‚ -1
                return new Date(parts[0], parts[1] - 1, parts[2]);
            }
            return null;
        }

        function formatDate(date) {
            if (!date) return '';
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        }

        function diffInDays(date1, date2) {
            if (!date1 || !date2) return 0;
            const msInDay = 24 * 60 * 60 * 1000;
            const d1 = Date.UTC(date1.getFullYear(), date1.getMonth(), date1.getDate());
            const d2 = Date.UTC(date2.getFullYear(), date2.getMonth(), date2.getDate());
            return Math.round((d2 - d1) / msInDay);
        }

        function getStatus(task) {
            if (task.completed) return 'completed';
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            if (!task.startDate || !task.endDate) return 'pending'; // æ—¥ä»˜ãŒãªã„ã‚¿ã‚¹ã‚¯ã¯ä¿ç•™

            // çµ‚äº†æ—¥ãŒä»Šæ—¥ä»¥é™ãªã‚‰é€²è¡Œä¸­ã€çµ‚äº†æ—¥ãŒéå»ãªã‚‰ä¿ç•™
            if (task.endDate >= today) {
                return 'in-progress';
            } else {
                return 'pending';
            }
        }
        
        // CSVãƒ‘ãƒ¼ã‚¹é–¢æ•°
        function parseCSV(text) {
            // ã‚¿ã‚¹ã‚¯CSVã®ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’æƒ³å®š: ãƒ¬ãƒ™ãƒ«,è¦ªã‚¿ã‚¹ã‚¯å,ã‚¿ã‚¹ã‚¯å,æ‹…å½“,ãƒ¡ãƒ¢,é–‹å§‹æ—¥,çµ‚äº†æ—¥,å®Œäº†
            const lines = text.split('\n').filter(line => line.trim() !== '');
            if (lines.length === 0) return [];
            
            // æœ€åˆã«BOMãŒã‚ã‚‹å ´åˆï¼ˆç‰¹ã«æ—¥æœ¬èªCSVã§ç™ºç”Ÿã—ã‚„ã™ã„ï¼‰ã€ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹
            const headerIndex = lines[0].charCodeAt(0) === 0xFEFF ? 1 : 0;
            if (lines.length <= headerIndex) return [];
            
            // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’èª­ã¿è¾¼ã¿ï¼ˆã“ã“ã§ã¯åˆ©ç”¨ã—ãªã„ãŒã€æ§‹é€ æŠŠæ¡ã®ãŸã‚ã«æ®‹ã™ï¼‰
            const header = lines[headerIndex].split(',').map(h => h.trim());

            const data = [];

            for (let i = headerIndex + 1; i < lines.length; i++) {
                const line = lines[i].split(',').map(c => c.trim());
                if (line.length < 5) continue; // æœ€å°é™ã®åˆ—ãŒãªã„è¡Œã¯ã‚¹ã‚­ãƒƒãƒ—
                
                const task = {
                    id: Date.now() + i, // ãƒ¦ãƒ‹ãƒ¼ã‚¯IDã‚’ä»˜ä¸
                    level: parseInt(line[0] || '1'),
                    parentName: line[1] || '',
                    name: line[2] || 'åç§°æœªè¨­å®šã‚¿ã‚¹ã‚¯',
                    assignee: line[3] || 'æœªå®š',
                    memo: line[4] || '',
                    startDate: parseDate(line[5]), // 6åˆ—ç›®
                    endDate: parseDate(line[6]),   // 7åˆ—ç›®
                    completed: line[7] === 'å®Œäº†' || line[7] === 'TRUE', // 8åˆ—ç›®
                    children: [], // éšå±¤æ§‹é€ ã®ãŸã‚ã«è¿½åŠ 
                    isParent: false, // å­ã‚’æŒã¤ã‹ã©ã†ã‹
                    isExpanded: true, // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§å±•é–‹
                };
                
                task.status = getStatus(task);

                // æ—¥ä»˜ãŒæœ‰åŠ¹ãªã‚¿ã‚¹ã‚¯ã®ã¿è¿½åŠ 
                if (task.startDate && task.endDate) {
                    data.push(task);
                } else if (task.level <= 2) {
                    // ãƒ¬ãƒ™ãƒ«2ã¾ã§ã®è¦ªã‚¿ã‚¹ã‚¯ã¯æ—¥ä»˜ãŒãªãã¦ã‚‚è¿½åŠ ï¼ˆæ§‹é€ è¡¨ç¤ºç”¨ï¼‰
                    data.push(task);
                }
            }

            // éšå±¤æ§‹é€ ã®æ§‹ç¯‰
            const taskMap = new Map();
            data.forEach(task => taskMap.set(task.name, task));

            data.forEach(task => {
                if (task.parentName) {
                    const parent = taskMap.get(task.parentName);
                    if (parent) {
                        parent.children.push(task);
                        parent.isParent = true;
                    }
                }
            });

            // è¦ªã‚¿ã‚¹ã‚¯ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„ã‚¿ã‚¹ã‚¯ï¼ˆãƒ¬ãƒ™ãƒ«1ã®æƒ³å®šï¼‰ã¨ã€è¦ªãŒè¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸã‚¿ã‚¹ã‚¯ã®ã¿ã‚’ãƒ«ãƒ¼ãƒˆã«æ®‹ã™
            return data.filter(task => !task.parentName || task.level === 1 || !taskMap.get(task.parentName));
        }

        // ãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ‰ï¼†ä¿å­˜
        function loadData() {
            const savedTasks = localStorage.getItem('istyle_tasks');
            if (savedTasks) {
                tasks = JSON.parse(savedTasks).map(task => ({
                    ...task,
                    startDate: task.startDate ? new Date(task.startDate) : null,
                    endDate: task.endDate ? new Date(task.endDate) : null
                }));
            } else {
                tasks = [];
            }

            // ãƒ‡ãƒ¼ã‚¿ãŒãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸã‚‰ã€ã™ã¹ã¦ã®æç”»é–¢æ•°ã‚’å‘¼ã³å‡ºã™
            renderDashboard();
            renderGanttChart();
            renderCalendar();
            renderStaffGrid();
            renderHierarchicalTaskList();
        }

        function saveData() {
            localStorage.setItem('istyle_tasks', JSON.stringify(tasks));
        }
        
        function clearData() {
            if (confirm('æœ¬å½“ã«å…¨ã¦ã®ã‚¿ã‚¹ã‚¯ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚')) {
                localStorage.removeItem('istyle_tasks');
                localStorage.removeItem('istyle_currentUser');
                localStorage.removeItem('istyle_currentStoreId');
                tasks = [];
                // ç”»é¢ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦åˆæœŸçŠ¶æ…‹ã«æˆ»ã™
                location.reload();
            }
        }


        // ãƒ­ã‚°ã‚¤ãƒ³é–¢é€£
        const users = [
            { email: 'test@istyle.com', password: 'password', name: 'ç«¹ä¹‹å†… å¤ªéƒ', role: 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼' },
            { email: 'manager@istyle.com', password: 'password', name: 'ç§‹å±± èŠ±å­', role: 'åº—é•·' }
        ];

        function checkLogin() {
            const savedUser = localStorage.getItem('istyle_currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                // æœ€å¾Œã«é¸æŠã—ãŸåº—èˆ—ã‚’ãƒ­ãƒ¼ãƒ‰
                currentStoreId = localStorage.getItem('istyle_currentStoreId') || stores[0];
                showApp();
            } else {
                showLogin();
            }
        }

        function showLogin() {
            document.getElementById('loginScreen').style.display = 'flex';
            // ã‚¢ãƒ—ãƒªã‚³ãƒ³ãƒ†ãƒŠãŒå­˜åœ¨ã—ãªã„å¯èƒ½æ€§ãŒã‚ã‚‹ã®ã§nullãƒã‚§ãƒƒã‚¯ã‚’è¿½åŠ 
            const appContainer = document.getElementById('appContainer');
            if(appContainer) appContainer.style.display = 'none';
        }

        function showApp() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('appContainer').style.display = 'flex';
            
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’è¡¨ç¤º
            document.getElementById('currentUserName').textContent = currentUser.name;
            document.getElementById('currentUserRole').textContent = currentUser.role;

            // åº—èˆ—ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ã®åˆæœŸåŒ–ã¨é¸æŠ
            initializeStoreSelector();
            document.getElementById('storeSelect').value = currentStoreId;
            // ãƒ­ã‚°ã‚¤ãƒ³å¾Œã®åˆå›æç”»ã§å…¨ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’å†æç”»
            loadData();
        }

        function handleLogin(event) {
            event.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const user = users.find(u => u.email === email && u.password === password);
            const loginError = document.getElementById('loginError');

            if (user) {
                currentUser = user;
                localStorage.setItem('istyle_currentUser', JSON.stringify(user));
                loginError.style.display = 'none';
                showApp();
            } else {
                loginError.textContent = 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™ã€‚';
                loginError.style.display = 'block';
            }
        }

        function logout() {
            localStorage.removeItem('istyle_currentUser');
            currentUser = null;
            showLogin();
        }

        // åº—èˆ—ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼
        function initializeStoreSelector() {
            const select = document.getElementById('storeSelect');
            select.innerHTML = '';
            stores.forEach(store => {
                const option = document.createElement('option');
                option.value = store;
                option.textContent = store;
                select.appendChild(option);
            });
            select.value = currentStoreId || stores[0];
        }

        function switchStore() {
            currentStoreId = document.getElementById('storeSelect').value;
            localStorage.setItem('istyle_currentStoreId', currentStoreId);
            // åº—èˆ—ã‚’åˆ‡ã‚Šæ›¿ãˆãŸã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿ï¼ˆãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ãªã®ã§å®Ÿéš›ã¯ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å‡¦ç†ãŒå¿…è¦ï¼‰
            loadData(); 
            // é¸æŠä¸­ã®ã‚¿ãƒ–ã‚’å†æç”»ï¼ˆactiveã‚¯ãƒ©ã‚¹ã‚’æŒã¤è¦ç´ ãŒã‚ã‚Œã°ãã‚Œã‚’æ¸¡ã™ï¼‰
            const activeNav = document.querySelector('.nav-item.active');
            if (activeNav) {
                const tabId = activeNav.onclick.toString().match(/showTab\('([^']*)'/)[1];
                showTab(tabId, activeNav);
            } else {
                showTab('dashboard', document.querySelector('.nav-item[onclick*="dashboard"]'));
            }
        }


        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
        function showTab(tabId, element) {
            // â­ ReferenceErrorå›é¿ã®ãŸã‚ã€ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã¨ã—ã¦å®šç¾©
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.getElementById(tabId).classList.add('active');

            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            if (element) {
                element.classList.add('active');
            }
            
            // ãƒ˜ãƒƒãƒ€ãƒ¼æƒ…å ±ã®æ›´æ–°
            const titles = {
                'dashboard': ['ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰', 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®é€²æ—ã‚’ä¸€ç›®ã§ç¢ºèª'],
                'gantt': ['ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆ', 'ã‚¿ã‚¹ã‚¯ã®æœŸé–“ã¨ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’è¦–è¦šåŒ–'],
                'calendar': ['ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼', 'æ—¥ä»˜ã”ã¨ã®ã‚¿ã‚¹ã‚¯ã‚’ç¢ºèª'],
                'staff': ['ã‚¹ã‚¿ãƒƒãƒ•', 'ãƒãƒ¼ãƒ ãƒ¡ãƒ³ãƒãƒ¼ã®æ‹…å½“ã‚¿ã‚¹ã‚¯ã¨é€²æ—'],
                'timeline': ['ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³', 'æœ€è¿‘ã®é‡è¦ãªã‚¢ã‚¯ã‚·ãƒ§ãƒ³å±¥æ­´'],
                'tasks': ['ã‚¿ã‚¹ã‚¯ç®¡ç†', 'ã‚¿ã‚¹ã‚¯ã®éšå±¤ã¨è©³ç´°ã‚’ç¢ºèª'],
                'settings': ['è¨­å®š', 'ã‚¢ãƒ—ãƒªã®ãƒ‡ãƒ¼ã‚¿ç®¡ç†']
            };
            document.getElementById('pageTitle').textContent = titles[tabId][0];
            document.getElementById('pageDescription').textContent = titles[tabId][1];

            // ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆã¨ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã¯æç”»ã‚³ã‚¹ãƒˆãŒé«˜ã„ãŸã‚ã€è¡¨ç¤ºæ™‚ã«å†æç”»ã‚’å¼·åˆ¶
            if (tabId === 'gantt') {
                renderGanttChart();
            } else if (tabId === 'calendar') {
                renderCalendar();
            } else if (tabId === 'tasks') {
                renderHierarchicalTaskList();
            } else if (tabId === 'staff') {
                renderStaffGrid();
            }
            
            // ãƒ¢ãƒã‚¤ãƒ«ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‰ã˜ã‚‹
            if (window.innerWidth <= 768) {
                document.getElementById('sidebar').classList.remove('active');
                document.querySelector('.mobile-overlay').classList.remove('active');
            }
        }

        function toggleSidebar() {
            // â­ ReferenceErrorå›é¿ã®ãŸã‚ã€ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã¨ã—ã¦å®šç¾©
            const sidebar = document.getElementById('sidebar');
            const overlay = document.querySelector('.mobile-overlay');
            sidebar.classList.toggle('active');
            overlay.classList.toggle('active');
        }


        // CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        function setupFileImport() {
            const dropZone = document.getElementById('importZone');
            const fileInput = document.getElementById('csvFile');

            dropZone.addEventListener('click', () => fileInput.click());

            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('dragover');
            });

            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('dragover');
            });

            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('dragover');
                const file = e.dataTransfer.files[0];
                if (file && file.name.endsWith('.csv')) {
                    readCSVFile(file);
                } else {
                    alert('CSVãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚');
                }
            });

            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    readCSVFile(file);
                }
            });
        }

        function handleFileSelect(event) {
            // input[type=file]ã‹ã‚‰ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©
            const file = event.target.files[0];
            if (file) {
                readCSVFile(file);
            }
        }
        
        function readCSVFile(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    // CSVãƒ•ã‚¡ã‚¤ãƒ«ã¯UTF-8ã§èª­ã¿è¾¼ã¿
                    const newTasks = parseCSV(e.target.result);
                    tasks = newTasks;
                    saveData();
                    // èª­ã¿è¾¼ã¿å®Œäº†å¾Œã€ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’æ›´æ–°
                    showTab('dashboard', document.querySelector('.nav-item[onclick*="dashboard"]'));
                    alert('CSVãƒ‡ãƒ¼ã‚¿ãŒæ­£å¸¸ã«ã‚¤ãƒ³ãƒãƒ¼ãƒˆã•ã‚Œã¾ã—ãŸï¼');
                } catch (error) {
                    console.error('CSVãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼:', error);
                    alert('CSVãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                }
            };
             // ãƒ•ã‚¡ã‚¤ãƒ«ã®æ–‡å­—ã‚³ãƒ¼ãƒ‰ãŒShift-JISã®å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ã€èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼ã‚’é˜²ããŸã‚ã«'UTF-8'ã¨'Shift-JIS'ã‚’è©¦ã—ã¾ã™
            try {
                reader.readAsText(file, 'UTF-8');
            } catch (e) {
                // UTF-8ã§å¤±æ•—ã—ãŸã‚‰Shift-JISã‚’è©¦è¡Œ
                reader.readAsText(file, 'Shift_JIS');
            }
        }

        // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰æç”»
        function renderDashboard() {
            const allTasks = tasks.flatMap(t => t.children.length > 0 ? t.children : [t]); // å­ã‚¿ã‚¹ã‚¯ã‚‚å«ã‚ãŸãƒ•ãƒ©ãƒƒãƒˆãƒªã‚¹ãƒˆ
            const total = allTasks.length;
            const completed = allTasks.filter(t => t.completed).length;
            const inProgress = allTasks.filter(t => t.status === 'in-progress' && !t.completed).length;
            const progress = total > 0 ? Math.round((completed / total) * 100) : 0;

            document.getElementById('totalTasks').textContent = total;
            document.getElementById('completedTasks').textContent = completed;
            document.getElementById('inProgressTasks').textContent = inProgress;
            document.getElementById('progressPercent').textContent = `${progress}%`;

            // ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ï¼ˆä¾‹: ãƒ¬ãƒ™ãƒ«1ã¾ãŸã¯2ã®ã‚¿ã‚¹ã‚¯ã‚’æŠœç²‹ï¼‰
            const milestonesEl = document.getElementById('milestones');
            milestonesEl.innerHTML = '';

            const projectMilestones = tasks.filter(t => t.level <= 2 && !t.completed).sort((a, b) => {
                if (a.endDate && b.endDate) return a.endDate.getTime() - b.endDate.getTime();
                if (a.endDate) return -1;
                if (b.endDate) return 1;
                return 0;
            }).slice(0, 5); // æœŸé™ãŒè¿‘ã„ä¸Šä½5ä»¶
            
            if (projectMilestones.length === 0) {
                 milestonesEl.innerHTML = `<div class="empty-state">
                                            <div class="empty-state-icon">ğŸ‰</div>
                                            <div class="empty-state-text">ã™ã¹ã¦ã®é‡è¦ã‚¿ã‚¹ã‚¯ãŒå®Œäº†ã—ã¦ã„ã¾ã™ï¼</div>
                                          </div>`;
            } else {
                projectMilestones.forEach(task => {
                    const statusClass = task.status;
                    milestonesEl.innerHTML += `
                        <div class="task-item level-${task.level}">
                            <div class="task-header">
                                <div class="task-name">${task.name}</div>
                                <div class="task-status ${statusClass}">${statusClass === 'completed' ? 'å®Œäº†' : (statusClass === 'in-progress' ? 'é€²è¡Œä¸­' : 'ä¿ç•™')}</div>
                            </div>
                            <div class="task-meta">
                                <span>æ‹…å½“: ${task.assignee}</span>
                                <span>æœŸé™: ${task.endDate ? formatDate(task.endDate) : 'æœªè¨­å®š'}</span>
                            </div>
                        </div>
                    `;
                });
            }
        }

        // ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆæç”»
        function renderGanttChart() {
            const ganttContainer = document.getElementById('ganttContainer');
            ganttContainer.innerHTML = '';
            
            if (tasks.length === 0) {
                 ganttContainer.innerHTML = `<div class="empty-state">
                                                <div class="empty-state-icon">ğŸ“…</div>
                                                <div class="empty-state-text">ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’å¾…æ©Ÿä¸­</div>
                                            </div>`;
                return;
            }

            // åŸºæº–æ—¥ (å…¨ã‚¿ã‚¹ã‚¯ã®æœ€å°é–‹å§‹æ—¥)
            const allDates = tasks.map(t => t.startDate).filter(d => d);
            const minDate = allDates.length > 0 ? new Date(Math.min(...allDates)) : new Date();
            minDate.setDate(minDate.getDate() - 7); // 7æ—¥å‰ã‹ã‚‰é–‹å§‹

            // æœ€å¤§æ—¥ (å…¨ã‚¿ã‚¹ã‚¯ã®æœ€å¤§çµ‚äº†æ—¥)
            const maxDate = tasks.map(t => t.endDate).filter(d => d);
            let maxDateVal = maxDate.length > 0 ? new Date(Math.max(...maxDate)) : new Date();
            maxDateVal.setDate(maxDateVal.getDate() + 14); // 14æ—¥å¾Œã¾ã§è¡¨ç¤º
            
            // ä»Šæ—¥ã®æ—¥ä»˜
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            let currentDate = new Date(minDate);
            currentDate.setHours(0, 0, 0, 0); // æ™‚åˆ»ã‚’ãƒªã‚»ãƒƒãƒˆ
            let dayIndex = 0;
            const dateMap = {}; // æ—¥ä»˜ã¨ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®ãƒãƒƒãƒ”ãƒ³ã‚°
            let totalDays = 0;
            let yearBlocks = {};
            let monthBlocks = {};
            
            // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ˜ãƒƒãƒ€ãƒ¼ã®æ§‹ç¯‰
            while (currentDate <= maxDateVal) {
                const dateKey = formatDate(currentDate);
                dateMap[dateKey] = dayIndex;

                const year = currentDate.getFullYear();
                const month = currentDate.getMonth() + 1;

                if (!yearBlocks[year]) {
                    yearBlocks[year] = { count: 0, start: dayIndex };
                }
                yearBlocks[year].count++;

                const monthKey = `${year}-${month}`;
                if (!monthBlocks[monthKey]) {
                    monthBlocks[monthKey] = { count: 0, start: dayIndex };
                }
                monthBlocks[monthKey].count++;

                currentDate.setDate(currentDate.getDate() + 1);
                dayIndex++;
                totalDays++;
            }

            const totalWidth = totalDays * DAY_WIDTH * ganttZoomLevel;

            // 1. ãƒ˜ãƒƒãƒ€ãƒ¼ã®HTMLç”Ÿæˆ
            let yearHeaderHtml = '';
            for (const year in yearBlocks) {
                const width = yearBlocks[year].count * DAY_WIDTH * ganttZoomLevel;
                yearHeaderHtml += `<div class="gantt-year-block" style="width: ${width}px;">${year}å¹´</div>`;
            }

            let monthHeaderHtml = '';
            for (const monthKey in monthBlocks) {
                const width = monthBlocks[monthKey].count * DAY_WIDTH * ganttZoomLevel;
                const monthName = monthKey.split('-')[1] + 'æœˆ';
                monthHeaderHtml += `<div class="gantt-month-block" style="width: ${width}px;">${monthName}</div>`;
            }

            let dayHeaderHtml = '';
            let timelineBgHtml = '';
            currentDate = new Date(minDate);
            currentDate.setHours(0, 0, 0, 0); // æ™‚åˆ»ã‚’ãƒªã‚»ãƒƒãƒˆ
            while (currentDate <= maxDateVal) {
                const day = currentDate.getDate();
                const dayOfWeek = currentDate.getDay(); // 0:æ—¥, 6:åœŸ
                const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                const isToday = diffInDays(currentDate, today) === 0;

                const dayClass = `gantt-day-cell ${isWeekend ? 'weekend' : ''} ${isToday ? 'today' : ''}`;
                dayHeaderHtml += `<div class="${dayClass}" style="width: ${DAY_WIDTH * ganttZoomLevel}px;">${day}</div>`;
                
                const bgClass = `gantt-day-bg ${isWeekend ? 'weekend' : ''}`;
                timelineBgHtml += `<div class="${bgClass}" style="width: ${DAY_WIDTH * ganttZoomLevel}px;"></div>`;

                currentDate.setDate(currentDate.getDate() + 1);
            }

            const headerHtml = `
                <div class="gantt-header-fixed" style="height: ${HEADER_HEIGHT}px;">
                    <div class="gantt-timeline-wrapper">
                        <div class="gantt-task-names" style="width: ${TASK_COL_WIDTH}px; background: var(--surface);"></div>
                        <div class="gantt-timeline-container" style="min-width: ${totalWidth}px;">
                            <div class="gantt-calendar-header">
                                <div class="gantt-year-header">${yearHeaderHtml}</div>
                                <div class="gantt-month-header">${monthHeaderHtml}</div>
                            </div>
                            <div class="gantt-day-header">${dayHeaderHtml}</div>
                        </div>
                    </div>
                </div>
            `;
            ganttContainer.innerHTML += headerHtml;

            // 2. ã‚¿ã‚¹ã‚¯è¡Œã¨ãƒãƒ¼ã®HTMLç”Ÿæˆ
            const ganttScrollWrapper = document.createElement('div');
            ganttScrollWrapper.className = 'gantt-scroll-wrapper';
            ganttScrollWrapper.id = 'ganttScrollWrapper';
            ganttContainer.appendChild(ganttScrollWrapper);


            const taskNamesContainer = document.createElement('div');
            taskNamesContainer.className = 'gantt-task-names';
            taskNamesContainer.style.width = TASK_COL_WIDTH + 'px';
            taskNamesContainer.style.flexShrink = 0;
            taskNamesContainer.style.position = 'sticky';
            taskNamesContainer.style.left = '0';
            taskNamesContainer.style.zIndex = '40';

            const timelineRowsContainer = document.createElement('div');
            timelineRowsContainer.className = 'gantt-timeline-container';
            timelineRowsContainer.style.minWidth = totalWidth + 'px';

            const ganttContentWrapper = document.createElement('div');
            ganttContentWrapper.style.display = 'flex';
            ganttContentWrapper.appendChild(taskNamesContainer);
            ganttContentWrapper.appendChild(timelineRowsContainer);
            ganttScrollWrapper.appendChild(ganttContentWrapper);
            
            // ã‚¿ã‚¹ã‚¯è¡Œã®å†å¸°çš„ãªç”Ÿæˆé–¢æ•°
            function buildTaskRows(taskList, parentId) {
                taskList.forEach(task => {
                    const rowId = `task-row-${task.id}`;
                    let isVisible = true;
                    // è¦ªã‚¿ã‚¹ã‚¯ãŒé–‰ã˜ã¦ã„ã‚‹å ´åˆã¯éè¡¨ç¤º
                    if (parentId) {
                        const parentTask = tasks.find(t => t.id === parentId);
                        if (parentTask && !parentTask.isExpanded) {
                            isVisible = false;
                        }
                    }

                    // ã‚¿ã‚¹ã‚¯åã‚»ãƒ«
                    const taskNameEl = document.createElement('div');
                    taskNameEl.className = `gantt-task-info ${task.isParent ? 'parent-task-info' : ''}`;
                    taskNameEl.dataset.taskId = task.id;
                    taskNameEl.style.width = TASK_COL_WIDTH + 'px';
                    taskNameEl.style.minHeight = '40px';
                    taskNameEl.style.height = '100%';

                    let toggleBtnHtml = '';
                    if (task.isParent) {
                        const icon = task.isExpanded ? 'â–¼' : 'â–¶ï¸';
                        toggleBtnHtml = `<span class="gantt-toggle-btn" onclick="toggleTaskChildren(${task.id}, event)">${icon}</span>`;
                    }
                    
                    taskNameEl.innerHTML = `
                        <div style="padding-left: ${task.level * 10}px;">
                            ${toggleBtnHtml}
                            <span class="task-name-text">${task.name}</span>
                        </div>
                    `;
                    taskNamesContainer.appendChild(taskNameEl);

                    // ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚»ãƒ«
                    const timelineRowEl = document.createElement('div');
                    timelineRowEl.className = 'gantt-timeline-row';
                    timelineRowEl.dataset.taskId = task.id;
                    timelineRowEl.style.minHeight = '40px';
                    timelineRowEl.style.height = '100%';
                    timelineRowsContainer.appendChild(timelineRowEl);
                    
                    // è¡Œè¦ç´ ï¼ˆã‚¿ã‚¹ã‚¯åã¨ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚’å›²ã‚€ï¼‰
                    const rowEl = document.createElement('div');
                    rowEl.className = `gantt-row level-${task.level} ${task.isParent ? (task.isExpanded ? 'expanded' : '') : ''} ${!isVisible ? 'collapsed' : ''}`;
                    rowEl.id = rowId;
                    
                    // èƒŒæ™¯ã®æ—¥ã®ç·šã‚’è¿½åŠ 
                    timelineRowEl.innerHTML = `<div class="gantt-timeline-bg">${timelineBgHtml}</div>`;
                    
                    // ã‚¿ã‚¹ã‚¯ãƒãƒ¼ã®æç”»
                    if (task.startDate && task.endDate) {
                        const startKey = formatDate(task.startDate);
                        const endKey = formatDate(task.endDate);
                        
                        const startIndex = dateMap[startKey] !== undefined ? dateMap[startKey] : 0;
                        const endIndex = dateMap[endKey] !== undefined ? dateMap[endKey] : totalDays - 1;

                        if (startIndex !== undefined && endIndex !== undefined) {
                            // æœŸé–“ã®æ—¥æ•°ï¼ˆçµ‚äº†æ—¥ã‚’å«ã‚€ï¼‰
                            const durationDays = endIndex - startIndex + 1;
                            
                            // é–‹å§‹ä½ç½® (å·¦ç«¯ã‹ã‚‰ã®ãƒ”ã‚¯ã‚»ãƒ«æ•°)
                            const leftPos = startIndex * DAY_WIDTH * ganttZoomLevel;
                            
                            // å¹… (ãƒ”ã‚¯ã‚»ãƒ«æ•°)
                            const barWidth = durationDays * DAY_WIDTH * ganttZoomLevel;

                            // ãƒãƒ¼ã®HTML
                            const barHtml = `
                                <div class="gantt-bar" 
                                     data-task-id="${task.id}" 
                                     style="left: ${leftPos}px; width: ${barWidth}px; background: ${task.completed ? 'var(--success)' : 'linear-gradient(135deg, var(--primary), var(--secondary))'}">
                                    ${task.name}
                                    <div class="gantt-bar-resize-left" data-type="start"></div>
                                    <div class="gantt-bar-resize-right" data-type="end"></div>
                                </div>
                            `;
                            timelineRowEl.innerHTML += barHtml;
                        }
                    }

                    // å­ã‚¿ã‚¹ã‚¯ã®å†å¸°å‘¼ã³å‡ºã—
                    if (task.children.length > 0 && task.isExpanded) {
                        buildTaskRows(task.children, task.id);
                    }
                });
            }
            
            // ãƒ«ãƒ¼ãƒˆã‚¿ã‚¹ã‚¯ã®ã¿ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã—ã¦é–‹å§‹
            const rootTasks = tasks.filter(t => !t.parentName || t.level === 1);
            buildTaskRows(rootTasks, null);
            
            // ä»Šæ—¥ã®ç·šã®æç”»
            const todayIndex = dateMap[formatDate(today)];
            if (todayIndex !== undefined) {
                const todayLeft = todayIndex * DAY_WIDTH * ganttZoomLevel;
                const todayLineHtml = `<div class="gantt-today-line" style="left: ${todayLeft}px; height: 100%;"></div>`;
                timelineRowsContainer.innerHTML += todayLineHtml;
            }

            // ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒªã‚µã‚¤ã‚ºã‚¤ãƒ™ãƒ³ãƒˆã®è¨­å®š
            setupGanttDragAndResize(minDate);
        }
        
        // éšå±¤ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆã®æç”» (ã‚¿ã‚¹ã‚¯ç®¡ç†ã‚¿ãƒ–)
        function renderHierarchicalTaskList() {
            const listEl = document.getElementById('hierarchicalTaskList');
            listEl.innerHTML = '';

            if (tasks.length === 0) {
                 listEl.innerHTML = `<div class="empty-state">
                                        <div class="empty-state-icon">ğŸ“‹</div>
                                        <div class="empty-state-text">è¡¨ç¤ºã§ãã‚‹ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“</div>
                                    </div>`;
                return;
            }
            
            // å†å¸°çš„ãªæç”»é–¢æ•°
            function buildList(taskList) {
                let html = '';
                taskList.forEach(task => {
                    const statusClass = task.completed ? 'completed' : (task.status === 'in-progress' ? 'in-progress' : 'pending');
                    const statusText = task.completed ? 'å®Œäº†' : (task.status === 'in-progress' ? 'é€²è¡Œä¸­' : 'ä¿ç•™');

                    html += `
                        <div class="task-item level-${task.level} ${task.completed ? 'task-completed' : ''}" data-task-id="${task.id}">
                            <div class="task-header">
                                <div class="task-name" style="padding-left: ${task.level * 10}px;">
                                    <input type="checkbox" id="task-check-${task.id}" ${task.completed ? 'checked' : ''} onclick="toggleTaskCompletion(${task.id}, event)">
                                    <label for="task-check-${task.id}" style="margin-left: 8px;">${task.name}</label>
                                </div>
                                <div class="task-status ${statusClass}">${statusText}</div>
                            </div>
                            <div class="task-meta">
                                <span class="task-assignee">${task.assignee}</span>
                                <span>é–‹å§‹: ${task.startDate ? formatDate(task.startDate) : 'æœªè¨­å®š'}</span>
                                <span>çµ‚äº†: ${task.endDate ? formatDate(task.endDate) : 'æœªè¨­å®š'}</span>
                            </div>
                            <div class="task-memo">${task.memo || 'ãƒ¡ãƒ¢ãªã—'}</div>
                            <div class="task-actions">
                                <button class="btn-edit" onclick="openTaskModal(${task.id})">ç·¨é›†</button>
                                <button class="btn-delete" onclick="deleteTask(${task.id})">å‰Šé™¤</button>
                            </div>
                        </div>
                    `;

                    if (task.children && task.children.length > 0) {
                        html += buildList(task.children);
                    }
                });
                return html;
            }

            // ãƒ«ãƒ¼ãƒˆã‚¿ã‚¹ã‚¯ã®ã¿ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã—ã¦é–‹å§‹
            const rootTasks = tasks.filter(t => !t.parentName || t.level === 1);
            listEl.innerHTML = buildList(rootTasks);
        }

        function toggleTaskChildren(taskId, event) {
            // â­ ReferenceErrorå›é¿ã®ãŸã‚ã€ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã¨ã—ã¦å®šç¾©
            event.stopPropagation();
            const task = tasks.find(t => t.id === taskId);
            if (!task || !task.isParent) return;

            task.isExpanded = !task.isExpanded;
            saveData();
            
            // ç”»é¢ã‚’å†æç”»ã—ã¦çŠ¶æ…‹ã‚’åæ˜ 
            renderGanttChart(); 
        }

        // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æç”»
        let currentMonth = new Date();

        function renderCalendar() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const titleEl = document.getElementById('calendarTitle');
            const gridEl = document.getElementById('calendarGrid');
            gridEl.innerHTML = ''; // æ›œæ—¥ã®ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ä¿æŒã™ã‚‹ãŸã‚ã€æ—¥ä»˜éƒ¨åˆ†ã ã‘ã‚’ã‚¯ãƒªã‚¢ã™ã‚‹å‡¦ç†ãŒå¿…è¦ã ãŒã€ã“ã“ã§ã¯ç°¡ç•¥åŒ–ã®ãŸã‚å…¨ã‚¯ãƒªã‚¢å¾Œã€æ›œæ—¥ã‚’å†è¿½åŠ 

            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth();
            
            titleEl.textContent = `${year}å¹´ ${month + 1}æœˆ`;

            // æ›œæ—¥ã®ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’å†è¿½åŠ 
            const dayNames = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
            dayNames.forEach((day, index) => {
                const color = index === 0 ? 'var(--danger)' : (index === 6 ? 'var(--primary)' : 'var(--text-primary)');
                gridEl.innerHTML += `<div class="calendar-day-number" style="text-align: center; color: ${color};">${day}</div>`;
            });

            // ãã®æœˆã®æœ€åˆã®æ—¥ã®æ›œæ—¥ (0:æ—¥, 6:åœŸ)
            const firstDayOfMonth = new Date(year, month, 1);
            const startDayOfWeek = firstDayOfMonth.getDay(); 

            // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼é–‹å§‹æ—¥ (å…ˆæœˆã®æœ€çµ‚é€±ã®æœ€åˆã®æ—¥)
            const calendarStartDay = new Date(firstDayOfMonth);
            calendarStartDay.setDate(firstDayOfMonth.getDate() - startDayOfWeek);

            // 6é€±åˆ†ã®æ—¥ä»˜ã‚»ãƒ«ã‚’ä½œæˆ (6è¡Œ x 7åˆ— = 42æ—¥)
            for (let i = 0; i < 42; i++) {
                const day = new Date(calendarStartDay);
                day.setDate(calendarStartDay.getDate() + i);
                day.setHours(0, 0, 0, 0); // æ™‚åˆ»ã‚’ãƒªã‚»ãƒƒãƒˆ
                
                const isOtherMonth = day.getMonth() !== month;
                const isToday = day.getFullYear() === today.getFullYear() && 
                                day.getMonth() === today.getMonth() && 
                                day.getDate() === today.getDate();

                const dayClass = `calendar-day ${isOtherMonth ? 'other-month' : ''} ${isToday ? 'today' : ''}`;
                
                // æœŸé–“å†…ã«ã‚ã‚‹ã‚¿ã‚¹ã‚¯ã‚’æŠ½å‡º
                const dayTasks = tasks.filter(t => 
                    t.startDate && t.endDate && 
                    day >= t.startDate && day <= t.endDate
                ).slice(0, 3); // æœ€å¤§3ä»¶ã¾ã§è¡¨ç¤º

                let tasksHtml = '';
                dayTasks.forEach(task => {
                    tasksHtml += `<div class="calendar-task" style="background: ${task.completed ? 'var(--success)' : 'var(--primary)'};">${task.name}</div>`;
                });

                gridEl.innerHTML += `
                    <div class="${dayClass}" onclick="alert('æ—¥ä»˜ ${formatDate(day)} ã®è©³ç´°ã‚’è¡¨ç¤º')">
                        <div class="calendar-day-number">${day.getDate()}</div>
                        ${tasksHtml}
                    </div>
                `;
            }
        }

        function changeMonth(delta) {
            // â­ ReferenceErrorå›é¿ã®ãŸã‚ã€ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã¨ã—ã¦å®šç¾©
            if (delta === 0) {
                currentMonth = new Date();
            } else {
                currentMonth.setMonth(currentMonth.getMonth() + delta);
            }
            renderCalendar();
        }

        // ã‚¹ã‚¿ãƒƒãƒ•ã‚°ãƒªãƒƒãƒ‰æç”»
        function renderStaffGrid() {
            const gridEl = document.getElementById('staffGrid');
            gridEl.innerHTML = '';

            const assigneeMap = {};
            const allTasks = tasks.flatMap(t => t.children.length > 0 ? t.children : [t]); // å­ã‚¿ã‚¹ã‚¯ã‚‚å«ã‚ãŸãƒ•ãƒ©ãƒƒãƒˆãƒªã‚¹ãƒˆ
            
            allTasks.forEach(task => {
                const assignees = task.assignee.split(/[\sãƒ»,ã€/]/).filter(a => a.trim() !== '');
                assignees.forEach(assignee => {
                    if (!assigneeMap[assignee]) {
                        assigneeMap[assignee] = { total: 0, completed: 0, pending: 0, inProgress: 0 };
                    }
                    assigneeMap[assignee].total++;
                    if (task.completed) {
                        assigneeMap[assignee].completed++;
                    } else if (task.status === 'in-progress') {
                        assigneeMap[assignee].inProgress++;
                    } else {
                        assigneeMap[assignee].pending++;
                    }
                });
            });

            const assignees = Object.keys(assigneeMap);

            if (assignees.length === 0) {
                 gridEl.innerHTML = `<div class="empty-state">
                                        <div class="empty-state-icon">ğŸ‘¥</div>
                                        <div class="empty-state-text">æ‹…å½“è€…ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>
                                    </div>`;
                return;
            }

            assignees.forEach(name => {
                const stats = assigneeMap[name];
                const progress = stats.total > 0 ? Math.round((stats.completed / stats.total) * 100) : 0;
                
                gridEl.innerHTML += `
                    <div class="staff-card">
                        <div class="staff-name">${name}</div>
                        <div class="staff-role">${name === currentUser.name ? currentUser.role : 'æ‹…å½“è€…'}</div>
                        <div class="staff-info">å®Œäº†ã‚¿ã‚¹ã‚¯: ${stats.completed} / ${stats.total} (${progress}%)</div>
                        <div class="staff-info">é€²è¡Œä¸­ã‚¿ã‚¹ã‚¯: ${stats.inProgress}</div>
                        <div class="staff-info">ä¿ç•™ã‚¿ã‚¹ã‚¯: ${stats.pending}</div>
                    </div>
                `;
            });
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«é–¢é€£ (ã‚¿ã‚¹ã‚¯ç·¨é›†/è¿½åŠ )
        function openTaskModal(taskId) {
            // â­ ReferenceErrorå›é¿ã®ãŸã‚ã€ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã¨ã—ã¦å®šç¾©
            const modal = document.getElementById('taskModal');
            const form = document.getElementById('taskForm');
            const title = document.getElementById('modalTitle');
            form.reset();
            document.getElementById('taskId').value = '';

            if (taskId) {
                const task = tasks.find(t => t.id === taskId);
                if (task) {
                    title.textContent = 'ã‚¿ã‚¹ã‚¯ç·¨é›†';
                    document.getElementById('taskId').value = task.id;
                    document.getElementById('taskName').value = task.name;
                    document.getElementById('taskAssignee').value = task.assignee;
                    document.getElementById('taskLevel').value = task.level;
                    document.getElementById('taskParentName').value = task.parentName;
                    document.getElementById('taskStart').value = task.startDate ? formatDate(task.startDate) : '';
                    document.getElementById('taskEnd').value = task.endDate ? formatDate(task.endDate) : '';
                    document.getElementById('taskMemo').value = task.memo;
                }
            } else {
                title.textContent = 'æ–°è¦ã‚¿ã‚¹ã‚¯è¿½åŠ ';
            }
            modal.classList.add('active');
        }

        function closeTaskModal() {
            // â­ ReferenceErrorå›é¿ã®ãŸã‚ã€ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã¨ã—ã¦å®šç¾©
            document.getElementById('taskModal').classList.remove('active');
        }

        function saveTask(event) {
            // â­ ReferenceErrorå›é¿ã®ãŸã‚ã€ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã¨ã—ã¦å®šç¾©
            event.preventDefault();
            const id = document.getElementById('taskId').value;
            const name = document.getElementById('taskName').value;
            const assignee = document.getElementById('taskAssignee').value;
            const level = parseInt(document.getElementById('taskLevel').value);
            const parentName = document.getElementById('taskParentName').value;
            const startDate = parseDate(document.getElementById('taskStart').value);
            const endDate = parseDate(document.getElementById('taskEnd').value);
            const memo = document.getElementById('taskMemo').value;

            const newTaskData = {
                name,
                assignee,
                level,
                parentName,
                startDate,
                endDate,
                memo,
            };

            if (id) {
                // ç·¨é›†
                const taskIndex = tasks.findIndex(t => t.id === parseInt(id));
                if (taskIndex > -1) {
                    tasks[taskIndex] = { 
                        ...tasks[taskIndex], 
                        ...newTaskData, 
                        status: getStatus({ ...tasks[taskIndex], ...newTaskData })
                    };
                }
            } else {
                // æ–°è¦è¿½åŠ 
                const newTask = {
                    id: Date.now(),
                    ...newTaskData,
                    completed: false,
                    status: getStatus(newTaskData),
                    children: [],
                    isParent: false,
                    isExpanded: true
                };
                tasks.push(newTask);
            }
            
            // éšå±¤ã‚’å†æ§‹ç¯‰ï¼ˆCSVèª­ã¿è¾¼ã¿æ™‚ã¨åŒã˜å‡¦ç†ã‚’æ¨¡å€£ï¼‰
            const flatTasks = JSON.parse(JSON.stringify(tasks));
            flatTasks.forEach(t => { t.children = []; t.isParent = false; });
            const taskMap = new Map();
            flatTasks.forEach(task => taskMap.set(task.name, task));

            flatTasks.forEach(task => {
                if (task.parentName) {
                    const parent = taskMap.get(task.parentName);
                    if (parent) {
                        parent.children.push(task);
                        parent.isParent = true;
                    }
                }
            });
            // ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆå…¨ä½“ã‚’ã€è¦ªã‚¿ã‚¹ã‚¯ã®æ§‹é€ ã‚’åæ˜ ã—ãŸã‚‚ã®ã«ç½®ãæ›ãˆã‚‹
            tasks = flatTasks;


            saveData();
            closeTaskModal();
            loadData(); // å…¨ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’å†æç”»
        }

        function deleteTask(taskId) {
            // â­ ReferenceErrorå›é¿ã®ãŸã‚ã€ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã¨ã—ã¦å®šç¾©
            if (confirm('ã“ã®ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                tasks = tasks.filter(t => t.id !== taskId);
                saveData();
                loadData();
                renderHierarchicalTaskList();
            }
        }

        function toggleTaskCompletion(taskId, event) {
            // â­ ReferenceErrorå›é¿ã®ãŸã‚ã€ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã¨ã—ã¦å®šç¾©
            // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¦ªè¦ç´ ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã¨ã—ã¦å‡¦ç†ã—ãªã„ã‚ˆã†ã«
            event.stopPropagation(); 
            const task = tasks.find(t => t.id === taskId);
            if (task) {
                task.completed = !task.completed;
                task.status = getStatus(task);
                saveData();
                loadData(); 

                // å®Œäº†æ™‚ã«ç´™å¹é›ª
                if (task.completed) {
                    confetti({
                        particleCount: 100,
                        spread: 70,
                        origin: { y: 0.6 }
                    });
                }
            }
        }

        // ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆã®ã‚ºãƒ¼ãƒ 
        function zoomGantt(factor) {
            // â­ ReferenceErrorå›é¿ã®ãŸã‚ã€ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã¨ã—ã¦å®šç¾©
            ganttZoomLevel *= factor;
            // æœ€å°ãƒ»æœ€å¤§ã‚ºãƒ¼ãƒ ãƒ¬ãƒ™ãƒ«ã‚’è¨­å®š
            if (ganttZoomLevel < 0.5) ganttZoomLevel = 0.5;
            if (ganttZoomLevel > 3.0) ganttZoomLevel = 3.0;
            renderGanttChart();
        }
        
        // ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆã‚’ä»Šæ—¥ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
        function scrollToToday() {
            // â­ ReferenceErrorå›é¿ã®ãŸã‚ã€ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã¨ã—ã¦å®šç¾©
            const ganttScrollWrapper = document.getElementById('ganttScrollWrapper');
            if (ganttScrollWrapper) {
                // ä»Šæ—¥ãŒå§‹ã¾ã‚‹ä½ç½®ã‚’è¨ˆç®—
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                const allDates = tasks.map(t => t.startDate).filter(d => d);
                const minDate = allDates.length > 0 ? new Date(Math.min(...allDates)) : new Date();
                minDate.setDate(minDate.getDate() - 7); 
                minDate.setHours(0, 0, 0, 0); // æ™‚åˆ»ã‚’ãƒªã‚»ãƒƒãƒˆ

                const daysFromStart = diffInDays(minDate, today);
                
                // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½® (ã‚¿ã‚¹ã‚¯ååˆ—ã®å¹… + æ—¥æ•° * æ—¥ã®å¹… * ã‚ºãƒ¼ãƒ ãƒ¬ãƒ™ãƒ«)
                // ç”»é¢ä¸­å¤®ã«è¡¨ç¤ºã™ã‚‹ãŸã‚ã«ã€ç”»é¢å¹…ã®åŠåˆ†ã‚’å¼•ã
                const scrollPos = daysFromStart * DAY_WIDTH * ganttZoomLevel + TASK_COL_WIDTH - (ganttScrollWrapper.offsetWidth / 2);

                ganttScrollWrapper.scrollTo({
                    left: scrollPos,
                    behavior: 'smooth'
                });
            }
        }
        
        // ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆã®ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒªã‚µã‚¤ã‚ºå‡¦ç†
        function setupGanttDragAndResize(minDate) {
            const allBars = document.querySelectorAll('.gantt-bar');
            const dayWidth = DAY_WIDTH * ganttZoomLevel;
            
            // ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®ã‚¿ã‚¹ã‚¯ãƒ‡ãƒ¼ã‚¿ã‚‚ã€ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° 'resizingTask' ã‚’ä½¿ã†ã‚ˆã†ã«å¤‰æ›´æ¸ˆã¿ã€‚

            allBars.forEach(bar => {
                const taskId = parseInt(bar.dataset.taskId);
                const task = tasks.find(t => t.id === taskId);
                if (!task || task.completed) return; // å®Œäº†ã‚¿ã‚¹ã‚¯ã¯ç·¨é›†ä¸å¯

                // 1. ãƒ‰ãƒ©ãƒƒã‚°
                bar.addEventListener('mousedown', (e) => {
                    if (e.target.classList.contains('gantt-bar-resize-left') || e.target.classList.contains('gantt-bar-resize-right')) return;
                    
                    isDragging = true;
                    draggingBar = bar;
                    
                    // ãƒãƒ¼ã®å·¦ç«¯ã¨ã‚¯ãƒªãƒƒã‚¯ä½ç½®ã®å·®ã‚’è¨ˆç®— (ãƒ‰ãƒ©ãƒƒã‚°ã‚ªãƒ•ã‚»ãƒƒãƒˆ)
                    const barRect = bar.getBoundingClientRect();
                    dragOffset = e.clientX - barRect.left;
                    
                    bar.classList.add('dragging');
                    document.body.style.cursor = 'move';
                    document.body.style.userSelect = 'none';
                });

                // 2. ãƒªã‚µã‚¤ã‚º
                bar.querySelectorAll('.gantt-bar-resize-left, .gantt-bar-resize-right').forEach(handle => {
                    handle.addEventListener('mousedown', (e) => {
                        e.stopPropagation(); // ãƒ‰ãƒ©ãƒƒã‚°ã‚¤ãƒ™ãƒ³ãƒˆã¨ç«¶åˆã—ãªã„ã‚ˆã†ã«
                        isResizing = true;
                        resizingBar = bar;
                        // â­ é‡è¤‡å®£è¨€ã‚¨ãƒ©ãƒ¼ã‚’é¿ã‘ã‚‹ãŸã‚ã€ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‚’å†åˆ©ç”¨
                        resizingTask = task; // ãƒªã‚µã‚¤ã‚ºå¯¾è±¡ã®ã‚¿ã‚¹ã‚¯ã‚’ã‚»ãƒƒãƒˆ
                        
                        document.body.style.cursor = 'ew-resize';
                        document.body.style.userSelect = 'none';
                    });
                });
            });

            // 3. ãƒã‚¦ã‚¹ç§»å‹• (å…¨ä½“)
            document.addEventListener('mousemove', (e) => {
                const scrollWrapper = document.getElementById('ganttScrollWrapper');
                if (!scrollWrapper) return;
                
                const timelineContainer = scrollWrapper.querySelector('.gantt-timeline-container');
                if (!timelineContainer) return;

                const timelineContainerRect = timelineContainer.getBoundingClientRect();
                const mouseX = e.clientX - timelineContainerRect.left + scrollWrapper.scrollLeft;

                // ãƒ‰ãƒ©ãƒƒã‚°å‡¦ç†
                if (isDragging && draggingBar) {
                    const newLeft = mouseX - dragOffset;
                    
                    // æ–°ã—ã„é–‹å§‹æ—¥ã‚’è¨ˆç®— (å››æ¨äº”å…¥ã—ã¦æœ€ã‚‚è¿‘ã„æ—¥ã¸)
                    const newDayIndex = Math.round((newLeft) / dayWidth);
                    const newStartDate = new Date(minDate);
                    newStartDate.setDate(minDate.getDate() + newDayIndex);
                    newStartDate.setHours(0, 0, 0, 0); // æ™‚åˆ»ã‚’ãƒªã‚»ãƒƒãƒˆ
                    
                    // ã‚¿ã‚¹ã‚¯ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
                    const taskToUpdate = tasks.find(t => t.id === parseInt(draggingBar.dataset.taskId));
                    if (taskToUpdate && taskToUpdate.startDate && taskToUpdate.endDate) {
                        // æœŸé–“ã‚’ç¶­æŒã—ãŸã¾ã¾çµ‚äº†æ—¥ã‚‚è¨ˆç®—
                        const duration = diffInDays(taskToUpdate.startDate, taskToUpdate.endDate);
                        const newEndDate = new Date(newStartDate);
                        newEndDate.setDate(newStartDate.getDate() + duration);
                        
                        taskToUpdate.startDate = newStartDate;
                        taskToUpdate.endDate = newEndDate;
                        
                        // è¦‹ãŸç›®ã‚’ã™ãã«æ›´æ–°
                        draggingBar.style.left = newDayIndex * dayWidth + 'px';
                    }
                }
                
                // ãƒªã‚µã‚¤ã‚ºå‡¦ç†
                if (isResizing && resizingBar && resizingTask) {
                    // resizeTypeã‚’ãƒã‚¦ã‚¹ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã‹ã‚‰å†å–å¾—ï¼ˆhandleãŒãƒ›ãƒãƒ¼ã•ã‚Œç¶šã‘ã¦ã„ã‚‹ã‹ç¢ºèªï¼‰
                    const targetHandle = e.target.closest('.gantt-bar-resize-left, .gantt-bar-resize-right');
                    const resizeType = targetHandle ? targetHandle.dataset.type : null;
                    
                    if (resizeType) {
                        const barLeft = parseInt(resizingBar.style.left.replace('px', ''));
                        
                        if (resizeType === 'start') {
                            const newDayIndex = Math.floor((mouseX) / dayWidth);
                            const newLeft = newDayIndex * dayWidth;
                            
                            // æ–°ã—ã„é–‹å§‹æ—¥
                            const newStartDate = new Date(minDate);
                            newStartDate.setDate(minDate.getDate() + newDayIndex);
                            newStartDate.setHours(0, 0, 0, 0); // æ™‚åˆ»ã‚’ãƒªã‚»ãƒƒãƒˆ
                            
                            // æœŸé–“ãŒ1æ—¥æœªæº€ã«ãªã‚‰ãªã„ã‚ˆã†ã«åˆ¶é™
                            if (newStartDate < resizingTask.endDate) {
                                // è¦‹ãŸç›®ã®æ›´æ–°
                                resizingBar.style.left = newLeft + 'px';
                                resizingBar.style.width = (resizingTask.endDate.getTime() - newStartDate.getTime()) / (24 * 60 * 60 * 1000) * dayWidth + dayWidth + 'px'; // æœŸé–“æ—¥æ•° * dayWidth
                                // ãƒ‡ãƒ¼ã‚¿æ›´æ–°
                                resizingTask.startDate = newStartDate;
                            }
                        } else if (resizeType === 'end') {
                            const newDayIndex = Math.ceil((mouseX) / dayWidth) - 1; // çµ‚äº†æ—¥ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
                            
                            // æ–°ã—ã„çµ‚äº†æ—¥
                            const newEndDate = new Date(minDate);
                            newEndDate.setDate(minDate.getDate() + newDayIndex);
                            newEndDate.setHours(0, 0, 0, 0); // æ™‚åˆ»ã‚’ãƒªã‚»ãƒƒãƒˆ
                            
                            // æœŸé–“ãŒ1æ—¥æœªæº€ã«ãªã‚‰ãªã„ã‚ˆã†ã«åˆ¶é™
                            if (newEndDate >= resizingTask.startDate) {
                                // æ–°ã—ã„å¹…
                                const durationDays = diffInDays(resizingTask.startDate, newEndDate) + 1;
                                const newWidth = durationDays * dayWidth;
                                // è¦‹ãŸç›®ã®æ›´æ–°
                                resizingBar.style.width = newWidth + 'px';
                                // ãƒ‡ãƒ¼ã‚¿æ›´æ–°
                                resizingTask.endDate = newEndDate;
                            }
                        }
                    }
                }
            });

            // 4. ãƒã‚¦ã‚¹ã‚¢ãƒƒãƒ— (å…¨ä½“)
            document.addEventListener('mouseup', () => {
                if (isDragging || isResizing) {
                    saveData(); // ãƒ‰ãƒ©ãƒƒã‚°ã¾ãŸã¯ãƒªã‚µã‚¤ã‚ºãŒçµ‚äº†ã—ãŸã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
                    // å®Œäº†å¾Œã€ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆã‚’å†æç”»ã—ã¦æœ€æ–°ã®çŠ¶æ…‹ã«ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
                    // renderGanttChart();
                }

                isDragging = false;
                draggingBar = null;
                isResizing = false;
                resizingBar = null;
                resizingTask = null; // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‚’ã‚¯ãƒªã‚¢

                document.body.style.cursor = 'default';
                document.body.style.userSelect = 'auto';
                
                // ãƒ‰ãƒ©ãƒƒã‚°ã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤
                document.querySelectorAll('.gantt-bar.dragging').forEach(bar => {
                    bar.classList.remove('dragging');
                });
            });
        }
        
        // ãƒªã‚µã‚¤ã‚¶ãƒ¼æ©Ÿèƒ½ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        function setupResizers() {
            const sidebar = document.getElementById('sidebar');
            const sidebarResizer = document.getElementById('sidebarResizer');
            const contentHeader = document.getElementById('contentHeader');
            const headerResizer = document.getElementById('headerResizer');

            let startX, startY, startWidth, startHeight;

            // ã‚µã‚¤ãƒ‰ãƒãƒ¼ãƒªã‚µã‚¤ã‚¶ãƒ¼
            if (sidebarResizer) {
                sidebarResizer.addEventListener('mousedown', (e) => {
                    isResizingSidebar = true;
                    startX = e.clientX;
                    startWidth = sidebar.offsetWidth;
                    document.body.style.cursor = 'ew-resize';
                    document.body.style.userSelect = 'none';
                    e.preventDefault();
                });
            }

            // ãƒ˜ãƒƒãƒ€ãƒ¼ãƒªã‚µã‚¤ã‚¶ãƒ¼
            if (headerResizer) {
                headerResizer.addEventListener('mousedown', (e) => {
                    isResizingHeader = true;
                    startY = e.clientY;
                    // ç¾åœ¨ã®ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã«åŸºã¥ã„ã¦é«˜ã•ã‚’æ¦‚ç®—
                    startHeight = contentHeader.offsetHeight;
                    document.body.style.cursor = 'ns-resize';
                    document.body.style.userSelect = 'none';
                    e.preventDefault();
                });
            }

            // ãƒã‚¦ã‚¹ç§»å‹•
            document.addEventListener('mousemove', (e) => {
                if (isResizingSidebar) {
                    const width = startWidth + (e.clientX - startX);
                    if (width >= 200 && width <= 500) {
                        sidebar.style.width = width + 'px';
                        TASK_COL_WIDTH = width; // ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆã®ã‚¿ã‚¹ã‚¯ååˆ—å¹…ã¨é€£å‹•
                        // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æç”»ã¯ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚³ã‚¹ãƒˆãŒé«˜ã„ãŸã‚ã€mouseupæ™‚ã«æç”»ã—ã¦ã‚‚è‰¯ã„
                        // renderGanttChart(); 
                    }
                } else if (isResizingHeader) {
                    const newHeight = startHeight + (e.clientY - startY);
                    if (newHeight >= 50 && newHeight <= 200) {
                         // ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã§é«˜ã•ã‚’èª¿æ•´
                        const paddingV = Math.max(8, (newHeight - 40) / 2); // 8pxãŒæœ€å°
                        contentHeader.style.padding = `${paddingV}px 24px ${paddingV}px 24px`;
                        HEADER_HEIGHT = newHeight;
                        
                        // ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆã® max-height ã‚‚èª¿æ•´
                        const ganttContainer = document.querySelector('.gantt-container');
                        if(ganttContainer) {
                            ganttContainer.style.maxHeight = `calc(100vh - ${newHeight + 10}px)`;
                        }
                    }
                }
            });

            // ãƒã‚¦ã‚¹ã‚¢ãƒƒãƒ—
            document.addEventListener('mouseup', () => {
                if (isResizingSidebar) {
                    renderGanttChart(); // ã‚µã‚¤ãƒ‰ãƒãƒ¼ã®å¹…å¤‰æ›´å¾Œã«ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆã‚’å†æç”»
                }
                isResizingSidebar = false;
                isResizingHeader = false;
                document.body.style.cursor = 'default';
                document.body.style.userSelect = 'auto';
            });
        }


        // åˆæœŸå‡¦ç†
        window.onload = function() {
            // â­ ä¿®æ­£: HTMLè¦ç´ ãŒãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã‹ã‚‰JSé–¢æ•°ã‚’å‘¼ã³å‡ºã™ã“ã¨ã§ReferenceErrorã‚’å›é¿
            initializeStoreSelector();
            setupFileImport();
            setupResizers();
            // æœ€å¾Œã«ãƒ­ã‚°ã‚¤ãƒ³ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œï¼ˆãƒ‡ãƒ¼ã‚¿ã®ãƒ­ãƒ¼ãƒ‰ã¯checkLogin/showAppå†…ã§è¡Œã‚ã‚Œã‚‹ï¼‰
            checkLogin();
        };

    </script>
</body>
</html>