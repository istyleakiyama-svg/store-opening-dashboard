<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>I-STYLE æ–°åº—ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ - å®Œå…¨ç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #007AFF;
            --secondary: #5856D6;
            --success: #34C759;
            --warning: #FF9500;
            --danger: #FF3B30;
            --background: #F5F5F7;
            --surface: #FFFFFF;
            --text-primary: #1D1D1F;
            --text-secondary: #86868B;
            --border: #D2D2D7;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Helvetica Neue', Arial, sans-serif;
            background: var(--background);
            color: var(--text-primary);
            line-height: 1.6;
        }

        .app-container {
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ */
        .mobile-menu-btn {
            display: none;
            position: fixed;
            top: 16px;
            left: 16px;
            z-index: 1001;
            background: var(--primary);
            color: white;
            border: none;
            width: 48px;
            height: 48px;
            border-radius: 12px;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3);
        }

        .mobile-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }

        /* ã‚µã‚¤ãƒ‰ãƒãƒ¼ */
        .sidebar {
            width: 280px;
            background: var(--surface);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            z-index: 1000;
            position: relative;
        }

        .sidebar-header {
            padding: 24px;
            border-bottom: 1px solid var(--border);
        }

        .logo {
            font-size: 24px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
        }

        .store-selector {
            margin-top: 16px;
        }

        .store-select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-size: 15px;
            background: var(--background);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .store-select:focus {
            outline: none;
            border-color: var(--primary);
            background: var(--surface);
        }

        .nav-menu {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            margin-bottom: 4px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
            color: var(--text-primary);
        }

        .nav-item:hover {
            background: var(--background);
        }

        .nav-item.active {
            background: var(--primary);
            color: white;
        }

        .nav-item .icon {
            margin-right: 12px;
            font-size: 20px;
        }

        /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */
        .main-content {
            flex: 1;
            overflow-y: auto;
            background: var(--background);
        }

        .content-header {
            background: var(--surface);
            padding: 12px 24px;
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(20px);
            background: rgba(255, 255, 255, 0.9);
            overflow: hidden;
            transition: all 0.2s ease;
        }

        .content-header h1 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 2px;
        }

        .content-header p {
            color: var(--text-secondary);
            font-size: 13px;
        }

        .content-body {
            padding: 16px;
        }

        /* ãƒªã‚µã‚¤ã‚¶ãƒ¼ */
        .sidebar-resizer {
            position: absolute;
            right: 0;
            top: 0;
            width: 5px;
            height: 100%;
            cursor: ew-resize;
            background: transparent;
            z-index: 1001;
            transition: background 0.2s ease;
        }

        .sidebar-resizer:hover {
            background: var(--primary);
        }

        .header-resizer {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 5px;
            cursor: ns-resize;
            background: transparent;
            z-index: 101;
            transition: background 0.2s ease;
        }

        .header-resizer:hover {
            background: var(--primary);
        }

        /* ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */
        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ã‚«ãƒ¼ãƒ‰ */
        .card {
            background: var(--surface);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            flex-wrap: wrap;
            gap: 8px;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
        }

        /* ãƒœã‚¿ãƒ³ */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: #0051D5;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3);
        }

        .btn-secondary {
            background: var(--background);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: #E8E8ED;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-group {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        /* çµ±è¨ˆã‚«ãƒ¼ãƒ‰ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            padding: 24px;
            border-radius: 16px;
            color: white;
            text-align: center;
        }

        .stat-value {
            font-size: 36px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }

        /* éšå±¤ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆ */
        .hierarchical-task-list {
            margin-top: 20px;
        }

        .task-group {
            margin-bottom: 16px;
        }

        .parent-task {
            background: linear-gradient(135deg, rgba(0, 122, 255, 0.15), rgba(88, 86, 214, 0.15));
            border-left: 6px solid var(--primary);
            padding: 20px;
            margin-bottom: 8px;
            border-radius: 12px;
            font-weight: 700;
            font-size: 18px;
        }

        .child-tasks {
            margin-left: 30px;
        }

        .task-item {
            background: var(--background);
            border-left: 4px solid var(--primary);
            padding: 16px;
            margin-bottom: 8px;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .task-item:hover {
            background: #E8E8ED;
            transform: translateX(4px);
        }

        .task-item.level-1 {
            background: linear-gradient(135deg, rgba(0, 122, 255, 0.1), rgba(88, 86, 214, 0.1));
            border-left-width: 6px;
            font-weight: 700;
            font-size: 18px;
            padding: 20px;
        }

        .task-item.level-2 {
            margin-left: 30px;
            border-left-color: var(--secondary);
            font-weight: 600;
            font-size: 16px;
        }

        .task-item.level-3 {
            margin-left: 60px;
            border-left-color: var(--success);
        }

        .task-item.level-4 { margin-left: 90px; border-left-color: var(--warning); }
        .task-item.level-5 { margin-left: 120px; border-left-color: #FF2D55; }
        .task-item.level-6 { margin-left: 150px; border-left-color: #AF52DE; }
        .task-item.level-7 { margin-left: 180px; border-left-color: #FFD60A; }
        .task-item.level-8 { margin-left: 210px; border-left-color: #64D2FF; }
        .task-item.level-9 { margin-left: 240px; border-left-color: #30D158; }
        .task-item.level-10 { margin-left: 270px; border-left-color: #BF5AF2; }

        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
            gap: 12px;
        }

        .task-name {
            font-weight: 600;
            color: var(--text-primary);
            flex: 1;
        }

        .task-meta {
            display: flex;
            gap: 12px;
            font-size: 14px;
            color: var(--text-secondary);
            margin-top: 8px;
            flex-wrap: wrap;
        }

        .task-assignee {
            background: rgba(0, 122, 255, 0.1);
            color: var(--primary);
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 600;
        }

        .task-status {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 600;
        }

        .task-status.pending { background: #FEF5E7; color: #D68910; }
        .task-status.in-progress { background: #E3F2FD; color: #1976D2; }
        .task-status.completed { background: #E8F5E9; color: #388E3C; }

        .task-memo {
            color: var(--text-secondary);
            font-size: 14px;
            margin-top: 8px;
            font-style: italic;
        }

        .task-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .btn-edit, .btn-delete {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-edit {
            background: #E3F2FD;
            color: #1976D2;
        }

        .btn-delete {
            background: #FFEBEE;
            color: #C62828;
        }

        /* ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆ */
        .gantt-container {
            background: var(--surface);
            border-radius: 16px;
            padding: 12px;
            display: flex;
            flex-direction: column;
            max-height: calc(100vh - 120px);
            min-height: 400px;
        }

        /* 2. ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆâ†’ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒœã‚¿ãƒ³ã‚’å¸¸æ™‚è¡¨ç¤ºã•ã›ãŸã„ */
        .gantt-scroll-wrapper {
            overflow: scroll; /* auto ã‹ã‚‰ scroll ã«å¤‰æ›´ */
            overflow-x: scroll; /* æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’æ˜ç¤º */
            overflow-y: scroll; /* ç¸¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’æ˜ç¤º */
            flex: 1;
            position: relative;
        }

        /* 1. ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆâ†’å­ã€å­«ã‚¿ã‚¹ã‚¯ã®è¡¨ç¤º/éè¡¨ç¤º (æ–°è¦è¿½åŠ ) */
        /* é–‰ã˜ã¦ã„ã‚‹ã‚¿ã‚¹ã‚¯ã®è¡Œã¯éè¡¨ç¤º */
        .gantt-row.collapsed {
            display: none;
        }

        /* å±•é–‹/æŠ˜ã‚ŠãŸãŸã¿ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .gantt-toggle-btn {
            display: inline-block;
            margin-right: 6px;
            cursor: pointer;
            font-size: 10px;
            line-height: 1;
            transition: transform 0.2s ease;
            font-family: 'SF Pro Display', 'Helvetica Neue', Arial, sans-serif; /* è¨˜å·ãŒå´©ã‚Œãªã„ã‚ˆã†ã« */
            font-weight: 900;
        }

        /* å±•é–‹çŠ¶æ…‹ã®è¡Œï¼ˆè¦ªã‚¿ã‚¹ã‚¯ï¼‰ */
        .gantt-row.expanded > .gantt-task-info > div {
            /* flexã‚’ç¶­æŒã—ã¦ãƒœã‚¿ãƒ³ã¨ã‚¿ã‚¹ã‚¯åã‚’ä¸¦ã¹ã‚‹ */
            display: flex;
            align-items: center;
        }

        /* å±•é–‹çŠ¶æ…‹ã®æ™‚ã®ãƒœã‚¿ãƒ³ã®å‘ãï¼ˆâ–¶ï¸ã‹ã‚‰â–¼ã¸ï¼‰ */
        .gantt-row.expanded > .gantt-task-info .gantt-toggle-btn {
            transform: rotate(90deg);
        }

        /* éè¦ªã‚¿ã‚¹ã‚¯ã®æƒ…å ±éƒ¨åˆ†ã‚’èª¿æ•´ */
        .gantt-row:not(.expanded) > .gantt-task-info > div {
            display: block; /* ãƒœã‚¿ãƒ³ãŒãªã„å ´åˆã¯ç¸¦ã«ç©ã‚€ */
        }
        
        .gantt-header-fixed {
            position: sticky;
            top: 0;
            background: var(--surface);
            z-index: 15;
            padding-bottom: 16px;
            border-bottom: 2px solid var(--border);
            margin-bottom: 16px;
        }

        .gantt-timeline-wrapper {
            display: flex;
        }

        .gantt-task-names {
            width: 300px;
            flex-shrink: 0;
            position: sticky;
            left: 0;
            background: var(--surface);
            z-index: 40;
        }

        .gantt-timeline-container {
            flex: 1;
            min-width: 2000px;
        }

        .gantt-calendar-header {
            display: flex;
            border-bottom: 2px solid var(--border);
            margin-bottom: 12px;
        }

        .gantt-year-header {
            display: flex;
            margin-bottom: 8px;
        }

        .gantt-year-block {
            flex: 0 0 auto;
            text-align: center;
            padding: 10px 12px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            font-weight: 700;
            font-size: 15px;
            border-radius: 8px;
            margin: 0 1px;
        }

        .gantt-month-header {
            display: flex;
            margin-bottom: 4px;
        }

        .gantt-month-block {
            flex: 0 0 auto;
            text-align: center;
            padding: 8px 6px;
            background: var(--background);
            font-weight: 600;
            font-size: 13px;
            border-radius: 6px;
            margin: 0 1px;
        }

        .gantt-day-header {
            display: flex;
        }

        .gantt-day-cell {
            flex: 0 0 30px;
            width: 30px;
            text-align: center;
            padding: 6px 2px;
            font-size: 10px;
            border-right: 1px solid var(--border);
            color: var(--text-secondary);
            line-height: 1.2;
        }

        .gantt-day-cell.weekend {
            background: rgba(255, 149, 0, 0.05);
        }

        .gantt-day-cell.today {
            background: rgba(0, 122, 255, 0.15);
            color: var(--primary);
            font-weight: 700;
        }

        .gantt-row {
            display: flex;
            align-items: stretch;
            border-bottom: 1px solid var(--border);
            min-height: 30px;
        }

        .gantt-task-info {
            padding: 4px 8px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            background: #FFFFFF !important;
            position: sticky;
            left: 0;
            z-index: 150;
            border-right: 2px solid var(--border);
        }

        .gantt-row.level-1 .gantt-task-info {
            font-weight: 700;
            background: #e8f0ff !important;
        }

        .gantt-row.level-2 .gantt-task-info {
            padding-left: 32px;
            font-weight: 600;
        }

        .gantt-row.level-3 .gantt-task-info {
            padding-left: 52px;
        }

        .gantt-timeline-row {
            flex: 1;
            position: relative;
            display: flex;
            align-items: center;
        }

        .gantt-timeline-bg {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
        }

        .gantt-day-bg {
            border-right: 1px solid rgba(0, 0, 0, 0.05);
        }

        .gantt-day-bg.weekend {
            background: rgba(255, 149, 0, 0.02);
        }

        .gantt-bar {
            position: absolute;
            height: 32px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 8px;
            cursor: move;
            display: flex;
            align-items: center;
            padding: 0 12px;
            color: white;
            font-size: 12px;
            font-weight: 600;
            user-select: none;
            transition: box-shadow 0.2s ease;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            z-index: 5;
            opacity: 1;
        }

        .gantt-bar:hover {
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.5);
            z-index: 20;
        }

        .gantt-bar.dragging {
            opacity: 0.8;
            z-index: 100;
        }

        .gantt-bar-resize-left,
        .gantt-bar-resize-right {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 10px;
            cursor: ew-resize;
            background: rgba(255, 255, 255, 0.3);
        }

        .gantt-bar-resize-left {
            left: 0;
            border-radius: 8px 0 0 8px;
        }

        .gantt-bar-resize-right {
            right: 0;
            border-radius: 0 8px 8px 0;
        }

        .gantt-today-line {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 3px;
            background: var(--danger);
            z-index: 20;
            pointer-events: none;
            box-shadow: 0 0 8px rgba(255, 59, 48, 0.5);
        }

        /* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ */
        .calendar-container {
            background: var(--surface);
            border-radius: 16px;
            padding: 24px;
            /* 3. ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ç¸¦å¹…æ‹¡å¼µ: 220px -> 100px */
            height: calc(100vh - 100px); 
            display: flex;
            flex-direction: column;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            flex-shrink: 0;
        }

        .calendar-nav {
            display: flex;
            gap: 8px;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            grid-template-rows: repeat(6, 1fr);
            gap: 8px;
            flex: 1;
            min-height: 0;
        }

        .calendar-day {
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 8px;
            position: relative;
            overflow: auto;
        }

        .calendar-day.other-month {
            opacity: 0.3;
        }

        .calendar-day.today {
            background: rgba(0, 122, 255, 0.1);
            border-color: var(--primary);
            border-width: 2px;
        }

        .calendar-day-number {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .calendar-task {
            font-size: 11px;
            padding: 2px 6px;
            background: var(--primary);
            color: white;
            border-radius: 4px;
            margin-bottom: 2px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* ã‚¹ã‚¿ãƒƒãƒ•ã‚°ãƒªãƒƒãƒ‰ */
        .staff-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
        }

        .staff-card {
            background: var(--background);
            border-radius: 12px;
            padding: 20px;
            transition: all 0.2s ease;
        }

        .staff-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        .staff-name {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .staff-role {
            display: inline-block;
            padding: 4px 12px;
            background: rgba(0, 122, 255, 0.1);
            color: var(--primary);
            border-radius: 12px;
            font-size: 13px;
            margin-bottom: 12px;
        }

        .staff-info {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 32px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 2px solid var(--border);
        }

        .modal-title {
            font-size: 24px;
            font-weight: 700;
        }

        /* ãƒ•ã‚©ãƒ¼ãƒ  */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 15px;
            transition: all 0.2s ease;
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(0, 122, 255, 0.1);
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        /* CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ */
        .import-zone {
            border: 2px dashed var(--border);
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            background: var(--background);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .import-zone:hover {
            border-color: var(--primary);
            background: rgba(0, 122, 255, 0.05);
        }

        .import-zone.dragover {
            border-color: var(--primary);
            background: rgba(0, 122, 255, 0.1);
        }

        /* å°åˆ·ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        @media print {
            .sidebar,
            .content-header,
            .mobile-menu-btn,
            .btn,
            .task-actions,
            .calendar-nav {
                display: none !important;
            }

            body {
                background: white;
            }

            .main-content {
                width: 100%;
                padding: 0;
            }

            .content-body {
                padding: 0;
            }

            .gantt-container {
                box-shadow: none;
                border: 1px solid #000;
                page-break-inside: avoid;
            }

            .card-header {
                border-bottom: 2px solid #000;
                padding-bottom: 16px;
                margin-bottom: 16px;
            }

            .card-title {
                color: #000;
                font-size: 20px;
            }

            .gantt-bar {
                print-color-adjust: exact;
                -webkit-print-color-adjust: exact;
            }

            .gantt-year-block,
            .gantt-month-block {
                print-color-adjust: exact;
                -webkit-print-color-adjust: exact;
            }

            .gantt-scroll-wrapper {
                overflow: visible !important;
                max-height: none !important;
                transform: none !important;
            }

            .gantt-task-info {
                position: relative;
                left: auto;
            }
        }

        /* ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œ */
        /* 4. ã‚¹ãƒãƒ›ã§ã‚‚è¦‹ã‚„ã™ã„æ§˜ã« (æ—¢å­˜ã® @media ãƒ–ãƒ­ãƒƒã‚¯å†…ã«è¿½è¨˜/ä¿®æ­£) */
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: 0;
                top: 0;
                height: 100%;
                transform: translateX(-100%);
            }

            .sidebar.active {
                transform: translateX(0);
            }

            .mobile-menu-btn {
                display: block;
            }

            .mobile-overlay.active {
                display: block;
            }

            .content-header {
                padding: 20px 16px;
                padding-top: 80px;
            }

            .content-header h1 {
                font-size: 24px;
            }

            .content-body {
                padding: 16px;
            }

            .gantt-task-names,
            .gantt-task-info {
                width: 150px;
            }

            .task-item.level-2 { margin-left: 20px; }
            .task-item.level-3 { margin-left: 40px; }
            .task-item.level-4 { margin-left: 60px; }
            .task-item.level-5 { margin-left: 80px; }
            .task-item.level-6 { margin-left: 100px; }
            .task-item.level-7 { margin-left: 120px; }
            .task-item.level-8 { margin-left: 140px; }
            .task-item.level-9 { margin-left: 160px; }
            .task-item.level-10 { margin-left: 180px; }

            .staff-grid {
                grid-template-columns: 1fr;
            }

            .calendar-grid {
                gap: 4px;
            }

            .calendar-day {
                min-height: 60px;
                padding: 4px;
            }

            /* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®é«˜ã•ã‚’èª¿æ•´ */
            .calendar-container {
                height: auto; 
                min-height: calc(100vh - 150px); /* æœ€å°é«˜ã•ã‚’è¨­å®šã—ã¦è¦‹ã‚„ã™ãã™ã‚‹ */
            }
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-state-text {
            font-size: 18px;
        }
    </style>
</head>
<body>
    <div id="loginScreen" class="login-screen" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(135deg, #007AFF, #5856D6); z-index: 9999; display: flex; align-items: center; justify-content: center;">
        <div style="background: white; padding: 48px; border-radius: 24px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); width: 420px; max-width: 90%;">
            <h1 style="font-size: 32px; font-weight: 700; background: linear-gradient(135deg, #007AFF, #5856D6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-align: center; margin-bottom: 32px;">ğŸª I-STYLE</h1>
            <div id="loginError" style="display: none; padding: 12px; background: rgba(255, 59, 48, 0.1); color: #FF3B30; border-radius: 8px; margin-bottom: 16px; font-size: 14px;"></div>
            <form id="loginForm" onsubmit="handleLogin(event)">
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                    <input type="email" id="loginEmail" required style="width: 100%; padding: 12px; border: 2px solid #D2D2D7; border-radius: 10px; font-size: 16px;">
                </div>
                <div style="margin-bottom: 24px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                    <input type="password" id="loginPassword" required style="width: 100%; padding: 12px; border: 2px solid #D2D2D7; border-radius: 10px; font-size: 16px;">
                </div>
                <button type="submit" style="width: 100%; padding: 14px; background: #007AFF; color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer;">ãƒ­ã‚°ã‚¤ãƒ³</button>
            </form>
        </div>
    </div>

    <button class="mobile-menu-btn" onclick="toggleSidebar()">â˜°</button>
    <div class="mobile-overlay" onclick="toggleSidebar()"></div>

    <div class="app-container" id="appContainer" style="display: none;">
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="logo">ğŸª I-STYLE</div>
                <div class="store-selector">
                    <select class="store-select" id="storeSelect" onchange="switchStore()">
                        <option value="default">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆåº—èˆ—</option>
                    </select>
                </div>
                <div id="userInfo" style="margin-top: 16px; padding: 12px; background: #F5F5F7; border-radius: 10px;">
                    <div style="font-weight: 600; margin-bottom: 4px;" id="currentUserName"></div>
                    <div style="font-size: 12px; color: #86868B;" id="currentUserRole"></div>
                </div>
            </div>

            <nav class="nav-menu">
                <div class="nav-item active" onclick="showTab('dashboard')">
                    <span class="icon">ğŸ“Š</span>
                    ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
                </div>
                <div class="nav-item" onclick="showTab('gantt')">
                    <span class="icon">ğŸ“…</span>
                    ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆ
                </div>
                <div class="nav-item" onclick="showTab('calendar')">
                    <span class="icon">ğŸ—“ï¸</span>
                    ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼
                </div>
                <div class="nav-item" onclick="showTab('staff')">
                    <span class="icon">ğŸ‘¥</span>
                    ã‚¹ã‚¿ãƒƒãƒ•
                </div>
                <div class="nav-item" onclick="showTab('timeline')">
                    <span class="icon">â±ï¸</span>
                    ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³
                </div>
                <div class="nav-item" onclick="showTab('tasks')">
                    <span class="icon">ğŸ“‹</span>
                    ã‚¿ã‚¹ã‚¯ç®¡ç†
                </div>
                <div class="nav-item" onclick="showTab('settings')">
                    <span class="icon">âš™ï¸</span>
                    è¨­å®š
                </div>
            </nav>
            <div style="margin-top: auto; padding: 16px; border-top: 1px solid #D2D2D7;">
                <button onclick="logout()" style="width: 100%; padding: 12px; background: #FF3B30; color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer;">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
            </div>
            <div class="sidebar-resizer" id="sidebarResizer"></div>
        </aside>

        <main class="main-content">
            <div class="content-header">
                <h1 id="pageTitle">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
                <p id="pageDescription">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®é€²æ—ã‚’ä¸€ç›®ã§ç¢ºèª</p>
                <div class="header-resizer" id="headerResizer"></div>
            </div>
            <div class="content-body">
                <div id="dashboard" class="tab-content active">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="totalTasks">0</div>
                            <div class="stat-label">ç·ã‚¿ã‚¹ã‚¯æ•°</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="completedTasks">0</div>
                            <div class="stat-label">å®Œäº†</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="inProgressTasks">0</div>
                            <div class="stat-label">é€²è¡Œä¸­</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="progressPercent">0%</div>
                            <div class="stat-label">é€²æ—ç‡</div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦</h2>
                        </div>
                        <div id="dashboardStats"></div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">é‡è¦ãªãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³</h2>
                        </div>
                        <div id="milestones">
                            <div class="empty-state">
                                <div class="empty-state-icon">ğŸ‰</div>
                                <div class="empty-state-text">é‡è¦ãªã‚¿ã‚¹ã‚¯ã‚’ãƒãƒ¼ã‚¯ã—ã¾ã—ã‚‡ã†</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="gantt" class="tab-content">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ»ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆ</h2>
                        </div>
                        <div class="gantt-container" id="ganttChart">
                            <div class="empty-state">
                                <div class="empty-state-icon">ğŸ“…</div>
                                <div class="empty-state-text">ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="calendar" class="tab-content">
                    <div class="calendar-container">
                        <div class="calendar-header">
                            <h2 class="card-title" id="calendarTitle">2025å¹´ 10æœˆ</h2>
                            <div class="calendar-nav btn-group">
                                <button class="btn btn-secondary" onclick="todayMonth()">ä»Šæ—¥</button>
                                <button class="btn btn-secondary" onclick="previousMonth()">â—€</button>
                                <button class="btn btn-secondary" onclick="nextMonth()">â–¶</button>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(7, 1fr); margin-bottom: 8px; font-weight: 600; text-align: center; color: var(--text-secondary); flex-shrink: 0;">
                            <div>æ—¥</div>
                            <div>æœˆ</div>
                            <div>ç«</div>
                            <div>æ°´</div>
                            <div>æœ¨</div>
                            <div>é‡‘</div>
                            <div>åœŸ</div>
                        </div>
                        <div class="calendar-grid" id="calendarGrid">
                        </div>
                    </div>
                </div>

                <div id="staff" class="tab-content">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">ã‚¹ã‚¿ãƒƒãƒ•ä¸€è¦§</h2>
                            <button class="btn btn-primary" onclick="openStaffModal()">â• ã‚¹ã‚¿ãƒƒãƒ•è¿½åŠ </button>
                        </div>
                        <div class="staff-grid" id="staffList">
                            <div class="empty-state">
                                <div class="empty-state-icon">ğŸ‘¥</div>
                                <div class="empty-state-text">ã‚¹ã‚¿ãƒƒãƒ•ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="timeline" class="tab-content">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">ã‚¿ã‚¹ã‚¯ãƒ»ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ (é–‹å§‹æ—¥é †)</h2>
                        </div>
                        <div id="timelineView">
                            <div class="empty-state">
                                <div class="empty-state-icon">â±ï¸</div>
                                <div class="empty-state-text">ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="tasks" class="tab-content">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">ã‚¿ã‚¹ã‚¯è¿½åŠ /ç·¨é›†</h2>
                        </div>
                        <form onsubmit="addOrUpdateTask(event)" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                            <div class="form-group">
                                <label class="form-label">ãƒ¬ãƒ™ãƒ«</label>
                                <input type="number" id="taskLevel" class="form-input" min="1" max="10" value="1" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">è¦ªã‚¿ã‚¹ã‚¯å</label>
                                <input type="text" id="taskParent" class="form-input">
                            </div>
                            <div class="form-group">
                                <label class="form-label">ã‚¿ã‚¹ã‚¯å</label>
                                <input type="text" id="taskName" class="form-input" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">æ‹…å½“è€…</label>
                                <input type="text" id="taskAssignee" class="form-input">
                            </div>
                            <div class="form-group">
                                <label class="form-label">ãƒ¡ãƒ¢</label>
                                <input type="text" id="taskMemo" class="form-input">
                            </div>
                            <div class="form-group">
                                <label class="form-label">é–‹å§‹æ—¥</label>
                                <input type="date" id="taskStart" class="form-input" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">çµ‚äº†æ—¥</label>
                                <input type="date" id="taskEnd" class="form-input" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
                                <select id="taskStatus" class="form-select" required>
                                    <option value="æœªç€æ‰‹">æœªç€æ‰‹</option>
                                    <option value="é€²è¡Œä¸­">é€²è¡Œä¸­</option>
                                    <option value="å®Œäº†">å®Œäº†</option>
                                </select>
                            </div>
                            <div class="form-group" style="display: flex; align-items: flex-end; gap: 8px;">
                                <button type="submit" class="btn btn-primary" id="taskSubmitBtn">â• ã‚¿ã‚¹ã‚¯è¿½åŠ </button>
                                <button type="button" class="btn btn-secondary" id="cancelEditBtn" onclick="cancelEdit()" style="display: none;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                            </div>
                        </form>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">éšå±¤ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆ</h2>
                        </div>
                        <div class="hierarchical-task-list" id="taskList"></div>
                    </div>
                </div>

                <div id="settings" class="tab-content">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">åº—èˆ—ç®¡ç†</h2>
                        </div>
                        <div class="form-group">
                            <label class="form-label">æ–°è¦åº—èˆ—å</label>
                            <input type="text" id="newStoreName" class="form-input">
                            <button class="btn btn-secondary" onclick="addStore()" style="margin-top: 10px;">â• åº—èˆ—è¿½åŠ </button>
                        </div>
                        <div class="form-group">
                            <button class="btn btn-danger" onclick="deleteStore()">ğŸ—‘ï¸ ç¾åœ¨ã®åº—èˆ—ã‚’å‰Šé™¤</button>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">ã‚¹ã‚¿ãƒƒãƒ•/ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†</h2>
                            <button class="btn btn-primary" onclick="openUserModal()">â• ãƒ¦ãƒ¼ã‚¶ãƒ¼è¿½åŠ </button>
                        </div>
                        <div id="userList"></div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">ãƒ‡ãƒ¼ã‚¿ã‚¤ãƒ³ãƒãƒ¼ãƒˆ/ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</h2>
                        </div>
                        <div class="form-group">
                            <button class="btn btn-secondary" onclick="exportData()">â¬‡ï¸ ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ (JSON)</button>
                        </div>
                        <div class="form-group">
                            <button class="btn btn-secondary" onclick="exportTasksAsCsv()">â¬‡ï¸ ã‚¿ã‚¹ã‚¯ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ (CSV)</button>
                        </div>
                        <div class="form-group">
                            <label class="form-label">ã‚¿ã‚¹ã‚¯ã‚¤ãƒ³ãƒãƒ¼ãƒˆ (CSV)</label>
                            <div class="import-zone" id="csvDropZone">
                                CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã“ã“ã«ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã€ã¾ãŸã¯ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠ
                                <input type="file" id="csvFileInput" accept=".csv" style="display: none;" onchange="handleFileSelect(event)">
                            </div>
                        </div>
                        <div class="form-group">
                            <button class="btn btn-danger" onclick="clearAllData()">âš ï¸ å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="staffModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="staffModalTitle">ã‚¹ã‚¿ãƒƒãƒ•è¿½åŠ </h2>
            </div>
            <form onsubmit="addOrUpdateStaff(event)">
                <input type="hidden" id="staffId">
                <div class="form-group">
                    <label class="form-label">åå‰</label>
                    <input type="text" id="staffName" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">å½¹å‰²/éƒ¨ç½²</label>
                    <input type="text" id="staffRole" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">é€£çµ¡å…ˆï¼ˆãƒ¡ãƒ¼ãƒ«ï¼‰</label>
                    <input type="email" id="staffEmail" class="form-input">
                </div>
                <div class="form-group">
                    <label class="form-label">å‚™è€ƒ</label>
                    <textarea id="staffMemo" class="form-textarea"></textarea>
                </div>
                <div class="btn-group" style="justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('staffModal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button type="submit" class="btn btn-primary" id="staffSubmitBtnText">è¿½åŠ </button>
                </div>
            </form>
        </div>
    </div>

    <div id="userModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">ãƒ¦ãƒ¼ã‚¶ãƒ¼è¿½åŠ </h2>
            </div>
            <form onsubmit="addOrUpdateUser(event)">
                <input type="hidden" id="userId">
                <div class="form-group">
                    <label class="form-label">åå‰</label>
                    <input type="text" id="userName" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ (ID)</label>
                    <input type="email" id="userEmail" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                    <input type="password" id="userPassword" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">æ¨©é™</label>
                    <select id="userRole" class="form-select" required>
                        <option value="editor">ç·¨é›†è€…</option>
                        <option value="admin">ç®¡ç†è€…</option>
                    </select>
                </div>
                <div class="btn-group" style="justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('userModal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button type="submit" class="btn btn-primary">ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²</button>
                </div>
            </form>
        </div>
    </div>


    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã¨åˆæœŸãƒ‡ãƒ¼ã‚¿
        let data = {};
        let currentStoreId = 'default';
        let currentUser = null;
        let isEditingTaskId = null;
        let isEditingStaffId = null;

        const users = [
            { id: 1, name: 'ç®¡ç†è€…', email: 'admin@example.com', password: 'password', role: 'admin' },
            { id: 2, name: 'ç·¨é›†è€…', email: 'editor@example.com', password: 'password', role: 'editor' },
        ];

        // ãƒ‡ãƒ¼ã‚¿ã®åˆæœŸåŒ–ã¨ä¿å­˜
        function initializeData() {
            return {
                stores: {
                    'default': {
                        name: 'ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆåº—èˆ—',
                        tasks: [
                            // åˆæœŸã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ï¼ˆã‚¿ã‚¹ã‚¯ï¼‰
                            { id: 101, level: 1, parent: '', name: 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨ˆç”»ãƒ»åŸºæœ¬è¨­è¨ˆ', assignee: 'ç®¡ç†è€…', memo: 'ã‚­ãƒƒã‚¯ã‚ªãƒ•ä¼šè­°ã¨è¦ä»¶å®šç¾©', start: '2025-01-01', end: '2025-01-15', status: 'å®Œäº†', isMilestone: true, children: [102, 103] },
                            { id: 102, level: 2, parent: 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨ˆç”»ãƒ»åŸºæœ¬è¨­è¨ˆ', name: 'ã‚­ãƒƒã‚¯ã‚ªãƒ•ä¼šè­°', assignee: 'ç®¡ç†è€…', memo: 'å…¨é–¢ä¿‚è€…ã¸ã®å…±æœ‰', start: '2025-01-01', end: '2025-01-05', status: 'å®Œäº†', children: [] },
                            { id: 103, level: 2, parent: 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨ˆç”»ãƒ»åŸºæœ¬è¨­è¨ˆ', name: 'è¦ä»¶å®šç¾©ãƒ•ã‚§ãƒ¼ã‚º', assignee: 'ç®¡ç†è€…', memo: 'åº—èˆ—ã‚³ãƒ³ã‚»ãƒ—ãƒˆã¨ä¸»è¦ã‚¿ã‚¹ã‚¯ã®æ´—ã„å‡ºã—', start: '2025-01-06', end: '2025-01-15', status: 'å®Œäº†', children: [] },

                            { id: 201, level: 1, parent: '', name: 'åº—èˆ—å·¥äº‹ãƒ»å†…è£…æº–å‚™', assignee: 'å·¥äº‹æ‹…å½“', memo: 'å†…è£…æ¥­è€…ã¨ã®é€£æº', start: '2025-01-16', end: '2025-03-31', status: 'é€²è¡Œä¸­', isMilestone: false, children: [202, 203] },
                            { id: 202, level: 2, parent: 'åº—èˆ—å·¥äº‹ãƒ»å†…è£…æº–å‚™', name: 'å†…è£…è¨­è¨ˆã®ç¢ºå®š', assignee: 'è¨­è¨ˆæ‹…å½“', memo: '', start: '2025-01-16', end: '2025-01-31', status: 'å®Œäº†', children: [] },
                            { id: 203, level: 2, parent: 'åº—èˆ—å·¥äº‹ãƒ»å†…è£…æº–å‚™', name: 'ä»€å™¨ãƒ»å‚™å“ã®ç™ºæ³¨', assignee: 'ç™ºæ³¨æ‹…å½“', memo: 'é•·æœŸç´æœŸã®ã‚‚ã®ã‚’å„ªå…ˆ', start: '2025-02-01', end: '2025-02-15', status: 'é€²è¡Œä¸­', children: [204] },
                            { id: 204, level: 3, parent: 'ä»€å™¨ãƒ»å‚™å“ã®ç™ºæ³¨', name: 'ãƒ¬ã‚¸ã‚·ã‚¹ãƒ†ãƒ å¥‘ç´„', assignee: 'ITæ‹…å½“', memo: '', start: '2025-02-05', end: '2025-02-10', status: 'å®Œäº†', children: [] },
                            
                            { id: 301, level: 1, parent: '', name: 'æ¡ç”¨ãƒ»ç ”ä¿®', assignee: 'äººäº‹éƒ¨', memo: '', start: '2025-03-01', end: '2025-04-30', status: 'æœªç€æ‰‹', isMilestone: false, children: [302, 303, 304] },
                            { id: 302, level: 2, parent: 'æ¡ç”¨ãƒ»ç ”ä¿®', name: 'æ±‚äººåºƒå‘Šã®æ²è¼‰é–‹å§‹', assignee: 'äººäº‹éƒ¨', memo: '', start: '2025-03-01', end: '2025-03-07', status: 'æœªç€æ‰‹', children: [] },
                            { id: 303, level: 2, parent: 'æ¡ç”¨ãƒ»ç ”ä¿®', name: 'é¢æ¥ãƒ»æ¡ç”¨æ±ºå®š', assignee: 'äººäº‹éƒ¨', memo: 'è¨ˆ5åã‚’æ¡ç”¨ç›®æ¨™', start: '2025-03-08', end: '2025-04-15', status: 'æœªç€æ‰‹', children: [] },
                            { id: 304, level: 2, parent: 'æ¡ç”¨ãƒ»ç ”ä¿®', name: 'ã‚¹ã‚¿ãƒƒãƒ•ç ”ä¿®å®Ÿæ–½', assignee: 'åº—é•·å€™è£œ', memo: '', start: '2025-04-16', end: '2025-04-30', status: 'æœªç€æ‰‹', children: [] },

                            { id: 401, level: 1, parent: '', name: 'å•†å“ãƒ»è²©ä¿ƒæº–å‚™', assignee: 'å•†å“éƒ¨', memo: '', start: '2025-03-15', end: '2025-05-15', status: 'æœªç€æ‰‹', isMilestone: false, children: [402, 403] },
                            { id: 402, level: 2, parent: 'å•†å“ãƒ»è²©ä¿ƒæº–å‚™', name: 'åˆæœŸå•†å“ç™ºæ³¨å®Œäº†', assignee: 'å•†å“éƒ¨', memo: '', start: '2025-03-15', end: '2025-04-15', status: 'æœªç€æ‰‹', children: [] },
                            { id: 403, level: 2, parent: 'å•†å“ãƒ»è²©ä¿ƒæº–å‚™', name: 'ã‚ªãƒ¼ãƒ—ãƒ³ãƒãƒ©ã‚·ä½œæˆ', assignee: 'è²©ä¿ƒéƒ¨', memo: '', start: '2025-04-01', end: '2025-05-01', status: 'æœªç€æ‰‹', children: [] },

                            { id: 501, level: 1, parent: '', name: 'æœ€çµ‚ãƒã‚§ãƒƒã‚¯', assignee: 'åº—é•·', memo: 'ãƒ—ãƒ¬ã‚ªãƒ¼ãƒ—ãƒ³å‰ã®æœ€çµ‚ç¢ºèª', start: '2025-05-16', end: '2025-05-25', status: 'æœªç€æ‰‹', isMilestone: true, children: [] },
                            { id: 601, level: 1, parent: '', name: 'ã‚°ãƒ©ãƒ³ãƒ‰ã‚ªãƒ¼ãƒ—ãƒ³', assignee: 'å…¨ç¤¾', memo: 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå®Œäº†', start: '2025-05-26', end: '2025-05-26', status: 'æœªç€æ‰‹', isMilestone: true, children: [] },
                        ],
                        staff: [
                            { id: 1, name: 'å±±ç”° å¤ªéƒ', role: 'åº—é•·å€™è£œ', email: 'yamada@example.com', memo: 'å·¥äº‹ãƒ»æ¡ç”¨ã®è²¬ä»»è€…' },
                            { id: 2, name: 'ä½è—¤ èŠ±å­', role: 'å•†å“éƒ¨', email: 'sato@example.com', memo: 'åˆæœŸå•†å“é¸å®šæ‹…å½“' },
                            { id: 3, name: 'ç”°ä¸­ æ¬¡éƒ', role: 'å·¥äº‹æ‹…å½“', email: 'tanaka@example.com', memo: 'å†…è£…é€²æ—ç®¡ç†' },
                        ],
                        nextTaskId: 602,
                        nextStaffId: 4,
                    }
                },
                nextStoreId: 2,
            };
        }

        // LocalStorageã‹ã‚‰ã®èª­ã¿è¾¼ã¿
        function loadData() {
            const savedData = localStorage.getItem('istyle_dashboardData');
            if (savedData) {
                data = JSON.parse(savedData);
                // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã«nextTaskId/nextStaffIdãŒãªã„å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                if (!data.stores[currentStoreId].nextTaskId) data.stores[currentStoreId].nextTaskId = 1;
                if (!data.stores[currentStoreId].nextStaffId) data.stores[currentStoreId].nextStaffId = 1;
            } else {
                data = initializeData();
                saveData();
            }

            const savedStoreId = localStorage.getItem('istyle_currentStoreId');
            if (savedStoreId && data.stores[savedStoreId]) {
                currentStoreId = savedStoreId;
            } else {
                currentStoreId = Object.keys(data.stores)[0];
            }
        }

        // LocalStorageã¸ã®ä¿å­˜
        function saveData() {
            localStorage.setItem('istyle_dashboardData', JSON.stringify(data));
            localStorage.setItem('istyle_currentStoreId', currentStoreId);
            renderAllViews();
        }

        // åº—èˆ—åˆ‡ã‚Šæ›¿ãˆã®UIè¨­å®š
        function initializeStoreSelector() {
            const select = document.getElementById('storeSelect');
            select.innerHTML = '';
            
            Object.keys(data.stores).forEach(id => {
                const store = data.stores[id];
                const option = document.createElement('option');
                option.value = id;
                option.textContent = store.name;
                if (id === currentStoreId) {
                    option.selected = true;
                }
                select.appendChild(option);
            });
            updateCurrentStoreName(data.stores[currentStoreId].name);
        }

        function switchStore() {
            const select = document.getElementById('storeSelect');
            currentStoreId = select.value;
            saveData();
            updateCurrentStoreName(data.stores[currentStoreId].name);
        }

        function updateCurrentStoreName(name) {
            document.getElementById('pageTitle').textContent = `ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ - ${name}`;
            document.getElementById('pageDescription').textContent = 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®é€²æ—ã‚’ä¸€ç›®ã§ç¢ºèª';
        }

        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });

            document.getElementById(tabName).classList.add('active');
            document.querySelector(`.nav-item[onclick="showTab('${tabName}')"]`).classList.add('active');

            // ãƒ˜ãƒƒãƒ€ãƒ¼æƒ…å ±æ›´æ–°
            const header = {
                'dashboard': { title: 'ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰', desc: 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®é€²æ—ã‚’ä¸€ç›®ã§ç¢ºèª' },
                'gantt': { title: 'ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆ', desc: 'ã‚¿ã‚¹ã‚¯ã®æœŸé–“ã¨ä¾å­˜é–¢ä¿‚ã‚’è¦–è¦šåŒ–' },
                'calendar': { title: 'ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼', desc: 'æ—¥ä»˜ãƒ™ãƒ¼ã‚¹ã§ã‚¿ã‚¹ã‚¯ã®æœŸé™ã‚’ç¢ºèª' },
                'staff': { title: 'ã‚¹ã‚¿ãƒƒãƒ•', desc: 'åº—èˆ—ã‚¹ã‚¿ãƒƒãƒ•ã®ç®¡ç†' },
                'timeline': { title: 'ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³', desc: 'ã‚¿ã‚¹ã‚¯é–‹å§‹æ—¥é †ã®ãƒªã‚¹ãƒˆ' },
                'tasks': { title: 'ã‚¿ã‚¹ã‚¯ç®¡ç†', desc: 'ã‚¿ã‚¹ã‚¯ã®è¿½åŠ ã€ç·¨é›†ã€éšå±¤è¡¨ç¤º' },
                'settings': { title: 'è¨­å®š', desc: 'åº—èˆ—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã€ãƒ‡ãƒ¼ã‚¿ã®ç®¡ç†' },
            };
            document.getElementById('pageTitle').textContent = header[tabName].title + (tabName !== 'settings' ? ` - ${data.stores[currentStoreId].name}` : '');
            document.getElementById('pageDescription').textContent = header[tabName].desc;

            // ã‚¿ãƒ–å›ºæœ‰ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
            renderAllViews();
            
            // ãƒ¢ãƒã‚¤ãƒ«ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‰ã˜ã‚‹
            if (document.querySelector('.sidebar').classList.contains('active')) {
                toggleSidebar();
            }
        }

        // å…¨ãƒ“ãƒ¥ãƒ¼ã®å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
        function renderAllViews() {
            const currentTab = document.querySelector('.tab-content.active').id;
            if (currentTab === 'dashboard') renderDashboard();
            if (currentTab === 'gantt') renderGanttChart();
            if (currentTab === 'calendar') renderCalendar(currentCalendarDate);
            if (currentTab === 'staff') renderStaffList();
            if (currentTab === 'timeline') renderTimeline();
            if (currentTab === 'tasks') renderTaskList();
            if (currentTab === 'settings') renderUserList();
        }

        // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
        function renderDashboard() {
            const store = data.stores[currentStoreId];
            const allTasks = store.tasks;
            const totalTasks = allTasks.length;
            const completedTasks = allTasks.filter(t => t.status === 'å®Œäº†').length;
            const inProgressTasks = allTasks.filter(t => t.status === 'é€²è¡Œä¸­').length;
            const progressPercent = totalTasks > 0 ? ((completedTasks / totalTasks) * 100).toFixed(0) : 0;
            
            // çµ±è¨ˆæƒ…å ±ã®æ›´æ–°
            document.getElementById('totalTasks').textContent = totalTasks;
            document.getElementById('completedTasks').textContent = completedTasks;
            document.getElementById('inProgressTasks').textContent = inProgressTasks;
            document.getElementById('progressPercent').textContent = `${progressPercent}%`;

            // é€²æ—ãŒ100%ãªã‚‰ç´™å¹é›ªã‚’å‡ºã™
            if (progressPercent == 100 && totalTasks > 0) {
                 confetti({
                    particleCount: 100,
                    spread: 70,
                    origin: { y: 0.6 }
                });
            }

            // ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ã®è¡¨ç¤º
            const milestones = allTasks.filter(t => t.isMilestone).sort((a, b) => new Date(a.start) - new Date(b.start));
            const milestonesContainer = document.getElementById('milestones');
            if (milestones.length === 0) {
                milestonesContainer.innerHTML = `<div class="empty-state"><div class="empty-state-icon">ğŸ‰</div><div class="empty-state-text">é‡è¦ãªã‚¿ã‚¹ã‚¯ã‚’ãƒãƒ¼ã‚¯ã—ã¾ã—ã‚‡ã†</div></div>`;
                return;
            }

            milestonesContainer.innerHTML = milestones.map(m => `
                <div style="border-left: 4px solid ${m.status === 'å®Œäº†' ? '#34C759' : '#007AFF'}; padding: 12px; margin-bottom: 12px; background: #F5F5F7; border-radius: 8px;">
                    <div style="font-weight: 600; font-size: 16px;">${m.name}</div>
                    <div style="font-size: 14px; color: #86868B;">
                        æœŸé™: ${m.end} | æ‹…å½“: ${m.assignee || 'æœªå®š'} | ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: <span class="task-status ${m.status === 'å®Œäº†' ? 'completed' : 'pending'}">${m.status}</span>
                    </div>
                </div>
            `).join('');
        }

        // ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
        const DAY_WIDTH = 30; // 1æ—¥ã®å¹… (px)
        let TASK_COL_WIDTH = 300; // ã‚¿ã‚¹ã‚¯ååˆ—ã®å¹… (px, åˆæœŸå€¤ã¯CSSã¨åˆã‚ã›ã‚‹)

        function renderGanttChart() {
            const store = data.stores[currentStoreId];
            if (store.tasks.length === 0) {
                document.getElementById('ganttChart').innerHTML = `<div class="empty-state"><div class="empty-state-icon">ğŸ“…</div><div class="empty-state-text">ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“</div></div>`;
                return;
            }

            // 1. ã‚¿ã‚¹ã‚¯ãƒ‡ãƒ¼ã‚¿ã®æº–å‚™ã¨æœŸé–“ã®ç‰¹å®š
            const allTasks = store.tasks;
            const taskMap = allTasks.reduce((map, task) => (map[task.id] = task, map), {});

            const startDates = allTasks.map(t => new Date(t.start)).filter(d => !isNaN(d));
            const endDates = allTasks.map(t => new Date(t.end)).filter(d => !isNaN(d));

            if (startDates.length === 0 || endDates.length === 0) {
                document.getElementById('ganttChart').innerHTML = `<div class="empty-state"><div class="empty-state-icon">ğŸ“…</div><div class="empty-state-text">ã‚¿ã‚¹ã‚¯ã«æœ‰åŠ¹ãªæ—¥ä»˜ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“</div></div>`;
                return;
            }

            let minDate = new Date(Math.min(...startDates));
            let maxDate = new Date(Math.max(...endDates));

            // è¡¨ç¤ºæœŸé–“ã‚’å‰å¾Œã«ä½™è£•ã‚’æŒãŸã›ã‚‹
            minDate.setDate(minDate.getDate() - 10);
            maxDate.setDate(maxDate.getDate() + 10);

            // 2. ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ˜ãƒƒãƒ€ãƒ¼ã®ç”Ÿæˆ
            const { days, years, months, totalWidth } = generateTimelineHeader(minDate, maxDate);
            
            const calendarHeaderHtml = `
                <div class="gantt-header-fixed">
                    <div class="gantt-timeline-wrapper">
                        <div class="gantt-task-names" style="width: ${TASK_COL_WIDTH}px;"></div>
                        <div class="gantt-timeline-container" style="min-width: ${totalWidth}px;">
                            ${years}
                            ${months}
                            ${days}
                        </div>
                    </div>
                </div>
            `;
            
            // 3. ã‚¿ã‚¹ã‚¯è¡Œã¨ãƒãƒ¼ã®ç”Ÿæˆ
            const taskListHtml = generateHierarchicalTaskList(allTasks, taskMap, (task, level) => {
                const startDate = new Date(task.start);
                const endDate = new Date(task.end);
                const startOffsetDays = Math.max(0, Math.floor((startDate - minDate) / (1000 * 60 * 60 * 24)));
                const durationDays = Math.max(1, Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1);

                const left = startOffsetDays * DAY_WIDTH;
                const barWidth = durationDays * DAY_WIDTH;

                // ãƒãƒ¼ã®è‰²ã®æ±ºå®š
                let barColor = '';
                if (task.status === 'å®Œäº†') {
                    barColor = 'background: linear-gradient(135deg, #34C759, #30D158);'; // Success
                } else if (task.status === 'é€²è¡Œä¸­') {
                    barColor = 'background: linear-gradient(135deg, #FF9500, #FFCC00);'; // Warning/In Progress
                } else {
                    barColor = 'background: linear-gradient(135deg, var(--primary), var(--secondary));'; // Primary/Pending
                }

                const taskBarHtml = `
                    <div class="gantt-bar"
                        style="left: ${left}px; width: ${barWidth}px; ${barColor}"
                        data-task-id="${task.id}"
                        data-start-date="${task.start}"
                        data-end-date="${task.end}">
                        ${task.name}
                        <div class="gantt-bar-resize-left"></div>
                        <div class="gantt-bar-resize-right"></div>
                    </div>
                `;

                // ã‚¿ã‚¹ã‚¯ååˆ—
                const toggleBtn = task.children && task.children.length > 0 ? 
                    `<span class="gantt-toggle-btn" onclick="toggleGanttRow(${task.id})">â–¶</span>` : '';

                const taskNameHtml = `
                    <div class="gantt-task-info" style="width: ${TASK_COL_WIDTH}px;">
                        <div>${toggleBtn}${task.name}</div>
                    </div>
                `;

                // ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³èƒŒæ™¯
                const backgroundHtml = days.match(/<div class="gantt-day-cell(.*?)"/g).map((match, index) => {
                    const isWeekend = match.includes('weekend');
                    const isToday = match.includes('today');
                    let bgClass = 'gantt-day-bg';
                    if (isWeekend) bgClass += ' weekend';
                    if (isToday) bgClass += ' today';
                    return `<div class="${bgClass}" style="flex: 0 0 ${DAY_WIDTH}px; width: ${DAY_WIDTH}px;"></div>`;
                }).join('');

                return `
                    <div class="gantt-row level-${level}" data-task-id="${task.id}" data-parent-id="${task.parent ? taskMap[task.parent] ? taskMap[task.parent].id : '' : ''}">
                        ${taskNameHtml}
                        <div class="gantt-timeline-row">
                            <div class="gantt-timeline-bg" style="min-width: ${totalWidth}px;">${backgroundHtml}</div>
                            ${taskBarHtml}
                        </div>
                    </div>
                `;
            });

            // 4. ä»Šæ—¥ã®ç·šã®ç”Ÿæˆ
            const today = new Date();
            const todayOffsetDays = Math.floor((today - minDate) / (1000 * 60 * 60 * 24));
            const todayLineLeft = todayOffsetDays * DAY_WIDTH + (DAY_WIDTH / 2); // 1æ—¥ã®çœŸã‚“ä¸­

            const todayLineHtml = `<div class="gantt-today-line" style="left: ${todayLineLeft}px; min-height: ${allTasks.length * 30}px;"></div>`;

            // 5. æœ€çµ‚çš„ãªHTMLã®çµåˆ
            const scrollWrapperHtml = `
                <div class="gantt-scroll-wrapper" id="ganttScrollWrapper">
                    <div class="gantt-timeline-all">
                        <div class="gantt-timeline-content" style="width: ${totalWidth + TASK_COL_WIDTH}px;">
                            ${taskListHtml.join('')}
                            <div class="gantt-timeline-row">
                                <div class="gantt-task-info" style="width: ${TASK_COL_WIDTH}px; border-bottom: none;"></div>
                                <div class="gantt-timeline-row" style="min-width: ${totalWidth}px; border-bottom: none;">${todayLineHtml}</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('ganttChart').innerHTML = calendarHeaderHtml + scrollWrapperHtml;
            
            // 6. ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã‚¤ãƒ™ãƒ³ãƒˆã®è¨­å®š
            setupGanttDragAndDrop();
            
            // 7. åˆæœŸã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’ä»Šæ—¥ã«åˆã‚ã›ã‚‹
            const scrollWrapper = document.getElementById('ganttScrollWrapper');
            if (scrollWrapper) {
                // ä¸­å¤®ã‹ã‚‰å°‘ã—å³ã«ãšã‚‰ã™
                scrollWrapper.scrollLeft = Math.max(0, todayLineLeft - (scrollWrapper.clientWidth / 2) + 150);
            }
        }

        function generateTimelineHeader(minDate, maxDate) {
            const today = new Date();
            const oneDay = 1000 * 60 * 60 * 24;
            const totalDays = Math.ceil((maxDate - minDate) / oneDay);

            let daysHtml = '<div class="gantt-day-header">';
            let monthsHtml = '<div class="gantt-month-header" id="ganttMonthHeader">';
            let yearsHtml = '<div class="gantt-year-header" id="ganttYearHeader">';
            
            let currentDay = new Date(minDate);
            let monthStarts = [];
            let yearStarts = [];
            let lastYear = null;
            let lastMonth = null;

            for (let i = 0; i <= totalDays; i++) {
                const dayOfWeek = currentDay.getDay(); // 0:æ—¥, 6:åœŸ
                const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                const isToday = currentDay.toDateString() === today.toDateString();
                
                let dayClass = 'gantt-day-cell';
                if (isWeekend) dayClass += ' weekend';
                if (isToday) dayClass += ' today';

                daysHtml += `<div class="${dayClass}">${currentDay.getDate()}</div>`;

                // æœˆã®å§‹ã¾ã‚Šã‚’è¨˜éŒ²
                if (currentDay.getMonth() !== lastMonth) {
                    monthStarts.push({
                        month: currentDay.getMonth(),
                        year: currentDay.getFullYear(),
                        index: i,
                        date: new Date(currentDay),
                    });
                    lastMonth = currentDay.getMonth();
                }

                // å¹´ã®å§‹ã¾ã‚Šã‚’è¨˜éŒ²
                if (currentDay.getFullYear() !== lastYear) {
                    yearStarts.push({
                        year: currentDay.getFullYear(),
                        index: i,
                    });
                    lastYear = currentDay.getFullYear();
                }

                currentDay.setDate(currentDay.getDate() + 1);
            }

            // æœˆãƒ–ãƒ­ãƒƒã‚¯ã®å¹…ã‚’è¨ˆç®—ã—ã¦HTMLã«æŒ¿å…¥
            for (let i = 0; i < monthStarts.length; i++) {
                const start = monthStarts[i].index;
                const end = i < monthStarts.length - 1 ? monthStarts[i + 1].index : totalDays;
                const width = (end - start) * DAY_WIDTH;
                const monthName = monthStarts[i].date.toLocaleDateString('ja-JP', { month: 'short' });
                monthsHtml += `<div class="gantt-month-block" style="width: ${width}px;">${monthName}</div>`;
            }

            // å¹´ãƒ–ãƒ­ãƒƒã‚¯ã®å¹…ã‚’è¨ˆç®—ã—ã¦HTMLã«æŒ¿å…¥
            for (let i = 0; i < yearStarts.length; i++) {
                const start = yearStarts[i].index;
                const end = i < yearStarts.length - 1 ? yearStarts[i + 1].index : totalDays;
                const width = (end - start) * DAY_WIDTH;
                yearsHtml += `<div class="gantt-year-block" style="width: ${width}px;">${yearStarts[i].year}å¹´</div>`;
            }


            daysHtml += '</div>';
            monthsHtml += '</div>';
            yearsHtml += '</div>';

            return {
                days: daysHtml,
                months: monthsHtml,
                years: yearsHtml,
                totalWidth: totalDays * DAY_WIDTH,
            };
        }

        // ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆã®ãƒˆã‚°ãƒ«å‡¦ç† (æ–°è¦è¿½åŠ )
        function toggleGanttRow(parentId) {
            const row = document.querySelector(`.gantt-row[data-task-id="${parentId}"]`);
            if (!row) return;

            const isExpanded = row.classList.toggle('expanded');
            
            // è¦ªã‚¿ã‚¹ã‚¯ã®ãƒ¬ãƒ™ãƒ«ã‚’å–å¾—
            const parentLevel = parseInt(row.className.match(/level-(\d+)/)[1]);

            // å­ã‚¿ã‚¹ã‚¯ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹
            const tasks = data.stores[currentStoreId].tasks;
            const taskMap = tasks.reduce((map, task) => (map[task.id] = task, map), {});

            function toggleChildren(id, show) {
                const children = tasks.filter(t => taskMap[t.id].parent == taskMap[id].name);
                children.forEach(child => {
                    const childRow = document.querySelector(`.gantt-row[data-task-id="${child.id}"]`);
                    if (childRow) {
                        childRow.classList.toggle('collapsed', !show);
                        
                        // é–‰ã˜ã‚‹ã¨ãã¯ã•ã‚‰ã«å­å­«ã‚‚é–‰ã˜ã‚‹
                        if (!show) {
                            childRow.classList.remove('expanded');
                            toggleChildren(child.id, false);
                        }
                    }
                });
            }

            // ç›´æ¥ã®å­å­«ã‚¿ã‚¹ã‚¯ã‚’æ“ä½œ
            tasks.filter(t => taskMap[t.id].parent === taskMap[parentId].name).forEach(child => {
                 const childRow = document.querySelector(`.gantt-row[data-task-id="${child.id}"]`);
                 if (childRow) {
                     childRow.classList.toggle('collapsed', !isExpanded);
                     // é–‰ã˜ã‚‹ã¨ãã¯ã•ã‚‰ã«å­å­«ã‚‚é–‰ã˜ã‚‹
                    if (!isExpanded) {
                        childRow.classList.remove('expanded');
                        toggleChildren(child.id, false);
                    }
                 }
            });
        }


        // ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆã®ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—å‡¦ç†
        function setupGanttDragAndDrop() {
            const ganttBars = document.querySelectorAll('.gantt-bar');
            ganttBars.forEach(bar => {
                let isDragging = false;
                let isResizing = false;
                let resizeDirection = null;
                let startX, barLeft, barWidth, task;

                // 2. ã‚¿ã‚¹ã‚¯æƒ…å ±ã®å–å¾—
                const taskId = bar.dataset.taskId;
                task = data.stores[currentStoreId].tasks.find(t => t.id == taskId);

                // 3. ç§»å‹•é–‹å§‹ (ã‚¿ã‚¹ã‚¯ãƒãƒ¼æœ¬ä½“)
                bar.addEventListener('mousedown', (e) => {
                    if (e.target.classList.contains('gantt-bar-resize-left') || e.target.classList.contains('gantt-bar-resize-right')) {
                        return; // ãƒªã‚µã‚¤ã‚ºãƒãƒ³ãƒ‰ãƒ«ã®å ´åˆã¯ç„¡è¦–
                    }
                    isDragging = true;
                    startX = e.clientX;
                    barLeft = bar.offsetLeft;
                    document.body.classList.add('dragging');
                    bar.classList.add('dragging');
                    e.preventDefault();
                });

                // 4. ãƒªã‚µã‚¤ã‚ºé–‹å§‹
                bar.querySelectorAll('.gantt-bar-resize-left, .gantt-bar-resize-right').forEach(handle => {
                    handle.addEventListener('mousedown', (e) => {
                        isResizing = true;
                        resizeDirection = e.target.classList.contains('gantt-bar-resize-left') ? 'left' : 'right';
                        startX = e.clientX;
                        barLeft = bar.offsetLeft;
                        barWidth = bar.offsetWidth;
                        document.body.classList.add('dragging');
                        bar.classList.add('dragging');
                        e.stopPropagation();
                        e.preventDefault();
                    });
                });

                // 5. ãƒã‚¦ã‚¹ç§»å‹•
                document.addEventListener('mousemove', (e) => {
                    const store = data.stores[currentStoreId];
                    const minDate = new Date(Math.min(...store.tasks.map(t => new Date(t.start))));
                    minDate.setDate(minDate.getDate() - 10); // renderGanttChartã§è¨­å®šã—ãŸä½™è£•æœŸé–“ã¨åˆã‚ã›ã‚‹

                    const dx = e.clientX - startX;
                    const daysOffset = Math.round(dx / DAY_WIDTH);
                    
                    if (isDragging) {
                        // æ–°ã—ã„é–‹å§‹æ—¥ã‚’è¨ˆç®—
                        const newLeft = barLeft + (daysOffset * DAY_WIDTH);
                        const newStartDate = new Date(task.start);
                        newStartDate.setDate(newStartDate.getDate() + daysOffset);
                        
                        // æœŸé–“ã®è¨ˆç®—
                        const duration = (new Date(task.end) - new Date(task.start)) / (1000 * 60 * 60 * 24);
                        const newEndDate = new Date(newStartDate);
                        newEndDate.setDate(newEndDate.getDate() + duration);

                        // UIã®æ›´æ–°ã¯mousemoveã§ã¯è¡Œã‚ãšã€mouseupã§æœ€çµ‚ç¢ºå®šã™ã‚‹
                        bar.style.left = newLeft + 'px';
                        bar.dataset.newStart = formatDate(newStartDate);
                        bar.dataset.newEnd = formatDate(newEndDate);
                    } else if (isResizing) {
                        if (resizeDirection === 'right') {
                            const newWidth = barWidth + dx;
                            const newDays = Math.max(1, Math.round(newWidth / DAY_WIDTH));
                            const newEndOffset = barLeft + (newDays * DAY_WIDTH) - barLeft; // æ–°ã—ã„çµ‚äº†æ—¥ã®Xåº§æ¨™
                            
                            const daysFromMin = Math.round((barLeft + newEndOffset) / DAY_WIDTH);
                            const newEndDate = new Date(minDate);
                            newEndDate.setDate(newEndDate.getDate() + daysFromMin - 1); // -1ã¯æœŸé–“ãŒ1æ—¥çŸ­ã„ã“ã¨ã‚’è€ƒæ…®

                            bar.style.width = newDays * DAY_WIDTH + 'px';
                            bar.dataset.newEnd = formatDate(newEndDate);

                        } else if (resizeDirection === 'left') {
                            const newLeft = barLeft + dx;
                            const newWidth = barWidth - dx;

                            if (newWidth >= DAY_WIDTH) {
                                const newDaysOffset = Math.round((newLeft - barLeft) / DAY_WIDTH);
                                const newStart = new Date(task.start);
                                newStart.setDate(newStart.getDate() + newDaysOffset);

                                bar.style.left = newLeft + 'px';
                                bar.style.width = newWidth + 'px';
                                bar.dataset.newStart = formatDate(newStart);
                            }
                        }
                    }
                });

                // 6. ãƒã‚¦ã‚¹ã‚¢ãƒƒãƒ— (æœ€çµ‚ç¢ºå®š)
                document.addEventListener('mouseup', () => {
                    if (isDragging || isResizing) {
                        document.body.classList.remove('dragging');
                        bar.classList.remove('dragging');

                        const newStart = bar.dataset.newStart;
                        const newEnd = bar.dataset.newEnd;

                        if (newStart || newEnd) {
                            // ãƒ‡ãƒ¼ã‚¿ã®æ›´æ–°
                            task.start = newStart || task.start;
                            task.end = newEnd || task.end;
                            // durationãŒ1æ—¥ã®ã‚¿ã‚¹ã‚¯ã‚’ãƒ‰ãƒ©ãƒƒã‚°ã—ãŸå ´åˆã€æœŸé–“ã‚’ç¶­æŒã™ã‚‹ãŸã‚ã«start/endä¸¡æ–¹ã‚’æ›´æ–°ã™ã‚‹å¿…è¦ãŒã‚ã‚‹
                            // æœŸé–“è¨ˆç®—ã¨æ›´æ–°å‡¦ç†ã‚’çµ±åˆ
                            const start = new Date(task.start);
                            const end = new Date(task.end);

                            if (start > end) {
                                // é–‹å§‹æ—¥ãŒçµ‚äº†æ—¥ã‚ˆã‚Šå¾Œã«ãªã£ãŸå ´åˆã€æœŸé–“ã‚’1æ—¥ã«ä¿®æ­£
                                end.setDate(start.getDate());
                                task.end = formatDate(end);
                            }

                            saveData();
                            renderGanttChart(); // å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã—ã¦æœ€æ–°ã®çŠ¶æ…‹ã‚’åæ˜ 
                        }

                        isDragging = false;
                        isResizing = false;
                        resizeDirection = null;
                        bar.removeAttribute('data-new-start');
                        bar.removeAttribute('data-new-end');
                    }
                });
            });
        }


        // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
        let currentCalendarDate = new Date();

        function renderCalendar(date) {
            currentCalendarDate = date;
            const year = date.getFullYear();
            const month = date.getMonth();
            
            document.getElementById('calendarTitle').textContent = `${year}å¹´ ${month + 1}æœˆ`;
            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';
            
            // æœˆã®æœ€åˆã®æ—¥ã¨æœ€å¾Œã®æ—¥
            const firstDayOfMonth = new Date(year, month, 1);
            const lastDayOfMonth = new Date(year, month + 1, 0);
            
            // ã‚°ãƒªãƒƒãƒ‰ã®æœ€åˆã®ã‚»ãƒ«ã«è¡¨ç¤ºã™ã‚‹æ—¥ä»˜ (æ—¥æ›œæ—¥ã‹ã‚‰é–‹å§‹)
            const startDayIndex = firstDayOfMonth.getDay(); // 0 (Sun) - 6 (Sat)
            const startDate = new Date(firstDayOfMonth);
            startDate.setDate(firstDayOfMonth.getDate() - startDayIndex);
            
            const store = data.stores[currentStoreId];
            const tasks = store.tasks;

            // 6é€±é–“ (42æ—¥) ã®æ—¥ä»˜ã‚’ç”Ÿæˆ
            for (let i = 0; i < 42; i++) {
                const currentDate = new Date(startDate);
                currentDate.setDate(startDate.getDate() + i);
                
                const isOtherMonth = currentDate.getMonth() !== month;
                const isToday = currentDate.toDateString() === new Date().toDateString();

                let dayClass = 'calendar-day';
                if (isOtherMonth) dayClass += ' other-month';
                if (isToday) dayClass += ' today';
                
                const dayTasks = tasks.filter(task => {
                    const start = new Date(task.start);
                    const end = new Date(task.end);
                    // çµ‚æ—¥ã‚¿ã‚¹ã‚¯ã¨ã—ã¦æ‰±ã†ãŸã‚ã€çµ‚äº†æ—¥ã¯ãã®æ—¥ã®çµ‚ã‚ã‚Šã¨è¦‹ãªã™
                    // new Date(task.end) ãŒ 2025-01-05 ã®å ´åˆã€5æ—¥ã¾ã§å«ã‚€
                    
                    // ã‚¿ã‚¹ã‚¯é–‹å§‹æ—¥ <= ç¾åœ¨ã®æ—¥ä»˜ ã‹ã¤ ç¾åœ¨ã®æ—¥ä»˜ <= ã‚¿ã‚¹ã‚¯çµ‚äº†æ—¥
                    return currentDate >= start && currentDate <= end;
                });
                
                let tasksHtml = dayTasks.map(t => `<div class="calendar-task" title="${t.name} (${t.assignee})">${t.name}</div>`).join('');
                
                grid.innerHTML += `
                    <div class="${dayClass}">
                        <div class="calendar-day-number">${currentDate.getDate()}</div>
                        ${tasksHtml}
                    </div>
                `;
            }
        }

        function previousMonth() {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
            renderCalendar(currentCalendarDate);
        }

        function nextMonth() {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
            renderCalendar(currentCalendarDate);
        }

        function todayMonth() {
            currentCalendarDate = new Date();
            renderCalendar(currentCalendarDate);
        }


        // ã‚¹ã‚¿ãƒƒãƒ•ç®¡ç†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
        function renderStaffList() {
            const store = data.stores[currentStoreId];
            const staffList = store.staff;
            const container = document.getElementById('staffList');

            if (staffList.length === 0) {
                container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">ğŸ‘¥</div><div class="empty-state-text">ã‚¹ã‚¿ãƒƒãƒ•ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</div></div>`;
                return;
            }

            container.innerHTML = staffList.map(s => `
                <div class="staff-card">
                    <div class="staff-name">${s.name}</div>
                    <div class="staff-role">${s.role}</div>
                    <div class="staff-info">ğŸ“§ ${s.email || 'æœªç™»éŒ²'}</div>
                    <div class="staff-info">ğŸ“ ${s.memo || 'ç‰¹ã«ãªã—'}</div>
                    <div class="btn-group" style="margin-top: 16px;">
                        <button class="btn btn-secondary" onclick="openStaffModal(${s.id})">ç·¨é›†</button>
                        <button class="btn btn-danger" onclick="deleteStaff(${s.id})">å‰Šé™¤</button>
                    </div>
                </div>
            `).join('');
        }

        function openStaffModal(staffId = null) {
            const modal = document.getElementById('staffModal');
            document.getElementById('staffModalTitle').textContent = staffId ? 'ã‚¹ã‚¿ãƒƒãƒ•ç·¨é›†' : 'ã‚¹ã‚¿ãƒƒãƒ•è¿½åŠ ';
            document.getElementById('staffSubmitBtnText').textContent = staffId ? 'æ›´æ–°' : 'è¿½åŠ ';
            isEditingStaffId = staffId;
            
            const form = document.forms[1];
            form.reset();

            if (staffId) {
                const staff = data.stores[currentStoreId].staff.find(s => s.id === staffId);
                if (staff) {
                    document.getElementById('staffId').value = staff.id;
                    document.getElementById('staffName').value = staff.name;
                    document.getElementById('staffRole').value = staff.role;
                    document.getElementById('staffEmail').value = staff.email;
                    document.getElementById('staffMemo').value = staff.memo;
                }
            }
            modal.classList.add('active');
        }

        function addOrUpdateStaff(event) {
            event.preventDefault();
            const store = data.stores[currentStoreId];
            const staffId = document.getElementById('staffId').value;
            const name = document.getElementById('staffName').value;
            const role = document.getElementById('staffRole').value;
            const email = document.getElementById('staffEmail').value;
            const memo = document.getElementById('staffMemo').value;

            if (staffId && isEditingStaffId) {
                // æ›´æ–°
                const index = store.staff.findIndex(s => s.id == staffId);
                if (index !== -1) {
                    store.staff[index] = { id: parseInt(staffId), name, role, email, memo };
                }
            } else {
                // è¿½åŠ 
                const newStaff = {
                    id: store.nextStaffId++,
                    name,
                    role,
                    email,
                    memo,
                };
                store.staff.push(newStaff);
            }

            isEditingStaffId = null;
            closeModal('staffModal');
            saveData();
        }

        function deleteStaff(staffId) {
            if (currentUser.role !== 'admin' && currentUser.role !== 'editor') {
                alert('ã“ã®æ“ä½œã«ã¯ç®¡ç†è€…ã¾ãŸã¯ç·¨é›†è€…æ¨©é™ãŒå¿…è¦ã§ã™ã€‚');
                return;
            }
            
            if (!confirm('ã“ã®ã‚¹ã‚¿ãƒƒãƒ•æƒ…å ±ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;

            const store = data.stores[currentStoreId];
            store.staff = store.staff.filter(s => s.id !== staffId);
            saveData();
        }


        // ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
        function renderTimeline() {
            const store = data.stores[currentStoreId];
            const tasks = store.tasks.sort((a, b) => new Date(a.start) - new Date(b.start));
            const container = document.getElementById('timelineView');

            if (tasks.length === 0) {
                container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">â±ï¸</div><div class="empty-state-text">ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“</div></div>`;
                return;
            }

            container.innerHTML = tasks.map(t => {
                const statusClass = t.status === 'å®Œäº†' ? 'completed' : t.status === 'é€²è¡Œä¸­' ? 'in-progress' : 'pending';
                return `
                    <div style="display: flex; align-items: flex-start; margin-bottom: 24px;">
                        <div style="width: 120px; flex-shrink: 0; font-size: 14px; font-weight: 600; color: var(--primary); padding-top: 4px;">
                            ${t.start}<br>
                            <span style="font-size: 12px; color: var(--text-secondary); font-weight: 500;">(${t.end} å®Œäº†äºˆå®š)</span>
                        </div>
                        <div style="flex-grow: 1; border-left: 3px solid #D2D2D7; padding-left: 20px; position: relative;">
                            <div style="position: absolute; left: -8px; top: 8px; width: 15px; height: 15px; border-radius: 50%; background: var(--primary); border: 3px solid white; box-shadow: 0 0 0 2px var(--primary);"></div>
                            <div style="font-size: 18px; font-weight: 700; margin-bottom: 4px;">${t.name}</div>
                            <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 8px;">
                                ãƒ¬ãƒ™ãƒ«: ${t.level} | æ‹…å½“: ${t.assignee || 'æœªå®š'} | è¦ª: ${t.parent || 'ãªã—'}
                            </div>
                            <span class="task-status ${statusClass}">${t.status}</span>
                            ${t.memo ? `<div style="font-size: 14px; color: #5856D6; margin-top: 8px; font-style: italic;">ãƒ¡ãƒ¢: ${t.memo}</div>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ã‚¿ã‚¹ã‚¯ç®¡ç†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
        function renderTaskList() {
            const store = data.stores[currentStoreId];
            const tasks = store.tasks.sort((a, b) => new Date(a.start) - new Date(b.start));
            const container = document.getElementById('taskList');

            if (tasks.length === 0) {
                container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">ğŸ“‹</div><div class="empty-state-text">ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“</div></div>`;
                return;
            }

            // è¦ªã‚¿ã‚¹ã‚¯åã‹ã‚‰å­ã‚¿ã‚¹ã‚¯IDã®é…åˆ—ã‚’å–å¾—ã™ã‚‹ãƒãƒƒãƒ—ã‚’ä½œæˆ
            const taskHierarchy = tasks.reduce((map, task) => {
                if (task.parent) {
                    if (!map[task.parent]) map[task.parent] = [];
                    map[task.parent].push(task);
                }
                return map;
            }, {});

            // ãƒˆãƒƒãƒ—ãƒ¬ãƒ™ãƒ«ã®ã‚¿ã‚¹ã‚¯ (è¦ªã‚¿ã‚¹ã‚¯åãŒç©ºã®ã‚‚ã®) ã‚’æŠ½å‡º
            const topLevelTasks = tasks.filter(t => !t.parent);
            
            let html = '';

            // å†å¸°çš„ã«ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°
            function buildTaskHtml(task) {
                const statusClass = task.status === 'å®Œäº†' ? 'completed' : task.status === 'é€²è¡Œä¸­' ? 'in-progress' : 'pending';
                
                let taskHtml = `
                    <div class="task-item level-${task.level}" data-task-id="${task.id}">
                        <div class="task-header">
                            <div class="task-name">${task.name}</div>
                            <span class="task-status ${statusClass}">${task.status}</span>
                        </div>
                        <div class="task-meta">
                            <div>ãƒ¬ãƒ™ãƒ«: ${task.level}</div>
                            <div>é–‹å§‹æ—¥: ${task.start}</div>
                            <div>çµ‚äº†æ—¥: ${task.end}</div>
                            <div class="task-assignee">${task.assignee || 'æœªå®š'}</div>
                            ${task.parent ? `<div style="color: #5856D6;">è¦ª: ${task.parent}</div>` : ''}
                        </div>
                        ${task.memo ? `<div class="task-memo">ğŸ“ ${task.memo}</div>` : ''}
                        <div class="task-actions">
                            <button class="btn-edit" onclick="editTask(${task.id})">ç·¨é›†</button>
                            <button class="btn-delete" onclick="deleteTask(${task.id})">å‰Šé™¤</button>
                        </div>
                    </div>
                `;

                // å­ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Œã°å†å¸°çš„ã«å‘¼ã³å‡ºã™
                if (taskHierarchy[task.name]) {
                    taskHierarchy[task.name].forEach(childTask => {
                        taskHtml += buildTaskHtml(childTask);
                    });
                }
                
                return taskHtml;
            }

            // ãƒˆãƒƒãƒ—ãƒ¬ãƒ™ãƒ«ã‹ã‚‰é–‹å§‹
            topLevelTasks.forEach(task => {
                html += buildTaskHtml(task);
            });

            container.innerHTML = html;
        }

        // ã‚¿ã‚¹ã‚¯è¿½åŠ /ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ ã®å‡¦ç†
        function addOrUpdateTask(event) {
            event.preventDefault();
            const store = data.stores[currentStoreId];
            const level = parseInt(document.getElementById('taskLevel').value);
            const parent = document.getElementById('taskParent').value;
            const name = document.getElementById('taskName').value;
            const assignee = document.getElementById('taskAssignee').value;
            const memo = document.getElementById('taskMemo').value;
            const start = document.getElementById('taskStart').value;
            const end = document.getElementById('taskEnd').value;
            const status = document.getElementById('taskStatus').value;
            
            if (new Date(start) > new Date(end)) {
                alert('çµ‚äº†æ—¥ã¯é–‹å§‹æ—¥ä»¥é™ã®æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            const isMilestone = level === 1 && (new Date(start).getTime() === new Date(end).getTime()); // ãƒ¬ãƒ™ãƒ«1ã§æœŸé–“ãŒ1æ—¥ã®ã‚‚ã®ã‚’ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ã¨ã™ã‚‹
            
            if (isEditingTaskId) {
                // æ›´æ–°
                const index = store.tasks.findIndex(t => t.id === isEditingTaskId);
                if (index !== -1) {
                    store.tasks[index] = { id: isEditingTaskId, level, parent, name, assignee, memo, start, end, status, isMilestone, children: store.tasks[index].children };
                }
                isEditingTaskId = null;
                document.getElementById('taskSubmitBtn').textContent = 'â• ã‚¿ã‚¹ã‚¯è¿½åŠ ';
                document.getElementById('cancelEditBtn').style.display = 'none';
                document.forms[0].reset();
            } else {
                // è¿½åŠ 
                const newTask = {
                    id: store.nextTaskId++,
                    level,
                    parent,
                    name,
                    assignee,
                    memo,
                    start,
                    end,
                    status,
                    isMilestone,
                    children: [] // åˆæœŸå­ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆã¯ç©º
                };
                store.tasks.push(newTask);
                document.forms[0].reset();
            }

            // è¦ªã‚¿ã‚¹ã‚¯ã®å­ã‚¿ã‚¹ã‚¯IDã‚’å†æ§‹ç¯‰ã™ã‚‹ï¼ˆã‚·ãƒ³ãƒ—ãƒ«åŒ–ã®ãŸã‚ã€å¸¸ã«å…¨ã‚¿ã‚¹ã‚¯ã§å®Ÿè¡Œï¼‰
            rebuildTaskHierarchy(store.tasks);

            saveData();
        }

        // ã‚¿ã‚¹ã‚¯éšå±¤æƒ…å ±ã®å†æ§‹ç¯‰
        function rebuildTaskHierarchy(tasks) {
            // å…¨ã‚¿ã‚¹ã‚¯ã®å­ã‚¿ã‚¹ã‚¯IDã‚’ã‚¯ãƒªã‚¢
            tasks.forEach(t => t.children = []);

            // è¦ªã‚¿ã‚¹ã‚¯åã‚’ã‚­ãƒ¼ã¨ã™ã‚‹ãƒãƒƒãƒ—ã‚’ä½œæˆ
            const nameToTaskMap = tasks.reduce((map, task) => {
                map[task.name] = task;
                return map;
            }, {});

            // å„ã‚¿ã‚¹ã‚¯ã«ã¤ã„ã¦ã€è¦ªã‚¿ã‚¹ã‚¯ã® children ãƒªã‚¹ãƒˆã«è‡ªåˆ†ã®IDã‚’è¿½åŠ 
            tasks.forEach(task => {
                if (task.parent) {
                    const parentTask = nameToTaskMap[task.parent];
                    if (parentTask) {
                        // é‡è¤‡ã—ãªã„ã‚ˆã†ã«è¿½åŠ 
                        if (!parentTask.children.includes(task.id)) {
                            parentTask.children.push(task.id);
                        }
                    }
                }
            });
        }

        function editTask(taskId) {
            const task = data.stores[currentStoreId].tasks.find(t => t.id === taskId);
            if (!task) return;

            isEditingTaskId = taskId;
            
            // ãƒ•ã‚©ãƒ¼ãƒ ã«å€¤ã‚’è¨­å®š
            document.getElementById('taskLevel').value = task.level;
            document.getElementById('taskParent').value = task.parent;
            document.getElementById('taskName').value = task.name;
            document.getElementById('taskAssignee').value = task.assignee;
            document.getElementById('taskMemo').value = task.memo;
            document.getElementById('taskStart').value = task.start;
            document.getElementById('taskEnd').value = task.end;
            document.getElementById('taskStatus').value = task.status;

            document.getElementById('taskSubmitBtn').textContent = 'ğŸ’¾ ã‚¿ã‚¹ã‚¯æ›´æ–°';
            document.getElementById('cancelEditBtn').style.display = 'inline-block';

            // ç·¨é›†ä¸­ã®ã‚¿ã‚¹ã‚¯ã¾ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
            document.getElementById('tasks').scrollTop = 0;
        }

        function cancelEdit() {
            isEditingTaskId = null;
            document.forms[0].reset();
            document.getElementById('taskSubmitBtn').textContent = 'â• ã‚¿ã‚¹ã‚¯è¿½åŠ ';
            document.getElementById('cancelEditBtn').style.display = 'none';
        }

        function deleteTask(taskId) {
            if (currentUser.role !== 'admin' && currentUser.role !== 'editor') {
                alert('ã“ã®æ“ä½œã«ã¯ç®¡ç†è€…ã¾ãŸã¯ç·¨é›†è€…æ¨©é™ãŒå¿…è¦ã§ã™ã€‚');
                return;
            }

            const deletePassword = prompt('ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤ã™ã‚‹ã«ã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
            if (deletePassword !== 'delete') {
                alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚');
                return;
            }

            if (!confirm('ã“ã®ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆã“ã®ã‚¿ã‚¹ã‚¯ã‚’è¦ªã¨ã™ã‚‹å­ã‚¿ã‚¹ã‚¯ã¯å­¤ç«‹ã—ã¾ã™ï¼‰')) return;

            const store = data.stores[currentStoreId];
            store.tasks = store.tasks.filter(t => t.id !== taskId);
            
            // éšå±¤ã®å†æ§‹ç¯‰ã¨ä¿å­˜
            rebuildTaskHierarchy(store.tasks);
            saveData();
        }


        // ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
        function formatDate(date) {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }


        // ãƒ­ã‚°ã‚¤ãƒ³æ©Ÿèƒ½
        const loginScreen = document.getElementById('loginScreen');
        const appContainer = document.getElementById('appContainer');

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
        function renderUserList() {
            const container = document.getElementById('userList');
            
            if (users.length === 0) {
                container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">ğŸ‘¥</div><div class="empty-state-text">ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</div></div>`;
                return;
            }

            let html = '';
            users.forEach(user => {
                html += `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 16px; border-bottom: 1px solid #D2D2D7; background: white; border-radius: 8px; margin-bottom: 8px;">
                        <div>
                            <div style="font-weight: 600; margin-bottom: 4px;">${user.name}</div>
                            <div style="font-size: 14px; color: #86868B;">${user.email}</div>
                            <span style="display: inline-block; padding: 4px 12px; border-radius: 8px; font-size: 12px; font-weight: 600; margin-top: 8px; ${user.role === 'admin' ? 'background: rgba(0, 122, 255, 0.1); color: #007AFF;' : 'background: rgba(88, 86, 214, 0.1); color: #5856D6;'}" data-role="${user.role}">${user.role === 'admin' ? 'ç®¡ç†è€…' : 'ç·¨é›†è€…'}</span>
                        </div>
                        <div class="btn-group">
                            <button class="btn btn-secondary" onclick="openUserModal(${user.id})" ${user.id === currentUser.id || currentUser.role !== 'admin' ? 'disabled' : ''}>ç·¨é›†</button>
                            <button class="btn btn-danger" onclick="deleteUser(${user.id})" ${user.id === currentUser.id || currentUser.role !== 'admin' ? 'disabled' : ''}>å‰Šé™¤</button>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function openUserModal(userId = null) {
            if (currentUser.role !== 'admin' && userId === null) return;
            if (userId !== null && currentUser.role !== 'admin' && userId !== currentUser.id) return;

            const modal = document.getElementById('userModal');
            const form = document.forms[2];
            form.reset();

            if (userId) {
                const user = users.find(u => u.id === userId);
                if (user) {
                    document.getElementById('userId').value = user.id;
                    document.getElementById('userName').value = user.name;
                    document.getElementById('userEmail').value = user.email;
                    document.getElementById('userPassword').value = user.password;
                    document.getElementById('userRole').value = user.role;
                }
            }

            modal.classList.add('active');
        }

        function addOrUpdateUser(event) {
            event.preventDefault();
            const userId = document.getElementById('userId').value;
            const name = document.getElementById('userName').value;
            const email = document.getElementById('userEmail').value;
            const password = document.getElementById('userPassword').value;
            const role = document.getElementById('userRole').value;
            
            if (currentUser.role !== 'admin' && userId === null) {
                alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼è¿½åŠ ã«ã¯ç®¡ç†è€…æ¨©é™ãŒå¿…è¦ã§ã™ã€‚');
                return;
            }

            if (userId) {
                // æ›´æ–°
                const index = users.findIndex(u => u.id == userId);
                if (index !== -1) {
                    // ç®¡ç†è€…ä»¥å¤–ã¯æ¨©é™ã®å¤‰æ›´ä¸å¯
                    const finalRole = currentUser.role === 'admin' ? role : users[index].role;
                    users[index] = { id: parseInt(userId), name, email, password, role: finalRole };
                }
            } else {
                // è¿½åŠ 
                const newId = users.length > 0 ? Math.max(...users.map(u => u.id)) + 1 : 1;
                const newUser = { id: newId, name, email, password, role };
                users.push(newUser);
            }

            localStorage.setItem('istyle_users', JSON.stringify(users));
            closeModal('userModal');
            renderUserList();
            
            // è‡ªåˆ†ã®æƒ…å ±ã‚’æ›´æ–°ã—ãŸå ´åˆã€UIã‚’å†æ›´æ–°
            if (userId && parseInt(userId) === currentUser.id) {
                currentUser = users.find(u => u.id === currentUser.id);
                localStorage.setItem('istyle_currentUser', JSON.stringify(currentUser));
                updateUserInfo(currentUser);
            }
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤
        function deleteUser(userId) {
            if (currentUser.role !== 'admin') {
                alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤ã«ã¯ç®¡ç†è€…æ¨©é™ãŒå¿…è¦ã§ã™ã€‚');
                return;
            }
            if (userId === currentUser.id) {
                alert('è‡ªåˆ†è‡ªèº«ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¯å‰Šé™¤ã§ãã¾ã›ã‚“ã€‚');
                return;
            }
            
            if (!confirm('ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
            
            let storedUsers = users;
            storedUsers = storedUsers.filter(u => u.id !== userId);
            
            // usersé…åˆ—ã‚’æ›´æ–°
            users.length = 0; // é…åˆ—ã‚’ã‚¯ãƒªã‚¢
            Array.prototype.push.apply(users, storedUsers); // æ–°ã—ã„å†…å®¹ã‚’æŒ¿å…¥

            localStorage.setItem('istyle_users', JSON.stringify(users));
            renderUserList();
        }

        // ãƒ­ã‚°ã‚¤ãƒ³ãƒã‚§ãƒƒã‚¯
        function checkLogin() {
            const savedUser = localStorage.getItem('istyle_currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                // ä¿å­˜ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒç¾åœ¨ã®usersãƒªã‚¹ãƒˆã«å­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
                if (users.some(u => u.id === currentUser.id)) {
                    showApp(currentUser);
                    return;
                }
            }
            loginScreen.style.display = 'flex';
            appContainer.style.display = 'none';
        }

        // ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†
        function handleLogin(event) {
            event.preventDefault();
            // ä¿®æ­£ç®‡æ‰€: .trim() ã‚’è¿½åŠ ã—ã¦ã€å‰å¾Œã®ã‚¹ãƒšãƒ¼ã‚¹ã‚’è‡ªå‹•çš„ã«å‰Šé™¤ã—ã¾ã™ (ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¦æœ›ã«ã‚ˆã‚‹ä¿®æ­£)
            const email = document.getElementById('loginEmail').value.trim(); 
            const password = document.getElementById('loginPassword').value.trim();
            const errorElement = document.getElementById('loginError');
            errorElement.style.display = 'none';

            const user = users.find(u => u.email === email && u.password === password);

            if (user) {
                currentUser = user;
                localStorage.setItem('istyle_currentUser', JSON.stringify(currentUser));
                showApp(currentUser);
            } else {
                errorElement.textContent = 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚';
                errorElement.style.display = 'block';
            }
        }

        function showApp(user) {
            loginScreen.style.display = 'none';
            appContainer.style.display = 'flex';
            updateUserInfo(user);
            renderAllViews();
        }

        function updateUserInfo(user) {
            document.getElementById('currentUserName').textContent = user.name;
            document.getElementById('currentUserRole').textContent = user.role === 'admin' ? 'ç®¡ç†è€…' : 'ç·¨é›†è€…';
        }

        function logout() {
            localStorage.removeItem('istyle_currentUser');
            currentUser = null;
            loginScreen.style.display = 'flex';
            appContainer.style.display = 'none';
            document.getElementById('loginForm').reset();
        }


        // åº—èˆ—ç®¡ç†
        function addStore() {
            if (currentUser.role !== 'admin') {
                alert('åº—èˆ—ç®¡ç†ã«ã¯ç®¡ç†è€…æ¨©é™ãŒå¿…è¦ã§ã™ã€‚');
                return;
            }

            const newStoreName = document.getElementById('newStoreName').value.trim();
            if (!newStoreName) {
                alert('åº—èˆ—åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            const newId = `store-${data.nextStoreId++}`;
            data.stores[newId] = {
                name: newStoreName,
                tasks: [],
                staff: [],
                nextTaskId: 1,
                nextStaffId: 1,
            };

            currentStoreId = newId;
            document.getElementById('newStoreName').value = '';
            saveData();
            initializeStoreSelector();
            showTab('dashboard');
        }

        function deleteStore() {
            if (currentUser.role !== 'admin') {
                alert('åº—èˆ—ç®¡ç†ã«ã¯ç®¡ç†è€…æ¨©é™ãŒå¿…è¦ã§ã™ã€‚');
                return;
            }

            const deletePassword = prompt('åº—èˆ—ã‚’å‰Šé™¤ã™ã‚‹ã«ã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
            if (deletePassword !== 'delete') {
                alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚');
                return;
            }

            if (Object.keys(data.stores).length <= 1) {
                alert('æœ€å¾Œã®åº—èˆ—ã¯å‰Šé™¤ã§ãã¾ã›ã‚“ã€‚');
                return;
            }

            if (!confirm(`ã€Œ${data.stores[currentStoreId].name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ï¼‰`)) return;

            delete data.stores[currentStoreId];
            
            // å‰Šé™¤å¾Œã€åˆ¥ã®åº—èˆ—ã«åˆ‡ã‚Šæ›¿ãˆã‚‹
            currentStoreId = Object.keys(data.stores)[0];

            saveData();
            initializeStoreSelector();
            showTab('dashboard');
        }

        // ãƒ‡ãƒ¼ã‚¿æ“ä½œ
        function exportData() {
            const dataStr = JSON.stringify(data, null, 2);
            const blob = new Blob([dataStr], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `istyle_dashboard_data_${formatDate(new Date())}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function clearAllData() {
            if (currentUser.role !== 'admin') {
                alert('å…¨ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢ã«ã¯ç®¡ç†è€…æ¨©é™ãŒå¿…è¦ã§ã™ã€‚');
                return;
            }

            const deletePassword = prompt('å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã™ã‚‹ã«ã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
            if (deletePassword !== 'delete') {
                alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚');
                return;
            }

            if (confirm('æœ¬å½“ã«å…¨ã¦ã®ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ï¼‰')) {
                localStorage.removeItem('istyle_dashboardData');
                localStorage.removeItem('istyle_currentStoreId');
                localStorage.removeItem('istyle_currentUser');
                localStorage.removeItem('istyle_users');
                window.location.reload();
            }
        }

        // CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        function exportTasksAsCsv() {
            const store = data.stores[currentStoreId];
            const tasks = store.tasks;
            if (tasks.length === 0) {
                alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
                return;
            }

            const header = ["id", "level", "parent", "name", "assignee", "memo", "start", "end", "status", "isMilestone"];
            const csvRows = [
                header.join(',')
            ];

            for (const task of tasks) {
                const values = header.map(fieldName => {
                    const value = task[fieldName];
                    // CSVã®å€¤ã‚’ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
                    return `"${(value + "").replace(/"/g, '""')}"`;
                });
                csvRows.push(values.join(','));
            }

            const csvString = csvRows.join('\n');
            const blob = new Blob(["\ufeff", csvString], { type: 'text/csv;charset=utf-8;' }); // \ufeffã§BOMã‚’ä»˜åŠ ã—æ–‡å­—åŒ–ã‘ã‚’é˜²ã
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `istyle_tasks_${data.stores[currentStoreId].name}_${formatDate(new Date())}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        function setupFileImport() {
            const dropZone = document.getElementById('csvDropZone');
            const fileInput = document.getElementById('csvFileInput');

            dropZone.addEventListener('click', () => fileInput.click());
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('dragover');
            });
            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('dragover');
            });
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length) {
                    processCsvFile(files[0]);
                }
            });
        }

        function handleFileSelect(event) {
            const files = event.target.files;
            if (files.length) {
                processCsvFile(files[0]);
            }
        }

        function processCsvFile(file) {
            if (currentUser.role !== 'admin' && currentUser.role !== 'editor') {
                alert('ã‚¿ã‚¹ã‚¯ã‚¤ãƒ³ãƒãƒ¼ãƒˆã«ã¯ç®¡ç†è€…ã¾ãŸã¯ç·¨é›†è€…æ¨©é™ãŒå¿…è¦ã§ã™ã€‚');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const csvData = e.target.result;
                try {
                    importTasksFromCsv(csvData);
                    alert('ã‚¿ã‚¹ã‚¯ãŒæ­£å¸¸ã«ã‚¤ãƒ³ãƒãƒ¼ãƒˆã•ã‚Œã¾ã—ãŸã€‚');
                } catch (error) {
                    alert('CSVãƒ•ã‚¡ã‚¤ãƒ«ã®å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
                }
            };
            reader.readAsText(file, 'UTF-8');
        }

        function importTasksFromCsv(csv) {
            const lines = csv.split('\n').filter(line => line.trim() !== '');
            if (lines.length < 2) throw new Error("CSVãƒ‡ãƒ¼ã‚¿ãŒç©ºã¾ãŸã¯ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã®ã¿ã§ã™ã€‚");

            const header = lines[0].split(',').map(h => h.replace(/"/g, '').trim());
            const requiredFields = ["level", "name", "start", "end", "status"];
            if (!requiredFields.every(field => header.includes(field))) {
                throw new Error(`å¿…è¦ãªåˆ— (${requiredFields.join(', ')}) ãŒå«ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚`);
            }

            const newTasks = [];
            const store = data.stores[currentStoreId];
            let nextId = store.nextTaskId;

            for (let i = 1; i < lines.length; i++) {
                const values = parseCsvLine(lines[i]);
                if (values.length !== header.length) continue; 

                const taskData = {};
                header.forEach((key, index) => {
                    taskData[key] = values[index];
                });

                if (!taskData.name || !taskData.start || !taskData.end) continue;
                
                // ãƒ‡ãƒ¼ã‚¿å‹ã®èª¿æ•´
                const level = parseInt(taskData.level) || 1;
                const isMilestone = level === 1 && (new Date(taskData.start).getTime() === new Date(taskData.end).getTime());

                const newTask = {
                    id: nextId++,
                    level: level,
                    parent: taskData.parent || '',
                    name: taskData.name,
                    assignee: taskData.assignee || '',
                    memo: taskData.memo || '',
                    start: taskData.start,
                    end: taskData.end,
                    status: taskData.status || 'æœªç€æ‰‹',
                    isMilestone: isMilestone,
                    children: [],
                };
                newTasks.push(newTask);
            }
            
            // æ—¢å­˜ã‚¿ã‚¹ã‚¯ã‚’ã‚¯ãƒªã‚¢ã—ã¦æ–°ã—ã„ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ 
            store.tasks = newTasks;
            store.nextTaskId = nextId;
            
            // éšå±¤ã®å†æ§‹ç¯‰ã¨ä¿å­˜
            rebuildTaskHierarchy(store.tasks);
            saveData();
        }

        // CSVã®è¡Œã‚’é©åˆ‡ã«ãƒ‘ãƒ¼ã‚¹ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° (ãƒ€ãƒ–ãƒ«ã‚¯ã‚©ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³å¯¾å¿œ)
        function parseCsvLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];

                if (char === '"') {
                    if (inQuotes && line[i + 1] === '"') {
                        // ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã•ã‚ŒãŸãƒ€ãƒ–ãƒ«ã‚¯ã‚©ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ "" -> "
                        current += '"';
                        i++; // æ¬¡ã®ã‚¯ã‚©ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ã‚¹ã‚­ãƒƒãƒ—
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current.trim()); // æœ€å¾Œã®è¦ç´ ã‚’è¿½åŠ 
            return result.map(s => s.replace(/^"|"$/g, '')); // å‰å¾Œã®ã‚¯ã‚©ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤
        }


        // ã‚µã‚¤ãƒ‰ãƒãƒ¼ã®é–‹é–‰ (ãƒ¢ãƒã‚¤ãƒ«ç”¨)
        function toggleSidebar() {
            document.querySelector('.sidebar').classList.toggle('active');
            document.querySelector('.mobile-overlay').classList.toggle('active');
        }

        // ãƒªã‚µã‚¤ã‚¶ãƒ¼æ©Ÿèƒ½ (ã‚µã‚¤ãƒ‰ãƒãƒ¼ã¨ãƒ˜ãƒƒãƒ€ãƒ¼)
        function setupResizers() {
            const sidebarResizer = document.getElementById('sidebarResizer');
            const headerResizer = document.getElementById('headerResizer');
            const sidebar = document.querySelector('.sidebar');
            const contentHeader = document.querySelector('.content-header');

            let isResizingSidebar = false;
            let isResizingHeader = false;
            let startX, startY, startWidth, startHeight;

            // ã‚µã‚¤ãƒ‰ãƒãƒ¼ãƒªã‚µã‚¤ã‚º
            if(sidebarResizer) {
                sidebarResizer.addEventListener('mousedown', (e) => {
                    isResizingSidebar = true;
                    startX = e.clientX;
                    startWidth = sidebar.offsetWidth;
                    document.body.style.cursor = 'ew-resize';
                    document.body.style.userSelect = 'none';
                    e.preventDefault();
                });
            }

            // ãƒ˜ãƒƒãƒ€ãƒ¼ãƒªã‚µã‚¤ã‚º
            if(headerResizer) {
                headerResizer.addEventListener('mousedown', (e) => {
                    isResizingHeader = true;
                    startY = e.clientY;
                    // ç¾åœ¨ã® padding-top ã¨ padding-bottom ã®åˆè¨ˆã‚’ä»®ã®é«˜ã•ã¨ã™ã‚‹
                    const style = window.getComputedStyle(contentHeader);
                    startHeight = parseFloat(style.paddingTop) + parseFloat(style.paddingBottom);
                    document.body.style.cursor = 'ns-resize';
                    document.body.style.userSelect = 'none';
                    e.preventDefault();
                });
            }

            // ãƒã‚¦ã‚¹ç§»å‹•
            document.addEventListener('mousemove', (e) => {
                if (isResizingSidebar) {
                    const width = startWidth + (e.clientX - startX);
                    if (width >= 200 && width <= 500) {
                        sidebar.style.width = width + 'px';
                        TASK_COL_WIDTH = width; // ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆã®ã‚¿ã‚¹ã‚¯ååˆ—å¹…ã¨é€£å‹•
                        // resizeä¸­ã®é »ç¹ãªå†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã¯é‡ã„ãŸã‚ã€mouseupã§ã®ã¿å®Ÿè¡Œã™ã‚‹
                        // renderGanttChart();
                    }
                } else if (isResizingHeader) {
                    // padding-top ã¨ padding-bottom ã®åˆè¨ˆã‚’èª¿æ•´ã™ã‚‹ã“ã¨ã§é«˜ã•ã‚’å¤‰ãˆã‚‹
                    const dh = e.clientY - startY;
                    const newHeight = startHeight + dh;
                    const newPadding = Math.max(8, newHeight / 2); // æœ€å°8px, ä¸Šä¸‹å‡ç­‰ã«åˆ†ã‘ã‚‹
                    
                    if (newHeight >= 16 && newHeight <= 150) {
                        contentHeader.style.padding = `${newPadding}px 24px ${newPadding}px 24px`;
                    }
                }
            });

            // ãƒã‚¦ã‚¹ã‚¢ãƒƒãƒ—
            document.addEventListener('mouseup', () => {
                if (isResizingSidebar) {
                    // ãƒªã‚µã‚¤ã‚ºå®Œäº†æ™‚ã«ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆã‚’å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
                    renderGanttChart();
                }
                isResizingSidebar = false;
                isResizingHeader = false;
                document.body.style.cursor = 'default';
                document.body.style.userSelect = 'auto';
            });
        }


        // åˆæœŸå‡¦ç†
        window.onload = function() {
            // LocalStorageã‹ã‚‰usersãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€ (åˆå›èµ·å‹•æ™‚ã¯ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸusersé…åˆ—ãŒä½¿ã‚ã‚Œã‚‹)
            const storedUsers = localStorage.getItem('istyle_users');
            if (storedUsers) {
                // ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸé…åˆ—ã‚’LocalStorageã®å†…å®¹ã§ä¸Šæ›¸ã
                users.length = 0;
                Array.prototype.push.apply(users, JSON.parse(storedUsers));
            }
            
            loadData();
            initializeStoreSelector();
            setupFileImport();
            setupResizers();
            checkLogin();
        };

    </script>
</body>
</html>